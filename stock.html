<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StockPilot</title>
    <!-- Chargement de TailwindCSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ajout de la police Inter pour une meilleure apparence */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style pour l'icône de corbeille */
        .delete-icon:hover svg {
            color: #ef4444; /* text-red-500 */
        }
        /* Styles pour le Toast de Succès */
        #success-toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        #success-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        /* Style pour la transition du margin sur le main content */
        main {
            transition: margin-left 0.3s ease-in-out;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "firebase/": "https://aistudiocdn.com/firebase@^12.5.0/"
  }
}
</script>
</head>
<body class="bg-gray-50">

    <!-- 
      CONTENEUR DE LA PAGE D'AUTHENTIFICATION
    -->
    <div id="auth-page-container">
        <div class="min-h-screen bg-gray-50 flex flex-col justify-center items-center p-4">
            <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
                <div class="flex flex-col items-center mb-6">
                    <div class="bg-cyan-100 text-cyan-500 p-3 rounded-lg mb-4">
                        <div data-icon="logo" class="w-8 h-8"></div>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">StockPilot</h1>
                    <p class="text-gray-500 mt-1">
                        Connectez-vous à votre compte ou créez-en un pour continuer.
                    </p>
                </div>

                <div class="w-full bg-gray-100 rounded-lg p-1 flex mb-6">
                    <button id="auth-toggle-login" class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors bg-white shadow text-gray-800">
                        Se connecter
                    </button>
                    <button id="auth-toggle-signup" class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors text-gray-500 hover:bg-gray-200">
                        S'inscrire
                    </button>
                </div>

                <!-- Formulaire de connexion (initialement visible) -->
                <form id="login-form">
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="email">Email</label>
                            <input type="email" id="email" value="votre@email.com" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition" />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="password">Mot de passe</label>
                            <input type="password" id="password" value="********" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition" />
                        </div>
                        <p id="login-error" class="text-red-500 text-sm mt-2 hidden"></p> <!-- Ajout pour les erreurs -->
                        <button type="submit" id="login-submit-button" class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                            Se connecter
                        </button>
                    </div>
                </form>

                <!-- Formulaire d'inscription (initialement caché) -->
                <form id="signup-form" class="hidden">
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="fullName">Nom complet</label>
                            <input type="text" id="fullName" placeholder="Jean Dupont" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition" />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="companyName">Nom de l'entreprise</label>
                            <input type="text" id="companyName" placeholder="Ma Société" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition" />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="signup-email">Email</label>
                            <input type="email" id="signup-email" placeholder="votre@email.com" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition" />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="signup-password">Mot de passe</label>
                            <input type="password" id="signup-password" placeholder="********" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition" />
                        </div>
                        <p id="signup-error" class="text-red-500 text-sm mt-2 hidden"></p> <!-- Ajout pour les erreurs -->
                        <button type="submit" id="signup-submit-button" class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                            Créer mon compte
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 
      CONTENEUR DE L'APPLICATION (LAYOUT)
      Initialement caché, sera affiché par JS après la connexion.
    -->
    <div id="layout-container" class="hidden">
        <!-- Overlay pour sidebar mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-white shadow-md flex flex-col h-screen fixed top-0 left-0 z-40 transition-transform duration-300 ease-in-out -translate-x-full lg:translate-x-0 lg:transition-all">
            <div class="p-6 flex items-center space-x-3 border-b border-gray-200">
                <div class="bg-cyan-100 text-cyan-500 p-2 rounded-lg">
                    <div data-icon="logo" class="w-6 h-6"></div>
                </div>
                <h1 class="sidebar-text text-xl font-bold text-gray-800">StockPilot</h1>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <!-- Les boutons de navigation -->
                <button data-page="Tableau de bord" class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-cyan-400 text-white shadow">
                    <div data-icon="dashboard" class="w-5 h-5"></div>
                    <span class="sidebar-text">Tableau de bord</span>
                </button>
                <button data-page="Ventes" class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="sales" class="w-5 h-5"></div>
                    <span class="sidebar-text">Ventes</span>
                </button>
                <button data-page="Stock Boutique" class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="box" class="w-5 h-5"></div>
                    <span class="sidebar-text">Stock Boutique</span>
                </button>
                <button data-page="Mon Magasin" class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="box" class="w-5 h-5"></div>
                    <span class="sidebar-text">Mon Magasin</span>
                </button>
                <button data-page="Statistiques" class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="stats" class="w-5 h-5"></div>
                    <span class="sidebar-text">Statistiques</span>
                </button>
                <button data-page="Paramètres" class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="settings" class="w-5 h-5"></div>
                    <span class="sidebar-text">Paramètres</span>
                </button>
            </nav>
            <div class="p-4 border-t border-gray-200">
                <div class="sidebar-text p-4 mb-2 rounded-lg bg-gray-100">
                    <!-- Placeholder pour le profil utilisateur -->
                    <p class="text-sm font-medium text-gray-700">Utilisateur connecté</p>
                    <p id="user-email-display" class="text-xs text-gray-500 truncate">Chargement...</p> <!-- ID ajouté -->
                </div>
                <button id="logout-button" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">
                    <div data-icon="logout" class="w-5 h-5"></div>
                    <span class="sidebar-text">Déconnexion</span>
                </button>
            </div>
             <!-- Bouton pour réduire/agrandir la sidebar sur Desktop -->
            <div class="hidden lg:block absolute -right-3 top-20">
                <button id="sidebar-collapse-toggle" class="bg-white border rounded-full p-1.5 shadow-md hover:bg-gray-100 transition-colors">
                    <div data-icon="arrowLeft" class="w-4 h-4 text-gray-600"></div>
                </button>
            </div>
        </aside>

        <!-- Contenu principal (pages) -->
        <main class="flex-1 lg:ml-64 overflow-y-auto">
            
            <!-- Header pour la vue mobile -->
            <header id="mobile-header" class="sticky top-0 bg-gray-50/75 backdrop-blur-sm z-10 p-4 border-b border-gray-200 flex items-center justify-between lg:hidden">
                <button id="hamburger-button" class="text-gray-500 hover:text-gray-800">
                    <div data-icon="menu" class="w-6 h-6"></div>
                </button>
                <h1 id="mobile-page-title" class="text-lg font-semibold text-gray-800">Tableau de bord</h1>
                <div class="w-6"></div> <!-- Spacer -->
            </header>

            <!-- Page: Tableau de bord -->
            <div id="page-Tableau-de-bord" class="page-content p-4 md:p-8">
                <h1 class="text-3xl font-bold text-gray-800">Bienvenue!</h1>
                <p class="text-gray-500 mt-1">Voici un aperçu de votre activité</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Ventes du jour</p>
                            <p id="stat-daily-sales" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                        </div>
                        <div class="p-3 rounded-lg bg-blue-100">
                            <div data-icon="sales" class="w-6 h-6 text-blue-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Stock Boutique</p>
                            <p id="stat-shop-stock" class="text-2xl font-bold text-gray-800 mt-1">0 produits</p>
                        </div>
                        <div class="p-3 rounded-lg bg-green-100">
                            <div data-icon="box" class="w-6 h-6 text-green-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Stock Magasin</p>
                            <p id="stat-store-stock" class="text-2xl font-bold text-gray-800 mt-1">0 produits</p>
                        </div>
                        <div class="p-3 rounded-lg bg-yellow-100">
                            <div data-icon="box" class="w-6 h-6 text-yellow-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Revenus du mois</p>
                            <p id="stat-monthly-revenue" class="text-2xl font-bold text-gray-800 mt-1">0 FCFA</p>
                        </div>
                        <div class="p-3 rounded-lg bg-indigo-100">
                            <div data-icon="stats" class="w-6 h-6 text-indigo-500"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-10 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800">Démarrage rapide</h2>
                    <div class="mt-4 space-y-4">
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h3 class="font-semibold text-gray-700">1. Ajouter des produits au magasin</h3>
                            <p class="text-sm text-gray-500 mt-1">Commencez par ajouter vos produits dans "Mon Magasin" avec leurs prix d'achat.</p>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h3 class="font-semibold text-gray-700">2. Transférer vers la boutique</h3>
                            <p class="text-sm text-gray-500 mt-1">Transférez les produits vers votre "Stock Boutique" en ajoutant votre marge.</p>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h3 class="font-semibold text-gray-700">3. Enregistrer vos ventes</h3>
                            <p class="text-sm text-gray-500 mt-1">Utilisez l'interface "Ventes" pour enregistrer chaque transaction.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Ventes -->
            <div id="page-Ventes" class="page-content p-4 md:p-8 hidden">
                <h1 class="text-3xl font-bold text-gray-800">Ventes</h1>
                <p class="text-gray-500 mt-1">Enregistrez vos ventes quotidiennes</p>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <div data-icon="sales" class="w-6 h-6 mr-3 text-cyan-500"></div>
                        Enregistrer une vente
                    </h2>
                    <form id="sales-form" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1">
                            <label for="sales-product-select" class="block text-sm font-medium text-gray-700 mb-1">Produit *</label>
                            <select id="sales-product-select" name="product" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500">
                                <option value="">Sélectionner un produit</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label for="sales-quantity-input" class="block text-sm font-medium text-gray-700 mb-1">Quantité *</label>
                            <input type="number" name="quantity" id="sales-quantity-input" value="1" min="1" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500" />
                        </div>
                        
                        <!-- Nouveau champ : Montant total -->
                        <div class="col-span-1">
                            <label for="sales-total-amount" class="block text-sm font-medium text-gray-700 mb-1">Montant total</label>
                            <input type="text" id="sales-total-amount" value="0 FCFA" class="w-full border-gray-300 rounded-lg shadow-sm bg-gray-100 focus:ring-0 focus:border-gray-300" readonly />
                        </div>
                        
                        <div class="col-span-1">
                            <label for="seller-name" class="block text-sm font-medium text-gray-700 mb-1">Vendeur *</label>
                            <input type="text" name="seller" id="seller-name" class="w-full border-gray-300 rounded-lg shadow-sm bg-gray-100 focus:ring-0 focus:border-gray-300" readonly />
                        </div>

                        <div class="col-span-2">
                            <label for="sales-comment" class="block text-sm font-medium text-gray-700 mb-1">Commentaire (optionnel)</label>
                            <textarea name="comment" id="sales-comment" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500"></textarea>
                        </div>
                        
                        <p id="sales-error" class="text-red-500 text-sm mt-2 hidden col-span-2"></p>
                        
                        <div class="col-span-2">
                            <button type="submit" id="sales-submit-button" class="inline-flex items-center px-4 py-2 bg-cyan-400 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-500 transition-colors">
                                + Enregistrer la vente
                            </button>
                        </div>
                    </form>
                </div>
                <div class="mt-10 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800">Historique des ventes</h2>
                    <p class="text-sm text-gray-500 mt-1">Liste de toutes les transactions enregistrées.</p>
                    
                    <!-- Conteneur pour l'historique des ventes -->
                    <div id="sales-history-container" class="mt-6">
                        <!-- Message si vide -->
                        <div id="sales-history-placeholder" class="flex flex-col items-center justify-center text-center text-gray-500 h-32">
                            <p>Aucune vente enregistrée</p>
                        </div>
                        <!-- Tableau si non vide -->
                        <div id="sales-history-table-container" class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendeur</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qté</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commentaire</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-history-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de ventes insérées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Stock Boutique -->
            <div id="page-Stock-Boutique" class="page-content p-4 md:p-8 hidden">
                <h1 class="text-3xl font-bold text-gray-800">Stock de la Boutique</h1>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="relative flex-grow">
                            <!-- ID AJOUTÉ ICI -->
                            <input type="text" id="shop-search-input" placeholder="Rechercher par nom ou description..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500" />
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button id="open-restock-modal-button" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-50 transition-colors flex items-center gap-2">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 20v-5h-5" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 9a9 9 0 0114.13-6.364M20 15a9 9 0 01-14.13 6.364" />
                                </svg>
                                Réapprovisionner
                            </button>
                            <button id="open-transfer-modal-button" class="px-4 py-2 bg-cyan-400 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-500 transition-colors flex items-center gap-2">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Transférer depuis Magasin
                            </button>
                        </div>
                    </div>
                    <!-- Conteneur pour la liste des produits de la boutique -->
                    <div id="shop-stock-container" class="mt-6">
                        <!-- Message si vide (visible par défaut) -->
                        <div id="shop-stock-placeholder" class="flex flex-col items-center justify-center text-center text-gray-500 h-40">
                            <p>Aucun article en inventaire.</p>
                        </div>
                        <!-- Tableau si non vide (caché par défaut) -->
                        <div id="shop-stock-table-container" class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prix de Vente</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Seuil d'alerte</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="shop-stock-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de produits insérées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="mt-10 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800">Mouvements du Stock Boutique</h2>
                    <p class="text-sm text-gray-500 mt-1">Historique de tous les ajouts et réapprovisionnements de stock.</p>
                     <!-- Conteneur pour les mouvements de la boutique -->
                    <div id="shop-movements-container" class="mt-6">
                        <!-- Message si vide (visible par défaut) -->
                        <div id="shop-movements-placeholder" class="flex flex-col items-center justify-center text-center text-gray-500 h-32">
                            <p>Aucun mouvement de stock enregistré.</p>
                        </div>
                        <!-- Tableau si non vide (caché par défaut) -->
                        <div id="shop-movements-table-container" class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> <!-- AJOUTÉ -->
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qte Changée</th> <!-- Renommé -->
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changement</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commentaire</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Utilisateur</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="shop-movements-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de mouvements insérées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Mon Magasin -->
            <div id="page-Mon-Magasin" class="page-content p-4 md:p-8 hidden">
                <h1 class="text-3xl font-bold text-gray-800">Gestion du Magasin</h1>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="relative flex-grow">
                             <!-- ID AJOUTÉ ICI -->
                            <input type="text" id="store-search-input" placeholder="Rechercher par nom ou description..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500" />
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button id="open-entry-modal-button" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-50 transition-colors flex items-center gap-2">Entrée</button>
                            <button id="open-exit-modal-button" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-50 transition-colors flex items-center gap-2">Sortie</button>
                            <!-- ID ajouté au bouton "Nouveau Produit" -->
                            <button id="open-new-product-modal-button" class="px-4 py-2 bg-cyan-400 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-500 transition-colors flex items-center gap-2">
                                + Nouveau Produit
                            </button>
                        </div>
                    </div>
                    
                    <!-- Conteneur pour la liste des produits du magasin -->
                    <div id="store-products-container" class="mt-6">
                        <!-- Message si vide (visible par défaut) -->
                        <div id="store-products-placeholder" class="flex flex-col items-center justify-center text-center text-gray-500 h-40">
                            <p>Aucun article dans le magasin.</p>
                        </div>
                        <!-- Tableau si non vide (caché par défaut) -->
                        <div id="store-products-table-container" class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Coût d'achat</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="store-products-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de produits insérées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
                <div class="mt-10 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800">Mouvements du Magasin</h2>
                    <p class="text-sm text-gray-500 mt-1">Historique de toutes les entrées et sorties du magasin.</p>

                    <!-- Conteneur pour les mouvements du magasin -->
                    <div id="store-movements-container" class="mt-6">
                        <!-- Message si vide (visible par défaut) -->
                        <div id="store-movements-placeholder" class="flex flex-col items-center justify-center text-center text-gray-500 h-32">
                            <p>Aucun mouvement enregistré.</p>
                        </div>
                        <!-- Tableau si non vide (caché par défaut) -->
                        <div id="store-movements-table-container" class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changement Stock</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commentaire</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="store-movements-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de mouvements insérées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Statistiques -->
            <div id="page-Statistiques" class="page-content p-4 md:p-8 hidden">
                <h1 class="text-3xl font-bold text-gray-800">Statistiques</h1>
                <p class="text-gray-500 mt-1">Analysez vos performances commerciales</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Ventes totales</p>
                            <p id="stat-total-sales" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                            <p class="text-xs text-gray-400 mt-2">+0% par rapport au mois dernier</p>
                        </div>
                        <div class="p-3 rounded-lg bg-blue-100">
                            <div data-icon="sales" class="w-6 h-6 text-blue-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Revenus</p>
                            <p id="stat-revenue" class="text-2xl font-bold text-gray-800 mt-1">0 FCFA</p>
                            <p class="text-xs text-gray-400 mt-2">+0% par rapport au mois dernier</p>
                        </div>
                        <div class="p-3 rounded-lg bg-indigo-100">
                            <div data-icon="stats" class="w-6 h-6 text-indigo-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Produits en stock</p>
                            <p id="stat-products-in-stock" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                            <p class="text-xs text-gray-400 mt-2">Dans la boutique</p>
                        </div>
                        <div class="p-3 rounded-lg bg-green-100">
                            <div data-icon="box" class="w-6 h-6 text-green-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Marge moyenne</p>
                            <p id="stat-avg-margin" class="text-2xl font-bold text-gray-800 mt-1">0%</p>
                            <p class="text-xs text-gray-400 mt-2">Sur tous les produits</p>
                        </div>
                        <div class="p-3 rounded-lg bg-purple-100">
                            <div data-icon="chartBar" class="w-6 h-6 text-purple-500"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-10 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800">Graphiques et analyses</h2>
                    <div class="mt-6 flex flex-col items-center justify-center text-center text-gray-500 h-64">
                        <div data-icon="stats" class="w-16 h-16 text-gray-300 mb-4"></div>
                        <p>Les graphiques détaillés seront disponibles prochainement</p>
                    </div>
                </div>
            </div>

            <!-- Page: Paramètres -->
            <div id="page-Paramètres" class="page-content p-4 md:p-8 hidden">
                <h1 class="text-3xl font-bold">Paramètres</h1>
                <p class="text-gray-500 mt-1">Gérez les paramètres de votre compte et de l'application.</p>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <p>Les options de paramètres seront bientôt disponibles ici.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- 
      MODAL "AJOUTER UN NOUVEAU PRODUIT"
    -->
    <div id="new-product-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <!-- En-tête -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Ajouter un nouveau produit au magasin</h2>
                <button id="close-new-product-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- Formulaire -->
            <form id="new-product-form">
                <div class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700">Nom du Produit *</label>
                        <input type="text" id="product-name" placeholder="ex: Écran 27 pouces" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                    </div>
                    <div>
                        <label for="product-description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="product-description" placeholder="Une courte description du produit" rows="3" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="product-cost" class="block text-sm font-medium text-gray-700">Coût d'Achat *</label>
                            <input type="number" id="product-cost" placeholder="0" value="0" min="0" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                        </div>
                        <div>
                            <label for="product-currency" class="block text-sm font-medium text-gray-700">Devise *</label>
                            <input type="text" id="product-currency" placeholder="EUR" value="EUR" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                        </div>
                    </div>
                    <div>
                        <label for="product-quantity" class="block text-sm font-medium text-gray-700">Quantité Initiale *</label>
                        <input type="number" id="product-quantity" placeholder="0" value="0" min="0" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                    </div>
                    <p id="new-product-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="new-product-submit-button" class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Ajouter le produit
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 
      MODAL "ENREGISTRER UNE ENTRÉE"
    -->
    <div id="entry-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Enregistrer une entrée</h2>
                <button id="close-entry-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="entry-form">
                <div class="space-y-4">
                    <div>
                        <label for="entry-product-select" class="block text-sm font-medium text-gray-700">Produit *</label>
                        <select id="entry-product-select" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                            <option value="">Sélectionnez un produit</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>
                    <div>
                        <label for="entry-quantity" class="block text-sm font-medium text-gray-700">Quantité *</label>
                        <input type="number" id="entry-quantity" placeholder="0" min="1" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                    </div>
                    <div>
                        <label for="entry-comment" class="block text-sm font-medium text-gray-700">Commentaire (Optionnel)</label>
                        <textarea id="entry-comment" placeholder="ex: Arrivage fournisseur..." rows="3" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"></textarea>
                    </div>
                    <p id="entry-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="entry-submit-button" class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Enregistrer l'entrée
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 
      MODAL "ENREGISTRER UNE SORTIE"
    -->
    <div id="exit-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Enregistrer une sortie</h2>
                <button id="close-exit-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="exit-form">
                <div class="space-y-4">
                    <div>
                        <label for="exit-product-select" class="block text-sm font-medium text-gray-700">Produit *</label>
                        <select id="exit-product-select" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                            <option value="">Sélectionnez un produit</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>
                    <div>
                        <label for="exit-quantity" class="block text-sm font-medium text-gray-700">Quantité *</label>
                        <input type="number" id="exit-quantity" placeholder="0" min="1" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                    </div>
                    <div>
                        <label for="exit-comment" class="block text-sm font-medium text-gray-700">Commentaire (Optionnel)</label>
                        <textarea id="exit-comment" placeholder="ex: Transfert vers boutique..." rows="3" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"></textarea>
                    </div>
                    <p id="exit-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="exit-submit-button" class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Enregistrer la sortie
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 
      MODAL "TRANSFÉRER UN ARTICLE DEPUIS LE MAGASIN"
    -->
    <div id="transfer-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Transférer un article depuis le Magasin</h2>
                <button id="close-transfer-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="transfer-form">
                <div class="space-y-4">
                    <div>
                        <label for="transfer-product-select" class="block text-sm font-medium text-gray-700">Article Source (depuis le Magasin) *</label>
                        <select id="transfer-product-select" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                            <option value="">Sélectionnez un article à transférer...</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>
                    
                    <div id="transfer-source-info" class="hidden">
                        <h4 class="text-sm font-medium text-gray-700">Informations de l'article source</h4>
                        <p class="mt-1 p-3 bg-gray-100 rounded-lg text-sm text-gray-600">
                            Coût d'achat: <span id="transfer-cost-display" class="font-semibold">0 CFA</span>
                        </p>
                    </div>

                    <div>
                        <label for="transfer-selling-price" class="block text-sm font-medium text-gray-700">Prix de Vente (pour la Boutique) *</label>
                        <input type="number" id="transfer-selling-price" placeholder="110000" min="0" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="transfer-quantity" class="block text-sm font-medium text-gray-700">Stock à Transférer *</label>
                            <input type="number" id="transfer-quantity" placeholder="1" min="1" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                        </div>
                        <div>
                            <label for="transfer-alert-threshold" class="block text-sm font-medium text-gray-700">Seuil d'alerte</label>
                            <input type="number" id="transfer-alert-threshold" placeholder="10" value="10" min="0" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400">
                        </div>
                    </div>
                    
                    <div id="transfer-stock-warning" class="hidden flex items-center p-3 bg-yellow-100 border border-yellow-200 rounded-lg">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <p class="text-sm text-yellow-700">Cette valeur doit être inférieure ou égale à X.</p>
                    </div>
                    
                    <p class="text-xs text-gray-500">
                        Si un article de boutique lié à cette source existe déjà, le stock sera fusionné. Sinon, un nouvel article sera créé.
                    </p>
                    
                    <p id="transfer-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="transfer-submit-button" class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Transférer et Créer/Mettre à jour l'article
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      MODAL "RÉAPPROVISIONNER UN ARTICLE"
    -->
    <div id="restock-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Réapprovisionner un article</h2>
                <button id="close-restock-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="restock-form">
                <div class="space-y-4">
                    <div>
                        <label for="restock-product-select" class="block text-sm font-medium text-gray-700">Produit de la Boutique *</label>
                        <select id="restock-product-select" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                            <option value="">Sélectionnez un produit à réapprovisionner</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>

                    <div id="restock-source-info" class="hidden">
                        <h4 class="text-sm font-medium text-gray-700">Article Source</h4>
                        <p class="mt-1 p-3 bg-gray-100 rounded-lg text-sm text-gray-600">
                            <span id="restock-source-name" class="font-semibold"></span>
                            (Stock magasin disponible: <span id="restock-source-stock" class="font-semibold">0</span>)
                        </p>
                    </div>

                    <div>
                        <label for="restock-quantity" class="block text-sm font-medium text-gray-700">Quantité à Ajouter (depuis le Magasin) *</label>
                        <input type="number" id="restock-quantity" placeholder="1" min="1" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" required>
                    </div>

                    <div id="restock-stock-warning" class="hidden flex items-center p-3 bg-yellow-100 border border-yellow-200 rounded-lg">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <p class="text-sm text-yellow-700">Cette valeur doit être inférieure ou égale à X.</p>
                    </div>
                    
                    <div>
                        <label for="restock-comment" class="block text-sm font-medium text-gray-700">Commentaire (Optionnel)</label>
                        <textarea id="restock-comment" placeholder="ex: Réapprovisionnement hebdomadaire" rows="3" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"></textarea>
                    </div>
                    <p id="restock-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="restock-submit-button" class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Confirmer le réapprovisionnement
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 
      TOAST DE SUCCÈS GLOBAL
    -->
    <div id="success-toast" class="fixed bottom-5 right-5 z-50">
        <div class="flex items-center bg-green-500 text-white text-sm font-medium px-4 py-3 rounded-lg shadow-lg">
            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span id="success-toast-message">Opération réussie!</span>
        </div>
    </div>


    <script type="module">
        // --- SDK Firebase ---
        // Importer les fonctions nécessaires des SDK Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            set,
            push,
            onValue,
            off,
            update,
            query,
            orderByChild,
            equalTo,
            get
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- GESTION DES ICÔNES SVG ---
        
        /**
         * Renvoie le code SVG pour une icône donnée.
         * @param {string} name - Le nom de l'icône.
         * @returns {string} - La chaîne de caractères SVG.
         */
        function getIconSVG(name) {
            const icons = {
                logo: `
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L4 6.5V17.5L12 22L20 17.5V6.5L12 2ZM11 15.5V10.5H13V15.5H11ZM11.5 8.5C10.67 8.5 10 7.83 10 7C10 6.17 10.67 5.5 11.5 5.5C12.33 5.5 13 6.17 13 7C13 7.83 12.33 8.5 11.5 8.5Z" />
                    </svg>`,
                dashboard: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>`,
                sales: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>`,
                box: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>`,
                stats: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>`,
                settings: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>`,
                logout: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>`,
                chartBar: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-4m3 4v-2m3 2v-6m3 2V7" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 20h14" />
                    </svg>`,
                trash: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>`,
                arrowUp: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                    </svg>`,
                arrowDown: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>`,
                menu: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>`,
                arrowLeft: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>`,
                arrowRight: `
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>`
            };
            return icons[name] || '';
        }

        /**
         * Remplace tous les placeholders d'icônes [data-icon] par le SVG réel.
         */
        function renderIcons() {
            document.querySelectorAll('[data-icon]').forEach(element => {
                const iconName = element.getAttribute('data-icon');
                const svgString = getIconSVG(iconName);
                if (svgString) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = svgString.trim();
                    const svgElement = tempDiv.firstChild;
                    
                    if (svgElement) {
                        const placeholderClasses = element.getAttribute('class') || '';
                        svgElement.setAttribute('class', placeholderClasses);
                        element.replaceWith(svgElement);
                    } else {
                        console.error("Impossible de créer l'élément SVG pour l'icône:", iconName);
                    }
                }
            });
        }
        
        try {
            renderIcons();
        } catch (e) {
            console.error("Erreur critique lors du rendu des icônes:", e);
        }

        // --- GESTION DE L'APPLICATION ---

        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration et initialisation de Firebase ---
            const firebaseConfig = {
                apiKey: "AIzaSyB65Iye8YMpxXsPthdBYmNojBMpaTPZS3A",
                authDomain: "gestion-stock-c9484.firebaseapp.com",
                databaseURL: "https://gestion-stock-c9484-default-rtdb.firebaseio.com",
                projectId: "gestion-stock-c9484",
                storageBucket: "gestion-stock-c9484.firebasestorage.app",
                messagingSenderId: "834033352449",
                appId: "1:834033352449:web:b86ff5b60c816bb469e500",
                measurementId: "G-5VKP3S88F8"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getDatabase(app);

            // État de l'application
            let isAuthenticated = false;
            let currentPage = 'Tableau de bord';
            let isLoginView = true;
            let currentUser = null;
            let currentUserData = null;
            let allStoreProducts = {};
            let allShopStock = {};
            let isSidebarOpen = false; // Pour la visibilité sur mobile
            let isSidebarCollapsed = false; // Pour l'état réduit sur desktop

            let storeProductsListener = null, storeMovementsListener = null, shopStockListener = null, shopMovementsListener = null, salesHistoryListener = null;
            let storeProductsRef = null, storeMovementsRef = null, shopStockRef = null, shopMovementsRef = null, salesHistoryRef = null;

            // Références DOM
            const authPageContainer = document.getElementById('auth-page-container');
            const layoutContainer = document.getElementById('layout-container');
            const logoutButton = document.getElementById('logout-button');
            const navButtons = document.querySelectorAll('.nav-button');
            const pageContents = document.querySelectorAll('.page-content');
            const authToggleLogin = document.getElementById('auth-toggle-login');
            const authToggleSignup = document.getElementById('auth-toggle-signup');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const userEmailDisplay = document.getElementById('user-email-display');
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error');
            const loginSubmitButton = document.getElementById('login-submit-button');
            const signupSubmitButton = document.getElementById('signup-submit-button');
            
            // Sidebar responsive
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('main');
            const mobileHeader = document.getElementById('mobile-header');
            const mobilePageTitle = document.getElementById('mobile-page-title');
            const hamburgerButton = document.getElementById('hamburger-button');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebarCollapseToggle = document.getElementById('sidebar-collapse-toggle');

            // Barres de recherche
            const storeSearchInput = document.getElementById('store-search-input');
            const shopSearchInput = document.getElementById('shop-search-input');

            // Références DOM pour "Mon Magasin"
            const storeProductsPlaceholder = document.getElementById('store-products-placeholder');
            const storeProductsTableContainer = document.getElementById('store-products-table-container');
            const storeProductsTbody = document.getElementById('store-products-tbody');
            const storeMovementsPlaceholder = document.getElementById('store-movements-placeholder');
            const storeMovementsTableContainer = document.getElementById('store-movements-table-container');
            const storeMovementsTbody = document.getElementById('store-movements-tbody');
            
            // Références DOM pour "Stock Boutique"
            const shopStockPlaceholder = document.getElementById('shop-stock-placeholder');
            const shopStockTableContainer = document.getElementById('shop-stock-table-container');
            const shopStockTbody = document.getElementById('shop-stock-tbody');
            const shopMovementsPlaceholder = document.getElementById('shop-movements-placeholder');
            const shopMovementsTableContainer = document.getElementById('shop-movements-table-container');
            const shopMovementsTbody = document.getElementById('shop-movements-tbody');

            // Références DOM pour "Ventes"
            const salesForm = document.getElementById('sales-form');
            const salesProductSelect = document.getElementById('sales-product-select');
            const salesQuantityInput = document.getElementById('sales-quantity-input');
            const salesTotalAmount = document.getElementById('sales-total-amount');
            const sellerNameInput = document.getElementById('seller-name');
            const salesComment = document.getElementById('sales-comment');
            const salesError = document.getElementById('sales-error');
            const salesSubmitButton = document.getElementById('sales-submit-button');
            const salesHistoryPlaceholder = document.getElementById('sales-history-placeholder');
            const salesHistoryTableContainer = document.getElementById('sales-history-table-container');
            const salesHistoryTbody = document.getElementById('sales-history-tbody');

            // Références DOM pour le modal "Nouveau Produit"
            const openNewProductModalButton = document.getElementById('open-new-product-modal-button');
            const newProductModal = document.getElementById('new-product-modal');
            const closeNewProductModalButton = document.getElementById('close-new-product-modal-button');
            const newProductForm = document.getElementById('new-product-form');
            const newProductError = document.getElementById('new-product-error');
            const newProductSubmitButton = document.getElementById('new-product-submit-button');

            // Références DOM pour le modal "Entrée"
            const openEntryModalButton = document.getElementById('open-entry-modal-button');
            const entryModal = document.getElementById('entry-modal');
            const closeEntryModalButton = document.getElementById('close-entry-modal-button');
            const entryForm = document.getElementById('entry-form');
            const entryProductSelect = document.getElementById('entry-product-select');
            const entryError = document.getElementById('entry-error');
            const entrySubmitButton = document.getElementById('entry-submit-button');
            
            // Références DOM pour le modal "Sortie"
            const openExitModalButton = document.getElementById('open-exit-modal-button');
            const exitModal = document.getElementById('exit-modal');
            const closeExitModalButton = document.getElementById('close-exit-modal-button');
            const exitForm = document.getElementById('exit-form');
            const exitProductSelect = document.getElementById('exit-product-select');
            const exitError = document.getElementById('exit-error');
            const exitSubmitButton = document.getElementById('exit-submit-button');
            
            // Références DOM pour le modal "Transférer"
            const openTransferModalButton = document.getElementById('open-transfer-modal-button');
            const transferModal = document.getElementById('transfer-modal');
            const closeTransferModalButton = document.getElementById('close-transfer-modal-button');
            const transferForm = document.getElementById('transfer-form');
            const transferProductSelect = document.getElementById('transfer-product-select');
            const transferSourceInfo = document.getElementById('transfer-source-info');
            const transferCostDisplay = document.getElementById('transfer-cost-display');
            const transferStockWarning = document.getElementById('transfer-stock-warning');
            const transferError = document.getElementById('transfer-error');
            const transferSubmitButton = document.getElementById('transfer-submit-button');

            // Références DOM pour le modal "Réapprovisionner"
            const openRestockModalButton = document.getElementById('open-restock-modal-button');
            const restockModal = document.getElementById('restock-modal');
            const closeRestockModalButton = document.getElementById('close-restock-modal-button');
            const restockForm = document.getElementById('restock-form');
            const restockProductSelect = document.getElementById('restock-product-select');
            const restockSourceInfo = document.getElementById('restock-source-info');
            const restockSourceName = document.getElementById('restock-source-name');
            const restockSourceStock = document.getElementById('restock-source-stock');
            const restockStockWarning = document.getElementById('restock-stock-warning');
            const restockError = document.getElementById('restock-error');
            const restockSubmitButton = document.getElementById('restock-submit-button');
            
            // Références DOM pour le Toast de Succès
            const successToast = document.getElementById('success-toast');
            const successToastMessage = document.getElementById('success-toast-message');

            /**
             * Affiche un toast de succès avec un message.
             * @param {string} message - Le message à afficher.
             */
            function showSuccessToast(message) {
                if (successToastMessage) {
                    successToastMessage.textContent = message;
                }
                if (successToast) {
                    successToast.classList.add('show');
                    setTimeout(() => {
                        successToast.classList.remove('show');
                    }, 3000); // Cacher après 3 secondes
                }
            }

            /**
             * Formate un nombre en devise.
             * @param {number} value - La valeur numérique.
             * @param {string} currency - Le code de la devise (ex: "CFA", "EUR").
             * @returns {string} - La chaîne formatée.
             */
            function formatCurrency(value, currency) {
                if(isNaN(value)) value = 0;
                // Essayer de deviner la devise du produit source si non fournie
                const displayCurrency = (currency || 'CFA').toUpperCase() === 'CFA' ? 'XOF' : currency;
                try {
                    return new Intl.NumberFormat('fr-FR', { 
                        style: 'currency', 
                        currency: displayCurrency, 
                        minimumFractionDigits: 0 
                    }).format(value);
                } catch (e) {
                    // Fallback sur CFA/XOF si la devise n'est pas reconnue
                     return new Intl.NumberFormat('fr-FR', { 
                        style: 'currency', 
                        currency: 'XOF', 
                        minimumFractionDigits: 0 
                    }).format(value);
                }
            }
            
            /**
             * Formate une date ISO en format lisible.
             * @param {string} isoString - La date en format ISO.
             * @returns {string} - La date formatée.
             */
            function formatDateForDisplay(isoString) {
                const date = new Date(isoString);
                // Format: "11 nov. 2025, 22:35"
                return date.toLocaleString('fr-FR', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(' à', ',');
            }


            /**
             * Remplit les listes de sélection de produits du Magasin.
             * @param {object | null} products - L'objet des produits ou null.
             */
            function populateStoreProductSelects(products) {
                const selects = [entryProductSelect, exitProductSelect, transferProductSelect];
                selects.forEach(select => {
                    if (!select) return;
                    // Garder la première option ("Sélectionnez un produit")
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption.cloneNode(true)); // Utiliser cloneNode pour la sécurité
                    
                    if (products) {
                        Object.values(products).forEach(product => {
                            const option = document.createElement('option');
                            option.value = product.id;
                            option.textContent = `${product.name} (Actuellement : ${product.quantityInStore})`;
                            select.appendChild(option);
                        });
                    }
                });
            }
            
            /**
             * Remplit les listes de sélection des produits de la Boutique.
             * @param {object | null} products - L'objet des produits ou null.
             */
            function populateShopProductSelects(products) {
                const selects = [restockProductSelect, salesProductSelect]; // MAJ : inclut salesProductSelect
                selects.forEach(select => {
                    if (!select) return;
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption.cloneNode(true));
                    
                    if (products) {
                        Object.values(products).forEach(product => {
                            const option = document.createElement('option');
                            option.value = product.id;
                            // Personnaliser le texte en fonction du sélecteur
                            if (select.id === 'restock-product-select') {
                                option.textContent = `${product.name} (Actuellement : ${product.quantityInShop})`;
                            } else {
                                // Pour le sélecteur des ventes
                                option.textContent = `${product.name} (Stock: ${product.quantityInShop})`;
                            }
                            select.appendChild(option);
                        });
                    }
                });
            }

            /**
             * Affiche les produits du magasin dans le tableau.
             * @param {string} [searchTerm=''] - Terme de recherche optionnel.
             */
            function renderStoreProducts(searchTerm = '') {
                const products = allStoreProducts;
                const normalizedSearch = searchTerm.toLowerCase();
                
                const filteredProducts = Object.values(products).filter(product => {
                    const nameMatch = product.name?.toLowerCase().includes(normalizedSearch);
                    const descMatch = product.description?.toLowerCase().includes(normalizedSearch);
                    return nameMatch || descMatch;
                });

                if (filteredProducts.length > 0) {
                    storeProductsPlaceholder.classList.add('hidden');
                    storeProductsTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedProducts = filteredProducts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    sortedProducts.forEach(product => {
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="p-2 bg-gray-100 rounded-lg mr-3">
                                            <svg class="w-5 h-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                                        </div>
                                        <span class="text-sm font-medium text-gray-900">${product.name}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.description || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-700">${product.quantityInStore}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(product.purchaseCost, product.currency)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button class="delete-icon text-gray-400 hover:text-red-500" data-product-id="${product.id}">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    storeProductsTbody.innerHTML = html;
                } else {
                    storeProductsTableContainer.classList.add('hidden');
                    storeProductsPlaceholder.classList.remove('hidden');
                    if (searchTerm) {
                        storeProductsPlaceholder.textContent = 'Aucun résultat trouvé.';
                    } else {
                        storeProductsPlaceholder.textContent = 'Aucun article dans le magasin.';
                    }
                    storeProductsTbody.innerHTML = '';
                }
            }

            /**
             * Affiche les mouvements du magasin dans le tableau.
             * @param {DataSnapshot} snapshot - Le snapshot Firebase.
             */
            function onStoreMovementsValue(snapshot) {
                const movements = snapshot.val();
                if (movements) {
                    storeMovementsPlaceholder.classList.add('hidden');
                    storeMovementsTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedMovements = Object.values(movements).sort((a, b) => new Date(b.date) - new Date(a.date));

                    sortedMovements.forEach(move => {
                        const isEntry = move.type === 'Entrée';
                        const arrowIcon = isEntry ? getIconSVG('arrowUp') : getIconSVG('arrowDown');
                        
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${move.productName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span class="flex items-center ${isEntry ? 'text-green-600' : 'text-red-600'}">
                                        <span class="w-4 h-4 mr-1.5">${arrowIcon.replace('class="w-6 h-6"', '')}</span>
                                        ${move.type}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${isEntry ? 'text-green-600' : 'text-red-600'}">${isEntry ? '+' : '-'}${move.quantityChange}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span class="flex items-center">
                                        <span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-md">${move.oldStock}</span>
                                        <svg class="w-4 h-4 mx-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7-7 7" /></svg>
                                        <span class="px-2 py-0.5 ${isEntry ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} rounded-md">${move.newStock}</span>
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.comment}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(move.date)}</td>
                            </tr>
                        `;
                    });
                    storeMovementsTbody.innerHTML = html;
                } else {
                    storeMovementsPlaceholder.classList.remove('hidden');
                    storeMovementsTableContainer.classList.add('hidden');
                    storeMovementsTbody.innerHTML = '';
                }
            }
            
            /**
             * Met à jour le cache local et déclenche le rendu du stock magasin.
             * @param {DataSnapshot} snapshot 
             */
            function onStoreProductsValue(snapshot) {
                allStoreProducts = snapshot.val() || {};
                populateStoreProductSelects(allStoreProducts);
                const searchTerm = storeSearchInput ? storeSearchInput.value : '';
                renderStoreProducts(searchTerm);
            }

            /**
             * Affiche le stock de la boutique dans le tableau.
             * @param {string} [searchTerm=''] - Terme de recherche optionnel.
             */
            function renderShopStock(searchTerm = '') {
                const stock = allShopStock;
                const normalizedSearch = searchTerm.toLowerCase();

                const filteredStock = Object.values(stock).filter(item => {
                    const nameMatch = item.name?.toLowerCase().includes(normalizedSearch);
                    return nameMatch;
                });

                if (filteredStock.length > 0) {
                    shopStockPlaceholder.classList.add('hidden');
                    shopStockTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedStock = filteredStock.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    sortedStock.forEach(item => {
                        const isLowStock = item.quantityInShop <= item.alertThreshold;
                        const currency = allStoreProducts[item.sourceProductId]?.currency || 'CFA';
                        html += `
                            <tr class="hover:bg-gray-50 ${isLowStock ? 'bg-red-50' : ''}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="p-2 bg-gray-100 rounded-lg mr-3">
                                            <svg class="w-5 h-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                                        </div>
                                        <span class="text-sm font-medium text-gray-900">${item.name}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${isLowStock ? 'text-red-600' : 'text-gray-700'}">${item.quantityInShop}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(item.sellingPrice, currency)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.alertThreshold}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button class="delete-icon text-gray-400 hover:text-red-500" data-stock-id="${item.id}">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    shopStockTbody.innerHTML = html;
                } else {
                    shopStockTableContainer.classList.add('hidden');
                    shopStockPlaceholder.classList.remove('hidden');
                    if (searchTerm) {
                        shopStockPlaceholder.textContent = 'Aucun résultat trouvé.';
                    } else {
                        shopStockPlaceholder.textContent = 'Aucun article en inventaire.';
                    }
                    shopStockTbody.innerHTML = '';
                }
            }
            
            /**
             * Met à jour le cache local et déclenche le rendu du stock boutique.
             * @param {DataSnapshot} snapshot 
             */
            function onShopStockValue(snapshot) {
                allShopStock = snapshot.val() || {};
                populateShopProductSelects(allShopStock); // MAJ
                const searchTerm = shopSearchInput ? shopSearchInput.value : '';
                renderShopStock(searchTerm);
            }

            /**
             * Affiche les mouvements de la boutique dans le tableau.
             * @param {DataSnapshot} snapshot - Le snapshot Firebase.
             */
            function onShopMovementsValue(snapshot) {
                const movements = snapshot.val();
                if (movements) {
                    shopMovementsPlaceholder.classList.add('hidden');
                    shopMovementsTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedMovements = Object.values(movements).sort((a, b) => new Date(b.date) - new Date(a.date));

                    sortedMovements.forEach(move => {
                        const isEntry = move.type === 'Entrée';
                        const arrowIcon = isEntry ? getIconSVG('arrowUp') : getIconSVG('arrowDown');
                        const qteClass = isEntry ? 'text-green-600' : 'text-red-600';
                        const qtePrefix = isEntry ? '+' : '-';
                        const stockClass = isEntry ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';

                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${move.productName}</td>
                                <!-- Colonne Type -->
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span class="flex items-center ${qteClass}">
                                        <span class="w-4 h-4 mr-1.5">${arrowIcon.replace('class="w-6 h-6"', '')}</span>
                                        ${move.type}
                                    </span>
                                </td>
                                <!-- Colonne Qte Changée -->
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${qteClass}">${qtePrefix}${move.quantityChange}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span class="flex items-center">
                                        <span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-md">${move.oldStock}</span>
                                        <svg class="w-4 h-4 mx-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7-7 7" /></svg>
                                        <span class="px-2 py-0.5 ${stockClass} rounded-md">${move.newStock}</span>
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.comment}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.userEmail.split('@')[0]}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(move.date)}</td>
                            </tr>
                        `;
                    });
                    shopMovementsTbody.innerHTML = html;
                } else {
                    shopMovementsPlaceholder.classList.remove('hidden');
                    shopMovementsTableContainer.classList.add('hidden');
                    shopMovementsTbody.innerHTML = '';
                }
            }

            /**
             * Affiche l'historique des ventes dans le tableau.
             * @param {DataSnapshot} snapshot - Le snapshot Firebase.
             */
            function onSalesHistoryValue(snapshot) {
                const sales = snapshot.val();
                if (sales) {
                    salesHistoryPlaceholder.classList.add('hidden');
                    salesHistoryTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedSales = Object.values(sales).sort((a, b) => new Date(b.date) - new Date(a.date));

                    sortedSales.forEach(sale => {
                        const currency = allStoreProducts[allShopStock[sale.shopProductId]?.sourceProductId]?.currency || 'CFA';
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.productName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.sellerName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.quantity}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-700">${formatCurrency(sale.totalAmount, currency)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.comment}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(sale.date)}</td>
                            </tr>
                        `;
                    });
                    salesHistoryTbody.innerHTML = html;
                } else {
                    salesHistoryPlaceholder.classList.remove('hidden');
                    salesHistoryTableContainer.classList.add('hidden');
                    salesHistoryTbody.innerHTML = '';
                }
            }

            /**
             * Met en place les écouteurs Firebase pour les données de l'utilisateur.
             * @param {string} uid - L'ID de l'utilisateur.
             */
            function setupFirebaseListeners(uid) {
                cleanupFirebaseListeners();
                
                // Magasin
                storeProductsRef = ref(db, `users/${uid}/storeProducts`);
                storeProductsListener = onValue(storeProductsRef, onStoreProductsValue);
                storeMovementsRef = ref(db, `users/${uid}/storeMovements`);
                storeMovementsListener = onValue(storeMovementsRef, onStoreMovementsValue);
                
                // Boutique
                shopStockRef = ref(db, `users/${uid}/shopStock`);
                shopStockListener = onValue(shopStockRef, onShopStockValue);
                shopMovementsRef = ref(db, `users/${uid}/shopMovements`);
                shopMovementsListener = onValue(shopMovementsRef, onShopMovementsValue);

                // Ventes
                salesHistoryRef = ref(db, `users/${uid}/salesHistory`);
                salesHistoryListener = onValue(salesHistoryRef, onSalesHistoryValue);
            }

            /**
             * Nettoie (détache) tous les écouteurs Firebase actifs.
             */
            function cleanupFirebaseListeners() {
                if (storeProductsListener && storeProductsRef) off(storeProductsRef, storeProductsListener);
                if (storeMovementsListener && storeMovementsRef) off(storeMovementsRef, storeMovementsListener);
                if (shopStockListener && shopStockRef) off(shopStockRef, shopStockListener);
                if (shopMovementsListener && shopMovementsRef) off(shopMovementsRef, shopMovementsListener);
                if (salesHistoryListener && salesHistoryRef) off(salesHistoryRef, salesHistoryListener);
                
                storeProductsListener = null; storeMovementsListener = null; shopStockListener = null; shopMovementsListener = null; salesHistoryListener = null;
                storeProductsRef = null; storeMovementsRef = null; shopStockRef = null; shopMovementsRef = null; salesHistoryRef = null;

                allStoreProducts = {};
                allShopStock = {};
                populateStoreProductSelects(null);
                populateShopProductSelects(null); // MAJ
            }


            /**
             * Met à jour l'interface utilisateur en fonction de l'état actuel.
             */
            function updateUI() {
                // Gérer l'état d'authentification
                if (isAuthenticated) {
                    if (authPageContainer) authPageContainer.classList.add('hidden');
                    if (layoutContainer) layoutContainer.classList.remove('hidden');
                    if (currentUser && currentUser.email && userEmailDisplay) {
                        userEmailDisplay.textContent = currentUser.email; // Mettre à jour l'email
                    }
                     if (mobilePageTitle) {
                        mobilePageTitle.textContent = currentPage;
                    }
                } else {
                    if (authPageContainer) authPageContainer.classList.remove('hidden');
                    if (layoutContainer) layoutContainer.classList.add('hidden');
                    if (userEmailDisplay) userEmailDisplay.textContent = "Non connecté";
                    if (sellerNameInput) sellerNameInput.value = ''; // Vider le nom du vendeur
                    isLoginView = true;
                    updateAuthFormView();
                    
                    // Nettoyer les données de l'interface
                    if (storeProductsTbody) storeProductsTbody.innerHTML = '';
                    if (storeMovementsTbody) storeMovementsTbody.innerHTML = '';
                    if (shopStockTbody) shopStockTbody.innerHTML = '';
                    if (shopMovementsTbody) shopMovementsTbody.innerHTML = '';
                    if (salesHistoryTbody) salesHistoryTbody.innerHTML = '';
                    
                    [storeProductsPlaceholder, storeMovementsPlaceholder, shopStockPlaceholder, shopMovementsPlaceholder, salesHistoryPlaceholder].forEach(p => p && p.classList.remove('hidden'));
                    [storeProductsTableContainer, storeMovementsTableContainer, shopStockTableContainer, shopMovementsTableContainer, salesHistoryTableContainer].forEach(t => t && t.classList.add('hidden'));
                    
                    return; // Arrêter ici si non authentifié
                }

                // Gérer la navigation des pages
                pageContents.forEach(page => {
                    if (page.id === `page-${currentPage.replace(/ /g, '-')}`) {
                        page.classList.remove('hidden');
                    } else {
                        page.classList.add('hidden');
                    }
                });

                // Gérer l'état actif des boutons de la sidebar
                navButtons.forEach(button => {
                    if (button.dataset.page === currentPage) {
                        button.classList.add('bg-cyan-500', 'text-white', 'shadow');
                        button.classList.remove('text-gray-600', 'hover:bg-gray-100');
                    } else {
                        button.classList.remove('bg-cyan-500', 'text-white', 'shadow');
                        button.classList.add('text-gray-600', 'hover:bg-gray-100');
                    }
                });
            }

            /**
             * Met à jour la vue du formulaire d'authentification (Login / Signup).
             */
            function updateAuthFormView() {
                // Cacher les messages d'erreur lors du basculement
                if(loginError) loginError.classList.add('hidden');
                if(signupError) signupError.classList.add('hidden');

                if (isLoginView) {
                    if(loginForm) loginForm.classList.remove('hidden');
                    if(signupForm) signupForm.classList.add('hidden');
                    if(authToggleLogin) {
                        authToggleLogin.classList.add('bg-white', 'shadow', 'text-gray-800');
                        authToggleLogin.classList.remove('text-gray-500', 'hover:bg-gray-200');
                    }
                    if(authToggleSignup) {
                        authToggleSignup.classList.remove('bg-white', 'shadow', 'text-gray-800');
                        authToggleSignup.classList.add('text-gray-500', 'hover:bg-gray-200');
                    }
                } else {
                    if(loginForm) loginForm.classList.add('hidden');
                    if(signupForm) signupForm.classList.remove('hidden');
                    if(authToggleSignup) {
                        authToggleSignup.classList.add('bg-white', 'shadow', 'text-gray-800');
                        authToggleSignup.classList.remove('text-gray-500', 'hover:bg-gray-200');
                    }
                    if(authToggleLogin) {
                        authToggleLogin.classList.remove('bg-white', 'shadow', 'text-gray-800');
                        authToggleLogin.classList.add('text-gray-500', 'hover:bg-gray-200');
                    }
                }
            }
            
            /**
             * Calcule et met à jour le montant total sur le formulaire de vente.
             */
            function updateSalesTotal() {
                if (!salesProductSelect || !salesQuantityInput || !salesTotalAmount) return;

                const shopProductId = salesProductSelect.value;
                const quantity = parseInt(salesQuantityInput.value, 10);
                
                if (!shopProductId || isNaN(quantity) || quantity <= 0) {
                    salesTotalAmount.value = formatCurrency(0, 'CFA'); // Défaut
                    return;
                }
                
                const shopProduct = allShopStock[shopProductId];
                if (shopProduct) {
                    const total = shopProduct.sellingPrice * quantity;
                    const currency = allStoreProducts[shopProduct.sourceProductId]?.currency || 'CFA';
                    salesTotalAmount.value = formatCurrency(total, currency);
                }
            }

            /**
             * Gère l'affichage de la sidebar sur mobile.
             */
            function updateSidebarMobileState() {
                if (isSidebarOpen) {
                    sidebar.classList.remove('-translate-x-full');
                    sidebarOverlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                }
            }

            /**
             * Gère l'état réduit de la sidebar sur desktop.
             */
            function updateSidebarDesktopState() {
                const sidebarTexts = document.querySelectorAll('.sidebar-text');
                const navButtonsToCenter = document.querySelectorAll('.nav-button, #logout-button');
                const toggleButtonContainer = sidebarCollapseToggle.firstElementChild;

                if (isSidebarCollapsed) {
                    sidebar.classList.replace('w-64', 'lg:w-20');
                    mainContent.classList.replace('lg:ml-64', 'lg:ml-20');
                    sidebarTexts.forEach(el => el.classList.add('lg:hidden'));
                    navButtonsToCenter.forEach(el => el.classList.add('lg:justify-center'));
                    toggleButtonContainer.innerHTML = getIconSVG('arrowRight');
                    renderIcons(); // Re-render to apply classes to new SVG
                } else {
                    sidebar.classList.replace('lg:w-20', 'w-64');
                    mainContent.classList.replace('lg:ml-20', 'lg:ml-64');
                    sidebarTexts.forEach(el => el.classList.remove('lg:hidden'));
                    navButtonsToCenter.forEach(el => el.classList.remove('lg:justify-center'));
                    toggleButtonContainer.innerHTML = getIconSVG('arrowLeft');
                    renderIcons(); // Re-render to apply classes to new SVG
                }
            }


            // --- ÉCOUTEURS D'ÉVÉNEMENTS (AVEC VÉRIFICATIONS) ---

            // --- Sidebar Responsive Listeners ---
            if (hamburgerButton) hamburgerButton.addEventListener('click', () => {
                isSidebarOpen = true;
                updateSidebarMobileState();
            });
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', () => {
                isSidebarOpen = false;
                updateSidebarMobileState();
            });
            if (sidebarCollapseToggle) sidebarCollapseToggle.addEventListener('click', () => {
                isSidebarCollapsed = !isSidebarCollapsed;
                updateSidebarDesktopState();
            });

            // Bascule Login/Signup
            if(authToggleLogin) authToggleLogin.addEventListener('click', () => {
                isLoginView = true;
                updateAuthFormView();
            });

            if(authToggleSignup) authToggleSignup.addEventListener('click', () => {
                isLoginView = false;
                updateAuthFormView();
            });

            // --- Formulaire de Vente ---
            if(salesProductSelect) salesProductSelect.addEventListener('change', updateSalesTotal);
            if(salesQuantityInput) salesQuantityInput.addEventListener('input', updateSalesTotal);
            
            if(salesForm) salesForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                salesError.classList.add('hidden');
                if (!currentUser || !currentUserData) {
                    salesError.textContent = "Vous devez être connecté.";
                    salesError.classList.remove('hidden');
                    return;
                }
                
                // 1. Récupérer les données
                const shopProductId = salesProductSelect.value;
                const quantity = parseInt(salesQuantityInput.value, 10);
                const comment = salesComment.value || "";
                const sellerName = currentUserData.fullName || currentUser.email;

                // 2. Valider les données
                if (!shopProductId || isNaN(quantity) || quantity <= 0) {
                    salesError.textContent = "Veuillez sélectionner un produit et une quantité valide.";
                    salesError.classList.remove('hidden');
                    return;
                }
                
                const shopProduct = allShopStock[shopProductId];
                if (!shopProduct) {
                    salesError.textContent = "Produit non trouvé.";
                    salesError.classList.remove('hidden');
                    return;
                }

                // 3. Valider le stock
                if (quantity > shopProduct.quantityInShop) {
                    salesError.textContent = `Stock insuffisant. (Disponible: ${shopProduct.quantityInShop})`;
                    salesError.classList.remove('hidden');
                    return;
                }
                
                salesSubmitButton.disabled = true;
                salesSubmitButton.textContent = "Enregistrement...";
                
                try {
                    // 4. Préparer la transaction atomique
                    const updates = {};
                    const now = new Date().toISOString();
                    
                    const shopOldStock = shopProduct.quantityInShop;
                    const shopNewStock = shopOldStock - quantity;
                    const totalAmount = shopProduct.sellingPrice * quantity;

                    // 4a. Mettre à jour le stock de la Boutique
                    updates[`users/${currentUser.uid}/shopStock/${shopProductId}/quantityInShop`] = shopNewStock;
                    updates[`users/${currentUser.uid}/shopStock/${shopProductId}/updatedAt`] = now;

                    // 4b. Créer le mouvement de Sortie de Boutique
                    const shopMoveKey = push(ref(db, `users/${currentUser.uid}/shopMovements`)).key;
                    updates[`users/${currentUser.uid}/shopMovements/${shopMoveKey}`] = {
                        id: shopMoveKey, shopProductId: shopProductId, productName: shopProduct.name,
                        type: "Sortie", quantityChange: quantity, oldStock: shopOldStock, newStock: shopNewStock,
                        comment: `Vente: ${comment}`, date: now,
                        userEmail: currentUser.email
                    };
                    
                    // 4c. Créer l'enregistrement de Vente
                    const saleKey = push(ref(db, `users/${currentUser.uid}/salesHistory`)).key;
                    updates[`users/${currentUser.uid}/salesHistory/${saleKey}`] = {
                        id: saleKey,
                        shopProductId: shopProductId,
                        productName: shopProduct.name,
                        quantity: quantity,
                        sellingPrice: shopProduct.sellingPrice,
                        totalAmount: totalAmount,
                        sellerName: sellerName,
                        comment: comment,
                        date: now
                    };
                    
                    // 5. Exécuter la transaction
                    await update(ref(db), updates);
                    
                    // 6. Succès
                    showSuccessToast("Vente enregistrée avec succès!");
                    salesForm.reset();
                    updateSalesTotal(); // Réinitialiser le montant
                    
                } catch (error) {
                    console.error("Erreur lors de l'enregistrement de la vente:", error);
                    salesError.textContent = `Erreur: ${error.message}`;
                    salesError.classList.remove('hidden');
                } finally {
                    salesSubmitButton.disabled = false;
                    salesSubmitButton.textContent = "+ Enregistrer la vente";
                }
            });


            // --- Modal "Nouveau Produit" ---
            if(openNewProductModalButton) openNewProductModalButton.addEventListener('click', () => {
                if(newProductModal) newProductModal.classList.remove('hidden');
                if(newProductError) newProductError.classList.add('hidden');
                if(newProductForm) newProductForm.reset();
            });
            if(closeNewProductModalButton) closeNewProductModalButton.addEventListener('click', () => newProductModal.classList.add('hidden'));
            if(newProductModal) newProductModal.addEventListener('click', (e) => e.target === newProductModal && newProductModal.classList.add('hidden'));
            
            if(newProductForm) newProductForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                newProductError.classList.add('hidden');
                if (!currentUser) {
                    newProductError.textContent = "Vous devez être connecté.";
                    newProductError.classList.remove('hidden');
                    return;
                }
                const productName = newProductForm['product-name'].value;
                const description = newProductForm['product-description'].value;
                const cost = parseFloat(newProductForm['product-cost'].value);
                const currency = newProductForm['product-currency'].value;
                const quantity = parseInt(newProductForm['product-quantity'].value, 10);
                if (!productName || !currency || isNaN(cost) || isNaN(quantity)) {
                    newProductError.textContent = "Veuillez remplir tous les champs obligatoires.";
                    newProductError.classList.remove('hidden');
                    return;
                }
                newProductSubmitButton.disabled = true;
                newProductSubmitButton.textContent = "Ajout en cours...";
                try {
                    const storeProductsRef = ref(db, `users/${currentUser.uid}/storeProducts`);
                    const newProductRef = push(storeProductsRef);
                    const newProduct = {
                        id: newProductRef.key, name: productName, description: description,
                        purchaseCost: cost, currency: currency, quantityInStore: quantity,
                        createdAt: new Date().toISOString()
                    };
                    await set(newProductRef, newProduct);
                    const movementsRef = ref(db, `users/${currentUser.uid}/storeMovements`);
                    const newMovementRef = push(movementsRef);
                    const newMovement = {
                        id: newMovementRef.key, productId: newProduct.id, productName: newProduct.name,
                        type: "Entrée", quantityChange: quantity, oldStock: 0, newStock: quantity,
                        comment: "Création initiale", date: new Date().toISOString()
                    };
                    await set(newMovementRef, newMovement);
                    
                    showSuccessToast("Produit ajouté avec succès!");
                    newProductForm.reset();
                    newProductModal.classList.add('hidden');
                } catch (error) {
                    console.error("Erreur lors de l'ajout du produit:", error);
                    newProductError.textContent = `Erreur: ${error.message}`;
                    newProductError.classList.remove('hidden');
                } finally {
                    newProductSubmitButton.disabled = false;
                    newProductSubmitButton.textContent = "Ajouter le produit";
                }
            });
            
            // --- Modal "Entrée" ---
            if(openEntryModalButton) openEntryModalButton.addEventListener('click', () => {
                if(entryModal) entryModal.classList.remove('hidden');
                if(entryError) entryError.classList.add('hidden');
                if(entryForm) entryForm.reset();
            });
            if(closeEntryModalButton) closeEntryModalButton.addEventListener('click', () => entryModal.classList.add('hidden'));
            if(entryModal) entryModal.addEventListener('click', (e) => e.target === entryModal && entryModal.classList.add('hidden'));
            
            if(entryForm) entryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                entryError.classList.add('hidden');
                if (!currentUser) {
                    entryError.textContent = "Vous devez être connecté.";
                    entryError.classList.remove('hidden');
                    return;
                }
                const productId = entryProductSelect.value;
                const quantity = parseInt(entryForm['entry-quantity'].value, 10);
                const comment = entryForm['entry-comment'].value || "Entrée manuelle";
                
                if (!productId || isNaN(quantity) || quantity <= 0) {
                    entryError.textContent = "Veuillez sélectionner un produit et une quantité valide.";
                    entryError.classList.remove('hidden');
                    return;
                }
                
                const product = allStoreProducts[productId];
                if (!product) {
                    entryError.textContent = "Produit non trouvé.";
                    entryError.classList.remove('hidden');
                    return;
                }
                
                entrySubmitButton.disabled = true;
                entrySubmitButton.textContent = "Enregistrement...";
                
                try {
                    const oldStock = product.quantityInStore;
                    const newStock = oldStock + quantity;
                    
                    const productRef = ref(db, `users/${currentUser.uid}/storeProducts/${productId}`);
                    await update(productRef, { quantityInStore: newStock });
                    
                    const movementsRef = ref(db, `users/${currentUser.uid}/storeMovements`);
                    const newMovementRef = push(movementsRef);
                    const newMovement = {
                        id: newMovementRef.key, productId: product.id, productName: product.name,
                        type: "Entrée", quantityChange: quantity, oldStock: oldStock, newStock: newStock,
                        comment: comment, date: new Date().toISOString()
                    };
                    await set(newMovementRef, newMovement);
                    
                    showSuccessToast("Entrée enregistrée!");
                    entryForm.reset();
                    entryModal.classList.add('hidden');
                    
                } catch (error) {
                    console.error("Erreur d'enregistrement d'entrée:", error);
                    entryError.textContent = `Erreur: ${error.message}`;
                    entryError.classList.remove('hidden');
                } finally {
                    entrySubmitButton.disabled = false;
                    entrySubmitButton.textContent = "Enregistrer l'entrée";
                }
            });
            
            // --- Modal "Sortie" ---
            if(openExitModalButton) openExitModalButton.addEventListener('click', () => {
                if(exitModal) exitModal.classList.remove('hidden');
                if(exitError) exitError.classList.add('hidden');
                if(exitForm) exitForm.reset();
            });
            if(closeExitModalButton) closeExitModalButton.addEventListener('click', () => exitModal.classList.add('hidden'));
            if(exitModal) exitModal.addEventListener('click', (e) => e.target === exitModal && exitModal.classList.add('hidden'));
            
            if(exitForm) exitForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                exitError.classList.add('hidden');
                if (!currentUser) {
                    exitError.textContent = "Vous devez être connecté.";
                    exitError.classList.remove('hidden');
                    return;
                }
                const productId = exitProductSelect.value;
                const quantity = parseInt(exitForm['exit-quantity'].value, 10);
                const comment = exitForm['exit-comment'].value || "Sortie manuelle";
                
                if (!productId || isNaN(quantity) || quantity <= 0) {
                    exitError.textContent = "Veuillez sélectionner un produit et une quantité valide.";
                    exitError.classList.remove('hidden');
                    return;
                }
                
                const product = allStoreProducts[productId];
                if (!product) {
                    exitError.textContent = "Produit non trouvé.";
                    exitError.classList.remove('hidden');
                    return;
                }
                
                const oldStock = product.quantityInStore;
                if (quantity > oldStock) {
                    exitError.textContent = `Stock insuffisant. (Actuel: ${oldStock})`;
                    exitError.classList.remove('hidden');
                    return;
                }
                
                exitSubmitButton.disabled = true;
                exitSubmitButton.textContent = "Enregistrement...";
                
                try {
                    const newStock = oldStock - quantity;
                    
                    const productRef = ref(db, `users/${currentUser.uid}/storeProducts/${productId}`);
                    await update(productRef, { quantityInStore: newStock });
                    
                    const movementsRef = ref(db, `users/${currentUser.uid}/storeMovements`);
                    const newMovementRef = push(movementsRef);
                    const newMovement = {
                        id: newMovementRef.key, productId: product.id, productName: product.name,
                        type: "Sortie", quantityChange: quantity, oldStock: oldStock, newStock: newStock,
                        comment: comment, date: new Date().toISOString()
                    };
                    await set(newMovementRef, newMovement);
                    
                    showSuccessToast("Sortie enregistrée!");
                    exitForm.reset();
                    exitModal.classList.add('hidden');
                    
                } catch (error) {
                    console.error("Erreur d'enregistrement de sortie:", error);
                    exitError.textContent = `Erreur: ${error.message}`;
                    exitError.classList.remove('hidden');
                } finally {
                    exitSubmitButton.disabled = false;
                    exitSubmitButton.textContent = "Enregistrer la sortie";
                }
            });
            
            // --- Modal "Transférer" ---
            if(openTransferModalButton) openTransferModalButton.addEventListener('click', () => {
                if(transferModal) transferModal.classList.remove('hidden');
                if(transferError) transferError.classList.add('hidden');
                if(transferStockWarning) transferStockWarning.classList.add('hidden');
                if(transferSourceInfo) transferSourceInfo.classList.add('hidden');
                if(transferForm) {
                    transferForm.reset();
                    transferForm['transfer-alert-threshold'].value = '10'; // Default value
                }
            });
            if(closeTransferModalButton) closeTransferModalButton.addEventListener('click', () => transferModal.classList.add('hidden'));
            if(transferModal) transferModal.addEventListener('click', (e) => e.target === transferModal && transferModal.classList.add('hidden'));
            
            if(transferProductSelect) transferProductSelect.addEventListener('change', () => {
                const productId = transferProductSelect.value;
                if (!productId) {
                    transferSourceInfo.classList.add('hidden');
                    return;
                }
                const product = allStoreProducts[productId];
                if (product) {
                    transferCostDisplay.textContent = formatCurrency(product.purchaseCost, product.currency);
                    transferSourceInfo.classList.remove('hidden');
                }
            });
            
            if(transferForm) transferForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                transferError.classList.add('hidden');
                transferStockWarning.classList.add('hidden');
                
                if (!currentUser) {
                    transferError.textContent = "Vous devez être connecté.";
                    transferError.classList.remove('hidden');
                    return;
                }

                const sourceProductId = transferProductSelect.value;
                const transferQty = parseInt(transferForm['transfer-quantity'].value, 10);
                const sellingPrice = parseFloat(transferForm['transfer-selling-price'].value);
                const alertThreshold = parseInt(transferForm['transfer-alert-threshold'].value, 10);
                
                if (!sourceProductId || isNaN(transferQty) || transferQty <= 0 || isNaN(sellingPrice) || sellingPrice < 0) {
                    transferError.textContent = "Veuillez remplir tous les champs obligatoires.";
                    transferError.classList.remove('hidden');
                    return;
                }
                
                const sourceProduct = allStoreProducts[sourceProductId];
                if (!sourceProduct) {
                    transferError.textContent = "Produit source non trouvé.";
                    transferError.classList.remove('hidden');
                    return;
                }
                
                if (transferQty > sourceProduct.quantityInStore) {
                    transferStockWarning.querySelector('p').textContent = `Cette valeur doit être inférieure ou égale à ${sourceProduct.quantityInStore}.`;
                    transferStockWarning.classList.remove('hidden');
                    return;
                }
                
                transferSubmitButton.disabled = true;
                transferSubmitButton.textContent = "Transfert en cours...";
                
                try {
                    const shopStockRef = ref(db, `users/${currentUser.uid}/shopStock`);
                    const shopStockQuery = query(shopStockRef, orderByChild('sourceProductId'), equalTo(sourceProductId));
                    const snapshot = await get(shopStockQuery);
                    let existingShopItem = null;
                    let existingShopItemId = null;
                    if (snapshot.exists()) {
                        existingShopItemId = Object.keys(snapshot.val())[0];
                        existingShopItem = snapshot.val()[existingShopItemId];
                    }

                    const updates = {};
                    const now = new Date().toISOString();
                    
                    const storeOldStock = sourceProduct.quantityInStore;
                    const storeNewStock = storeOldStock - transferQty;
                    const shopOldStock = existingShopItem ? existingShopItem.quantityInShop : 0;
                    const shopNewStock = shopOldStock + transferQty;

                    updates[`users/${currentUser.uid}/storeProducts/${sourceProductId}/quantityInStore`] = storeNewStock;
                    
                    const storeMovementsRef = ref(db, `users/${currentUser.uid}/storeMovements`);
                    const storeMoveKey = push(storeMovementsRef).key;
                    updates[`users/${currentUser.uid}/storeMovements/${storeMoveKey}`] = {
                        id: storeMoveKey, productId: sourceProductId, productName: sourceProduct.name,
                        type: "Sortie", quantityChange: transferQty, oldStock: storeOldStock, newStock: storeNewStock,
                        comment: "Transfert vers boutique", date: now
                    };
                    
                    const shopProductId = existingShopItem ? existingShopItemId : push(shopStockRef).key;
                    const shopProductData = {
                        id: shopProductId,
                        sourceProductId: sourceProductId,
                        name: sourceProduct.name,
                        purchaseCost: sourceProduct.purchaseCost, 
                        sellingPrice: sellingPrice,
                        quantityInShop: shopNewStock,
                        alertThreshold: isNaN(alertThreshold) ? 10 : alertThreshold,
                        createdAt: existingShopItem ? existingShopItem.createdAt : now,
                        updatedAt: now
                    };
                    updates[`users/${currentUser.uid}/shopStock/${shopProductId}`] = shopProductData;

                    const shopMovementsRef = ref(db, `users/${currentUser.uid}/shopMovements`);
                    const shopMoveKey = push(shopMovementsRef).key;
                    updates[`users/${currentUser.uid}/shopMovements/${shopMoveKey}`] = {
                        id: shopMoveKey, shopProductId: shopProductId, productName: sourceProduct.name,
                        type: "Entrée", quantityChange: transferQty, oldStock: shopOldStock, newStock: shopNewStock,
                        comment: "Transfert depuis le magasin", date: now,
                        userEmail: currentUser.email
                    };

                    await update(ref(db), updates);
                    
                    showSuccessToast("Transfert réussi!");
                    transferForm.reset();
                    transferModal.classList.add('hidden');

                } catch (error) {
                    console.error("Erreur lors du transfert:", error);
                    transferError.textContent = `Erreur: ${error.message}`;
                    transferError.classList.remove('hidden');
                } finally {
                    transferSubmitButton.disabled = false;
                    transferSubmitButton.textContent = "Transférer et Créer/Mettre à jour l'article";
                }
            });
            
            // --- Modal "Réapprovisionner" ---
            if(openRestockModalButton) openRestockModalButton.addEventListener('click', () => {
                if(restockModal) restockModal.classList.remove('hidden');
                if(restockError) restockError.classList.add('hidden');
                if(restockStockWarning) restockStockWarning.classList.add('hidden');
                if(restockSourceInfo) restockSourceInfo.classList.add('hidden');
                if(restockForm) restockForm.reset();
            });
            if(closeRestockModalButton) closeRestockModalButton.addEventListener('click', () => restockModal.classList.add('hidden'));
            if(restockModal) restockModal.addEventListener('click', (e) => e.target === restockModal && restockModal.classList.add('hidden'));
            
            if(restockProductSelect) restockProductSelect.addEventListener('change', () => {
                const shopProductId = restockProductSelect.value;
                if (!shopProductId) {
                    restockSourceInfo.classList.add('hidden');
                    return;
                }
                const shopProduct = allShopStock[shopProductId];
                const sourceProduct = allStoreProducts[shopProduct.sourceProductId];
                
                if (shopProduct && sourceProduct) {
                    restockSourceName.textContent = sourceProduct.name;
                    restockSourceStock.textContent = sourceProduct.quantityInStore;
                    restockSourceInfo.classList.remove('hidden');
                } else {
                    restockSourceInfo.classList.add('hidden');
                }
            });
            
            if(restockForm) restockForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                restockError.classList.add('hidden');
                restockStockWarning.classList.add('hidden');

                if (!currentUser) {
                    restockError.textContent = "Vous devez être connecté.";
                    restockError.classList.remove('hidden');
                    return;
                }

                const shopProductId = restockProductSelect.value;
                const restockQty = parseInt(restockForm['restock-quantity'].value, 10);
                const comment = restockForm['restock-comment'].value || "Réapprovisionnement";

                if (!shopProductId || isNaN(restockQty) || restockQty <= 0) {
                    restockError.textContent = "Veuillez sélectionner un produit et une quantité valide.";
                    restockError.classList.remove('hidden');
                    return;
                }

                const shopProduct = allShopStock[shopProductId];
                if (!shopProduct) {
                    restockError.textContent = "Produit de boutique non trouvé.";
                    restockError.classList.remove('hidden');
                    return;
                }
                
                const sourceProduct = allStoreProducts[shopProduct.sourceProductId];
                if (!sourceProduct) {
                    restockError.textContent = "Produit source (magasin) non trouvé. Impossible de réapprovisionner.";
                    restockError.classList.remove('hidden');
                    return;
                }

                if (restockQty > sourceProduct.quantityInStore) {
                    restockStockWarning.querySelector('p').textContent = `Stock magasin insuffisant (disponible: ${sourceProduct.quantityInStore}).`;
                    restockStockWarning.classList.remove('hidden');
                    return;
                }

                restockSubmitButton.disabled = true;
                restockSubmitButton.textContent = "Enregistrement...";

                try {
                    const updates = {};
                    const now = new Date().toISOString();
                    const storeOldStock = sourceProduct.quantityInStore;
                    const storeNewStock = storeOldStock - restockQty;
                    const shopOldStock = shopProduct.quantityInShop;
                    const shopNewStock = shopOldStock + restockQty;

                    updates[`users/${currentUser.uid}/storeProducts/${sourceProduct.id}/quantityInStore`] = storeNewStock;

                    const storeMovementsRef = ref(db, `users/${currentUser.uid}/storeMovements`);
                    const storeMoveKey = push(storeMovementsRef).key;
                    updates[`users/${currentUser.uid}/storeMovements/${storeMoveKey}`] = {
                        id: storeMoveKey, productId: sourceProduct.id, productName: sourceProduct.name,
                        type: "Sortie", quantityChange: restockQty, oldStock: storeOldStock, newStock: storeNewStock,
                        comment: comment, date: now
                    };

                    updates[`users/${currentUser.uid}/shopStock/${shopProductId}/quantityInShop`] = shopNewStock;
                    updates[`users/${currentUser.uid}/shopStock/${shopProductId}/updatedAt`] = now;
                    
                    const shopMovementsRef = ref(db, `users/${currentUser.uid}/shopMovements`);
                    const shopMoveKey = push(shopMovementsRef).key;
                    updates[`users/${currentUser.uid}/shopMovements/${shopMoveKey}`] = {
                        id: shopMoveKey, shopProductId: shopProductId, productName: shopProduct.name,
                        type: "Entrée", quantityChange: restockQty, oldStock: shopOldStock, newStock: shopNewStock,
                        comment: comment, date: now,
                        userEmail: currentUser.email
                    };

                    await update(ref(db), updates);

                    showSuccessToast("Réapprovisionnement réussi!");
                    restockForm.reset();
                    restockModal.classList.add('hidden');

                } catch (error) {
                    console.error("Erreur lors du réapprovisionnement:", error);
                    restockError.textContent = `Erreur: ${error.message}`;
                    restockError.classList.remove('hidden');
                } finally {
                    restockSubmitButton.disabled = false;
                    restockSubmitButton.textContent = "Confirmer le réapprovisionnement";
                }
            });

            // Soumission du formulaire de connexion
            if(loginForm) loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = loginForm.email.value;
                const password = loginForm.password.value;
                if(loginError) loginError.classList.add('hidden'); 
                if(loginSubmitButton) {
                    loginSubmitButton.disabled = true;
                    loginSubmitButton.textContent = "Connexion...";
                }
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Erreur de connexion:", error.message);
                    if(loginError) {
                        loginError.textContent = getFirebaseAuthErrorMessage(error.code);
                        loginError.classList.remove('hidden');
                    }
                } finally {
                    if(loginSubmitButton) {
                        loginSubmitButton.disabled = false;
                        loginSubmitButton.textContent = "Se connecter";
                    }
                }
            });

            // Soumission du formulaire d'inscription
            if(signupForm) signupForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = signupForm['signup-email'].value;
                const password = signupForm['signup-password'].value;
                const fullName = signupForm.fullName.value;
                const companyName = signupForm.companyName.value;
                if(signupError) signupError.classList.add('hidden');
                if(signupSubmitButton) {
                    signupSubmitButton.disabled = true;
                    signupSubmitButton.textContent = "Création...";
                }
                if (!fullName || !companyName) {
                    if(signupError) {
                        signupError.textContent = "Veuillez remplir tous les champs.";
                        signupError.classList.remove('hidden');
                    }
                    if(signupSubmitButton) {
                        signupSubmitButton.disabled = false;
                        signupSubmitButton.textContent = "Créer mon compte";
                    }
                    return;
                }
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    // Enregistrer les infos utilisateur dans la DB
                    await set(ref(db, 'users/' + user.uid), {
                        fullName: fullName,
                        companyName: companyName,
                        email: email
                    });
                } catch (error) {
                    console.error("Erreur d'inscription:", error.message);
                    if(signupError) {
                        signupError.textContent = getFirebaseAuthErrorMessage(error.code);
                        signupError.classList.remove('hidden');
                    }
                } finally {
                    if(signupSubmitButton) {
                        signupSubmitButton.disabled = false;
                        signupSubmitButton.textContent = "Créer mon compte";
                    }
                }
            });
            
            // Barres de recherche
            if (storeSearchInput) {
                storeSearchInput.addEventListener('input', (e) => {
                    renderStoreProducts(e.target.value);
                });
            }
            if (shopSearchInput) {
                shopSearchInput.addEventListener('input', (e) => {
                    renderShopStock(e.target.value);
                });
            }

            // Clics sur les boutons de navigation de la Sidebar
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const pageName = button.dataset.page;
                    if (pageName) {
                        currentPage = pageName;
                        if (window.innerWidth < 1024) { // Sur mobile, ferme la sidebar
                            isSidebarOpen = false;
                            updateSidebarMobileState();
                        }
                        updateUI();
                    }
                });
            });

            // Déconnexion
            if(logoutButton) logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    cleanupFirebaseListeners(); // Nettoyer les écouteurs lors de la déconnexion
                } catch (error) {
                    console.error("Erreur de déconnexion:", error);
                }
            });
            
            // --- GESTIONNAIRE D'ÉTAT D'AUTHENTIFICATION ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    isAuthenticated = true;
                    currentUser = user;
                    
                    // Récupérer les données de l'utilisateur (nom, etc.)
                    currentUserData = null; // Réinitialiser
                    const userProfileRef = ref(db, `users/${user.uid}`);
                    get(userProfileRef).then((snapshot) => {
                        if (snapshot.exists()) {
                            currentUserData = snapshot.val();
                            if (sellerNameInput && currentUserData.fullName) {
                                sellerNameInput.value = currentUserData.fullName;
                            }
                        } else {
                            console.warn("Aucun profil trouvé pour l'utilisateur:", user.uid);
                        }
                    }).catch((error) => {
                        console.error("Erreur de récupération du profil:", error);
                    });

                    setupFirebaseListeners(user.uid); // Démarrer les écouteurs
                } else {
                    isAuthenticated = false;
                    currentUser = null;
                    currentUserData = null; // Vider les données utilisateur
                    currentPage = 'Tableau de bord';
                    cleanupFirebaseListeners(); // Assurer que tout est nettoyé
                }
                updateUI();
            });

            // --- FONCTION UTILITAIRE ---
            function getFirebaseAuthErrorMessage(code) {
                switch (code) {
                    case 'auth/invalid-email':
                        return 'Adresse e-mail invalide.';
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        return 'E-mail ou mot de passe incorrect.';
                    case 'auth/email-already-in-use':
                        return 'Cet e-mail est déjà utilisé.';
                    case 'auth/weak-password':
                        return 'Le mot de passe doit comporter au moins 6 caractères.';
                    case 'auth/configuration-not-found':
                        return "Erreur de configuration. Avez-vous activé 'Email/Mot de passe' dans la console Firebase?";
                    default:
                        return `Une erreur est survenue (${code}). Veuillez réessayer.`;
                }
            }
            
            // Mettre à jour l'UI une première fois au cas où l'état d'auth est déjà connu
            updateUI();

        });

    </script>
</body>
</html>
