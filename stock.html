<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StockPilot</title>
    <!-- Chargement de TailwindCSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ajout de la police Inter pour une meilleure apparence */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Style pour l'ic√¥ne de corbeille */
        .delete-icon:hover svg {
            color: #ef4444;
            /* text-red-500 */
        }

        /* Styles pour le Toast de Succ√®s */
        #success-toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }

        #success-toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Style pour la transition du margin sur le main content */
        main {
            transition: margin-left 0.3s ease-in-out;
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "firebase/app": "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js",
    "react": "https://esm.sh/react@^19.2.4",
    "firebase/": "https://esm.sh/firebase@^12.8.0/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>

<body class="bg-gray-50">

    <!-- 
      CONTENEUR DE LA PAGE D'AUTHENTIFICATION
    -->
    <div id="auth-page-container">
        <div class="min-h-screen bg-gray-50 flex flex-col justify-center items-center p-4">
            <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
                <div class="flex flex-col items-center mb-6">
                    <div class="bg-cyan-100 text-cyan-500 p-3 rounded-lg mb-4">
                        <div data-icon="logo" class="w-8 h-8"></div>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">StockPilot</h1>
                    <p class="text-gray-500 mt-1">
                        Connectez-vous √† votre compte ou cr√©ez-en un pour continuer.
                    </p>
                </div>

                <div class="w-full bg-gray-100 rounded-lg p-1 flex mb-6">
                    <button id="auth-toggle-login"
                        class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors bg-white shadow text-gray-800">
                        Se connecter
                    </button>
                    <button id="auth-toggle-signup"
                        class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors text-gray-500 hover:bg-gray-200">
                        S'inscrire
                    </button>
                </div>

                <!-- Formulaire de connexion (initialement visible) -->
                <form id="login-form">
                    <div class="space-y-4">
                        <div class="flex bg-gray-100 rounded-lg p-1 text-xs font-semibold">
                            <button type="button" id="login-mode-admin"
                                class="flex-1 px-3 py-2 rounded-md bg-white text-gray-800 shadow">Admin</button>
                            <button type="button" id="login-mode-code"
                                class="flex-1 px-3 py-2 rounded-md text-gray-500 hover:text-gray-700">Collaborateur</button>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="email">Email</label>
                            <input type="email" id="email" name="email"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                        </div>
                        <div id="login-password-field">
                            <label class="text-sm font-medium text-gray-600" for="password">Mot de passe</label>
                            <input type="password" id="password" name="password"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                        </div>
                        <div id="login-access-code-field" class="hidden">
                            <label class="text-sm font-medium text-gray-600" for="access-code">Code d'acc√®s</label>
                            <input type="text" id="access-code" name="access-code" placeholder="Ex: Z4T7-9Q3S"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition uppercase tracking-widest" />
                            <p class="text-xs text-gray-500 mt-1">Demandez ce code √† l'administrateur de votre
                                entreprise.</p>
                        </div>
                        <p id="login-error" class="text-red-500 text-sm mt-2 hidden"></p>
                        <!-- Ajout pour les erreurs -->
                        <button type="submit" id="login-submit-button"
                            class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                            Se connecter
                        </button>
                    </div>
                </form>

                <!-- Formulaire d'inscription (initialement cach√©) -->
                <form id="signup-form" class="hidden">
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="fullName">Nom complet</label>
                            <input type="text" id="fullName" name="fullName" placeholder="Jean Dupont"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="companyName">Nom de
                                l'entreprise</label>
                            <input type="text" id="companyName" name="companyName" placeholder="Ma Soci√©t√©"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                            <p class="text-xs text-gray-500 mt-1">Si le nom correspond √† une entreprise existante, vous
                                la rejoindrez.</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="signup-email">Email</label>
                            <input type="email" id="signup-email" name="signup-email" placeholder="votre@email.com"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="signup-password">Mot de passe</label>
                            <input type="password" id="signup-password" name="signup-password" placeholder="********"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                        </div>
                        <div id="signup-error-container" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
                            <p id="signup-error" class="text-red-500 text-sm"></p>
                        </div>
                        <button type="submit" id="signup-submit-button"
                            class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                            Cr√©er mon compte
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 
      CONTENEUR DE L'APPLICATION (LAYOUT)
      Initialement cach√©, sera affich√© par JS apr√®s la connexion.
    -->
    <div id="layout-container" class="hidden">
        <!-- Overlay pour sidebar mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-64 bg-white shadow-md flex flex-col h-screen fixed top-0 left-0 z-40 transition-transform duration-300 ease-in-out -translate-x-full lg:translate-x-0 lg:transition-all">
            <div class="p-6 flex items-center space-x-3 border-b border-gray-200">
                <div class="bg-cyan-100 text-cyan-500 p-2 rounded-lg">
                    <div data-icon="logo" class="w-6 h-6"></div>
                </div>
                <h1 class="sidebar-text text-xl font-bold text-gray-800">StockPilot</h1>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <!-- Les boutons de navigation -->
                <button data-page="Tableau de bord"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-cyan-400 text-white shadow">
                    <div data-icon="dashboard" class="w-5 h-5"></div>
                    <span class="sidebar-text">Tableau de bord</span>
                </button>
                <button data-page="Ventes"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="sales" class="w-5 h-5"></div>
                    <span class="sidebar-text">Ventes</span>
                </button>
                <button data-page="Stock Boutique"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="box" class="w-5 h-5"></div>
                    <span class="sidebar-text">Stock Boutique</span>
                </button>
                <button data-page="Mon Magasin"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="box" class="w-5 h-5"></div>
                    <span class="sidebar-text">Mon Magasin</span>
                </button>
                <button data-page="Statistiques"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="stats" class="w-5 h-5"></div>
                    <span class="sidebar-text">Statistiques</span>
                </button>
                <button data-page="Param√®tres"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="settings" class="w-5 h-5"></div>
                    <span class="sidebar-text">Param√®tres</span>
                </button>
            </nav>
            <div class="p-4 border-t border-gray-200">
                <div class="sidebar-text p-4 mb-2 rounded-lg bg-gray-100">
                    <!-- Placeholder pour le profil utilisateur -->
                    <p id="user-name-display" class="text-sm font-medium text-gray-700">Utilisateur connect√©</p>
                    <p id="user-company-display" class="text-xs text-gray-500 font-semibold truncate mt-1"></p>
                    <p id="user-email-display" class="text-xs text-gray-400 truncate">Chargement...</p>
                </div>
                <button id="logout-button"
                    class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">
                    <div data-icon="logout" class="w-5 h-5"></div>
                    <span class="sidebar-text">D√©connexion</span>
                </button>
            </div>
            <!-- Bouton pour r√©duire/agrandir la sidebar sur Desktop -->
            <div class="hidden lg:block absolute -right-3 top-20">
                <button id="sidebar-collapse-toggle"
                    class="bg-white border rounded-full p-1.5 shadow-md hover:bg-gray-100 transition-colors">
                    <div data-icon="arrowLeft" class="w-4 h-4 text-gray-600"></div>
                </button>
            </div>
        </aside>

        <!-- Contenu principal (pages) -->
        <main class="flex-1 lg:ml-64 overflow-y-auto h-screen">

            <!-- Header pour la vue mobile -->
            <header id="mobile-header"
                class="sticky top-0 bg-gray-50/75 backdrop-blur-sm z-10 p-4 border-b border-gray-200 flex items-center justify-between lg:hidden">
                <button id="hamburger-button" class="text-gray-500 hover:text-gray-800">
                    <div data-icon="menu" class="w-6 h-6"></div>
                </button>
                <h1 id="mobile-page-title" class="text-lg font-semibold text-gray-800">Tableau de bord</h1>
                <div class="w-6"></div> <!-- Spacer -->
            </header>

            <!-- Page: Tableau de bord -->
            <div id="page-Tableau-de-bord" class="page-content p-4 md:p-8">
                <h1 class="text-3xl font-bold text-gray-800">Bienvenue!</h1>
                <p class="text-gray-500 mt-1">Voici un aper√ßu de votre activit√©</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Ventes du jour</p>
                            <p id="stat-daily-sales" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                            <p id="trend-daily-sales" class="text-xs mt-2"></p>
                        </div>
                        <div class="p-3 rounded-lg bg-blue-100">
                            <div data-icon="sales" class="w-6 h-6 text-blue-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Stock Boutique</p>
                            <p id="stat-shop-stock" class="text-2xl font-bold text-gray-800 mt-1">0 produits</p>
                            <p id="trend-shop-stock" class="text-xs mt-2"></p>
                        </div>
                        <div class="p-3 rounded-lg bg-green-100">
                            <div data-icon="box" class="w-6 h-6 text-green-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Stock Magasin</p>
                            <p id="stat-store-stock" class="text-2xl font-bold text-gray-800 mt-1">0 produits</p>
                            <p id="trend-store-stock" class="text-xs mt-2"></p>
                        </div>
                        <div class="p-3 rounded-lg bg-yellow-100">
                            <div data-icon="box" class="w-6 h-6 text-yellow-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Revenus du mois</p>
                            <p id="stat-monthly-revenue" class="text-2xl font-bold text-gray-800 mt-1">0 FCFA</p>
                            <p id="trend-monthly-revenue" class="text-xs mt-2"></p>
                        </div>
                        <div class="p-3 rounded-lg bg-indigo-100">
                            <div data-icon="stats" class="w-6 h-6 text-indigo-500"></div>
                        </div>
                    </div>
                    <!-- StatCard: Alertes Stock NOUVEAU -->
                    <div
                        class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between border-2 border-orange-200">
                        <div>
                            <p class="text-sm text-gray-500">Alertes Stock</p>
                            <p id="stat-low-stock" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                            <span id="badge-low-stock"
                                class="hidden inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 mt-2">
                                ‚ö†Ô∏è Action requise
                            </span>
                        </div>
                        <div class="p-3 rounded-lg bg-orange-100">
                            <div data-icon="alert" class="w-6 h-6 text-orange-500"></div>
                        </div>
                    </div>
                    <!-- StatCard: B√©n√©fice NOUVEAU -->
                    <div
                        class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between border-2 border-emerald-200">
                        <div>
                            <p class="text-sm text-gray-500">Benefice du mois</p>
                            <p id="stat-monthly-profit" class="text-2xl font-bold text-gray-800 mt-1">0 FCFA</p>
                            <p id="trend-monthly-profit" class="text-xs mt-2"></p>
                        </div>
                        <div class="p-3 rounded-lg bg-emerald-100">
                            <div data-icon="dollar" class="w-6 h-6 text-emerald-500"></div>
                        </div>
                    </div>
                </div>

                <!-- Actions Rapides -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mt-8">
                    <button data-quick-action="Ventes"
                        class="p-6 bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 text-white group">
                        <div class="flex flex-col items-center space-y-2">
                            <div data-icon="sales"
                                class="w-8 h-8 text-white group-hover:scale-110 transition-transform"></div>
                            <span class="font-semibold">Nouvelle Vente</span>
                        </div>
                    </button>
                    <button data-quick-action="Reappro"
                        class="p-6 bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 text-white group">
                        <div class="flex flex-col items-center space-y-2">
                            <div data-icon="box" class="w-8 h-8 text-white group-hover:scale-110 transition-transform">
                            </div>
                            <span class="font-semibold">Reapprovisionner</span>
                        </div>
                    </button>
                    <button data-quick-action="Mon Magasin"
                        class="p-6 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 text-white group">
                        <div class="flex flex-col items-center space-y-2">
                            <div data-icon="box" class="w-8 h-8 text-white group-hover:scale-110 transition-transform">
                            </div>
                            <span class="font-semibold">Ajouter Produit</span>
                        </div>
                    </button>
                    <button data-quick-action="Statistiques"
                        class="p-6 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 text-white group">
                        <div class="flex flex-col items-center space-y-2">
                            <div data-icon="stats"
                                class="w-8 h-8 text-white group-hover:scale-110 transition-transform"></div>
                            <span class="font-semibold">Voir Rapports</span>
                        </div>
                    </button>
                </div>

                <!-- Timeline d'Activit√©s R√©centes -->
                <div class="bg-white p-6 rounded-lg shadow-sm mt-8">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <div data-icon="clock" class="w-5 h-5 mr-2 text-cyan-500"></div>
                        Activites Recentes
                    </h2>
                    <div id="recent-activities" class="mt-4 space-y-3">
                        <p class="text-sm text-gray-500">Aucune activite pour le moment</p>
                    </div>
                </div>

                <div class="mt-10 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800">Demarrage rapide</h2>
                    <div class="mt-4 space-y-4">
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h3 class="font-semibold text-gray-700">1. Ajouter des produits au magasin</h3>
                            <p class="text-sm text-gray-500 mt-1">Commencez par ajouter vos produits dans "Mon Magasin"
                                avec leurs prix d'achat.</p>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h3 class="font-semibold text-gray-700">2. Transf√©rer vers la boutique</h3>
                            <p class="text-sm text-gray-500 mt-1">Transf√©rez les produits vers votre "Stock Boutique" en
                                ajoutant votre marge.</p>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h3 class="font-semibold text-gray-700">3. Enregistrer vos ventes</h3>
                            <p class="text-sm text-gray-500 mt-1">Utilisez l'interface "Ventes" pour enregistrer chaque
                                transaction.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Ventes -->
            <div id="page-Ventes" class="page-content p-4 md:p-8 hidden">
                <h1 class="text-3xl font-bold text-gray-800">Ventes</h1>
                <p class="text-gray-500 mt-1">Enregistrez vos ventes quotidiennes</p>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <div data-icon="sales" class="w-6 h-6 mr-3 text-cyan-500"></div>
                        Enregistrer une vente
                    </h2>
                    <form id="sales-form" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1">
                            <label for="sales-product-select"
                                class="block text-sm font-medium text-gray-700 mb-1">Produit *</label>
                            <select id="sales-product-select" name="product"
                                class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500">
                                <option value="">S√©lectionner un produit</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label for="sales-quantity-input"
                                class="block text-sm font-medium text-gray-700 mb-1">Quantit√© *</label>
                            <input type="number" name="quantity" id="sales-quantity-input" value="1" min="1"
                                class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500" />
                        </div>

                        <!-- Nouveau champ : Montant total -->
                        <div class="col-span-1">
                            <label for="sales-total-amount" class="block text-sm font-medium text-gray-700 mb-1">Montant
                                total</label>
                            <input type="text" id="sales-total-amount" value="0 FCFA"
                                class="w-full border-gray-300 rounded-lg shadow-sm bg-gray-100 focus:ring-0 focus:border-gray-300"
                                readonly />
                        </div>

                        <div class="col-span-1">
                            <label for="seller-name" class="block text-sm font-medium text-gray-700 mb-1">Vendeur
                                *</label>
                            <input type="text" name="seller" id="seller-name"
                                class="w-full border-gray-300 rounded-lg shadow-sm bg-gray-100 focus:ring-0 focus:border-gray-300"
                                readonly />
                        </div>

                        <div class="col-span-2">
                            <label for="sales-comment" class="block text-sm font-medium text-gray-700 mb-1">Commentaire
                                (optionnel)</label>
                            <textarea name="comment" id="sales-comment" rows="3"
                                class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500"></textarea>
                        </div>

                        <p id="sales-error" class="text-red-500 text-sm mt-2 hidden col-span-2"></p>

                        <div class="col-span-2 flex gap-3">
                            <button type="button" id="add-to-cart-button"
                                class="inline-flex items-center px-4 py-2 bg-cyan-400 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-500 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
                                    </path>
                                </svg>
                                Ajouter au panier
                            </button>
                            <button type="submit" id="sales-submit-button"
                                class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-300 transition-colors">
                                + Vente directe
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Bouton Facture (affich√© apr√®s vente r√©ussie) -->
                <div id="invoice-button-container"
                    class="mt-4 p-4 bg-gradient-to-r from-cyan-50 to-blue-50 rounded-lg border-2 border-cyan-300 hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-cyan-600 mr-3" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            <div>
                                <p class="text-sm font-semibold text-gray-700">Vente enregistr√©e avec succ√®s !</p>
                                <p class="text-xs text-gray-500">G√©n√©rez la facture PDF pour cette vente</p>
                            </div>
                        </div>
                        <button id="generate-invoice-button"
                            class="px-5 py-2.5 bg-cyan-500 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-600 transition-all duration-200 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            üìÑ G√©n√©rer Facture
                        </button>
                    </div>
                </div>


                <!-- Section Panier -->
                <div id="cart-section" class="mt-8 bg-white p-6 rounded-lg shadow-sm border-2 border-cyan-200 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            <svg class="w-6 h-6 mr-3 text-cyan-500" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                            Panier
                            <span id="cart-count"
                                class="ml-3 px-2.5 py-0.5 text-xs font-semibold rounded-full bg-cyan-100 text-cyan-800">0</span>
                        </h2>
                        <button id="clear-cart-button"
                            class="text-sm text-red-500 hover:text-red-700 font-medium flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                            Vider le panier
                        </button>
                    </div>

                    <!-- Tableau du panier -->
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="min-w-full bg-white divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Produit</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Prix unitaire</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Quantit√©</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Sous-total</th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cart-items-tbody" class="divide-y divide-gray-200">
                                <!-- Les articles du panier seront ins√©r√©s ici par JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Total et validation -->
                    <div
                        class="mt-6 flex flex-col md:flex-row items-center justify-between gap-4 p-4 bg-gray-50 rounded-lg">
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Total de la commande</p>
                            <p id="cart-total" class="text-3xl font-bold text-gray-800">0 FCFA</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="validate-cart-button"
                                class="px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                                Valider la vente
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-10 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800">Historique des ventes</h2>
                    <p class="text-sm text-gray-500 mt-1">Liste de toutes les transactions enregistr√©es.</p>

                    <!-- Conteneur pour l'historique des ventes -->
                    <div id="sales-history-container" class="mt-6">
                        <!-- Message si vide -->
                        <div id="sales-history-placeholder"
                            class="flex flex-col items-center justify-center text-center text-gray-500 h-32">
                            <p>Aucune vente enregistr√©e</p>
                        </div>
                        <!-- Tableau si non vide -->
                        <div id="sales-history-table-container"
                            class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Produit</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Vendeur</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Qt√©</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Montant</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Commentaire</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Date</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-history-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de ventes ins√©r√©es par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Stock Boutique -->
            <div id="page-Stock-Boutique" class="page-content p-4 md:p-8 hidden">
                <h1 class="text-3xl font-bold text-gray-800">Stock de la Boutique</h1>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="relative flex-grow">
                            <!-- ID AJOUT√â ICI -->
                            <input type="text" id="shop-search-input" placeholder="Rechercher par nom ou description..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500" />
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button id="open-restock-modal-button"
                                class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-50 transition-colors flex items-center gap-2">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h5" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M20 20v-5h-5" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 9a9 9 0 0114.13-6.364M20 15a9 9 0 01-14.13 6.364" />
                                </svg>
                                R√©approvisionner
                            </button>
                            <button id="open-transfer-modal-button"
                                class="px-4 py-2 bg-cyan-400 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-500 transition-colors flex items-center gap-2">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Transf√©rer depuis Magasin
                            </button>
                        </div>
                    </div>
                    <!-- Conteneur pour la liste des produits de la boutique -->
                    <div id="shop-stock-container" class="mt-6">
                        <!-- Message si vide (visible par d√©faut) -->
                        <div id="shop-stock-placeholder"
                            class="flex flex-col items-center justify-center text-center text-gray-500 h-40">
                            <p>Aucun article en inventaire.</p>
                        </div>
                        <!-- Tableau si non vide (cach√© par d√©faut) -->
                        <div id="shop-stock-table-container"
                            class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Produit</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Quantit√©</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Prix de Vente</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Seuil d'alerte</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="shop-stock-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de produits ins√©r√©es par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="mt-10 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800">Mouvements du Stock Boutique</h2>
                    <p class="text-sm text-gray-500 mt-1">Historique de tous les ajouts et r√©approvisionnements de
                        stock.</p>
                    <!-- Conteneur pour les mouvements de la boutique -->
                    <div id="shop-movements-container" class="mt-6">
                        <!-- Message si vide (visible par d√©faut) -->
                        <div id="shop-movements-placeholder"
                            class="flex flex-col items-center justify-center text-center text-gray-500 h-32">
                            <p>Aucun mouvement de stock enregistr√©.</p>
                        </div>
                        <!-- Tableau si non vide (cach√© par d√©faut) -->
                        <div id="shop-movements-table-container"
                            class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Produit</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Type</th> <!-- AJOUT√â -->
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Qte Chang√©e</th> <!-- Renomm√© -->
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Changement</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Commentaire</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Utilisateur</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Date</th>
                                    </tr>
                                </thead>
                                <tbody id="shop-movements-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de mouvements ins√©r√©es par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Mon Magasin -->
            <div id="page-Mon-Magasin" class="page-content p-4 md:p-8 hidden">
                <h1 class="text-3xl font-bold text-gray-800">Gestion du Magasin</h1>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="relative flex-grow">
                            <!-- ID AJOUT√â ICI -->
                            <input type="text" id="store-search-input"
                                placeholder="Rechercher par nom ou description..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500" />
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button id="open-entry-modal-button"
                                class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-50 transition-colors flex items-center gap-2">Entr√©e</button>
                            <button id="open-exit-modal-button"
                                class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-50 transition-colors flex items-center gap-2">Sortie</button>
                            <!-- ID ajout√© au bouton "Nouveau Produit" -->
                            <button id="open-new-product-modal-button"
                                class="px-4 py-2 bg-cyan-400 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-500 transition-colors flex items-center gap-2">
                                + Nouveau Produit
                            </button>
                        </div>
                    </div>

                    <!-- Conteneur pour la liste des produits du magasin -->
                    <div id="store-products-container" class="mt-6">
                        <!-- Message si vide (visible par d√©faut) -->
                        <div id="store-products-placeholder"
                            class="flex flex-col items-center justify-center text-center text-gray-500 h-40">
                            <p>Aucun article dans le magasin.</p>
                        </div>
                        <!-- Tableau si non vide (cach√© par d√©faut) -->
                        <div id="store-products-table-container"
                            class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Produit</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Description</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Quantit√©</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Co√ªt d'achat</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="store-products-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de produits ins√©r√©es par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
                <div class="mt-10 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800">Mouvements du Magasin</h2>
                    <p class="text-sm text-gray-500 mt-1">Historique de toutes les entr√©es et sorties du magasin.</p>

                    <!-- Conteneur pour les mouvements du magasin -->
                    <div id="store-movements-container" class="mt-6">
                        <!-- Message si vide (visible par d√©faut) -->
                        <div id="store-movements-placeholder"
                            class="flex flex-col items-center justify-center text-center text-gray-500 h-32">
                            <p>Aucun mouvement enregistr√©.</p>
                        </div>
                        <!-- Tableau si non vide (cach√© par d√©faut) -->
                        <div id="store-movements-table-container"
                            class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Produit</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Type</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Quantit√©</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Changement Stock</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Commentaire</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Date</th>
                                    </tr>
                                </thead>
                                <tbody id="store-movements-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de mouvements ins√©r√©es par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Statistiques -->
            <div id="page-Statistiques" class="page-content p-4 md:p-8 hidden">
                <h1 class="text-3xl font-bold text-gray-800">Statistiques</h1>
                <p class="text-gray-500 mt-1">Analysez vos performances commerciales globales</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Ventes totales</p>
                            <p id="stat-total-sales" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                            <p class="text-xs text-gray-400 mt-2">Depuis le d√©but</p>
                        </div>
                        <div class="p-3 rounded-lg bg-blue-100">
                            <div data-icon="sales" class="w-6 h-6 text-blue-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Revenus totaux</p>
                            <p id="stat-revenue" class="text-2xl font-bold text-gray-800 mt-1">0 FCFA</p>
                            <p class="text-xs text-gray-400 mt-2">Depuis le d√©but</p>
                        </div>
                        <div class="p-3 rounded-lg bg-indigo-100">
                            <div data-icon="stats" class="w-6 h-6 text-indigo-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Produits en stock</p>
                            <p id="stat-products-in-stock" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                            <p class="text-xs text-gray-400 mt-2">Dans la boutique</p>
                        </div>
                        <div class="p-3 rounded-lg bg-green-100">
                            <div data-icon="box" class="w-6 h-6 text-green-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Marge moyenne</p>
                            <p id="stat-avg-margin" class="text-2xl font-bold text-gray-800 mt-1">0%</p>
                            <p class="text-xs text-gray-400 mt-2">Sur toutes les ventes</p>
                        </div>
                        <div class="p-3 rounded-lg bg-purple-100">
                            <div data-icon="chartBar" class="w-6 h-6 text-purple-500"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-10 grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <!-- Section Produits les plus vendus -->
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800">Produits les plus vendus</h2>
                        <p class="text-sm text-gray-500 mt-1">Classement par quantit√© vendue.</p>
                        <div id="best-selling-container" class="mt-4">
                            <div id="best-selling-placeholder" class="text-center text-gray-500 py-8">
                                <p>Aucune donn√©e de vente disponible.</p>
                            </div>
                            <div id="best-selling-table-container" class="hidden overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Produit</th>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Qt√© Vendue</th>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Revenu G√©n√©r√©</th>
                                        </tr>
                                    </thead>
                                    <tbody id="best-selling-tbody" class="divide-y divide-gray-200">
                                        <!-- Donn√©es ins√©r√©es par JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Section Performance des vendeurs -->
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800">Performance des vendeurs</h2>
                        <p class="text-sm text-gray-500 mt-1">Classement par revenu g√©n√©r√©.</p>
                        <div id="seller-performance-container" class="mt-4">
                            <div id="seller-performance-placeholder" class="text-center text-gray-500 py-8">
                                <p>Aucune donn√©e de vente disponible.</p>
                            </div>
                            <div id="seller-performance-table-container" class="hidden overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Vendeur</th>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Nb. Ventes</th>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Revenu Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="seller-performance-tbody" class="divide-y divide-gray-200">
                                        <!-- Donn√©es ins√©r√©es par JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Param√®tres -->
            <div id="page-Param√®tres" class="page-content p-4 md:p-8 hidden">
                <div class="flex flex-col gap-2">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-2xl bg-cyan-100 flex items-center justify-center text-cyan-500">
                            <div data-icon="settings" class="w-6 h-6 text-cyan-500"></div>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold">Param√®tres</h1>
                            <p class="text-gray-500 mt-1">G√©rez les pr√©f√©rences de votre compte, de votre √©quipe et du
                                SaaS.</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400">
                        Seuls les administrateurs ont acc√®s complet √† cette zone. Les autres r√¥les peuvent √™tre limit√©s
                        via l'onglet
                        <span class="font-semibold text-gray-600">Acc√®s</span>.
                    </p>
                </div>

                <div id="settings-restricted-state"
                    class="mt-8 bg-white p-6 rounded-xl shadow-sm border border-red-100 hidden">
                    <div class="flex items-start gap-4">
                        <div class="p-2 rounded-full bg-red-50 text-red-500">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L4.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Acc√®s restreint</h2>
                            <p class="text-gray-500 mt-1">Vous devez √™tre administrateur de l'entreprise pour modifier
                                les param√®tres globaux. Contactez un administrateur pour revoir vos droits.</p>
                        </div>
                    </div>
                </div>

                <div id="settings-tabs-wrapper" class="mt-8 space-y-6 hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div>
                                <p class="text-sm uppercase tracking-wide text-gray-400">Plan actuel</p>
                                <p class="text-2xl font-semibold text-gray-800">StockPilot Pro</p>
                                <p class="text-gray-500 text-sm">Factur√© mensuellement ¬∑ 5 utilisateurs inclus</p>
                            </div>
                            <div class="flex flex-wrap gap-3 text-sm">
                                <div class="px-3 py-2 bg-cyan-50 text-cyan-700 rounded-lg font-medium"
                                    id="settings-admin-badge">R√¥le : Admin</div>
                                <button
                                    class="px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 font-semibold">Mettre
                                    √† niveau</button>
                                <button
                                    class="px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 font-semibold">T√©l√©charger
                                    la politique d'acc√®s</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex flex-wrap gap-2 bg-white p-2 rounded-2xl shadow-sm">
                            <button type="button" data-settings-tab="compte"
                                class="settings-tab-button px-4 py-2 rounded-xl text-sm font-semibold bg-cyan-500 text-white">Compte</button>
                            <button type="button" data-settings-tab="application"
                                class="settings-tab-button px-4 py-2 rounded-xl text-sm font-semibold text-gray-600 hover:text-gray-900">Application</button>
                            <button type="button" data-settings-tab="notifications"
                                class="settings-tab-button px-4 py-2 rounded-xl text-sm font-semibold text-gray-600 hover:text-gray-900">Notifications</button>
                            <button type="button" data-settings-tab="facturation"
                                class="settings-tab-button px-4 py-2 rounded-xl text-sm font-semibold text-gray-600 hover:text-gray-900">Facturation</button>
                            <button type="button" data-settings-tab="acces"
                                class="settings-tab-button px-4 py-2 rounded-xl text-sm font-semibold text-gray-600 hover:text-gray-900 flex items-center gap-2">
                                Acc√®s
                                <span
                                    class="px-2 py-0.5 rounded-full text-xs font-semibold bg-cyan-50 text-cyan-600 border border-cyan-100">Admin</span>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Onglet Compte -->
                        <div data-settings-panel="compte" class="bg-white rounded-2xl shadow-sm p-6 space-y-6">
                            <div class="flex flex-col gap-1">
                                <h2 class="text-xl font-semibold text-gray-900">Profil & Identit√©</h2>
                                <p class="text-sm text-gray-500">Coordonn√©es de l'entreprise et du responsable l√©gal.
                                </p>
                            </div>
                            <div class="grid gap-6 md:grid-cols-2">
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Nom de l'entreprise</label>
                                    <input type="text"
                                        class="mt-2 w-full rounded-lg border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        placeholder="Nom de votre entreprise" id="settings-company-name">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Fuseau horaire</label>
                                    <select
                                        class="mt-2 w-full rounded-lg border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        id="settings-timezone">
                                        <option value="Africa/Abidjan">(GMT) Afrique de l'Ouest</option>
                                        <option value="Europe/Paris">(GMT+1) Europe Centrale</option>
                                        <option value="America/New_York">(GMT-5) New York</option>
                                        <option value="Asia/Dubai">(GMT+4) Duba√Ø</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Email de support</label>
                                    <input type="email"
                                        class="mt-2 w-full rounded-lg border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        placeholder="support@entreprise.com">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Num√©ro WhatsApp</label>
                                    <input type="tel"
                                        class="mt-2 w-full rounded-lg border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        placeholder="+225 xx xx xx xx">
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-3">
                                <button
                                    class="px-5 py-2.5 bg-cyan-500 text-white rounded-xl text-sm font-semibold hover:bg-cyan-600">Enregistrer</button>
                                <button
                                    class="px-5 py-2.5 border border-gray-200 rounded-xl text-sm font-semibold text-gray-600 hover:bg-gray-50">Annuler</button>
                            </div>
                        </div>

                        <!-- Onglet Application -->
                        <div data-settings-panel="application"
                            class="bg-white rounded-2xl shadow-sm p-6 space-y-6 hidden">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">Fonctionnalit√©s activ√©es</h2>
                                <p class="text-sm text-gray-500">Activez uniquement les modules n√©cessaires √† votre
                                    entreprise.</p>
                            </div>
                            <div class="space-y-4">
                                <label
                                    class="flex items-start justify-between gap-4 p-4 rounded-xl border border-gray-200 hover:border-cyan-200 cursor-pointer">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-800">Gestion multi-boutiques</p>
                                        <p class="text-sm text-gray-500">Synchroniser plusieurs points de vente.</p>
                                    </div>
                                    <input type="checkbox"
                                        class="w-5 h-5 text-cyan-500 rounded border-gray-300 focus:ring-cyan-500"
                                        checked>
                                </label>
                                <label
                                    class="flex items-start justify-between gap-4 p-4 rounded-xl border border-gray-200 hover:border-cyan-200 cursor-pointer">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-800">Mode hors ligne</p>
                                        <p class="text-sm text-gray-500">Continuer les ventes m√™me sans connexion.</p>
                                    </div>
                                    <input type="checkbox"
                                        class="w-5 h-5 text-cyan-500 rounded border-gray-300 focus:ring-cyan-500">
                                </label>
                                <label
                                    class="flex items-start justify-between gap-4 p-4 rounded-xl border border-gray-200 hover:border-cyan-200 cursor-pointer">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-800">Synchronisation comptable</p>
                                        <p class="text-sm text-gray-500">Export automatique vers votre ERP.</p>
                                    </div>
                                    <input type="checkbox"
                                        class="w-5 h-5 text-cyan-500 rounded border-gray-300 focus:ring-cyan-500"
                                        checked>
                                </label>
                            </div>
                            <div class="flex justify-end">
                                <button
                                    class="px-5 py-2.5 bg-cyan-500 text-white rounded-xl text-sm font-semibold hover:bg-cyan-600">Sauvegarder</button>
                            </div>
                        </div>

                        <!-- Onglet Notifications -->
                        <div data-settings-panel="notifications"
                            class="bg-white rounded-2xl shadow-sm p-6 space-y-6 hidden">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">Alertes & Notifications</h2>
                                <p class="text-sm text-gray-500">Notifiez vos √©quipes lors des √©v√®nements critiques.</p>
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="p-4 border border-gray-200 rounded-2xl space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-semibold text-gray-800">Stock critique</p>
                                            <p class="text-sm text-gray-500">Email + push</p>
                                        </div>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer" checked>
                                            <span
                                                class="w-12 h-6 bg-gray-200 rounded-full peer peer-checked:bg-cyan-500 relative transition">
                                                <span
                                                    class="absolute top-0.5 left-1 w-5 h-5 bg-white rounded-full shadow transition-all peer-checked:translate-x-6"></span>
                                            </span>
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500">Envoyer aussi aux responsables magasin.</p>
                                </div>
                                <div class="p-4 border border-gray-200 rounded-2xl space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-semibold text-gray-800">Rapport quotidien</p>
                                            <p class="text-sm text-gray-500">Email 7h GMT</p>
                                        </div>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer" checked>
                                            <span
                                                class="w-12 h-6 bg-gray-200 rounded-full peer peer-checked:bg-cyan-500 relative transition">
                                                <span
                                                    class="absolute top-0.5 left-1 w-5 h-5 bg-white rounded-full shadow transition-all peer-checked:translate-x-6"></span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                <div class="p-4 border border-gray-200 rounded-2xl space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-semibold text-gray-800">Objectifs de ventes</p>
                                            <p class="text-sm text-gray-500">Slack + push</p>
                                        </div>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer">
                                            <span
                                                class="w-12 h-6 bg-gray-200 rounded-full peer peer-checked:bg-cyan-500 relative transition">
                                                <span
                                                    class="absolute top-0.5 left-1 w-5 h-5 bg-white rounded-full shadow transition-all peer-checked:translate-x-6"></span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                <div class="p-4 border border-gray-200 rounded-2xl space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-semibold text-gray-800">Facturation & retard</p>
                                            <p class="text-sm text-gray-500">Email + SMS</p>
                                        </div>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer" checked>
                                            <span
                                                class="w-12 h-6 bg-gray-200 rounded-full peer peer-checked:bg-cyan-500 relative transition">
                                                <span
                                                    class="absolute top-0.5 left-1 w-5 h-5 bg-white rounded-full shadow transition-all peer-checked:translate-x-6"></span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button
                                    class="px-5 py-2.5 bg-cyan-500 text-white rounded-xl text-sm font-semibold hover:bg-cyan-600">Mettre
                                    √† jour</button>
                            </div>
                        </div>

                        <!-- Onglet Facturation -->
                        <div data-settings-panel="facturation"
                            class="bg-white rounded-2xl shadow-sm p-6 space-y-6 hidden">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">Facturation & moyens de paiement</h2>
                                <p class="text-sm text-gray-500">Visualisez votre consommation et vos prochaines
                                    √©ch√©ances.</p>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="p-5 border border-gray-200 rounded-2xl space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm uppercase text-gray-400">Prochaine facture</p>
                                            <p class="text-2xl font-semibold text-gray-800">24 000 F CFA</p>
                                        </div>
                                        <span
                                            class="px-3 py-1 text-xs font-semibold rounded-full bg-green-50 text-green-700">Le
                                            01/12</span>
                                    </div>
                                    <p class="text-sm text-gray-500">Bas√©e sur 3 boutiques actives et 7 utilisateurs.
                                    </p>
                                    <button
                                        class="px-4 py-2.5 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-gray-50">T√©l√©charger
                                        la derni√®re facture</button>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-2xl space-y-4">
                                    <div>
                                        <p class="text-sm uppercase text-gray-400">Carte principale</p>
                                        <p class="text-lg font-semibold text-gray-800">**** 4587 ¬∑ Ecobank</p>
                                        <p class="text-sm text-gray-500">Titulaire : Turibe Bayomi</p>
                                    </div>
                                    <div class="flex gap-3">
                                        <button
                                            class="px-4 py-2 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-gray-50">Modifier</button>
                                        <button
                                            class="px-4 py-2 rounded-xl border border-red-200 text-sm font-semibold text-red-600 hover:bg-red-50">Supprimer</button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button
                                    class="px-5 py-2.5 bg-cyan-500 text-white rounded-xl text-sm font-semibold hover:bg-cyan-600">Ajouter
                                    un moyen de paiement</button>
                            </div>
                        </div>

                        <!-- Onglet Acc√®s -->
                        <div data-settings-panel="acces" class="bg-white rounded-2xl shadow-sm p-6 space-y-6 hidden">
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-3">
                                    <h2 class="text-xl font-semibold text-gray-900">Gestion des acc√®s</h2>
                                    <span
                                        class="px-2.5 py-0.5 text-xs rounded-full bg-cyan-50 text-cyan-600 border border-cyan-100">Admins
                                        uniquement</span>
                                </div>
                                <p class="text-sm text-gray-500">D√©finissez les r√¥les de vos collaborateurs et
                                    choisissez les modules qu'ils peuvent voir.</p>
                            </div>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div class="p-4 rounded-2xl border border-gray-200">
                                    <p class="text-sm uppercase text-gray-400">Employ√©s</p>
                                    <p class="text-3xl font-semibold text-gray-800" id="access-total-users">0</p>
                                </div>
                                <div class="p-4 rounded-2xl border border-gray-200">
                                    <p class="text-sm uppercase text-gray-400">Admins</p>
                                    <p class="text-3xl font-semibold text-gray-800" id="access-total-admins">0</p>
                                </div>
                                <div class="p-4 rounded-2xl border border-gray-200">
                                    <p class="text-sm uppercase text-gray-400">Invitations en attente</p>
                                    <p class="text-3xl font-semibold text-gray-800" id="access-total-pending">0</p>
                                </div>
                            </div>

                            <div class="p-4 rounded-2xl border border-gray-200 space-y-4">
                                <div>
                                    <p class="font-semibold text-gray-800">Ajouter un collaborateur</p>
                                    <p class="text-sm text-gray-500">G√©n√©rez un code d'acc√®s personnel et attribuez un
                                        r√¥le imm√©diatement.</p>
                                </div>
                                <form id="access-add-member-form" class="grid md:grid-cols-4 gap-4">
                                    <input type="text" id="access-member-name" placeholder="Nom complet"
                                        class="col-span-2 md:col-span-1 rounded-xl border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        required>
                                    <input type="email" id="access-member-email" placeholder="Email professionnel"
                                        class="col-span-2 md:col-span-1 rounded-xl border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        required>
                                    <select id="access-member-role"
                                        class="col-span-2 md:col-span-1 rounded-xl border-gray-200 focus:ring-cyan-400 focus:border-cyan-400">
                                        <option value="manager">Manager</option>
                                        <option value="vendeur">Vendeur</option>
                                        <option value="consultation">Consultation</option>
                                    </select>
                                    <button type="submit"
                                        class="col-span-2 md:col-span-1 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600">G√©n√©rer
                                        le code</button>
                                </form>
                            </div>

                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <p class="font-semibold text-gray-800">Collaborateurs actifs</p>
                                    <span class="text-sm text-gray-500">Cliquez sur un module pour
                                        l'activer/d√©sactiver.</span>
                                </div>
                                <div class="overflow-x-auto border border-gray-200 rounded-2xl">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead
                                            class="bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">
                                            <tr>
                                                <th class="px-4 py-3">Nom</th>
                                                <th class="px-4 py-3">Email</th>
                                                <th class="px-4 py-3">R√¥le</th>
                                                <th class="px-4 py-3">Modules autoris√©s</th>
                                                <th class="px-4 py-3">Code d'acc√®s</th>
                                                <th class="px-4 py-3 text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="access-members-tbody"
                                            class="divide-y divide-gray-100 text-sm text-gray-700">
                                            <tr>
                                                <td colspan="6" class="px-4 py-6 text-center text-gray-400">Chargement
                                                    des collaborateurs...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- 
      MODAL "AJOUTER UN NOUVEAU PRODUIT"
    -->
    <div id="new-product-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <!-- En-t√™te -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Ajouter un nouveau produit au magasin</h2>
                <button id="close-new-product-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <!-- Formulaire -->
            <form id="new-product-form">
                <div class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700">Nom du Produit
                            *</label>
                        <input type="text" id="product-name" placeholder="ex: √âcran 27 pouces"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                    </div>
                    <div>
                        <label for="product-description"
                            class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="product-description" placeholder="Une courte description du produit" rows="3"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="product-cost" class="block text-sm font-medium text-gray-700">Co√ªt d'Achat
                                *</label>
                            <input type="number" id="product-cost" placeholder="0" value="0" min="0"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                                required>
                        </div>
                        <div>
                            <label for="product-currency" class="block text-sm font-medium text-gray-700">Devise
                                *</label>
                            <input type="text" id="product-currency" placeholder="EUR" value="EUR"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                                required>
                        </div>
                    </div>
                    <div>
                        <label for="product-quantity" class="block text-sm font-medium text-gray-700">Quantit√© Initiale
                            *</label>
                        <input type="number" id="product-quantity" placeholder="0" value="0" min="0"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                    </div>
                    <p id="new-product-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="new-product-submit-button"
                        class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Ajouter le produit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      MODAL "ENREGISTRER UNE ENTR√âE"
    -->
    <div id="entry-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Enregistrer une entr√©e</h2>
                <button id="close-entry-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <form id="entry-form">
                <div class="space-y-4">
                    <div>
                        <label for="entry-product-select" class="block text-sm font-medium text-gray-700">Produit
                            *</label>
                        <select id="entry-product-select"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                            <option value="">S√©lectionnez un produit</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>
                    <div>
                        <label for="entry-quantity" class="block text-sm font-medium text-gray-700">Quantit√© *</label>
                        <input type="number" id="entry-quantity" placeholder="0" min="1"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                    </div>
                    <div>
                        <label for="entry-comment" class="block text-sm font-medium text-gray-700">Commentaire
                            (Optionnel)</label>
                        <textarea id="entry-comment" placeholder="ex: Arrivage fournisseur..." rows="3"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"></textarea>
                    </div>
                    <p id="entry-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="entry-submit-button"
                        class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Enregistrer l'entr√©e
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      MODAL "ENREGISTRER UNE SORTIE"
    -->
    <div id="exit-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Enregistrer une sortie</h2>
                <button id="close-exit-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <form id="exit-form">
                <div class="space-y-4">
                    <div>
                        <label for="exit-product-select" class="block text-sm font-medium text-gray-700">Produit
                            *</label>
                        <select id="exit-product-select"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                            <option value="">S√©lectionnez un produit</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>
                    <div>
                        <label for="exit-quantity" class="block text-sm font-medium text-gray-700">Quantit√© *</label>
                        <input type="number" id="exit-quantity" placeholder="0" min="1"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                    </div>
                    <div>
                        <label for="exit-comment" class="block text-sm font-medium text-gray-700">Commentaire
                            (Optionnel)</label>
                        <textarea id="exit-comment" placeholder="ex: Transfert vers boutique..." rows="3"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"></textarea>
                    </div>
                    <p id="exit-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="exit-submit-button"
                        class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Enregistrer la sortie
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      MODAL "TRANSF√âRER UN ARTICLE DEPUIS LE MAGASIN"
    -->
    <div id="transfer-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Transf√©rer un article depuis le Magasin</h2>
                <button id="close-transfer-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <form id="transfer-form">
                <div class="space-y-4">
                    <div>
                        <label for="transfer-product-select" class="block text-sm font-medium text-gray-700">Article
                            Source (depuis le Magasin) *</label>
                        <select id="transfer-product-select"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                            <option value="">S√©lectionnez un article √† transf√©rer...</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>

                    <div id="transfer-source-info" class="hidden">
                        <h4 class="text-sm font-medium text-gray-700">Informations de l'article source</h4>
                        <p class="mt-1 p-3 bg-gray-100 rounded-lg text-sm text-gray-600">
                            Co√ªt d'achat: <span id="transfer-cost-display" class="font-semibold">0 CFA</span>
                        </p>
                    </div>

                    <div>
                        <label for="transfer-selling-price" class="block text-sm font-medium text-gray-700">Prix de
                            Vente (pour la Boutique) *</label>
                        <input type="number" id="transfer-selling-price" placeholder="110000" min="0"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="transfer-quantity" class="block text-sm font-medium text-gray-700">Stock √†
                                Transf√©rer *</label>
                            <input type="number" id="transfer-quantity" placeholder="1" min="1"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                                required>
                        </div>
                        <div>
                            <label for="transfer-alert-threshold" class="block text-sm font-medium text-gray-700">Seuil
                                d'alerte</label>
                            <input type="number" id="transfer-alert-threshold" placeholder="10" value="10" min="0"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400">
                        </div>
                    </div>

                    <div id="transfer-stock-warning"
                        class="hidden flex items-center p-3 bg-yellow-100 border border-yellow-200 rounded-lg">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-yellow-700">Cette valeur doit √™tre inf√©rieure ou √©gale √† X.</p>
                    </div>

                    <p class="text-xs text-gray-500">
                        Si un article de boutique li√© √† cette source existe d√©j√†, le stock sera fusionn√©. Sinon, un
                        nouvel article sera cr√©√©.
                    </p>

                    <p id="transfer-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="transfer-submit-button"
                        class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Transf√©rer et Cr√©er/Mettre √† jour l'article
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      MODAL "R√âAPPROVISIONNER UN ARTICLE"
    -->
    <div id="restock-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">R√©approvisionner un article</h2>
                <button id="close-restock-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <form id="restock-form">
                <div class="space-y-4">
                    <div>
                        <label for="restock-product-select" class="block text-sm font-medium text-gray-700">Produit de
                            la Boutique *</label>
                        <select id="restock-product-select"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                            <option value="">S√©lectionnez un produit √† r√©approvisionner</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>

                    <div id="restock-source-info" class="hidden">
                        <h4 class="text-sm font-medium text-gray-700">Article Source</h4>
                        <p class="mt-1 p-3 bg-gray-100 rounded-lg text-sm text-gray-600">
                            <span id="restock-source-name" class="font-semibold"></span>
                            (Stock magasin disponible: <span id="restock-source-stock" class="font-semibold">0</span>)
                        </p>
                    </div>

                    <div>
                        <label for="restock-quantity" class="block text-sm font-medium text-gray-700">Quantit√© √† Ajouter
                            (depuis le Magasin) *</label>
                        <input type="number" id="restock-quantity" placeholder="1" min="1"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                    </div>

                    <div id="restock-stock-warning"
                        class="hidden flex items-center p-3 bg-yellow-100 border border-yellow-200 rounded-lg">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-yellow-700">Cette valeur doit √™tre inf√©rieure ou √©gale √† X.</p>
                    </div>

                    <div>
                        <label for="restock-comment" class="block text-sm font-medium text-gray-700">Commentaire
                            (Optionnel)</label>
                        <textarea id="restock-comment" placeholder="ex: R√©approvisionnement hebdomadaire" rows="3"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"></textarea>
                    </div>
                    <p id="restock-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="restock-submit-button"
                        class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Confirmer le r√©approvisionnement
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      TOAST DE SUCC√àS GLOBAL
    -->
    <div id="success-toast" class="fixed bottom-5 right-5 z-50">
        <div class="flex items-center bg-green-500 text-white text-sm font-medium px-4 py-3 rounded-lg shadow-lg">
            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="success-toast-message">Op√©ration r√©ussie!</span>
        </div>
    </div>



    <!-- jsPDF Libraries for Invoice Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script type="module">
        // --- SDK Firebase ---
        import { initializeApp } from "firebase/app";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "firebase/auth";
        import {
            getDatabase,
            ref,
            set,
            push,
            onValue,
            off,
            update,
            query,
            orderByChild,
            equalTo,
            get,
            remove
        } from "firebase/database";

        // --- GESTION DES IC√îNES SVG ---
        function getIconSVG(name, className = '') {
            const icons = {
                logo: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4 6.5V17.5L12 22L20 17.5V6.5L12 2ZM11 15.5V10.5H13V15.5H11ZM11.5 8.5C10.67 8.5 10 7.83 10 7C10 6.17 10.67 5.5 11.5 5.5C12.33 5.5 13 6.17 13 7C13 7.83 12.33 8.5 11.5 8.5Z" /></svg>`,
                dashboard: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>`,
                sales: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>`,
                box: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>`,
                stats: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>`,
                settings: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`,
                logout: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>`,
                chartBar: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-4m3 4v-2m3 2v-6m3 2V7" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 20h14" /></svg>`,
                trash: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`,
                arrowUp: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>`,
                arrowDown: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`,
                menu: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>`,
                arrowLeft: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>`,
                arrowRight: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>`
            };
            const svg = icons[name] || '';
            if (className && svg) {
                return svg.replace('<svg', `<svg class="${className}"`);
            }
            return svg;
        }

        function renderIcons() {
            document.querySelectorAll('[data-icon]').forEach(element => {
                const iconName = element.getAttribute('data-icon');
                // Pass the placeholder's class directly to the SVG generator
                const svgString = getIconSVG(iconName, element.className);
                if (svgString) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = svgString.trim();
                    const svgElement = tempDiv.firstChild;
                    if (svgElement) {
                        element.replaceWith(svgElement);
                    }
                }
            });
        }
        renderIcons();

        // --- GESTION DE L'APPLICATION ---

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyB65Iye8YMpxXsPthdBYmNojBMpaTPZS3A",
                authDomain: "gestion-stock-c9484.firebaseapp.com",
                databaseURL: "https://gestion-stock-c9484-default-rtdb.firebaseio.com",
                projectId: "gestion-stock-c9484",
                storageBucket: "gestion-stock-c9484.firebasestorage.app",
                messagingSenderId: "834033352449",
                appId: "1:834033352449:web:b86ff5b60c816bb469e500",
                measurementId: "G-5VKP3S88F8"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getDatabase(app);

            let isAuthenticated = false;
            let currentPage = 'Tableau de bord';
            let isLoginView = true;
            let currentUser = null;
            let currentUserData = null;
            let dbBasePath = '';

            const appData = { storeProducts: {}, shopStock: {}, salesHistory: {} };
            let isSidebarOpen = false;
            let isSidebarCollapsed = false;
            let isCodeLoginMode = false;
            let isCodeSession = false;


            let storeProductsListener, storeMovementsListener, shopStockListener, shopMovementsListener, salesHistoryListener, companyMembersListener;
            let storeProductsRef, storeMovementsRef, shopStockRef, shopMovementsRef, salesHistoryRef, companyMembersRef;

            const accessModules = ['Tableau de bord', 'Ventes', 'Stock Boutique', 'Mon Magasin', 'Statistiques', 'Param√®tres', 'Supprimer Stock Boutique', 'Supprimer Stock Magasin'];
            let teamMembersState = [];

            // Cart state
            let cartItems = [];

            // R√©f√©rences DOM
            const authPageContainer = document.getElementById('auth-page-container');
            const layoutContainer = document.getElementById('layout-container');
            const logoutButton = document.getElementById('logout-button');
            const navButtons = document.querySelectorAll('.nav-button');
            const pageContents = document.querySelectorAll('.page-content');
            const authToggleLogin = document.getElementById('auth-toggle-login');
            const authToggleSignup = document.getElementById('auth-toggle-signup');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const userEmailDisplay = document.getElementById('user-email-display');
            const userNameDisplay = document.getElementById('user-name-display');
            const userCompanyDisplay = document.getElementById('user-company-display');
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error');
            const signupErrorContainer = document.getElementById('signup-error-container');
            const loginSubmitButton = document.getElementById('login-submit-button');
            const signupSubmitButton = document.getElementById('signup-submit-button');
            const loginPasswordInput = document.getElementById('password');
            const loginAccessCodeInput = document.getElementById('access-code');
            const loginPasswordField = document.getElementById('login-password-field');
            const loginAccessCodeField = document.getElementById('login-access-code-field');
            const loginModeAdminButton = document.getElementById('login-mode-admin');
            const loginModeCodeButton = document.getElementById('login-mode-code');

            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('main');
            const mobileHeader = document.getElementById('mobile-header');
            const mobilePageTitle = document.getElementById('mobile-page-title');
            const hamburgerButton = document.getElementById('hamburger-button');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebarCollapseToggle = document.getElementById('sidebar-collapse-toggle');

            const storeSearchInput = document.getElementById('store-search-input');
            const shopSearchInput = document.getElementById('shop-search-input');

            const storeProductsPlaceholder = document.getElementById('store-products-placeholder');
            const storeProductsTableContainer = document.getElementById('store-products-table-container');
            const storeProductsTbody = document.getElementById('store-products-tbody');
            const storeMovementsPlaceholder = document.getElementById('store-movements-placeholder');
            const storeMovementsTableContainer = document.getElementById('store-movements-table-container');
            const storeMovementsTbody = document.getElementById('store-movements-tbody');

            const shopStockPlaceholder = document.getElementById('shop-stock-placeholder');
            const shopStockTableContainer = document.getElementById('shop-stock-table-container');
            const shopStockTbody = document.getElementById('shop-stock-tbody');
            const shopMovementsPlaceholder = document.getElementById('shop-movements-placeholder');
            const shopMovementsTableContainer = document.getElementById('shop-movements-table-container');
            const shopMovementsTbody = document.getElementById('shop-movements-tbody');

            const salesForm = document.getElementById('sales-form');
            const salesProductSelect = document.getElementById('sales-product-select');
            const salesQuantityInput = document.getElementById('sales-quantity-input');
            const salesTotalAmount = document.getElementById('sales-total-amount');
            const sellerNameInput = document.getElementById('seller-name');
            const salesComment = document.getElementById('sales-comment');
            const salesError = document.getElementById('sales-error');
            const salesSubmitButton = document.getElementById('sales-submit-button');
            const invoiceButtonContainer = document.getElementById('invoice-button-container');
            const generateInvoiceButton = document.getElementById('generate-invoice-button');
            const salesHistoryPlaceholder = document.getElementById('sales-history-placeholder');
            const salesHistoryTableContainer = document.getElementById('sales-history-table-container');
            const salesHistoryTbody = document.getElementById('sales-history-tbody');

            // Cart elements
            const addToCartButton = document.getElementById('add-to-cart-button');
            const cartSection = document.getElementById('cart-section');
            const cartCount = document.getElementById('cart-count');
            const cartItemsTbody = document.getElementById('cart-items-tbody');
            const cartTotal = document.getElementById('cart-total');
            const validateCartButton = document.getElementById('validate-cart-button');
            const clearCartButton = document.getElementById('clear-cart-button');


            // Modals
            const openNewProductModalButton = document.getElementById('open-new-product-modal-button');
            const newProductModal = document.getElementById('new-product-modal');
            const closeNewProductModalButton = document.getElementById('close-new-product-modal-button');
            const newProductForm = document.getElementById('new-product-form');
            const newProductError = document.getElementById('new-product-error');
            const newProductSubmitButton = document.getElementById('new-product-submit-button');

            const openEntryModalButton = document.getElementById('open-entry-modal-button');
            const entryModal = document.getElementById('entry-modal');
            const closeEntryModalButton = document.getElementById('close-entry-modal-button');
            const entryForm = document.getElementById('entry-form');
            const entryProductSelect = document.getElementById('entry-product-select');
            const entryError = document.getElementById('entry-error');
            const entrySubmitButton = document.getElementById('entry-submit-button');

            const openExitModalButton = document.getElementById('open-exit-modal-button');
            const exitModal = document.getElementById('exit-modal');
            const closeExitModalButton = document.getElementById('close-exit-modal-button');
            const exitForm = document.getElementById('exit-form');
            const exitProductSelect = document.getElementById('exit-product-select');
            const exitError = document.getElementById('exit-error');
            const exitSubmitButton = document.getElementById('exit-submit-button');

            const openTransferModalButton = document.getElementById('open-transfer-modal-button');
            const transferModal = document.getElementById('transfer-modal');
            const closeTransferModalButton = document.getElementById('close-transfer-modal-button');
            const transferForm = document.getElementById('transfer-form');
            const transferProductSelect = document.getElementById('transfer-product-select');
            const transferSourceInfo = document.getElementById('transfer-source-info');
            const transferCostDisplay = document.getElementById('transfer-cost-display');
            const transferStockWarning = document.getElementById('transfer-stock-warning');
            const transferError = document.getElementById('transfer-error');
            const transferSubmitButton = document.getElementById('transfer-submit-button');

            const openRestockModalButton = document.getElementById('open-restock-modal-button');
            const restockModal = document.getElementById('restock-modal');
            const closeRestockModalButton = document.getElementById('close-restock-modal-button');
            const restockForm = document.getElementById('restock-form');
            const restockProductSelect = document.getElementById('restock-product-select');
            const restockSourceInfo = document.getElementById('restock-source-info');
            const restockSourceName = document.getElementById('restock-source-name');
            const restockSourceStock = document.getElementById('restock-source-stock');
            const restockStockWarning = document.getElementById('restock-stock-warning');
            const restockError = document.getElementById('restock-error');
            const restockSubmitButton = document.getElementById('restock-submit-button');

            const successToast = document.getElementById('success-toast');
            const successToastMessage = document.getElementById('success-toast-message');

            // Param√®tres & acc√®s
            const settingsRestrictedState = document.getElementById('settings-restricted-state');
            const settingsTabsWrapper = document.getElementById('settings-tabs-wrapper');
            const settingsTabButtons = document.querySelectorAll('.settings-tab-button');
            const settingsPanels = document.querySelectorAll('[data-settings-panel]');
            const settingsAdminBadge = document.getElementById('settings-admin-badge');
            const accessMembersTbody = document.getElementById('access-members-tbody');
            const accessAddMemberForm = document.getElementById('access-add-member-form');
            const accessMemberNameInput = document.getElementById('access-member-name');
            const accessMemberEmailInput = document.getElementById('access-member-email');
            const accessMemberRoleInput = document.getElementById('access-member-role');
            const accessTotalUsers = document.getElementById('access-total-users');
            const accessTotalAdmins = document.getElementById('access-total-admins');
            const accessTotalPending = document.getElementById('access-total-pending');

            function showSuccessToast(message) {
                if (successToastMessage) successToastMessage.textContent = message;
                if (successToast) {
                    successToast.classList.add('show');
                    setTimeout(() => successToast.classList.remove('show'), 3000);
                }
            }

            function formatCurrency(value, currency = 'XOF') {
                if (isNaN(value) || value === null) value = 0;
                const displayCurrency = currency.toUpperCase() === 'CFA' ? 'XOF' : currency;
                try {
                    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: displayCurrency, minimumFractionDigits: 0 }).format(value);
                } catch (e) {
                    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF', minimumFractionDigits: 0 }).format(value);
                }
            }

            function formatDateForDisplay(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(' √†', ',');
            }

            function generateAccessCode() {
                const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 8; i += 1) {
                    code += alphabet[Math.floor(Math.random() * alphabet.length)];
                }
                return code;
            }

            function getCurrentUserRole() {
                if (!isAuthenticated || !currentUserData) return 'invite';
                return (currentUserData.role || 'admin').toLowerCase();
            }

            function updateSettingsAccess() {
                const isAdmin = getCurrentUserRole() === 'admin';
                if (settingsRestrictedState) settingsRestrictedState.classList.toggle('hidden', isAdmin);
                if (settingsTabsWrapper) settingsTabsWrapper.classList.toggle('hidden', !isAdmin);
                if (settingsAdminBadge) settingsAdminBadge.textContent = `R√¥le : ${isAdmin ? 'Admin' : 'Acc√®s limit√©'}`;
            }

            function hasPermission(permission) {
                if (!isAuthenticated || !currentUserData) return false;
                // Admins have all permissions
                if (currentUserData.role === 'admin') return true;
                // Check if user has the specific permission
                return currentUserData.permissions?.includes(permission) || false;
            }

            // Mapping des pages aux permissions requises
            const pagePermissions = {
                'Tableau de bord': null, // Accessible √† tous
                'Ventes': 'Ventes',
                'Stock Boutique': 'Stock Boutique',
                'Mon Magasin': 'Mon Magasin',
                'Statistiques': 'Statistiques',
                'Param√®tres': 'admin-only' // Cas sp√©cial pour admin seulement
            };

            function canAccessPage(pageName) {
                if (!isAuthenticated || !currentUserData) {
                    console.log(`[canAccessPage] Not authenticated or no user data for page: ${pageName}`);
                    return false;
                }

                // Admins can access everything
                if (currentUserData.role === 'admin') {
                    console.log(`[canAccessPage] Admin access granted for page: ${pageName}`);
                    return true;
                }

                const requiredPermission = pagePermissions[pageName];
                console.log(`[canAccessPage] Checking page: ${pageName}, Required permission: ${requiredPermission}`);
                console.log(`[canAccessPage] User permissions:`, currentUserData.permissions);

                // Si null, la page est accessible √† tous
                if (requiredPermission === null) {
                    console.log(`[canAccessPage] Page accessible to all: ${pageName}`);
                    return true;
                }

                // Si 'admin-only', seuls les admins peuvent acc√©der
                if (requiredPermission === 'admin-only') {
                    console.log(`[canAccessPage] Admin-only page, access denied: ${pageName}`);
                    return false;
                }

                // Sinon, v√©rifier la permission
                const hasAccess = hasPermission(requiredPermission);
                console.log(`[canAccessPage] Access result for ${pageName}: ${hasAccess}`);
                return hasAccess;
            }


            function handleManualLogout() {
                isAuthenticated = false;
                isCodeSession = false;
                currentUser = null;
                currentUserData = null;
                dbBasePath = '';
                cleanupFirebaseListeners();
                updateUI();
            }

            // === DASHBOARD FUNCTIONS ===

            /**
             * Met √† jour toutes les statistiques du tableau de bord
             */
            function updateDashboardStats() {
                if (!isAuthenticated || !dbBasePath) return;

                // Ventes du jour
                const dailySales = calculateDailySales();
                const statDaily = document.getElementById('stat-daily-sales');
                if (statDaily) statDaily.textContent = dailySales.count;

                // Stock boutique
                const shopStockCount = Object.keys(appData.shopStock || {}).length;
                const statShop = document.getElementById('stat-shop-stock');
                if (statShop) statShop.textContent = `${shopStockCount} produit${shopStockCount > 1 ? 's' : ''}`;

                // Stock magasin
                const storeStockCount = Object.keys(appData.storeProducts || {}).length;
                const statStore = document.getElementById('stat-store-stock');
                if (statStore) statStore.textContent = `${storeStockCount} produit${storeStockCount > 1 ? 's' : ''}`;

                // Revenus du mois
                const monthlyRevenue = calculateMonthlyRevenue();
                const statRevenue = document.getElementById('stat-monthly-revenue');
                if (statRevenue) statRevenue.textContent = `${monthlyRevenue.toLocaleString()} FCFA`;

                // Alertes stock faible
                const lowStockCount = countLowStockAlerts();
                const statLowStock = document.getElementById('stat-low-stock');
                const badgeLowStock = document.getElementById('badge-low-stock');
                if (statLowStock) statLowStock.textContent = lowStockCount;
                if (badgeLowStock) {
                    if (lowStockCount > 0) {
                        badgeLowStock.classList.remove('hidden');
                    } else {
                        badgeLowStock.classList.add('hidden');
                    }
                }

                // B√©n√©fice du mois
                const monthlyProfit = calculateMonthlyProfit();
                const statProfit = document.getElementById('stat-monthly-profit');
                if (statProfit) statProfit.textContent = `${monthlyProfit.toLocaleString()} FCFA`;

                // Mettre √† jour les tendances
                updateTrendIndicators();

                // Mettre √† jour la timeline
                updateActivityTimeline();
            }

            /**
             * Calculer les ventes du jour
             */
            function calculateDailySales() {
                const sales = appData.salesHistory || {};
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let count = 0;
                let amount = 0;

                Object.values(sales).forEach(sale => {
                    const saleDate = new Date(sale.date);
                    saleDate.setHours(0, 0, 0, 0);
                    if (saleDate.getTime() === today.getTime()) {
                        count += sale.quantity || 0;
                        amount += sale.totalAmount || 0;
                    }
                });

                return { count, amount };
            }

            /**
             * Calculer les revenus du mois
             */
            function calculateMonthlyRevenue() {
                const sales = appData.salesHistory || {};
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                let total = 0;
                Object.values(sales).forEach(sale => {
                    const saleDate = new Date(sale.date);
                    if (saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear) {
                        total += sale.totalAmount || 0;
                    }
                });

                return total;
            }

            /**
             * Compter les produits en alerte stock faible
             */
            function countLowStockAlerts() {
                const shopStock = appData.shopStock || {};
                return Object.values(shopStock).filter(item =>
                    item.quantityInShop <= (item.alertThreshold || 5)
                ).length;
            }

            /**
             * Calculer le b√©n√©fice du mois
             */
            function calculateMonthlyProfit() {
                const sales = appData.salesHistory || {};
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                let profit = 0;
                Object.values(sales).forEach(sale => {
                    const saleDate = new Date(sale.date);
                    if (saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear) {
                        // Trouver le produit source pour le prix d'achat
                        const shopProduct = Object.values(appData.shopStock || {}).find(p => p.id === sale.shopProductId);
                        if (shopProduct) {
                            const storeProduct = appData.storeProducts[shopProduct.sourceProductId];
                            if (storeProduct) {
                                const costPrice = storeProduct.purchasePrice || 0;
                                const sellingPrice = sale.sellingPrice || 0;
                                profit += (sellingPrice - costPrice) * sale.quantity;
                            }
                        }
                    }
                });

                return Math.round(profit);
            }

            /**
             * Mettre √† jour les indicateurs de tendance
             */
            function updateTrendIndicators() {
                // Ventes du jour vs hier
                const dailySales = calculateDailySales();
                const yesterdaySales = calculateYesterdaySales();
                updateTrend('trend-daily-sales', dailySales.count, yesterdaySales.count, 'ventes');

                // Revenus du mois vs mois dernier
                const monthlyRevenue = calculateMonthlyRevenue();
                const lastMonthRevenue = calculateLastMonthRevenue();
                updateTrend('trend-monthly-revenue', monthlyRevenue, lastMonthRevenue, 'FCFA');

                // B√©n√©fice vs mois dernier
                const monthlyProfit = calculateMonthlyProfit();
                const lastMonthProfit = calculateLastMonthProfit();
                updateTrend('trend-monthly-profit', monthlyProfit, lastMonthProfit, 'FCFA');
            }

            /**
             * Mettre √† jour un indicateur de tendance
             */
            function updateTrend(elementId, current, previous, unit) {
                const element = document.getElementById(elementId);
                if (!element) return;

                if (previous === 0) {
                    element.innerHTML = '';
                    return;
                }

                const diff = current - previous;
                const percent = Math.abs((diff / previous) * 100).toFixed(1);
                const arrow = diff >= 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
                const color = diff >= 0 ? 'text-green-600' : 'text-red-600';
                const sign = diff >= 0 ? '+' : '';

                element.innerHTML = `<span class="${color} font-semibold">${arrow} ${sign}${percent}% vs periode precedente</span>`;
            }

            /**
             * Calculer les ventes d'hier
             */
            function calculateYesterdaySales() {
                const sales = appData.salesHistory || {};
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(0, 0, 0, 0);

                let count = 0;
                Object.values(sales).forEach(sale => {
                    const saleDate = new Date(sale.date);
                    saleDate.setHours(0, 0, 0, 0);
                    if (saleDate.getTime() === yesterday.getTime()) {
                        count += sale.quantity || 0;
                    }
                });

                return { count };
            }

            /**
             * Calculer les revenus du mois dernier
             */
            function calculateLastMonthRevenue() {
                const sales = appData.salesHistory || {};
                const now = new Date();
                const lastMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                const year = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();

                let total = 0;
                Object.values(sales).forEach(sale => {
                    const saleDate = new Date(sale.date);
                    if (saleDate.getMonth() === lastMonth && saleDate.getFullYear() === year) {
                        total += sale.totalAmount || 0;
                    }
                });

                return total;
            }

            /**
             * Calculer le b√©n√©fice du mois dernier
             */
            function calculateLastMonthProfit() {
                const sales = appData.salesHistory || {};
                const now = new Date();
                const lastMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                const year = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();

                let profit = 0;
                Object.values(sales).forEach(sale => {
                    const saleDate = new Date(sale.date);
                    if (saleDate.getMonth() === lastMonth && saleDate.getFullYear() === year) {
                        const shopProduct = Object.values(appData.shopStock || {}).find(p => p.id === sale.shopProductId);
                        if (shopProduct) {
                            const storeProduct = appData.storeProducts[shopProduct.sourceProductId];
                            if (storeProduct) {
                                const costPrice = storeProduct.purchasePrice || 0;
                                const sellingPrice = sale.sellingPrice || 0;
                                profit += (sellingPrice - costPrice) * sale.quantity;
                            }
                        }
                    }
                });

                return Math.round(profit);
            }

            /**
             * Mettre √† jour la timeline d'activit√©s
             */
            function updateActivityTimeline() {
                const container = document.getElementById('recent-activities');
                if (!container) return;

                // R√©cup√©rer les 5 derni√®res activit√©s (ventes + mouvements)
                const activities = [];

                // Ventes
                const sales = Object.values(appData.salesHistory || {});
                sales.forEach(sale => {
                    activities.push({
                        date: new Date(sale.date),
                        type: 'sale',
                        icon: 'üí∞',
                        text: `Vente : ${sale.quantity} ${sale.productName}`,
                        amount: sale.totalAmount
                    });
                });

                // Mouvements boutique
                const shopMovements = Object.values(appData.shopMovements || {}).filter(m => m.type === 'Entr√©e');
                shopMovements.forEach(move => {
                    activities.push({
                        date: new Date(move.date),
                        type: 'entry',
                        icon: 'üì¶',
                        text: `Entree stock : ${move.quantityChange} ${move.productName}`
                    });
                });

                // Trier par date et prendre les 5 derniers
                activities.sort((a, b) => b.date - a.date);
                const recentActivities = activities.slice(0, 5);

                if (recentActivities.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">Aucune activite pour le moment</p>';
                    return;
                }

                container.innerHTML = recentActivities.map(activity => {
                    const time = activity.date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    const amountText = activity.amount ? ` - ${activity.amount.toLocaleString()} FCFA` : '';
                    return `
                        <div class="flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                            <span class="text-2xl">${activity.icon}</span>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">${activity.text}${amountText}</p>
                                <p class="text-xs text-gray-500 mt-1">üïê ${time}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function setActiveSettingsTab(tabId = 'compte') {
                if (!settingsTabButtons.length) return;
                settingsTabButtons.forEach(button => {
                    const isActive = button.dataset.settingsTab === tabId;
                    button.classList.toggle('bg-cyan-500', isActive);
                    button.classList.toggle('text-white', isActive);
                    button.classList.toggle('text-gray-600', !isActive);
                });
                settingsPanels.forEach(panel => panel.classList.toggle('hidden', panel.dataset.settingsPanel !== tabId));
            }

            function updateLoginModeUI() {
                if (!loginPasswordField || !loginAccessCodeField) return;
                if (isCodeLoginMode) {
                    loginPasswordField.classList.add('hidden');
                    loginAccessCodeField.classList.remove('hidden');
                    if (loginPasswordInput) loginPasswordInput.required = false;
                    if (loginAccessCodeInput) {
                        loginAccessCodeInput.required = true;
                        loginAccessCodeInput.value = '';
                    }
                    if (loginModeAdminButton) {
                        loginModeAdminButton.classList.remove('bg-white', 'shadow', 'text-gray-800');
                        loginModeAdminButton.classList.add('text-gray-500', 'hover:text-gray-700');
                    }
                    if (loginModeCodeButton) {
                        loginModeCodeButton.classList.remove('text-gray-500', 'hover:text-gray-700');
                        loginModeCodeButton.classList.add('bg-white', 'shadow', 'text-gray-800');
                    }
                } else {
                    loginPasswordField.classList.remove('hidden');
                    loginAccessCodeField.classList.add('hidden');
                    if (loginPasswordInput) loginPasswordInput.required = true;
                    if (loginAccessCodeInput) loginAccessCodeInput.required = false;
                    if (loginModeCodeButton) {
                        loginModeCodeButton.classList.remove('bg-white', 'shadow', 'text-gray-800');
                        loginModeCodeButton.classList.add('text-gray-500', 'hover:text-gray-700');
                    }
                    if (loginModeAdminButton) {
                        loginModeAdminButton.classList.remove('text-gray-500', 'hover:text-gray-700');
                        loginModeAdminButton.classList.add('bg-white', 'shadow', 'text-gray-800');
                    }
                }
            }

            function ensureCurrentUserInTeam() {
                if (!currentUser) return;
                teamMembersState = teamMembersState.filter(member => !member.isCurrentUser);
                const name = currentUserData?.fullName || 'Utilisateur';
                const email = currentUser?.email || currentUserData?.email;
                teamMembersState.unshift({
                    id: currentUser.uid,
                    name,
                    email,
                    role: getCurrentUserRole(),
                    status: 'actif',
                    permissions: [...accessModules],
                    isCurrentUser: true,
                    accessCode: currentUserData?.accessCode || 'ADMIN'
                });
                if (currentUserData && teamMembersState.length) {
                    const normalizedEmail = currentUserData.email?.toLowerCase();
                    teamMembersState = teamMembersState.map(member => ({
                        ...member,
                        isCurrentUser: member.email?.toLowerCase() === normalizedEmail
                    }));
                }
                renderAccessMembers();
            }

            function renderAccessMembers() {
                if (!accessMembersTbody) return;
                if (!teamMembersState.length) {
                    accessMembersTbody.innerHTML = `<tr><td colspan="6" class="px-4 py-6 text-center text-gray-400">Aucun collaborateur pour le moment.</td></tr>`;
                } else {
                    const rows = teamMembersState.map(member => {
                        const permissionButtons = accessModules.map(module => {
                            const isActive = member.permissions?.includes(module);
                            const classes = `px-3 py-1 rounded-full border text-xs font-semibold mr-2 mb-2 inline-flex ${isActive ? 'bg-cyan-50 border-cyan-200 text-cyan-600' : 'bg-gray-100 border-gray-200 text-gray-500'}`;
                            return `<button type="button" data-member-id="${member.id}" data-permission="${module}" class="${classes}">${module}</button>`;
                        }).join('');
                        const accessCodeBlock = member.accessCode ? `
                            <div class="flex items-center gap-2">
                                <span class="font-mono text-sm text-gray-900">${member.accessCode}</span>
                                <button type="button" data-copy-code="${member.accessCode}" class="px-2 py-1 text-xs font-semibold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200">Copier</button>
                            </div>
                        ` : `<span class="text-xs text-gray-400">Non d√©fini</span>`;
                        const statusLabel = member.status === 'pending' ? 'Code partag√©' : 'Actif';
                        const actionCell = member.isCurrentUser ? `<span class="text-xs text-gray-400">Vous</span>` : `<button type="button" data-remove-member="${member.id}" class="text-sm text-red-500 hover:text-red-600 font-semibold">Retirer</button>`;
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    <p class="font-semibold text-gray-900">${member.fullName || member.name || '-'}</p>
                                    <p class="text-xs text-gray-400">${statusLabel}</p>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-500">${member.email || '-'}</td>
                                <td class="px-4 py-3">
                                    <select data-role-select="${member.id}" class="rounded-lg border-gray-200 focus:ring-cyan-400 focus:border-cyan-400 text-sm">
                                        <option value="admin" ${member.role === 'admin' ? 'selected' : ''}>Admin</option>
                                        <option value="manager" ${member.role === 'manager' ? 'selected' : ''}>Manager</option>
                                        <option value="vendeur" ${member.role === 'vendeur' ? 'selected' : ''}>Vendeur</option>
                                        <option value="consultation" ${member.role === 'consultation' ? 'selected' : ''}>Consultation</option>
                                    </select>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex flex-wrap">${permissionButtons}</div>
                                </td>
                                <td class="px-4 py-3">
                                    ${accessCodeBlock}
                                </td>
                                <td class="px-4 py-3 text-right">
                                    ${actionCell}
                                </td>
                            </tr>
                        `;
                    }).join('');
                    accessMembersTbody.innerHTML = rows;
                }
                if (accessTotalUsers) accessTotalUsers.textContent = teamMembersState.length;
                if (accessTotalAdmins) accessTotalAdmins.textContent = teamMembersState.filter(m => m.role === 'admin').length;
                if (accessTotalPending) accessTotalPending.textContent = teamMembersState.filter(m => m.status === 'pending').length;
            }

            function toggleMemberPermission(memberId, permission) {
                const member = teamMembersState.find(m => m.id === memberId);
                if (!member) return;
                member.permissions = member.permissions || [];
                if (permission === 'Param√®tres' && member.role !== 'admin') {
                    showSuccessToast("Seuls les administrateurs peuvent acc√©der aux param√®tres.");
                    return;
                }
                if (member.permissions.includes(permission)) {
                    member.permissions = member.permissions.filter(p => p !== permission);
                } else {
                    member.permissions.push(permission);
                }
                renderAccessMembers();
                saveMemberState(member);
                ensureCurrentUserInTeam();
            }

            function setMemberRole(memberId, role) {
                const member = teamMembersState.find(m => m.id === memberId);
                if (!member) return;
                member.role = role;
                if (role === 'admin' && !member.permissions.includes('Param√®tres')) {
                    member.permissions.push('Param√®tres');
                }
                if (role !== 'admin') {
                    member.permissions = member.permissions.filter(permission => permission !== 'Param√®tres');
                }
                renderAccessMembers();
                saveMemberState(member);
                ensureCurrentUserInTeam();
            }

            if (settingsTabButtons.length) {
                settingsTabButtons.forEach(button => button.addEventListener('click', () => setActiveSettingsTab(button.dataset.settingsTab)));
                setActiveSettingsTab('compte');
            }

            async function findMemberByEmailAndCode(email, code) {
                const companiesSnapshot = await get(ref(db, 'companies'));
                if (!companiesSnapshot.exists()) return null;
                const normalizedEmail = email.trim().toLowerCase();
                const normalizedCode = code.trim().toUpperCase();
                const companies = companiesSnapshot.val();
                for (const [companyId, companyData] of Object.entries(companies)) {
                    if (!companyData.members) continue;
                    for (const [memberId, memberData] of Object.entries(companyData.members)) {
                        if ((memberData.email || '').toLowerCase() === normalizedEmail && (memberData.accessCode || '').toUpperCase() === normalizedCode) {
                            return {
                                companyId,
                                companyName: companyData.name || '',
                                memberId,
                                member: memberData
                            };
                        }
                    }
                }
                return null;
            }

            async function handleAccessCodeLogin(email, code) {
                if (!email || !code) {
                    if (loginError) {
                        loginError.textContent = "Email et code requis.";
                        loginError.classList.remove('hidden');
                    }
                    return;
                }
                try {
                    const match = await findMemberByEmailAndCode(email, code);
                    if (!match) {
                        if (loginError) {
                            loginError.textContent = "Code d'acc√®s invalide.";
                            loginError.classList.remove('hidden');
                        }
                        return;
                    }
                    isAuthenticated = true;
                    isCodeSession = true;
                    currentUser = { email, uid: match.memberId };
                    currentUserData = {
                        uid: match.memberId,
                        email,
                        fullName: match.member.fullName || match.member.name || 'Collaborateur',
                        companyId: match.companyId,
                        companyName: match.companyName,
                        role: match.member.role || 'consultation',
                        accessCode: match.member.accessCode
                    };
                    dbBasePath = `companies/${match.companyId}`;
                    if (match.member.status !== 'actif') {
                        await update(ref(db, `${dbBasePath}/members/${match.memberId}`), { status: 'actif' });
                    }
                    setupFirebaseListeners();
                    if (sellerNameInput) sellerNameInput.value = currentUserData.fullName || email;
                    updateSettingsAccess();
                    updateUI();
                    showSuccessToast("Connexion r√©ussie !");
                } catch (error) {
                    if (loginError) {
                        loginError.textContent = "Impossible de v√©rifier ce code pour le moment.";
                        loginError.classList.remove('hidden');
                    }
                } finally {
                    if (loginSubmitButton) { loginSubmitButton.disabled = false; loginSubmitButton.textContent = "Se connecter"; }
                }
            }

            function saveMemberState(member) {
                if (!member || !member.id || !dbBasePath) return;
                const memberCopy = { ...member };
                delete memberCopy.isCurrentUser;
                set(ref(db, `${dbBasePath}/members/${member.id}`), memberCopy);
            }

            function deleteMember(memberId) {
                if (!dbBasePath || !memberId) return;
                remove(ref(db, `${dbBasePath}/members/${memberId}`));
            }

            function onCompanyMembersValue(snapshot) {
                const membersData = snapshot.val() || {};
                teamMembersState = Object.keys(membersData).map(key => ({
                    id: key,
                    ...membersData[key],
                }));
                ensureCurrentUserInTeam();
            }

            if (accessMembersTbody) {
                accessMembersTbody.addEventListener('click', (event) => {
                    const permissionButton = event.target.closest('button[data-permission]');
                    if (permissionButton) {
                        toggleMemberPermission(permissionButton.dataset.memberId, permissionButton.dataset.permission);
                        return;
                    }
                    const removeButton = event.target.closest('button[data-remove-member]');
                    if (removeButton) {
                        teamMembersState = teamMembersState.filter(member => member.id !== removeButton.dataset.removeMember || member.isCurrentUser);
                        renderAccessMembers();
                        deleteMember(removeButton.dataset.removeMember);
                        return;
                    }
                    const copyButton = event.target.closest('button[data-copy-code]');
                    if (copyButton) {
                        const code = copyButton.dataset.copyCode;
                        if (!code) return;
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(code).then(() => showSuccessToast('Code copi√© dans le presse-papiers'));
                        } else {
                            const tempInput = document.createElement('input');
                            tempInput.value = code;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            showSuccessToast('Code copi√©');
                        }
                    }
                });
                accessMembersTbody.addEventListener('change', (event) => {
                    const roleSelect = event.target.closest('select[data-role-select]');
                    if (roleSelect) setMemberRole(roleSelect.dataset.roleSelect, roleSelect.value);
                });
            }

            if (accessAddMemberForm) {
                accessAddMemberForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    if (!dbBasePath) {
                        showSuccessToast("Veuillez s√©lectionner une entreprise valide.");
                        return;
                    }
                    const name = accessMemberNameInput.value.trim();
                    const email = accessMemberEmailInput.value.trim();
                    const role = accessMemberRoleInput.value;
                    if (!name || !email) return;

                    const accessCode = generateAccessCode();
                    const basePermissions = role === 'consultation' ? ['Tableau de bord', 'Statistiques'] : ['Tableau de bord', 'Ventes', 'Stock Boutique'];

                    try {
                        const newMemberRef = push(ref(db, `${dbBasePath}/members`));
                        await set(newMemberRef, {
                            id: newMemberRef.key,
                            fullName: name,
                            email,
                            role,
                            status: 'pending',
                            permissions: role === 'admin' ? [...accessModules] : basePermissions,
                            accessCode,
                            createdAt: new Date().toISOString(),
                            invitedBy: currentUser?.email || 'admin'
                        });
                        accessAddMemberForm.reset();
                        showSuccessToast(`Collaborateur ajout√©. Code: ${accessCode}`);
                    } catch (error) {
                        console.error(error);
                        showSuccessToast("Impossible d'ajouter ce collaborateur pour le moment.");
                    }
                });
            }

            function populateStoreProductSelects() {
                const products = appData.storeProducts;
                const selects = [entryProductSelect, exitProductSelect, transferProductSelect];
                selects.forEach(select => {
                    if (!select) return;
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption.cloneNode(true));
                    if (products) {
                        Object.values(products).forEach(product => {
                            const option = document.createElement('option');
                            option.value = product.id;
                            option.textContent = `${product.name} (Actuellement : ${product.quantityInStore})`;
                            select.appendChild(option);
                        });
                    }
                });
            }

            function populateShopProductSelects() {
                const products = appData.shopStock;
                const selects = [restockProductSelect, salesProductSelect];
                selects.forEach(select => {
                    if (!select) return;
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption.cloneNode(true));
                    if (products) {
                        Object.values(products).forEach(product => {
                            const option = document.createElement('option');
                            option.value = product.id;
                            if (select.id === 'restock-product-select') option.textContent = `${product.name} (Actuellement : ${product.quantityInShop})`;
                            else option.textContent = `${product.name} (Stock: ${product.quantityInShop})`;
                            select.appendChild(option);
                        });
                    }
                });
            }

            function renderStoreProducts(searchTerm = '') {
                const products = appData.storeProducts;
                const normalizedSearch = searchTerm.toLowerCase();
                const filteredProducts = Object.values(products).filter(product =>
                    product.name?.toLowerCase().includes(normalizedSearch) || product.description?.toLowerCase().includes(normalizedSearch)
                );

                if (filteredProducts.length > 0) {
                    storeProductsPlaceholder.classList.add('hidden');
                    storeProductsTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedProducts = filteredProducts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    const canDelete = hasPermission('Supprimer Stock Magasin');
                    sortedProducts.forEach(product => {
                        const deleteButtonHtml = canDelete
                            ? `<button class="delete-icon text-gray-400 hover:text-red-500" data-type="store" data-product-id="${product.id}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>`
                            : `<span class="text-xs text-gray-400">Non autoris√©</span>`;
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.description || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-700">${product.quantityInStore}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(product.purchaseCost, product.currency)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    ${deleteButtonHtml}
                                </td>
                            </tr>`;
                    });
                    storeProductsTbody.innerHTML = html;
                } else {
                    storeProductsTableContainer.classList.add('hidden');
                    storeProductsPlaceholder.classList.remove('hidden');
                    storeProductsTbody.innerHTML = '';
                }
            }

            function onStoreMovementsValue(snapshot) {
                const movements = snapshot.val();
                if (movements) {
                    storeMovementsPlaceholder.classList.add('hidden');
                    storeMovementsTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedMovements = Object.values(movements).sort((a, b) => new Date(b.date) - new Date(a.date));
                    sortedMovements.forEach(move => {
                        const isEntry = move.type === 'Entr√©e';
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${move.productName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.type}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${isEntry ? 'text-green-600' : 'text-red-600'}">${isEntry ? '+' : '-'}${move.quantityChange}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.newStock}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.comment}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(move.date)}</td>
                            </tr>`;
                    });
                    storeMovementsTbody.innerHTML = html;
                } else {
                    storeMovementsPlaceholder.classList.remove('hidden');
                    storeMovementsTableContainer.classList.add('hidden');
                    storeMovementsTbody.innerHTML = '';
                }
            }

            function onStoreProductsValue(snapshot) {
                appData.storeProducts = snapshot.val() || {};
                populateStoreProductSelects();
                renderStoreProducts(storeSearchInput ? storeSearchInput.value : '');
                updateAllStats();
            }

            function renderShopStock(searchTerm = '') {
                const stock = appData.shopStock;
                const normalizedSearch = searchTerm.toLowerCase();
                const filteredStock = Object.values(stock).filter(item => item.name?.toLowerCase().includes(normalizedSearch));

                if (filteredStock.length > 0) {
                    shopStockPlaceholder.classList.add('hidden');
                    shopStockTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedStock = filteredStock.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    const canDelete = hasPermission('Supprimer Stock Boutique');
                    sortedStock.forEach(item => {
                        const isLowStock = item.quantityInShop <= item.alertThreshold;
                        const currency = appData.storeProducts[item.sourceProductId]?.currency || 'CFA';
                        const deleteButtonHtml = canDelete
                            ? `<button class="delete-icon text-gray-400 hover:text-red-500" data-type="shop" data-stock-id="${item.id}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>`
                            : `<span class="text-xs text-gray-400">Non autoris√©</span>`;
                        html += `
                            <tr class="hover:bg-gray-50 ${isLowStock ? 'bg-red-50' : ''}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${isLowStock ? 'text-red-600' : 'text-gray-700'}">${item.quantityInShop}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(item.sellingPrice, currency)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.alertThreshold}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    ${deleteButtonHtml}
                                </td>
                            </tr>`;
                    });
                    shopStockTbody.innerHTML = html;
                } else {
                    shopStockTableContainer.classList.add('hidden');
                    shopStockPlaceholder.classList.remove('hidden');
                    shopStockTbody.innerHTML = '';
                }
            }

            function onShopStockValue(snapshot) {
                appData.shopStock = snapshot.val() || {};
                populateShopProductSelects();
                renderShopStock(shopSearchInput ? shopSearchInput.value : '');
                updateDashboardStats();
                updateAllStats();
            }

            function onShopMovementsValue(snapshot) {
                const movements = snapshot.val();
                if (movements) {
                    shopMovementsPlaceholder.classList.add('hidden');
                    shopMovementsTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedMovements = Object.values(movements).sort((a, b) => new Date(b.date) - new Date(a.date));
                    sortedMovements.forEach(move => {
                        const isEntry = move.type === 'Entr√©e';
                        const userDisplay = move.userEmail ? move.userEmail.split('@')[0] : 'N/A';
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${move.productName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.type}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${isEntry ? 'text-green-600' : 'text-red-600'}">${isEntry ? '+' : '-'}${move.quantityChange}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.newStock}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.comment}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${userDisplay}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(move.date)}</td>
                            </tr>`;
                    });
                    shopMovementsTbody.innerHTML = html;
                } else {
                    shopMovementsPlaceholder.classList.remove('hidden');
                    shopMovementsTableContainer.classList.add('hidden');
                    shopMovementsTbody.innerHTML = '';
                }
            }

            function onSalesHistoryValue(snapshot) {
                appData.salesHistory = snapshot.val() || {};
                const sales = appData.salesHistory;
                if (sales && Object.keys(sales).length > 0) {
                    salesHistoryPlaceholder.classList.add('hidden');
                    salesHistoryTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedSales = Object.values(sales).sort((a, b) => new Date(b.date) - new Date(a.date));
                    sortedSales.forEach(sale => {
                        const shopItem = appData.shopStock[sale.shopProductId];
                        const currency = shopItem ? (appData.storeProducts[shopItem.sourceProductId]?.currency || 'CFA') : 'CFA';
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.productName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.sellerName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.quantity}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-700">${formatCurrency(sale.totalAmount, currency)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.comment}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(sale.date)}</td>
                            </tr>`;
                    });
                    salesHistoryTbody.innerHTML = html;
                } else {
                    salesHistoryPlaceholder.classList.remove('hidden');
                    salesHistoryTableContainer.classList.add('hidden');
                    salesHistoryTbody.innerHTML = '';
                }
                updateDashboardStats();
            }

            function setupFirebaseListeners() {
                cleanupFirebaseListeners();
                if (!dbBasePath) return;

                storeProductsRef = ref(db, `${dbBasePath}/storeProducts`);
                storeProductsListener = onValue(storeProductsRef, onStoreProductsValue);

                storeMovementsRef = ref(db, `${dbBasePath}/storeMovements`);
                storeMovementsListener = onValue(storeMovementsRef, onStoreMovementsValue);

                shopStockRef = ref(db, `${dbBasePath}/shopStock`);
                shopStockListener = onValue(shopStockRef, onShopStockValue);

                shopMovementsRef = ref(db, `${dbBasePath}/shopMovements`);
                shopMovementsListener = onValue(shopMovementsRef, onShopMovementsValue);

                salesHistoryRef = ref(db, `${dbBasePath}/salesHistory`);
                salesHistoryListener = onValue(salesHistoryRef, onSalesHistoryValue);

                companyMembersRef = ref(db, `${dbBasePath}/members`);
                companyMembersListener = onValue(companyMembersRef, onCompanyMembersValue);
            }

            function cleanupFirebaseListeners() {
                if (storeProductsListener && storeProductsRef) off(storeProductsRef, storeProductsListener);
                if (storeMovementsListener && storeMovementsRef) off(storeMovementsRef, storeMovementsListener);
                if (shopStockListener && shopStockRef) off(shopStockRef, shopStockListener);
                if (shopMovementsListener && shopMovementsRef) off(shopMovementsRef, shopMovementsListener);
                if (salesHistoryListener && salesHistoryRef) off(salesHistoryRef, salesHistoryListener);
                if (companyMembersListener && companyMembersRef) off(companyMembersRef, companyMembersListener);

                storeProductsListener = null; storeMovementsListener = null; shopStockListener = null; shopMovementsListener = null; salesHistoryListener = null; companyMembersListener = null;
                appData.storeProducts = {}; appData.shopStock = {}; appData.salesHistory = {};
            }

            function updateUI() {
                if (isAuthenticated) {
                    if (authPageContainer) authPageContainer.classList.add('hidden');
                    if (layoutContainer) layoutContainer.classList.remove('hidden');
                    if (currentUser && userEmailDisplay) userEmailDisplay.textContent = currentUser.email;
                    if (currentUserData) {
                        if (userNameDisplay) userNameDisplay.textContent = currentUserData.fullName || 'Utilisateur';
                        if (userCompanyDisplay) userCompanyDisplay.textContent = currentUserData.companyName || '';
                    }
                    if (mobilePageTitle) mobilePageTitle.textContent = currentPage;

                    // V√©rifier si l'utilisateur peut acc√©der √† la page actuelle
                    if (!canAccessPage(currentPage)) {
                        // Rediriger vers le tableau de bord si acc√®s refus√©
                        currentPage = 'Tableau de bord';
                        if (mobilePageTitle) mobilePageTitle.textContent = currentPage;
                    }
                } else {
                    if (authPageContainer) authPageContainer.classList.remove('hidden');
                    if (layoutContainer) layoutContainer.classList.add('hidden');
                }

                pageContents.forEach(page => {
                    if (page.id === `page-${currentPage.replace(/ /g, '-')}`) page.classList.remove('hidden');
                    else page.classList.add('hidden');
                });

                navButtons.forEach(button => {
                    const pageName = button.dataset.page;

                    // Masquer le bouton si l'utilisateur n'a pas acc√®s √† la page
                    if (!canAccessPage(pageName)) {
                        button.style.display = 'none';
                        return;
                    } else {
                        button.style.display = '';
                    }

                    // Mettre en surbrillance le bouton actif
                    if (button.dataset.page === currentPage) {
                        button.classList.add('bg-cyan-400', 'text-white', 'shadow');
                        button.classList.remove('text-gray-600', 'hover:bg-gray-100');
                    } else {
                        button.classList.remove('bg-cyan-400', 'text-white', 'shadow');
                        button.classList.add('text-gray-600', 'hover:bg-gray-100');
                    }
                });

                updateSettingsAccess();

                // Mettre √† jour les boutons d'actions rapides
                if (isAuthenticated && typeof updateQuickActionButtons === 'function') {
                    updateQuickActionButtons();
                }
            }

            function updateAuthFormView() {
                updateLoginModeUI();
                if (isLoginView) {
                    if (loginForm) loginForm.classList.remove('hidden');
                    if (signupForm) signupForm.classList.add('hidden');
                    if (authToggleLogin) authToggleLogin.classList.add('bg-white', 'shadow', 'text-gray-800');
                    if (authToggleSignup) authToggleSignup.classList.remove('bg-white', 'shadow', 'text-gray-800');
                } else {
                    if (loginForm) loginForm.classList.add('hidden');
                    if (signupForm) signupForm.classList.remove('hidden');
                    if (authToggleSignup) authToggleSignup.classList.add('bg-white', 'shadow', 'text-gray-800');
                    if (authToggleLogin) authToggleLogin.classList.remove('bg-white', 'shadow', 'text-gray-800');
                }
            }

            function updateSalesTotal() {
                if (!salesProductSelect || !salesQuantityInput || !salesTotalAmount) return;
                const shopProductId = salesProductSelect.value;
                const quantity = parseInt(salesQuantityInput.value, 10);
                if (!shopProductId || isNaN(quantity) || quantity <= 0) {
                    salesTotalAmount.value = formatCurrency(0);
                    return;
                }
                const shopProduct = appData.shopStock[shopProductId];
                if (shopProduct) {
                    const total = shopProduct.sellingPrice * quantity;
                    const currency = appData.storeProducts[shopProduct.sourceProductId]?.currency;
                    salesTotalAmount.value = formatCurrency(total, currency);
                }
            }

            // --- FONCTIONS DE GESTION DU PANIER ---
            function addToCart() {
                const shopProductId = salesProductSelect.value;
                const quantity = parseInt(salesQuantityInput.value, 10);

                if (!shopProductId || isNaN(quantity) || quantity <= 0) {
                    if (salesError) {
                        salesError.textContent = "Veuillez s√©lectionner un produit et une quantit√© valide.";
                        salesError.classList.remove('hidden');
                        setTimeout(() => salesError.classList.add('hidden'), 3000);
                    }
                    return;
                }

                const shopProduct = appData.shopStock[shopProductId];
                if (!shopProduct) return;

                // V√©rifier si le produit est d√©j√† dans le panier
                const existingItemIndex = cartItems.findIndex(item => item.shopProductId === shopProductId);

                if (existingItemIndex !== -1) {
                    // Augmenter la quantit√© du produit existant
                    cartItems[existingItemIndex].quantity += quantity;
                } else {
                    // Ajouter un nouveau produit au panier
                    const currency = appData.storeProducts[shopProduct.sourceProductId]?.currency || 'CFA';
                    cartItems.push({
                        shopProductId,
                        name: shopProduct.name,
                        sellingPrice: shopProduct.sellingPrice,
                        quantity,
                        currency
                    });
                }

                // R√©initialiser le formulaire
                salesProductSelect.value = '';
                salesQuantityInput.value = '1';
                updateSalesTotal();

                // Mettre √† jour l'affichage du panier
                renderCart();
                showSuccessToast('Article ajout√© au panier');
            }

            function removeFromCart(index) {
                cartItems.splice(index, 1);
                renderCart();
                showSuccessToast('Article retir√© du panier');
            }

            function updateCartQuantity(index, newQty) {
                if (newQty <= 0) {
                    removeFromCart(index);
                } else {
                    cartItems[index].quantity = newQty;
                    renderCart();
                }
            }

            function calculateCartTotal() {
                return cartItems.reduce((total, item) => total + (item.sellingPrice * item.quantity), 0);
            }

            function renderCart() {
                if (cartItems.length === 0) {
                    cartSection.classList.add('hidden');
                    return;
                }

                cartSection.classList.remove('hidden');
                cartCount.textContent = cartItems.length;

                let html = '';
                cartItems.forEach((item, index) => {
                    const subtotal = item.sellingPrice * item.quantity;
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(item.sellingPrice, item.currency)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <div class="flex items-center gap-2">
                                    <button type="button" onclick="updateCartQuantity(${index}, ${item.quantity - 1})" class="text-gray-500 hover:text-gray-700">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9"></path>
                                        </svg>
                                    </button>
                                    <input type="number" value="${item.quantity}" min="1" 
                                        onchange="updateCartQuantity(${index}, parseInt(this.value))"
                                        class="w-16 text-center border border-gray-300 rounded px-2 py-1 text-sm">
                                    <button type="button" onclick="updateCartQuantity(${index}, ${item.quantity + 1})" class="text-gray-500 hover:text-gray-700">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-700">${formatCurrency(subtotal, item.currency)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button type="button" onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </td>
                        </tr>`;
                });

                cartItemsTbody.innerHTML = html;

                // Utiliser la devise du premier article pour le total
                const currency = cartItems[0]?.currency || 'CFA';
                const total = calculateCartTotal();
                cartTotal.textContent = formatCurrency(total, currency);
            }

            function clearCart() {
                if (cartItems.length === 0) return;

                if (confirm('Voulez-vous vraiment vider le panier ?')) {
                    cartItems = [];
                    renderCart();
                    showSuccessToast('Panier vid√©');
                }
            }

            async function validateCart() {
                if (!currentUser || !dbBasePath) return;
                if (cartItems.length === 0) {
                    alert('Le panier est vide !');
                    return;
                }

                // V√©rifier le stock disponible pour chaque article
                for (const item of cartItems) {
                    const shopProduct = appData.shopStock[item.shopProductId];
                    if (!shopProduct || item.quantity > shopProduct.quantityInShop) {
                        alert(`Stock insuffisant pour ${item.name}. Disponible: ${shopProduct?.quantityInShop || 0}`);
                        return;
                    }
                }

                try {
                    if (validateCartButton) validateCartButton.disabled = true;

                    const updates = {};
                    const now = new Date().toISOString();
                    const sellerName = currentUserData?.fullName || currentUser.email;
                    const comment = salesComment.value || "";

                    // Traiter chaque article du panier
                    for (const item of cartItems) {
                        const shopProduct = appData.shopStock[item.shopProductId];
                        const shopNewStock = shopProduct.quantityInShop - item.quantity;

                        // Mettre √† jour le stock de la boutique
                        updates[`${dbBasePath}/shopStock/${item.shopProductId}/quantityInShop`] = shopNewStock;

                        // Ajouter un mouvement de stock
                        const shopMoveKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                        updates[`${dbBasePath}/shopMovements/${shopMoveKey}`] = {
                            id: shopMoveKey,
                            shopProductId: item.shopProductId,
                            productName: item.name,
                            type: "Sortie",
                            quantityChange: item.quantity,
                            oldStock: shopProduct.quantityInShop,
                            newStock: shopNewStock,
                            comment: `Vente group√©e: ${comment}`,
                            date: now,
                            userEmail: currentUser.email
                        };

                        // Ajouter une vente √† l'historique
                        const saleKey = push(ref(db, `${dbBasePath}/salesHistory`)).key;
                        updates[`${dbBasePath}/salesHistory/${saleKey}`] = {
                            id: saleKey,
                            shopProductId: item.shopProductId,
                            productName: item.name,
                            quantity: item.quantity,
                            sellingPrice: item.sellingPrice,
                            totalAmount: item.sellingPrice * item.quantity,
                            sellerName,
                            comment,
                            date: now
                        };
                    }

                    await update(ref(db), updates);

                    const totalAmount = calculateCartTotal();
                    showSuccessToast(`Vente group√©e enregistr√©e ! Total: ${formatCurrency(totalAmount)}`);

                    // Pr√©parer les donn√©es pour la facture
                    const invoiceData = {
                        companyName: currentUserData?.companyName || 'Mon Entreprise',
                        sellerName,
                        date: now,
                        items: cartItems.map(item => ({
                            name: item.name,
                            quantity: item.quantity,
                            price: item.sellingPrice,
                            total: item.sellingPrice * item.quantity
                        })),
                        total: totalAmount,
                        currency: cartItems[0]?.currency || 'CFA',
                        comment
                    };

                    // Vider le panier et r√©initialiser le formulaire
                    cartItems = [];
                    renderCart();
                    salesComment.value = '';

                    // Afficher le bouton de g√©n√©ration de facture
                    showInvoiceButton(invoiceData);

                } catch (error) {
                    console.error(error);
                    alert('Une erreur est survenue lors de la validation de la vente');
                } finally {
                    if (validateCartButton) validateCartButton.disabled = false;
                }
            }

            // Exposer les fonctions pour les boutons et inputs inline
            window.addToCart = addToCart;
            window.removeFromCart = removeFromCart;
            window.updateCartQuantity = updateCartQuantity;
            window.clearCart = clearCart;
            window.validateCart = validateCart;


            // --- FONCTIONS DE G√âN√âRATION DE FACTURES PDF ---

            /**
             * Obtenir le prochain num√©ro de facture
             */
            async function getNextInvoiceNumber() {
                if (!dbBasePath) return 'FACT-0000-0001';

                const year = new Date().getFullYear();
                const counterPath = `${dbBasePath}/invoiceCounters/${year}`;

                try {
                    const snapshot = await get(ref(db, counterPath));
                    const currentCounter = snapshot.val() || 0;
                    const newCounter = currentCounter + 1;

                    // Incr√©menter le compteur dans Firebase
                    await set(ref(db, counterPath), newCounter);

                    // Format: FACT-2026-0001
                    const paddedNumber = String(newCounter).padStart(4, '0');
                    return `FACT-${year}-${paddedNumber}`;
                } catch (error) {
                    console.error('Erreur r√©cup√©ration num√©ro facture:', error);
                    return `FACT-${year}-0001`;
                }
            }

            /**
             * G√©n√©rer une facture PDF
             * @param {Object} invoiceData - Donn√©es de la facture
             */
            async function generateInvoicePDF(invoiceData) {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Obtenir le num√©ro de facture
                    const invoiceNumber = await getNextInvoiceNumber();

                    // Couleurs
                    const primaryColor = [6, 182, 212]; // Cyan
                    const darkGray = [31, 41, 55];
                    const lightGray = [243, 244, 246];

                    let yPos = 20;

                    // === EN-T√äTE ===
                    // Nom de l'entreprise
                    doc.setFillColor(...primaryColor);
                    doc.rect(0, 0, 210, 40, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(24);
                    doc.setFont(undefined, 'bold');
                    doc.text(invoiceData.companyName || 'Mon Entreprise', 20, 20);

                    // Titre FACTURE
                    doc.setFontSize(16);
                    doc.text('FACTURE', 150, 20);

                    // Num√©ro de facture
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text(`N¬∞ ${invoiceNumber}`, 150, 28);

                    // Date
                    const dateStr = new Date(invoiceData.date).toLocaleDateString('fr-FR');
                    doc.text(`Date: ${dateStr}`, 150, 35);

                    yPos = 50;

                    // === INFORMATIONS DE VENTE ===
                    doc.setTextColor(...darkGray);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('INFORMATIONS DE VENTE', 20, yPos);

                    yPos += 8;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Vendeur: ${invoiceData.sellerName}`, 20, yPos);

                    yPos += 6;
                    const saleDateTime = new Date(invoiceData.date).toLocaleString('fr-FR');
                    doc.text(`Date et heure de vente: ${saleDateTime}`, 20, yPos);

                    yPos += 10;

                    // === TABLEAU DES PRODUITS ===
                    // Fonction ultra-simple pour √©viter les probl√®mes d'encodage
                    const formatPDFCurrency = (amount) => {
                        // Convertir en string et ajouter des espaces pour les milliers
                        const numStr = Math.round(amount).toString();
                        return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                    };

                    const tableData = invoiceData.items.map(item => [
                        item.name,
                        item.quantity.toString(),
                        formatPDFCurrency(item.price),
                        formatPDFCurrency(item.total)
                    ]);

                    doc.autoTable({
                        startY: yPos,
                        head: [['Produit', 'Quantite', 'Prix Unitaire', 'Total']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: {
                            fillColor: primaryColor,
                            textColor: [255, 255, 255],
                            fontStyle: 'bold',
                            fontSize: 10,
                            halign: 'center'
                        },
                        bodyStyles: {
                            fontSize: 9
                        },
                        columnStyles: {
                            0: { cellWidth: 60, halign: 'left' },
                            1: { cellWidth: 30, halign: 'center' },
                            2: { cellWidth: 45, halign: 'right' },
                            3: { cellWidth: 45, halign: 'right' }
                        },
                        margin: { left: 15, right: 15 },
                        tableWidth: 'auto'
                    });

                    yPos = doc.lastAutoTable.finalY + 10;

                    // === TOTAL ===
                    doc.setFillColor(...lightGray);
                    doc.rect(15, yPos, 180, 12, 'F');
                    doc.setTextColor(...darkGray);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('TOTAL:', 135, yPos + 8);
                    doc.text(formatPDFCurrency(invoiceData.total) + ' ' + invoiceData.currency, 185, yPos + 8, { align: 'right' });

                    yPos += 20;

                    // === COMMENTAIRE (si pr√©sent) ===
                    if (invoiceData.comment) {
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'italic');
                        doc.setTextColor(100, 100, 100);
                        doc.text('Commentaire:', 20, yPos);
                        yPos += 6;
                        const commentLines = doc.splitTextToSize(invoiceData.comment, 170);
                        doc.text(commentLines, 20, yPos);
                        yPos += (commentLines.length * 5) + 10;
                    }

                    // === PIED DE PAGE ===
                    doc.setFillColor(...primaryColor);
                    doc.rect(0, 270, 210, 27, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text('Merci pour votre achat !', 105, 280, { align: 'center' });
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text('Facture g√©n√©r√©e par StockPilot', 105, 287, { align: 'center' });

                    // Sauvegarder la facture dans Firebase
                    await saveInvoiceRecord(invoiceNumber, invoiceData);

                    // T√©l√©charger le PDF
                    doc.save(`Facture_${invoiceNumber}.pdf`);
                    showSuccessToast(`Facture ${invoiceNumber} g√©n√©r√©e !`);

                } catch (error) {
                    console.error('Erreur g√©n√©ration PDF:', error);
                    alert('Erreur lors de la g√©n√©ration de la facture');
                }
            }

            /**
             * Sauvegarder l'enregistrement de la facture dans Firebase
             */
            async function saveInvoiceRecord(invoiceNumber, invoiceData) {
                if (!dbBasePath) return;

                try {
                    const invoiceKey = push(ref(db, `${dbBasePath}/invoices`)).key;
                    await set(ref(db, `${dbBasePath}/invoices/${invoiceKey}`), {
                        id: invoiceKey,
                        invoiceNumber,
                        generatedAt: new Date().toISOString(),
                        saleData: invoiceData
                    });
                } catch (error) {
                    console.error('Erreur sauvegarde facture:', error);
                }
            }

            /**
             * G√©n√©rer une facture depuis l'historique des ventes
             */
            async function generateInvoiceFromSale(saleId) {
                const sale = appData.salesHistory[saleId];
                if (!sale) {
                    alert('Vente introuvable');
                    return;
                }

                // Pr√©parer les donn√©es de facture
                const invoiceData = {
                    companyName: currentUserData?.companyName || 'Mon Entreprise',
                    sellerName: sale.sellerName || currentUser?.email,
                    date: sale.date,
                    items: [{
                        name: sale.productName,
                        quantity: sale.quantity,
                        price: sale.sellingPrice,
                        total: sale.totalAmount
                    }],
                    total: sale.totalAmount,
                    currency: appData.storeProducts[appData.shopStock[sale.shopProductId]?.sourceProductId]?.currency || 'CFA',
                    comment: sale.comment || ''
                };

                await generateInvoicePDF(invoiceData);
            }

            /**
             * Afficher le bouton de g√©n√©ration de facture
             */
            let currentInvoiceData = null;

            function showInvoiceButton(invoiceData) {
                currentInvoiceData = invoiceData;

                if (invoiceButtonContainer) {
                    invoiceButtonContainer.classList.remove('hidden');

                    // Masquer automatiquement apr√®s 30 secondes
                    setTimeout(() => {
                        invoiceButtonContainer.classList.add('hidden');
                    }, 30000);
                }
            }

            /**
             * Masquer le bouton de g√©n√©ration de facture
             */
            function hideInvoiceButton() {
                if (invoiceButtonContainer) {
                    invoiceButtonContainer.classList.add('hidden');
                }
                currentInvoiceData = null;
            }

            // Exposer les fonctions pour les boutons
            window.generateInvoiceFromSale = generateInvoiceFromSale;



            function updateSidebarMobileState() {
                if (isSidebarOpen) {
                    sidebar.classList.remove('-translate-x-full');
                    sidebarOverlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                }
            }

            function updateSidebarDesktopState() {
                const sidebarTexts = document.querySelectorAll('.sidebar-text');
                if (isSidebarCollapsed) {
                    sidebar.classList.replace('w-64', 'lg:w-20');
                    mainContent.classList.replace('lg:ml-64', 'lg:ml-20');
                    sidebarTexts.forEach(el => el.classList.add('lg:hidden'));
                } else {
                    sidebar.classList.replace('lg:w-20', 'w-64');
                    mainContent.classList.replace('lg:ml-20', 'lg:ml-64');
                    sidebarTexts.forEach(el => el.classList.remove('lg:hidden'));
                }
            }

            // --- √âCOUTEURS POUR LA SUPPRESSION ---
            if (storeProductsTbody) {
                storeProductsTbody.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button.delete-icon');
                    if (btn && btn.dataset.productId) {
                        if (confirm('Supprimer ce produit du magasin d√©finitivement ?')) {
                            try {
                                await remove(ref(db, `${dbBasePath}/storeProducts/${btn.dataset.productId}`));
                                showSuccessToast('Produit supprim√© du magasin');
                            } catch (err) { console.error(err); }
                        }
                    }
                });
            }

            if (shopStockTbody) {
                shopStockTbody.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button.delete-icon');
                    if (btn && btn.dataset.stockId) {
                        if (confirm('Supprimer ce produit de la boutique ?')) {
                            try {
                                await remove(ref(db, `${dbBasePath}/shopStock/${btn.dataset.stockId}`));
                                showSuccessToast('Produit retir√© de la boutique');
                            } catch (err) { console.error(err); }
                        }
                    }
                });
            }

            // Event Listeners
            if (hamburgerButton) hamburgerButton.addEventListener('click', () => { isSidebarOpen = true; updateSidebarMobileState(); });
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', () => { isSidebarOpen = false; updateSidebarMobileState(); });
            if (sidebarCollapseToggle) sidebarCollapseToggle.addEventListener('click', () => { isSidebarCollapsed = !isSidebarCollapsed; updateSidebarDesktopState(); });
            if (authToggleLogin) authToggleLogin.addEventListener('click', () => { isLoginView = true; updateAuthFormView(); });
            if (authToggleSignup) authToggleSignup.addEventListener('click', () => { isLoginView = false; updateAuthFormView(); });
            if (loginModeAdminButton) loginModeAdminButton.addEventListener('click', () => { isCodeLoginMode = false; updateLoginModeUI(); });
            if (loginModeCodeButton) loginModeCodeButton.addEventListener('click', () => { isCodeLoginMode = true; updateLoginModeUI(); });
            if (salesProductSelect) salesProductSelect.addEventListener('change', updateSalesTotal);
            if (salesQuantityInput) salesQuantityInput.addEventListener('input', updateSalesTotal);

            // Cart event listeners
            if (addToCartButton) addToCartButton.addEventListener('click', addToCart);
            if (validateCartButton) validateCartButton.addEventListener('click', validateCart);
            if (clearCartButton) clearCartButton.addEventListener('click', clearCart);

            // Invoice generation button listener
            if (generateInvoiceButton) {
                generateInvoiceButton.addEventListener('click', async () => {
                    if (currentInvoiceData) {
                        await generateInvoicePDF(currentInvoiceData);
                        hideInvoiceButton();
                    }
                });
            }

            // Quick Actions buttons
            const quickActionButtons = document.querySelectorAll('[data-quick-action]');

            function setActivePage(pageName) {
                // V√©rifier les permissions avant de naviguer
                if (!canAccessPage(pageName)) {
                    alert(`Vous n'avez pas acc√®s √† la page "${pageName}".`);
                    return;
                }
                currentPage = pageName;
                updateUI();
            }

            function updateQuickActionButtons() {
                quickActionButtons.forEach(button => {
                    const targetPage = button.dataset.quickAction;
                    let canAccess = false;

                    // D√©terminer quelle page v√©rifier
                    if (targetPage === 'Reappro') {
                        canAccess = canAccessPage('Stock Boutique');
                    } else {
                        canAccess = canAccessPage(targetPage);
                    }

                    // Masquer le bouton si l'utilisateur n'a pas acc√®s
                    if (!canAccess) {
                        button.style.display = 'none';
                    } else {
                        button.style.display = '';
                    }
                });
            }

            quickActionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetPage = button.dataset.quickAction;
                    if (targetPage === 'Reappro') {
                        // V√©rifier l'acc√®s √† Stock Boutique
                        if (!canAccessPage('Stock Boutique')) {
                            alert('Vous n\'avez pas acc√®s au r√©approvisionnement.');
                            return;
                        }
                        // Naviguer vers Stock Boutique
                        setActivePage('Stock Boutique');
                        // Ouvrir le modal de r√©approvisionnement
                        setTimeout(() => {
                            const reapproButton = document.getElementById('open-restock-modal-button');
                            if (reapproButton) reapproButton.click();
                        }, 100);
                    } else {
                        setActivePage(targetPage);
                    }
                });
            });


            // Auth Logic
            if (loginForm) loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = loginForm.email.value.trim();
                if (isCodeLoginMode) {
                    const accessCode = loginAccessCodeInput.value.trim();
                    await handleAccessCodeLogin(email, accessCode);
                } else {
                    const password = loginPasswordInput.value;
                    try {
                        if (loginSubmitButton) loginSubmitButton.disabled = true;
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (error) {
                        if (loginError) {
                            loginError.textContent = "Email ou mot de passe incorrect.";
                            loginError.classList.remove('hidden');
                        }
                    } finally {
                        if (loginSubmitButton) loginSubmitButton.disabled = false;
                    }
                }
            });

            if (signupForm) signupForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = signupForm['signup-email'].value;
                const password = signupForm['signup-password'].value;
                const fullName = signupForm.fullName.value;
                const companyName = signupForm.companyName.value;

                try {
                    if (signupSubmitButton) signupSubmitButton.disabled = true;
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const companyId = push(ref(db, 'companies')).key;
                    await set(ref(db, `companies/${companyId}`), { name: companyName, createdAt: new Date().toISOString(), createdBy: user.uid });
                    const userData = { uid: user.uid, email, fullName, companyName, companyId, role: 'admin' };
                    await set(ref(db, `users/${user.uid}`), userData);
                    await set(ref(db, `companies/${companyId}/members/${user.uid}`), { fullName, email, role: 'admin', status: 'actif', permissions: [...accessModules] });
                } catch (error) {
                    if (signupError) {
                        signupError.textContent = error.message;
                        if (signupErrorContainer) signupErrorContainer.classList.remove('hidden');
                    }
                } finally {
                    if (signupSubmitButton) signupSubmitButton.disabled = false;
                }
            });

            if (salesForm) salesForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !dbBasePath) return;
                const shopProductId = salesProductSelect.value;
                const quantity = parseInt(salesQuantityInput.value, 10);
                const comment = salesComment.value || "";
                const sellerName = currentUserData?.fullName || currentUser.email;
                if (!shopProductId || isNaN(quantity) || quantity <= 0) return;
                const shopProduct = appData.shopStock[shopProductId];
                if (!shopProduct || quantity > shopProduct.quantityInShop) {
                    alert("Stock insuffisant !");
                    return;
                }

                try {
                    if (salesSubmitButton) salesSubmitButton.disabled = true;
                    const updates = {}; const now = new Date().toISOString();
                    const shopNewStock = shopProduct.quantityInShop - quantity;
                    updates[`${dbBasePath}/shopStock/${shopProductId}/quantityInShop`] = shopNewStock;
                    const shopMoveKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                    updates[`${dbBasePath}/shopMovements/${shopMoveKey}`] = { id: shopMoveKey, shopProductId, productName: shopProduct.name, type: "Sortie", quantityChange: quantity, oldStock: shopProduct.quantityInShop, newStock: shopNewStock, comment: `Vente: ${comment}`, date: now, userEmail: currentUser.email };
                    const saleKey = push(ref(db, `${dbBasePath}/salesHistory`)).key;
                    updates[`${dbBasePath}/salesHistory/${saleKey}`] = { id: saleKey, shopProductId, productName: shopProduct.name, quantity, sellingPrice: shopProduct.sellingPrice, totalAmount: shopProduct.sellingPrice * quantity, sellerName, comment, date: now };
                    await update(ref(db), updates);
                    showSuccessToast("Vente enregistr√©e!");

                    // Proposer de g√©n√©rer la facture
                    const currency = appData.storeProducts[shopProduct.sourceProductId]?.currency || 'CFA';
                    const invoiceData = {
                        companyName: currentUserData?.companyName || 'Mon Entreprise',
                        sellerName,
                        date: now,
                        items: [{
                            name: shopProduct.name,
                            quantity,
                            price: shopProduct.sellingPrice,
                            total: shopProduct.sellingPrice * quantity
                        }],
                        total: shopProduct.sellingPrice * quantity,
                        currency,
                        comment
                    };

                    salesForm.reset();
                    updateSalesTotal();

                    // Afficher le bouton de g√©n√©ration de facture
                    showInvoiceButton(invoiceData);

                } catch (error) {
                    console.error(error);
                } finally {
                    if (salesSubmitButton) salesSubmitButton.disabled = false;
                }
            });

            if (newProductForm) newProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !dbBasePath) return;
                const name = newProductForm['product-name'].value;
                const desc = newProductForm['product-description'].value;
                const cost = parseFloat(newProductForm['product-cost'].value);
                const currency = newProductForm['product-currency'].value;
                const qty = parseInt(newProductForm['product-quantity'].value, 10);
                if (!name || isNaN(cost)) return;

                try {
                    if (newProductSubmitButton) newProductSubmitButton.disabled = true;

                    // LOGIQUE D'AGR√âGATION AUTO (MAGASIN)
                    const existingProduct = Object.values(appData.storeProducts).find(p =>
                        p.name.toLowerCase() === name.trim().toLowerCase() && p.purchaseCost === cost
                    );

                    if (existingProduct) {
                        const newStock = existingProduct.quantityInStore + qty;
                        const updates = {};
                        const now = new Date().toISOString();
                        updates[`${dbBasePath}/storeProducts/${existingProduct.id}/quantityInStore`] = newStock;
                        const moveKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                        updates[`${dbBasePath}/storeMovements/${moveKey}`] = { id: moveKey, productId: existingProduct.id, productName: name, type: "Entr√©e", quantityChange: qty, oldStock: existingProduct.quantityInStore, newStock: newStock, comment: "Ajout automatique (m√™me prix)", date: now };
                        await update(ref(db), updates);
                        showSuccessToast("Stock mis √† jour pour le produit existant");
                    } else {
                        const newRef = push(ref(db, `${dbBasePath}/storeProducts`));
                        const newProd = { id: newRef.key, name: name.trim(), description: desc, purchaseCost: cost, currency, quantityInStore: qty, createdAt: new Date().toISOString() };
                        await set(newRef, newProd);
                        const moveRef = push(ref(db, `${dbBasePath}/storeMovements`));
                        await set(moveRef, { id: moveRef.key, productId: newProd.id, productName: name, type: "Entr√©e", quantityChange: qty, oldStock: 0, newStock: qty, comment: "Cr√©ation", date: new Date().toISOString() });
                        showSuccessToast("Produit ajout√©!");
                    }

                    newProductForm.reset();
                    newProductModal.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                } finally {
                    if (newProductSubmitButton) newProductSubmitButton.disabled = false;
                }
            });

            if (entryForm) entryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !dbBasePath) return;
                const pid = entryProductSelect.value;
                const qty = parseInt(entryForm['entry-quantity'].value, 10);
                const comment = entryForm['entry-comment'].value;
                const prod = appData.storeProducts[pid];
                if (!prod || qty <= 0) return;

                try {
                    if (entrySubmitButton) entrySubmitButton.disabled = true;
                    const newStock = prod.quantityInStore + qty;
                    const updates = {};
                    updates[`${dbBasePath}/storeProducts/${pid}/quantityInStore`] = newStock;
                    const moveKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                    updates[`${dbBasePath}/storeMovements/${moveKey}`] = { id: moveKey, productId: pid, productName: prod.name, type: "Entr√©e", quantityChange: qty, oldStock: prod.quantityInStore, newStock, comment, date: new Date().toISOString() };
                    await update(ref(db), updates);
                    showSuccessToast("Entr√©e de stock r√©ussie !");
                    entryForm.reset();
                    entryModal.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                } finally {
                    if (entrySubmitButton) entrySubmitButton.disabled = false;
                }
            });

            if (exitForm) exitForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !dbBasePath) return;
                const pid = exitProductSelect.value;
                const qty = parseInt(exitForm['exit-quantity'].value, 10);
                const comment = exitForm['exit-comment'].value;
                const prod = appData.storeProducts[pid];
                if (!prod || qty <= 0) return;
                if (qty > prod.quantityInStore) {
                    alert("Stock insuffisant dans le magasin.");
                    return;
                }

                try {
                    if (exitSubmitButton) exitSubmitButton.disabled = true;
                    const newStock = prod.quantityInStore - qty;
                    const updates = {};
                    updates[`${dbBasePath}/storeProducts/${pid}/quantityInStore`] = newStock;
                    const moveKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                    updates[`${dbBasePath}/storeMovements/${moveKey}`] = { id: moveKey, productId: pid, productName: prod.name, type: "Sortie", quantityChange: qty, oldStock: prod.quantityInStore, newStock, comment, date: new Date().toISOString() };
                    await update(ref(db), updates);
                    showSuccessToast("Sortie de stock r√©ussie !");
                    exitForm.reset();
                    exitModal.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                } finally {
                    if (exitSubmitButton) exitSubmitButton.disabled = false;
                }
            });

            if (transferForm) transferForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !dbBasePath) return;
                const sourceId = transferProductSelect.value;
                const qty = parseInt(transferForm['transfer-quantity'].value, 10);
                const price = parseFloat(transferForm['transfer-selling-price'].value);
                const alertT = parseInt(transferForm['transfer-alert-threshold'].value, 10) || 5;
                const sourceProd = appData.storeProducts[sourceId];
                if (!sourceProd || qty > sourceProd.quantityInStore) {
                    alert("Stock magasin insuffisant.");
                    return;
                }

                try {
                    if (transferSubmitButton) transferSubmitButton.disabled = true;

                    // LOGIQUE D'AGR√âGATION AUTO (BOUTIQUE) par NOM + PRIX
                    let existingItem = Object.values(appData.shopStock).find(i =>
                        i.name.toLowerCase() === sourceProd.name.toLowerCase() && i.sellingPrice === price
                    );

                    const updates = {}; const now = new Date().toISOString();
                    const storeNew = sourceProd.quantityInStore - qty;
                    const shopOld = existingItem ? existingItem.quantityInShop : 0;
                    const shopNew = shopOld + qty;

                    updates[`${dbBasePath}/storeProducts/${sourceId}/quantityInStore`] = storeNew;
                    const smKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                    updates[`${dbBasePath}/storeMovements/${smKey}`] = { id: smKey, productId: sourceId, productName: sourceProd.name, type: "Sortie", quantityChange: qty, oldStock: sourceProd.quantityInStore, newStock: storeNew, comment: "Transfert Boutique", date: now };

                    const shopId = existingItem ? existingItem.id : push(ref(db, `${dbBasePath}/shopStock`)).key;
                    updates[`${dbBasePath}/shopStock/${shopId}`] = { id: shopId, sourceProductId: sourceId, name: sourceProd.name, purchaseCost: sourceProd.purchaseCost, sellingPrice: price, quantityInShop: shopNew, alertThreshold: alertT, createdAt: existingItem ? existingItem.createdAt : now, updatedAt: now };

                    const shmKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                    updates[`${dbBasePath}/shopMovements/${shmKey}`] = { id: shmKey, shopProductId: shopId, productName: sourceProd.name, type: "Entr√©e", quantityChange: qty, oldStock: shopOld, newStock: shopNew, comment: existingItem ? "Fusion stock (m√™me prix)" : "Depuis magasin", date: now, userEmail: currentUser.email };

                    await update(ref(db), updates);
                    showSuccessToast(existingItem ? "Stock fusionn√© en boutique !" : "Transfert boutique r√©ussi !");
                    transferForm.reset();
                    transferModal.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                } finally {
                    if (transferSubmitButton) transferSubmitButton.disabled = false;
                }
            });

            if (restockForm) restockForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !dbBasePath) return;
                const sid = restockProductSelect.value;
                const qty = parseInt(restockForm['restock-quantity'].value, 10);
                const comment = restockForm['restock-comment'].value || "Restock";
                const shopProd = appData.shopStock[sid];
                if (!shopProd) return;
                const sourceProd = appData.storeProducts[shopProd.sourceProductId];
                if (!sourceProd || qty > sourceProd.quantityInStore) {
                    alert("Stock magasin insuffisant.");
                    return;
                }

                try {
                    if (restockSubmitButton) restockSubmitButton.disabled = true;
                    const updates = {}; const now = new Date().toISOString();
                    const storeNew = sourceProd.quantityInStore - qty;
                    const shopNew = shopProd.quantityInShop + qty;

                    updates[`${dbBasePath}/storeProducts/${sourceProd.id}/quantityInStore`] = storeNew;
                    const smKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                    updates[`${dbBasePath}/storeMovements/${smKey}`] = { id: smKey, productId: sourceProd.id, productName: sourceProd.name, type: "Sortie", quantityChange: qty, oldStock: sourceProd.quantityInStore, newStock: storeNew, comment: "R√©appro Boutique", date: now };

                    updates[`${dbBasePath}/shopStock/${sid}/quantityInShop`] = shopNew;
                    updates[`${dbBasePath}/shopStock/${sid}/updatedAt`] = now;
                    const shmKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                    updates[`${dbBasePath}/shopMovements/${shmKey}`] = { id: shmKey, shopProductId: sid, productName: shopProd.name, type: "Entr√©e", quantityChange: qty, oldStock: shopProd.quantityInShop, newStock: shopNew, comment: comment, date: now, userEmail: currentUser.email };

                    await update(ref(db), updates);
                    showSuccessToast("R√©approvisionnement r√©ussi !");
                    restockForm.reset();
                    restockModal.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                } finally {
                    if (restockSubmitButton) restockSubmitButton.disabled = false;
                }
            });

            // UI Navigation
            navButtons.forEach(btn => btn.addEventListener('click', () => {
                currentPage = btn.dataset.page;
                if (window.innerWidth < 1024) {
                    isSidebarOpen = false;
                    updateSidebarMobileState();
                }
                updateUI();
            }));

            if (logoutButton) logoutButton.addEventListener('click', () => {
                if (isCodeSession) {
                    handleManualLogout();
                    showSuccessToast('D√©connect√©');
                } else {
                    signOut(auth);
                }
            });

            // Delete event listeners with permission checks
            if (storeProductsTbody) {
                storeProductsTbody.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button.delete-icon');
                    if (btn && btn.dataset.productId) {
                        // Check permission
                        if (!hasPermission('Supprimer Stock Magasin')) {
                            alert('Vous n\'avez pas la permission de supprimer des produits du Stock Magasin.');
                            return;
                        }

                        if (confirm('Supprimer ce produit du magasin d√©finitivement ?')) {
                            try {
                                await remove(ref(db, `${dbBasePath}/storeProducts/${btn.dataset.productId}`));
                                showSuccessToast('Produit supprim√© du magasin');
                            } catch (err) {
                                console.error(err);
                                alert('Erreur lors de la suppression');
                            }
                        }
                    }
                });
            }

            if (shopStockTbody) {
                shopStockTbody.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button.delete-icon');
                    if (btn && btn.dataset.stockId) {
                        // Check permission
                        if (!hasPermission('Supprimer Stock Boutique')) {
                            alert('Vous n\'avez pas la permission de supprimer des produits du Stock Boutique.');
                            return;
                        }

                        if (confirm('Supprimer ce produit de la boutique ?')) {
                            try {
                                await remove(ref(db, `${dbBasePath}/shopStock/${btn.dataset.stockId}`));
                                showSuccessToast('Produit retir√© de la boutique');
                            } catch (err) {
                                console.error(err);
                                alert('Erreur lors de la suppression');
                            }
                        }
                    }
                });
            }


            // Modals Open
            if (openNewProductModalButton) openNewProductModalButton.addEventListener('click', () => { newProductModal.classList.remove('hidden'); newProductForm.reset(); });
            if (openEntryModalButton) openEntryModalButton.addEventListener('click', () => { entryModal.classList.remove('hidden'); entryForm.reset(); });
            if (openExitModalButton) openExitModalButton.addEventListener('click', () => { exitModal.classList.remove('hidden'); exitForm.reset(); });
            if (openTransferModalButton) openTransferModalButton.addEventListener('click', () => { transferModal.classList.remove('hidden'); transferForm.reset(); transferSourceInfo.classList.add('hidden'); });
            if (openRestockModalButton) openRestockModalButton.addEventListener('click', () => { restockModal.classList.remove('hidden'); restockForm.reset(); restockSourceInfo.classList.add('hidden'); });

            // Modals Close
            if (closeNewProductModalButton) closeNewProductModalButton.addEventListener('click', () => newProductModal.classList.add('hidden'));
            if (closeEntryModalButton) closeEntryModalButton.addEventListener('click', () => entryModal.classList.add('hidden'));
            if (closeExitModalButton) closeExitModalButton.addEventListener('click', () => exitModal.classList.add('hidden'));
            if (closeTransferModalButton) closeTransferModalButton.addEventListener('click', () => transferModal.classList.add('hidden'));
            if (closeRestockModalButton) closeRestockModalButton.addEventListener('click', () => restockModal.classList.add('hidden'));

            // Background Modal Close
            [newProductModal, entryModal, exitModal, transferModal, restockModal].forEach(m => {
                if (m) m.addEventListener('click', e => { if (e.target === m) m.classList.add('hidden'); });
            });

            // Select Interaction (Info display in modals)
            if (transferProductSelect) transferProductSelect.addEventListener('change', () => {
                const p = appData.storeProducts[transferProductSelect.value];
                if (p) {
                    transferCostDisplay.textContent = formatCurrency(p.purchaseCost, p.currency);
                    transferSourceInfo.classList.remove('hidden');
                } else {
                    transferSourceInfo.classList.add('hidden');
                }
            });

            if (restockProductSelect) restockProductSelect.addEventListener('change', () => {
                const si = appData.shopStock[restockProductSelect.value];
                if (si && appData.storeProducts[si.sourceProductId]) {
                    const sp = appData.storeProducts[si.sourceProductId];
                    restockSourceName.textContent = sp.name;
                    restockSourceStock.textContent = sp.quantityInStore;
                    restockSourceInfo.classList.remove('hidden');
                } else {
                    restockSourceInfo.classList.add('hidden');
                }
            });

            function updateAllStats() {
                const sales = Object.values(appData.salesHistory);
                const shopItems = Object.values(appData.shopStock);
                const storeItems = Object.values(appData.storeProducts);
                const now = new Date();
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();

                if (document.getElementById('stat-daily-sales'))
                    document.getElementById('stat-daily-sales').textContent = sales.filter(s => s.date >= startOfDay).length;

                if (document.getElementById('stat-monthly-revenue'))
                    document.getElementById('stat-monthly-revenue').textContent = formatCurrency(sales.filter(s => s.date >= startOfMonth).reduce((acc, s) => acc + s.totalAmount, 0));

                const shopCount = shopItems.reduce((acc, i) => acc + i.quantityInShop, 0);
                if (document.getElementById('stat-shop-stock'))
                    document.getElementById('stat-shop-stock').textContent = shopCount + " produits";

                if (document.getElementById('stat-store-stock'))
                    document.getElementById('stat-store-stock').textContent = storeItems.reduce((acc, i) => acc + i.quantityInStore, 0) + " produits";

                if (document.getElementById('stat-total-sales'))
                    document.getElementById('stat-total-sales').textContent = sales.length;

                if (document.getElementById('stat-revenue'))
                    document.getElementById('stat-revenue').textContent = formatCurrency(sales.reduce((acc, s) => acc + s.totalAmount, 0));

                if (document.getElementById('stat-products-in-stock'))
                    document.getElementById('stat-products-in-stock').textContent = shopItems.length;

                // Rendus statistiques (Top produits, etc)
                const bestSellingContainer = document.getElementById('best-selling-tbody');
                if (bestSellingContainer) {
                    const productSales = sales.reduce((acc, s) => { acc[s.productName] = (acc[s.productName] || 0) + s.quantity; return acc; }, {});
                    const sortedProd = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    bestSellingContainer.innerHTML = sortedProd.length ? sortedProd.map(([name, qty]) => `<tr class="hover:bg-gray-50"><td class="px-4 py-3 text-sm text-gray-800">${name}</td><td class="px-4 py-3 text-sm text-gray-600 font-bold">${qty}</td><td class="px-4 py-3"></td></tr>`).join('') : '';
                    if (sortedProd.length) {
                        document.getElementById('best-selling-placeholder')?.classList.add('hidden');
                        document.getElementById('best-selling-table-container')?.classList.remove('hidden');
                    }
                }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    isCodeSession = false;
                    isAuthenticated = true;
                    currentUser = user;
                    get(ref(db, `users/${user.uid}`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            currentUserData = snapshot.val();
                            currentUserData.role = currentUserData.role || 'admin';
                            if (sellerNameInput) sellerNameInput.value = currentUserData.fullName || user.email;
                            dbBasePath = currentUserData.companyId ? `companies/${currentUserData.companyId}` : `users/${user.uid}`;
                            setupFirebaseListeners();
                            ensureCurrentUserInTeam();
                            updateSettingsAccess();
                            updateUI();
                        }
                    });
                } else {
                    if (!isCodeSession) {
                        isAuthenticated = false; currentUser = null; currentUserData = null; dbBasePath = ''; currentPage = 'Tableau de bord'; cleanupFirebaseListeners(); updateUI();
                    }
                }
            });

            updateUI();
            updateAuthFormView();
        });
    </script>
</body>

</html>
