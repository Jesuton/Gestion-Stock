<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StockPilot</title>
    <!-- Chargement de TailwindCSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ajout de la police Inter pour une meilleure apparence */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Style pour l'icône de corbeille */
        .delete-icon:hover svg {
            color: #ef4444;
            /* text-red-500 */
        }

        /* Styles pour le Toast de Succès */
        #success-toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }

        #success-toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Style pour la transition du margin sur le main content */
        main {
            transition: margin-left 0.3s ease-in-out;
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "firebase/app": "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js",
    "react": "https://esm.sh/react@^19.2.4",
    "firebase/": "https://esm.sh/firebase@^12.8.0/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>

<body class="bg-gray-50">

    <!-- 
      CONTENEUR DE LA PAGE D'AUTHENTIFICATION
    -->
    <div id="auth-page-container">
        <div class="min-h-screen bg-gray-50 flex flex-col justify-center items-center p-4">
            <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
                <div class="flex flex-col items-center mb-6">
                    <div class="bg-cyan-100 text-cyan-500 p-3 rounded-lg mb-4">
                        <div data-icon="logo" class="w-8 h-8"></div>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">StockPilot</h1>
                    <p class="text-gray-500 mt-1">
                        Connectez-vous à votre compte ou créez-en un pour continuer.
                    </p>
                </div>

                <div class="w-full bg-gray-100 rounded-lg p-1 flex mb-6">
                    <button id="auth-toggle-login"
                        class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors bg-white shadow text-gray-800">
                        Se connecter
                    </button>
                    <button id="auth-toggle-signup"
                        class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors text-gray-500 hover:bg-gray-200">
                        S'inscrire
                    </button>
                </div>

                <!-- Formulaire de connexion (initialement visible) -->
                <form id="login-form">
                    <div class="space-y-4">
                        <div class="flex bg-gray-100 rounded-lg p-1 text-xs font-semibold">
                            <button type="button" id="login-mode-admin"
                                class="flex-1 px-3 py-2 rounded-md bg-white text-gray-800 shadow">Admin</button>
                            <button type="button" id="login-mode-code"
                                class="flex-1 px-3 py-2 rounded-md text-gray-500 hover:text-gray-700">Collaborateur</button>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="email">Email</label>
                            <input type="email" id="email" name="email"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                        </div>
                        <div id="login-password-field">
                            <label class="text-sm font-medium text-gray-600" for="password">Mot de passe</label>
                            <input type="password" id="password" name="password"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                        </div>
                        <div id="login-access-code-field" class="hidden">
                            <label class="text-sm font-medium text-gray-600" for="access-code">Code d'accès</label>
                            <input type="text" id="access-code" name="access-code" placeholder="Ex: Z4T7-9Q3S"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition uppercase tracking-widest" />
                            <p class="text-xs text-gray-500 mt-1">Demandez ce code à l'administrateur de votre
                                entreprise.</p>
                        </div>
                        <p id="login-error" class="text-red-500 text-sm mt-2 hidden"></p>
                        <!-- Ajout pour les erreurs -->
                        <button type="submit" id="login-submit-button"
                            class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                            Se connecter
                        </button>
                    </div>
                </form>

                <!-- Formulaire d'inscription (initialement caché) -->
                <form id="signup-form" class="hidden">
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="fullName">Nom complet</label>
                            <input type="text" id="fullName" name="fullName" placeholder="Jean Dupont"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="companyName">Nom de
                                l'entreprise</label>
                            <input type="text" id="companyName" name="companyName" placeholder="Ma Société"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                            <p class="text-xs text-gray-500 mt-1">Si le nom correspond à une entreprise existante, vous
                                la rejoindrez.</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="signup-email">Email</label>
                            <input type="email" id="signup-email" name="signup-email" placeholder="votre@email.com"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600" for="signup-password">Mot de passe</label>
                            <input type="password" id="signup-password" name="signup-password" placeholder="********"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                                required />
                        </div>
                        <div id="signup-error-container" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
                            <p id="signup-error" class="text-red-500 text-sm"></p>
                        </div>
                        <button type="submit" id="signup-submit-button"
                            class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                            Créer mon compte
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 
      CONTENEUR DE L'APPLICATION (LAYOUT)
      Initialement caché, sera affiché par JS après la connexion.
    -->
    <div id="layout-container" class="hidden">
        <!-- Overlay pour sidebar mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-64 bg-white shadow-md flex flex-col h-screen fixed top-0 left-0 z-40 transition-transform duration-300 ease-in-out -translate-x-full lg:translate-x-0 lg:transition-all">
            <div class="p-6 flex items-center space-x-3 border-b border-gray-200">
                <div class="bg-cyan-100 text-cyan-500 p-2 rounded-lg">
                    <div data-icon="logo" class="w-6 h-6"></div>
                </div>
                <h1 class="sidebar-text text-xl font-bold text-gray-800">StockPilot</h1>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <!-- Les boutons de navigation -->
                <button data-page="Tableau de bord"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-cyan-400 text-white shadow">
                    <div data-icon="dashboard" class="w-5 h-5"></div>
                    <span class="sidebar-text">Tableau de bord</span>
                </button>
                <button data-page="Ventes"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="sales" class="w-5 h-5"></div>
                    <span class="sidebar-text">Ventes</span>
                </button>
                <button data-page="Historique des ventes"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="stats" class="w-5 h-5"></div>
                    <span class="sidebar-text">Historique ventes</span>
                </button>
                <button data-page="Stock Boutique"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="box" class="w-5 h-5"></div>
                    <span class="sidebar-text">Stock Boutique</span>
                </button>
                <button data-page="Mon Magasin"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="box" class="w-5 h-5"></div>
                    <span class="sidebar-text">Mon Magasin</span>
                </button>
                <button data-page="Mouvements Magasin"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="clock" class="w-5 h-5"></div>
                    <span class="sidebar-text">Mouvements Magasin</span>
                </button>
                <button data-page="Statistiques"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="stats" class="w-5 h-5"></div>
                    <span class="sidebar-text">Statistiques</span>
                </button>
                <button data-page="Paramètres"
                    class="nav-button w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100">
                    <div data-icon="settings" class="w-5 h-5"></div>
                    <span class="sidebar-text">Paramètres</span>
                </button>
            </nav>
            <div class="p-4 border-t border-gray-200">
                <div class="sidebar-text p-4 mb-2 rounded-lg bg-gray-100">
                    <!-- Placeholder pour le profil utilisateur -->
                    <p id="user-name-display" class="text-sm font-medium text-gray-700">Utilisateur connecté</p>
                    <p id="user-company-display" class="text-xs text-gray-500 font-semibold truncate mt-1"></p>
                    <p id="user-email-display" class="text-xs text-gray-400 truncate">Chargement...</p>
                </div>
                <button id="logout-button"
                    class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">
                    <div data-icon="logout" class="w-5 h-5"></div>
                    <span class="sidebar-text">Déconnexion</span>
                </button>
            </div>
            <!-- Bouton pour réduire/agrandir la sidebar sur Desktop -->
            <div class="hidden lg:block absolute -right-3 top-20">
                <button id="sidebar-collapse-toggle"
                    class="bg-white border rounded-full p-1.5 shadow-md hover:bg-gray-100 transition-colors">
                    <div data-icon="arrowLeft" class="w-4 h-4 text-gray-600"></div>
                </button>
            </div>
        </aside>

        <!-- Contenu principal (pages) -->
        <main class="flex-1 lg:ml-64 overflow-y-auto h-screen">

            <!-- Header pour la vue mobile -->
            <header id="mobile-header"
                class="sticky top-0 bg-gray-50/75 backdrop-blur-sm z-10 p-4 border-b border-gray-200 flex items-center justify-between lg:hidden">
                <button id="hamburger-button" class="text-gray-500 hover:text-gray-800">
                    <div data-icon="menu" class="w-6 h-6"></div>
                </button>
                <h1 id="mobile-page-title" class="text-lg font-semibold text-gray-800">Tableau de bord</h1>
                <div class="w-6"></div> <!-- Spacer -->
            </header>

            <!-- Page: Tableau de bord -->
            <div id="page-Tableau-de-bord" class="page-content p-4 md:p-8">
                <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Tableau de bord</h1>
                        <p class="text-gray-500 mt-1">Vue d'ensemble de votre activité</p>
                    </div>
                    <div class="text-sm text-gray-500 lg:text-right">
                        <p>Dernière mise à jour</p>
                        <p id="dashboard-last-updated" class="font-semibold text-gray-900">—</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mt-6">
                    <div class="bg-white rounded-2xl border border-gray-100 p-5 shadow-sm flex flex-col justify-between">
                        <div class="flex items-center justify-between">
                            <div class="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center">
                                <div data-icon="dollar" class="w-6 h-6 text-blue-500"></div>
                            </div>
                            <span id="trend-monthly-revenue" class="text-xs font-semibold text-green-600"></span>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-500">Revenus du mois</p>
                            <p id="stat-monthly-revenue" class="text-2xl font-bold text-gray-900 mt-2">0 FCFA</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl border border-gray-100 p-5 shadow-sm flex flex-col justify-between">
                        <div class="flex items-center justify-between">
                            <div class="w-12 h-12 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
                                <div data-icon="sales" class="w-6 h-6 text-emerald-500"></div>
                            </div>
                            <span id="trend-monthly-orders" class="text-xs font-semibold text-green-600"></span>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-500">Commandes</p>
                            <p id="stat-orders" class="text-2xl font-bold text-gray-900 mt-2">0</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl border border-gray-100 p-5 shadow-sm flex flex-col justify-between">
                        <div class="flex items-center justify-between">
                            <div class="w-12 h-12 rounded-2xl bg-purple-50 text-purple-600 flex items-center justify-center">
                                <div data-icon="box" class="w-6 h-6 text-purple-500"></div>
                            </div>
                            <span id="trend-products-stock" class="text-xs font-semibold text-red-600"></span>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-500">Produits en stock</p>
                            <p id="stat-dashboard-products-in-stock" class="text-2xl font-bold text-gray-900 mt-2">0</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl border border-gray-100 p-5 shadow-sm flex flex-col justify-between">
                        <div class="flex items-center justify-between">
                            <div class="w-12 h-12 rounded-2xl bg-orange-50 text-orange-600 flex items-center justify-center">
                                <div data-icon="users" class="w-6 h-6 text-orange-500"></div>
                            </div>
                            <span id="trend-weekly-customers" class="text-xs font-semibold text-green-600"></span>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-500">Nouveaux clients</p>
                            <p id="stat-weekly-customers" class="text-2xl font-bold text-gray-900 mt-2">0</p>
                            <div class="mt-3 inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-gray-100 text-xs text-gray-600">
                                <span>Clients total</span>
                                <span id="stat-total-customers" class="font-semibold text-gray-900">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mt-6">
                    <div class="xl:col-span-2 bg-white rounded-2xl border border-gray-100 p-6 shadow-sm">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                            <div>
                                <h2 class="text-lg font-semibold text-gray-900">Ventes de la semaine</h2>
                                <p class="text-sm text-gray-500 mt-1">Évolution quotidienne</p>
                            </div>
                            <select id="dashboard-sales-range"
                                class="w-full sm:w-44 border border-gray-200 rounded-xl px-4 py-2 text-sm text-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                                <option>Cette semaine</option>
                            </select>
                        </div>
                        <div class="mt-6">
                            <div class="relative">
                                <svg id="dashboard-weekly-sales-chart" viewBox="0 0 700 260" class="w-full h-64">
                                    <g stroke="#E5E7EB" stroke-width="1">
                                        <line x1="60" y1="40" x2="660" y2="40" />
                                        <line x1="60" y1="90" x2="660" y2="90" />
                                        <line x1="60" y1="140" x2="660" y2="140" />
                                        <line x1="60" y1="190" x2="660" y2="190" />
                                        <line x1="60" y1="240" x2="660" y2="240" />
                                    </g>
                                    <g fill="#9CA3AF" font-size="12">
                                        <text id="dashboard-chart-max" x="10" y="44">0</text>
                                        <text id="dashboard-chart-mid" x="10" y="144">0</text>
                                        <text id="dashboard-chart-min" x="20" y="244">0</text>
                                    </g>
                                    <polyline id="dashboard-sales-line" fill="none" stroke="#3B82F6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" points="" />
                                    <g id="dashboard-sales-dots" fill="#3B82F6"></g>
                                    <polyline id="dashboard-orders-line" fill="none" stroke="#10B981" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" points="" />
                                    <g id="dashboard-orders-dots" fill="#10B981"></g>
                                    <line id="dashboard-chart-guide" x1="0" y1="40" x2="0" y2="240" stroke="#CBD5F5" stroke-width="1" class="hidden" />
                                    <g id="dashboard-hover-points"></g>
                                    <g fill="#6B7280" font-size="12">
                                        <text x="60" y="258">Lun</text>
                                        <text x="160" y="258">Mar</text>
                                        <text x="260" y="258">Mer</text>
                                        <text x="360" y="258">Jeu</text>
                                        <text x="460" y="258">Ven</text>
                                        <text x="560" y="258">Sam</text>
                                        <text x="650" y="258">Dim</text>
                                    </g>
                                </svg>
                                <div id="dashboard-chart-tooltip"
                                    class="absolute hidden rounded-xl border border-gray-200 bg-white px-4 py-3 text-xs text-gray-600 shadow-lg pointer-events-none z-10">
                                    <p id="dashboard-tooltip-day" class="text-sm font-semibold text-gray-900">—</p>
                                    <p id="dashboard-tooltip-sales" class="mt-2 text-blue-600">Ventes : 0</p>
                                    <p id="dashboard-tooltip-orders" class="mt-1 text-emerald-600">Commandes : 0</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-center gap-6 text-xs text-gray-500 mt-3">
                                <span class="inline-flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                                    Ventes (€)
                                </span>
                                <span class="inline-flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                                    Commandes
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-gray-100 p-6 shadow-sm">
                        <h2 class="text-lg font-semibold text-gray-900">Ventes par catégorie</h2>
                        <div class="mt-6 flex flex-col items-center gap-6">
                            <div id="dashboard-category-donut"
                                class="w-40 h-40 rounded-full"
                                style="background: conic-gradient(#3B82F6 0 45%, #10B981 45% 75%, #F59E0B 75% 90%, #8B5CF6 90% 100%);">
                            </div>
                            <div id="dashboard-category-legend" class="w-full space-y-3 text-sm text-gray-600"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mt-6">
                    <div class="bg-white rounded-2xl border border-gray-100 p-6 shadow-sm">
                        <h2 class="text-lg font-semibold text-gray-900">Produits les plus vendus</h2>
                        <div id="dashboard-top-products" class="mt-4 divide-y divide-gray-100"></div>
                        <div id="dashboard-top-products-empty" class="mt-6 text-sm text-gray-400 hidden">Aucune vente enregistrée.</div>
                    </div>
                    <div class="bg-white rounded-2xl border border-gray-100 p-6 shadow-sm">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-gray-900">Alertes de stock</h2>
                            <span id="dashboard-low-stock-count" class="text-xs font-semibold text-orange-600 bg-orange-50 px-2.5 py-1 rounded-full">0</span>
                        </div>
                        <div id="dashboard-stock-alerts" class="mt-4 space-y-3"></div>
                        <div id="dashboard-stock-alerts-empty" class="mt-6 text-sm text-gray-400 hidden">Aucune alerte de stock.</div>
                        <button type="button"
                            class="mt-6 w-full inline-flex items-center justify-center px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">
                            Commander des stocks
                        </button>
                    </div>
                </div>
            </div>

            <!-- Page: Ventes -->
            <div id="page-Ventes" class="page-content p-4 md:p-8 hidden">
                <div class="flex flex-col xl:flex-row gap-6">
                    <div class="flex-1 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                <div>
                                    <h1 class="text-2xl font-bold text-gray-900">Point de Vente</h1>
                                    <p class="text-sm text-gray-500 mt-1">Recherchez et ajoutez des produits à la facture.</p>
                                </div>
                                <span class="text-xs font-semibold px-3 py-1 rounded-full bg-cyan-50 text-cyan-700 border border-cyan-100">Stock Boutique</span>
                            </div>
                            <div class="mt-4 relative">
                                <input type="text" id="sales-product-search" placeholder="Rechercher un produit..."
                                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-cyan-500 focus:border-cyan-500" />
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </div>
                            <div id="sales-category-filters" class="mt-4 flex flex-wrap gap-2"></div>
                            <p id="sales-error" class="text-red-500 text-sm mt-3 hidden"></p>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <div id="sales-products-placeholder" class="flex flex-col items-center justify-center text-center text-gray-500 h-48">
                                <p>Aucun produit disponible.</p>
                            </div>
                            <div id="sales-products-container" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Cartes produits inserees par JS -->
                            </div>
                        </div>
                    </div>

                    <div class="xl:w-[360px] space-y-6">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                            <div class="p-6 border-b border-gray-100">
                                <h2 class="text-lg font-semibold text-gray-900">Facture en cours</h2>
                                <div class="mt-3 flex items-center gap-2 text-xs text-gray-500">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <span id="cart-items-count">0 article(s)</span>
                                </div>
                            </div>
                            <div class="p-6 border-b border-gray-100">
                                <p class="text-sm font-semibold text-gray-800">Client</p>
                                <input type="hidden" id="customer-id" />
                                <button id="open-customer-select-button"
                                    class="mt-3 w-full border-2 border-dashed border-gray-200 rounded-xl p-4 text-left hover:border-cyan-300 hover:bg-cyan-50/40 transition">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 rounded-full bg-cyan-50 text-cyan-600 flex items-center justify-center">
                                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M5.121 17.804A4 4 0 0112 15a4 4 0 016.879 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-semibold text-gray-800">Sélectionner / Ajouter un client</p>
                                            <p class="text-xs text-gray-500 mt-1">Optionnel - vente sans enregistrement possible</p>
                                        </div>
                                    </div>
                                </button>
                                <div id="customer-selected-card" class="mt-4 hidden p-4 rounded-lg border border-cyan-100 bg-cyan-50">
                                    <div class="flex items-start justify-between gap-3">
                                        <div>
                                            <p id="customer-selected-name" class="text-sm font-semibold text-gray-800">-</p>
                                            <p id="customer-selected-contact" class="text-xs text-gray-500">-</p>
                                        </div>
                                        <button id="change-customer-selection" class="text-xs font-semibold text-cyan-700 hover:text-cyan-900">Changer</button>
                                    </div>
                                    <div class="flex items-center gap-3 mt-3">
                                        <button id="customer-history-button" class="hidden text-xs font-semibold text-cyan-700 hover:text-cyan-900">Historique</button>
                                        <button id="clear-customer-selection" class="text-xs font-semibold text-gray-600 hover:text-gray-800">Vente sans client</button>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6">
                                <div id="cart-empty-state" class="flex flex-col items-center justify-center text-center text-gray-400 h-40">
                                    <svg class="w-14 h-14 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5m0 0L4 3m3 10l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <p class="mt-4 text-sm font-medium text-gray-500">Aucun article</p>
                                    <p class="text-xs text-gray-400">Sélectionnez des produits</p>
                                </div>
                                <div id="cart-items-list" class="hidden space-y-3"></div>
                                <div class="mt-5">
                                    <label for="hold-comment" class="text-xs font-semibold text-gray-500">Commentaire (mise en attente) *</label>
                                    <textarea id="hold-comment" rows="2" placeholder="Ex: Client revient à 16h"
                                        class="mt-2 w-full rounded-xl border border-gray-200 p-3 text-sm focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"></textarea>
                                    <p id="hold-comment-error" class="text-xs text-red-500 mt-2 hidden"></p>
                                </div>
                            </div>
                            <div class="p-6 border-t border-gray-100 space-y-3 bg-gray-50/60">
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span class="font-semibold">Appliquer la TVA (20%)</span>
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="tax-toggle-sales" class="sr-only peer" checked>
                                        <span
                                            class="w-12 h-6 bg-gray-200 rounded-full peer peer-checked:bg-cyan-500 relative transition">
                                            <span
                                                class="absolute top-0.5 left-1 w-5 h-5 bg-white rounded-full shadow transition-all peer-checked:translate-x-6"></span>
                                        </span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between text-sm text-gray-600">
                                    <span>Sous-total</span>
                                    <span id="cart-subtotal">0 FCFA</span>
                                </div>
                                <div id="cart-tax-row" class="flex items-center justify-between text-sm text-gray-400">
                                    <span>TVA (20%)</span>
                                    <span id="cart-tax">0 FCFA</span>
                                </div>
                                <div class="flex items-center justify-between text-base font-semibold text-gray-900 border-t border-gray-200 pt-3">
                                    <span>Total</span>
                                    <span id="cart-total" class="text-lg text-cyan-600">0 FCFA</span>
                                </div>
                                <button id="validate-cart-button"
                                    class="w-full py-3 bg-gray-300 text-white font-semibold rounded-xl shadow-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed">
                                    Valider la vente
                                </button>
                                <button id="generate-invoice-button"
                                    class="w-full py-3 bg-gray-300 text-white font-semibold rounded-xl shadow-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed">
                                    Générer la facture
                                </button>
                                <button id="pay-later-button"
                                    class="w-full py-3 bg-gray-300 text-white font-semibold rounded-xl shadow-sm transition-colors disabled:opacity-60 disabled:cursor-not-allowed">
                                    A payer plus tard
                                </button>
                                <button id="hold-cart-button"
                                    class="w-full py-3 border border-gray-200 bg-white text-gray-700 font-semibold rounded-xl hover:bg-gray-100 transition-colors disabled:opacity-60 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-400">
                                    Mettre en attente
                                </button>
                            </div>
                        </div>

                        <div id="customer-history-section" class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 hidden">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                <div>
                                    <h2 class="text-xl font-bold text-gray-800">Historique client</h2>
                                    <p id="customer-history-subtitle" class="text-sm text-gray-500 mt-1"></p>
                                </div>
                                <div class="text-xs font-semibold text-gray-500">Achats recents</div>
                            </div>
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="p-4 rounded-lg bg-gray-50 border border-gray-100">
                                    <p class="text-xs uppercase text-gray-400">Total achats</p>
                                    <p id="customer-history-total" class="text-2xl font-semibold text-gray-800">0 FCFA</p>
                                </div>
                                <div class="p-4 rounded-lg bg-gray-50 border border-gray-100">
                                    <p class="text-xs uppercase text-gray-400">Nombre d'achats</p>
                                    <p id="customer-history-count" class="text-2xl font-semibold text-gray-800">0</p>
                                </div>
                                <div class="p-4 rounded-lg bg-gray-50 border border-gray-100">
                                    <p class="text-xs uppercase text-gray-400">Dernier achat</p>
                                    <p id="customer-history-last" class="text-sm font-semibold text-gray-800">-</p>
                                </div>
                            </div>
                            <div class="mt-6">
                                <div id="customer-history-placeholder" class="flex flex-col items-center justify-center text-center text-gray-500 h-24">
                                    <p>Aucun achat pour ce client.</p>
                                </div>
                                <div id="customer-history-table-container" class="hidden overflow-x-auto rounded-lg border border-gray-200">
                                    <table class="min-w-full bg-white divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Articles</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendeur</th>
                                            </tr>
                                        </thead>
                                        <tbody id="customer-history-tbody" class="divide-y divide-gray-200">
                                            <!-- Historique client insere par JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Page: Historique des ventes -->
            <div id="page-Historique-des-ventes" class="page-content p-4 md:p-8 hidden">
                <div class="flex flex-col gap-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">Historique des ventes</h1>
                            <p class="text-gray-500 mt-1">Gérez toutes vos ventes et factures</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-3">
                            <label class="inline-flex items-center gap-3 text-sm text-gray-600 font-semibold">
                                TVA (20%)
                                <span class="inline-flex items-center">
                                    <input type="checkbox" id="tax-toggle-history" class="sr-only peer" checked>
                                    <span
                                        class="w-12 h-6 bg-gray-200 rounded-full peer peer-checked:bg-cyan-500 relative transition">
                                        <span
                                            class="absolute top-0.5 left-1 w-5 h-5 bg-white rounded-full shadow transition-all peer-checked:translate-x-6"></span>
                                    </span>
                                </span>
                            </label>
                            <button id="sales-history-export"
                                class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-gray-200 text-gray-700 font-semibold hover:bg-gray-50">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16V4m0 12l-4-4m4 4l4-4M4 20h16" />
                                </svg>
                                Exporter
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
                        <div class="rounded-2xl p-5 text-white bg-gradient-to-r from-blue-500 to-blue-600">
                            <p class="text-sm opacity-90">Ventes complétées</p>
                            <div class="mt-3 flex items-center justify-between">
                                <p id="sales-history-stat-completed" class="text-3xl font-bold">0</p>
                                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-2xl p-5 text-white bg-gradient-to-r from-orange-500 to-orange-600">
                            <p class="text-sm opacity-90">En attente</p>
                            <div class="mt-3 flex items-center justify-between">
                                <p id="sales-history-stat-pending" class="text-3xl font-bold">0</p>
                                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3M12 6a6 6 0 100 12 6 6 0 000-12z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-2xl p-5 text-white bg-gradient-to-r from-fuchsia-500 to-pink-500">
                            <p class="text-sm opacity-90">A payer plus tard</p>
                            <div class="mt-3 flex items-center justify-between">
                                <p id="sales-history-stat-paylater" class="text-3xl font-bold">0 FCFA</p>
                                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 11h18M5 7v10a2 2 0 002 2h10a2 2 0 002-2V7" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-2xl p-5 text-white bg-gradient-to-r from-green-500 to-green-600">
                            <p class="text-sm opacity-90">Revenus du jour</p>
                            <div class="mt-3 flex items-center justify-between">
                                <p id="sales-history-stat-today" class="text-3xl font-bold">0 FCFA</p>
                                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 1.343-3 3m6 0a3 3 0 00-3-3m0 0V4m0 7v6" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-2xl p-5 text-white bg-gradient-to-r from-purple-500 to-purple-600">
                            <p class="text-sm opacity-90">Revenus total</p>
                            <div class="mt-3 flex items-center justify-between">
                                <p id="sales-history-stat-total" class="text-3xl font-bold">0 FCFA</p>
                                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 17l6-6 4 4 8-8" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-3">
                        <button id="sales-history-tab-completed"
                            class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold bg-blue-600 text-white shadow">
                            <span class="inline-flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Ventes complétées
                            </span>
                            <span id="sales-history-completed-count" class="px-2 py-0.5 rounded-full text-xs bg-white/20">0</span>
                        </button>
                        <button id="sales-history-tab-pending"
                            class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200">
                            <span class="inline-flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3M12 6a6 6 0 100 12 6 6 0 000-12z" />
                                </svg>
                                Ventes en attente
                            </span>
                            <span id="sales-history-pending-count" class="px-2 py-0.5 rounded-full text-xs bg-gray-200">0</span>
                        </button>
                        <button id="sales-history-tab-paylater"
                            class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200">
                            <span class="inline-flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 11h18M5 7v10a2 2 0 002 2h10a2 2 0 002-2V7" />
                                </svg>
                                A payer plus tard
                            </span>
                            <span id="sales-history-paylater-count" class="px-2 py-0.5 rounded-full text-xs bg-gray-200">0</span>
                        </button>
                        <button id="sales-history-tab-store-validation"
                            class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200">
                            <span class="inline-flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 7l9-4 9 4-9 4-9-4zM3 7v10l9 4 9-4V7" />
                                </svg>
                                Validation ventes Magasin
                            </span>
                            <span id="sales-history-store-validation-count" class="px-2 py-0.5 rounded-full text-xs bg-gray-200">0</span>
                        </button>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-4">
                        <div class="relative flex-1">
                            <input type="text" id="sales-history-search" placeholder="Rechercher par N° facture, client..."
                                class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-cyan-500 focus:border-cyan-500" />
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <select id="sales-history-date-filter"
                            class="w-full lg:w-56 border border-gray-200 rounded-xl px-4 py-3 text-sm text-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                            <option value="all">Toutes les dates</option>
                            <option value="today">Aujourd'hui</option>
                            <option value="last7">7 derniers jours</option>
                            <option value="last30">30 derniers jours</option>
                            <option value="thisMonth">Ce mois</option>
                            <option value="lastMonth">Mois précédent</option>
                        </select>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                        <div id="sales-history-empty" class="flex flex-col items-center justify-center text-center text-gray-500 h-32">
                            <p>Aucune vente enregistrée</p>
                        </div>
                        <div id="sales-history-list" class="hidden space-y-4"></div>
                    </div>
                </div>
            </div>
            <!-- Page: Stock Boutique -->
            <div id="page-Stock-Boutique" class="page-content p-4 md:p-8 hidden">
                <h1 class="text-3xl font-bold text-gray-800">Stock de la Boutique</h1>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="relative flex-grow">
                            <!-- ID AJOUTÉ ICI -->
                            <input type="text" id="shop-search-input" placeholder="Rechercher par nom ou description..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500" />
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button id="open-transfer-modal-button"
                                class="px-4 py-2 bg-cyan-400 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-500 transition-colors flex items-center gap-2">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Transférer depuis Magasin
                            </button>
                        </div>
                    </div>
                    <!-- Conteneur pour la liste des produits de la boutique -->
                    <div id="shop-stock-container" class="mt-6">
                        <!-- Message si vide (visible par défaut) -->
                        <div id="shop-stock-placeholder"
                            class="flex flex-col items-center justify-center text-center text-gray-500 h-40">
                            <p>Aucun article en inventaire.</p>
                        </div>
                        <!-- Tableau si non vide (caché par défaut) -->
                        <div id="shop-stock-table-container"
                            class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Produit</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Quantité</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Prix de Vente</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Seuil d'alerte</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="shop-stock-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de produits insérées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="mt-10 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800">Mouvements du Stock Boutique</h2>
                    <p class="text-sm text-gray-500 mt-1">Historique de tous les ajouts et réapprovisionnements de
                        stock.</p>
                    <!-- Conteneur pour les mouvements de la boutique -->
                    <div id="shop-movements-container" class="mt-6">
                        <!-- Message si vide (visible par défaut) -->
                        <div id="shop-movements-placeholder"
                            class="flex flex-col items-center justify-center text-center text-gray-500 h-32">
                            <p>Aucun mouvement de stock enregistré.</p>
                        </div>
                        <!-- Tableau si non vide (caché par défaut) -->
                        <div id="shop-movements-table-container"
                            class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Produit</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Type</th> <!-- AJOUTÉ -->
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Qte Changée</th> <!-- Renommé -->
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Changement</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Commentaire</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Utilisateur</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Date</th>
                                    </tr>
                                </thead>
                                <tbody id="shop-movements-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de mouvements insérées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Mon Magasin -->
            <div id="page-Mon-Magasin" class="page-content p-4 md:p-8 hidden">
                <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Gestion du Magasin</h1>
                        <p class="text-gray-500 mt-1">Gestion du stock principal</p>
                    </div>
                    <button id="open-restock-modal-button"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold shadow-sm hover:bg-purple-700">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h10M7 11h10M7 15h10M5 7h.01M5 11h.01M5 15h.01" />
                        </svg>
                        Réapprovisionner la boutique
                    </button>
                </div>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="relative flex-grow">
                            <!-- ID AJOUTÉ ICI -->
                            <input type="text" id="store-search-input"
                                placeholder="Rechercher par nom ou description..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500" />
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button id="open-entry-modal-button"
                                class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-50 transition-colors flex items-center gap-2">Entrée</button>
                            <button id="open-exit-modal-button"
                                class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-50 transition-colors flex items-center gap-2">Sortie</button>
                            <!-- ID ajouté au bouton "Nouveau Produit" -->
                            <button id="open-new-product-modal-button"
                                class="px-4 py-2 bg-cyan-400 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-500 transition-colors flex items-center gap-2">
                                + Nouveau Produit
                            </button>
                        </div>
                    </div>

                    <!-- Conteneur pour la liste des produits du magasin -->
                    <div id="store-products-container" class="mt-6">
                        <!-- Message si vide (visible par défaut) -->
                        <div id="store-products-placeholder"
                            class="flex flex-col items-center justify-center text-center text-gray-500 h-40">
                            <p>Aucun article dans le magasin.</p>
                        </div>
                        <!-- Tableau si non vide (caché par défaut) -->
                        <div id="store-products-table-container"
                            class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Produit</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Description</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Quantité</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Coût d'achat</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="store-products-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de produits insérées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Page: Mouvements Magasin -->
            <div id="page-Mouvements-Magasin" class="page-content p-4 md:p-8 hidden">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-2xl bg-purple-100 text-purple-600 flex items-center justify-center">
                        <div data-icon="clock" class="w-5 h-5"></div>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Historique des mouvements</h1>
                        <p class="text-sm text-gray-500">Suivi des entrées, sorties et transferts du magasin.</p>
                    </div>
                </div>

                <div class="mt-6 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div id="store-movements-container" class="mt-2">
                        <div id="store-movements-placeholder"
                            class="flex flex-col items-center justify-center text-center text-gray-500 h-32">
                            <p>Aucun mouvement enregistré.</p>
                        </div>
                        <div id="store-movements-table-container"
                            class="hidden overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Produit</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Type</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Quantité</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Changement</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Commentaire</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Date</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Statut</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Action</th>
                                    </tr>
                                </thead>
                                <tbody id="store-movements-tbody" class="divide-y divide-gray-200">
                                    <!-- Lignes de mouvements insérées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Statistiques -->
            <div id="page-Statistiques" class="page-content p-4 md:p-8 hidden">
                <h1 class="text-3xl font-bold text-gray-800">Statistiques</h1>
                <p class="text-gray-500 mt-1">Analysez vos performances commerciales globales</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Ventes totales</p>
                            <p id="stat-total-sales" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                            <p class="text-xs text-gray-400 mt-2">Depuis le début</p>
                        </div>
                        <div class="p-3 rounded-lg bg-blue-100">
                            <div data-icon="sales" class="w-6 h-6 text-blue-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Revenus totaux</p>
                            <p id="stat-revenue" class="text-2xl font-bold text-gray-800 mt-1">0 FCFA</p>
                            <p class="text-xs text-gray-400 mt-2">Depuis le début</p>
                        </div>
                        <div class="p-3 rounded-lg bg-indigo-100">
                            <div data-icon="stats" class="w-6 h-6 text-indigo-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Produits en stock</p>
                            <p id="stat-products-in-stock" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                            <p class="text-xs text-gray-400 mt-2">Dans la boutique</p>
                        </div>
                        <div class="p-3 rounded-lg bg-green-100">
                            <div data-icon="box" class="w-6 h-6 text-green-500"></div>
                        </div>
                    </div>
                    <!-- StatCard -->
                    <div class="bg-white p-5 rounded-lg shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Marge moyenne</p>
                            <p id="stat-avg-margin" class="text-2xl font-bold text-gray-800 mt-1">0%</p>
                            <p class="text-xs text-gray-400 mt-2">Sur toutes les ventes</p>
                        </div>
                        <div class="p-3 rounded-lg bg-purple-100">
                            <div data-icon="chartBar" class="w-6 h-6 text-purple-500"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-10 grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <!-- Section Produits les plus vendus -->
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800">Produits les plus vendus</h2>
                        <p class="text-sm text-gray-500 mt-1">Classement par quantité vendue.</p>
                        <div id="best-selling-container" class="mt-4">
                            <div id="best-selling-placeholder" class="text-center text-gray-500 py-8">
                                <p>Aucune donnée de vente disponible.</p>
                            </div>
                            <div id="best-selling-table-container" class="hidden overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Produit</th>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Qté Vendue</th>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Revenu Généré</th>
                                        </tr>
                                    </thead>
                                    <tbody id="best-selling-tbody" class="divide-y divide-gray-200">
                                        <!-- Données insérées par JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Section Performance des vendeurs -->
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800">Performance des vendeurs</h2>
                        <p class="text-sm text-gray-500 mt-1">Classement par revenu généré.</p>
                        <div id="seller-performance-container" class="mt-4">
                            <div id="seller-performance-placeholder" class="text-center text-gray-500 py-8">
                                <p>Aucune donnée de vente disponible.</p>
                            </div>
                            <div id="seller-performance-table-container" class="hidden overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Vendeur</th>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Nb. Ventes</th>
                                            <th scope="col"
                                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Revenu Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="seller-performance-tbody" class="divide-y divide-gray-200">
                                        <!-- Données insérées par JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Paramètres -->
            <div id="page-Paramètres" class="page-content p-4 md:p-8 hidden">
                <div class="flex flex-col gap-2">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-2xl bg-cyan-100 flex items-center justify-center text-cyan-500">
                            <div data-icon="settings" class="w-6 h-6 text-cyan-500"></div>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold">Paramètres</h1>
                            <p class="text-gray-500 mt-1">Gérez les préférences de votre compte, de votre équipe et du
                                SaaS.</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400">
                        Seuls les administrateurs ont accès complet à cette zone. Les autres rôles peuvent être limités
                        via l'onglet
                        <span class="font-semibold text-gray-600">Accès</span>.
                    </p>
                </div>

                <div id="settings-restricted-state"
                    class="mt-8 bg-white p-6 rounded-xl shadow-sm border border-red-100 hidden">
                    <div class="flex items-start gap-4">
                        <div class="p-2 rounded-full bg-red-50 text-red-500">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L4.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Accès restreint</h2>
                            <p class="text-gray-500 mt-1">Vous devez être administrateur de l'entreprise pour modifier
                                les paramètres globaux. Contactez un administrateur pour revoir vos droits.</p>
                        </div>
                    </div>
                </div>

                <div id="settings-tabs-wrapper" class="mt-8 space-y-6 hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div>
                                <p class="text-sm uppercase tracking-wide text-gray-400">Plan actuel</p>
                                <p class="text-2xl font-semibold text-gray-800">StockPilot Pro</p>
                                <p class="text-gray-500 text-sm">Facturé mensuellement · 5 utilisateurs inclus</p>
                            </div>
                            <div class="flex flex-wrap gap-3 text-sm">
                                <div class="px-3 py-2 bg-cyan-50 text-cyan-700 rounded-lg font-medium"
                                    id="settings-admin-badge">Rôle : Admin</div>
                                <button
                                    class="px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 font-semibold">Mettre
                                    à niveau</button>
                                <button
                                    class="px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 font-semibold">Télécharger
                                    la politique d'accès</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex flex-wrap gap-2 bg-white p-2 rounded-2xl shadow-sm">
                            <button type="button" data-settings-tab="compte"
                                class="settings-tab-button px-4 py-2 rounded-xl text-sm font-semibold bg-cyan-500 text-white">Compte</button>
                            <button type="button" data-settings-tab="application"
                                class="settings-tab-button px-4 py-2 rounded-xl text-sm font-semibold text-gray-600 hover:text-gray-900">Application</button>
                            <button type="button" data-settings-tab="notifications"
                                class="settings-tab-button px-4 py-2 rounded-xl text-sm font-semibold text-gray-600 hover:text-gray-900">Notifications</button>
                            <button type="button" data-settings-tab="facturation"
                                class="settings-tab-button px-4 py-2 rounded-xl text-sm font-semibold text-gray-600 hover:text-gray-900">Facturation</button>
                            <button type="button" data-settings-tab="acces"
                                class="settings-tab-button px-4 py-2 rounded-xl text-sm font-semibold text-gray-600 hover:text-gray-900 flex items-center gap-2">
                                Accès
                                <span
                                    class="px-2 py-0.5 rounded-full text-xs font-semibold bg-cyan-50 text-cyan-600 border border-cyan-100">Admin</span>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Onglet Compte -->
                        <div data-settings-panel="compte" class="bg-white rounded-2xl shadow-sm p-6 space-y-6">
                            <div class="flex flex-col gap-1">
                                <h2 class="text-xl font-semibold text-gray-900">Profil & Identité</h2>
                                <p class="text-sm text-gray-500">Coordonnées de l'entreprise et du responsable légal.
                                </p>
                            </div>
                            <div class="grid gap-6 md:grid-cols-2">
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Nom de l'entreprise</label>
                                    <input type="text"
                                        class="mt-2 w-full rounded-lg border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        placeholder="Nom de votre entreprise" id="settings-company-name">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Fuseau horaire</label>
                                    <select
                                        class="mt-2 w-full rounded-lg border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        id="settings-timezone">
                                        <option value="Africa/Abidjan">(GMT) Afrique de l'Ouest</option>
                                        <option value="Europe/Paris">(GMT+1) Europe Centrale</option>
                                        <option value="America/New_York">(GMT-5) New York</option>
                                        <option value="Asia/Dubai">(GMT+4) Dubaï</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Email de support</label>
                                    <input type="email"
                                        class="mt-2 w-full rounded-lg border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        placeholder="support@entreprise.com">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Numéro WhatsApp</label>
                                    <input type="tel"
                                        class="mt-2 w-full rounded-lg border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        placeholder="+225 xx xx xx xx">
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-3">
                                <button
                                    class="px-5 py-2.5 bg-cyan-500 text-white rounded-xl text-sm font-semibold hover:bg-cyan-600">Enregistrer</button>
                                <button
                                    class="px-5 py-2.5 border border-gray-200 rounded-xl text-sm font-semibold text-gray-600 hover:bg-gray-50">Annuler</button>
                            </div>
                        </div>

                        <!-- Onglet Application -->
                        <div data-settings-panel="application"
                            class="bg-white rounded-2xl shadow-sm p-6 space-y-6 hidden">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">Fonctionnalités activées</h2>
                                <p class="text-sm text-gray-500">Activez uniquement les modules nécessaires à votre
                                    entreprise.</p>
                            </div>
                            <div class="space-y-4">
                                <label
                                    class="flex items-start justify-between gap-4 p-4 rounded-xl border border-gray-200 hover:border-cyan-200 cursor-pointer">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-800">Gestion multi-boutiques</p>
                                        <p class="text-sm text-gray-500">Synchroniser plusieurs points de vente.</p>
                                    </div>
                                    <input type="checkbox"
                                        class="w-5 h-5 text-cyan-500 rounded border-gray-300 focus:ring-cyan-500"
                                        checked>
                                </label>
                                <label
                                    class="flex items-start justify-between gap-4 p-4 rounded-xl border border-gray-200 hover:border-cyan-200 cursor-pointer">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-800">Mode hors ligne</p>
                                        <p class="text-sm text-gray-500">Continuer les ventes même sans connexion.</p>
                                    </div>
                                    <input type="checkbox"
                                        class="w-5 h-5 text-cyan-500 rounded border-gray-300 focus:ring-cyan-500">
                                </label>
                                <label
                                    class="flex items-start justify-between gap-4 p-4 rounded-xl border border-gray-200 hover:border-cyan-200 cursor-pointer">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-800">Synchronisation comptable</p>
                                        <p class="text-sm text-gray-500">Export automatique vers votre ERP.</p>
                                    </div>
                                    <input type="checkbox"
                                        class="w-5 h-5 text-cyan-500 rounded border-gray-300 focus:ring-cyan-500"
                                        checked>
                                </label>
                            </div>
                            <div class="flex justify-end">
                                <button
                                    class="px-5 py-2.5 bg-cyan-500 text-white rounded-xl text-sm font-semibold hover:bg-cyan-600">Sauvegarder</button>
                            </div>
                        </div>

                        <!-- Onglet Notifications -->
                        <div data-settings-panel="notifications"
                            class="bg-white rounded-2xl shadow-sm p-6 space-y-6 hidden">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">Alertes & Notifications</h2>
                                <p class="text-sm text-gray-500">Notifiez vos équipes lors des évènements critiques.</p>
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="p-4 border border-gray-200 rounded-2xl space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-semibold text-gray-800">Stock critique</p>
                                            <p class="text-sm text-gray-500">Email + push</p>
                                        </div>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer" checked>
                                            <span
                                                class="w-12 h-6 bg-gray-200 rounded-full peer peer-checked:bg-cyan-500 relative transition">
                                                <span
                                                    class="absolute top-0.5 left-1 w-5 h-5 bg-white rounded-full shadow transition-all peer-checked:translate-x-6"></span>
                                            </span>
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500">Envoyer aussi aux responsables magasin.</p>
                                </div>
                                <div class="p-4 border border-gray-200 rounded-2xl space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-semibold text-gray-800">Rapport quotidien</p>
                                            <p class="text-sm text-gray-500">Email 7h GMT</p>
                                        </div>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer" checked>
                                            <span
                                                class="w-12 h-6 bg-gray-200 rounded-full peer peer-checked:bg-cyan-500 relative transition">
                                                <span
                                                    class="absolute top-0.5 left-1 w-5 h-5 bg-white rounded-full shadow transition-all peer-checked:translate-x-6"></span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                <div class="p-4 border border-gray-200 rounded-2xl space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-semibold text-gray-800">Objectifs de ventes</p>
                                            <p class="text-sm text-gray-500">Slack + push</p>
                                        </div>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer">
                                            <span
                                                class="w-12 h-6 bg-gray-200 rounded-full peer peer-checked:bg-cyan-500 relative transition">
                                                <span
                                                    class="absolute top-0.5 left-1 w-5 h-5 bg-white rounded-full shadow transition-all peer-checked:translate-x-6"></span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                <div class="p-4 border border-gray-200 rounded-2xl space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-semibold text-gray-800">Facturation & retard</p>
                                            <p class="text-sm text-gray-500">Email + SMS</p>
                                        </div>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer" checked>
                                            <span
                                                class="w-12 h-6 bg-gray-200 rounded-full peer peer-checked:bg-cyan-500 relative transition">
                                                <span
                                                    class="absolute top-0.5 left-1 w-5 h-5 bg-white rounded-full shadow transition-all peer-checked:translate-x-6"></span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="border-t border-gray-100 pt-6 space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900">Sorties magasin en attente</h3>
                                        <p class="text-sm text-gray-500">Demandes à valider par un administrateur.</p>
                                    </div>
                                    <span id="pending-exit-count"
                                        class="px-2.5 py-1 text-xs font-semibold rounded-full bg-yellow-50 text-yellow-700 border border-yellow-200">0</span>
                                </div>
                                <div id="pending-exit-placeholder"
                                    class="flex items-center justify-center text-sm text-gray-400 h-20 border border-dashed border-gray-200 rounded-xl">
                                    Aucune demande en attente.
                                </div>
                                <div id="pending-exit-table-container"
                                    class="hidden overflow-x-auto rounded-xl border border-gray-200">
                                    <table class="min-w-full bg-white divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col"
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Date</th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Produit</th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Quantité</th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Demandé par</th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Commentaire</th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Statut</th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pending-exit-tbody" class="divide-y divide-gray-200">
                                            <!-- Demandes remplies par JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button
                                    class="px-5 py-2.5 bg-cyan-500 text-white rounded-xl text-sm font-semibold hover:bg-cyan-600">Mettre
                                    à jour</button>
                            </div>
                        </div>

                        <!-- Onglet Facturation -->
                        <div data-settings-panel="facturation"
                            class="bg-white rounded-2xl shadow-sm p-6 space-y-6 hidden">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">Facturation & moyens de paiement</h2>
                                <p class="text-sm text-gray-500">Visualisez votre consommation et vos prochaines
                                    échéances.</p>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="p-5 border border-gray-200 rounded-2xl space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm uppercase text-gray-400">Prochaine facture</p>
                                            <p class="text-2xl font-semibold text-gray-800">24 000 F CFA</p>
                                        </div>
                                        <span
                                            class="px-3 py-1 text-xs font-semibold rounded-full bg-green-50 text-green-700">Le
                                            01/12</span>
                                    </div>
                                    <p class="text-sm text-gray-500">Basée sur 3 boutiques actives et 7 utilisateurs.
                                    </p>
                                    <button
                                        class="px-4 py-2.5 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-gray-50">Télécharger
                                        la dernière facture</button>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-2xl space-y-4">
                                    <div>
                                        <p class="text-sm uppercase text-gray-400">Carte principale</p>
                                        <p class="text-lg font-semibold text-gray-800">**** 4587 · Ecobank</p>
                                        <p class="text-sm text-gray-500">Titulaire : Turibe Bayomi</p>
                                    </div>
                                    <div class="flex gap-3">
                                        <button
                                            class="px-4 py-2 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-gray-50">Modifier</button>
                                        <button
                                            class="px-4 py-2 rounded-xl border border-red-200 text-sm font-semibold text-red-600 hover:bg-red-50">Supprimer</button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button
                                    class="px-5 py-2.5 bg-cyan-500 text-white rounded-xl text-sm font-semibold hover:bg-cyan-600">Ajouter
                                    un moyen de paiement</button>
                            </div>
                        </div>

                        <!-- Onglet Accès -->
                        <div data-settings-panel="acces" class="bg-white rounded-2xl shadow-sm p-6 space-y-6 hidden">
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-3">
                                    <h2 class="text-xl font-semibold text-gray-900">Gestion des accès</h2>
                                    <span
                                        class="px-2.5 py-0.5 text-xs rounded-full bg-cyan-50 text-cyan-600 border border-cyan-100">Admins
                                        uniquement</span>
                                </div>
                                <p class="text-sm text-gray-500">Définissez les rôles de vos collaborateurs et
                                    choisissez les modules qu'ils peuvent voir.</p>
                            </div>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div class="p-4 rounded-2xl border border-gray-200">
                                    <p class="text-sm uppercase text-gray-400">Employés</p>
                                    <p class="text-3xl font-semibold text-gray-800" id="access-total-users">0</p>
                                </div>
                                <div class="p-4 rounded-2xl border border-gray-200">
                                    <p class="text-sm uppercase text-gray-400">Admins</p>
                                    <p class="text-3xl font-semibold text-gray-800" id="access-total-admins">0</p>
                                </div>
                                <div class="p-4 rounded-2xl border border-gray-200">
                                    <p class="text-sm uppercase text-gray-400">Invitations en attente</p>
                                    <p class="text-3xl font-semibold text-gray-800" id="access-total-pending">0</p>
                                </div>
                            </div>

                            <div class="p-4 rounded-2xl border border-gray-200 space-y-4">
                                <div>
                                    <p class="font-semibold text-gray-800">Ajouter un collaborateur</p>
                                    <p class="text-sm text-gray-500">Générez un code d'accès personnel et attribuez un
                                        rôle immédiatement.</p>
                                </div>
                                <form id="access-add-member-form" class="grid md:grid-cols-4 gap-4">
                                    <input type="text" id="access-member-name" placeholder="Nom complet"
                                        class="col-span-2 md:col-span-1 rounded-xl border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        required>
                                    <input type="email" id="access-member-email" placeholder="Email professionnel"
                                        class="col-span-2 md:col-span-1 rounded-xl border-gray-200 focus:ring-cyan-400 focus:border-cyan-400"
                                        required>
                                    <select id="access-member-role"
                                        class="col-span-2 md:col-span-1 rounded-xl border-gray-200 focus:ring-cyan-400 focus:border-cyan-400">
                                        <option value="manager">Manager</option>
                                        <option value="vendeur">Vendeur</option>
                                        <option value="consultation">Consultation</option>
                                    </select>
                                    <button type="submit"
                                        class="col-span-2 md:col-span-1 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600">Générer
                                        le code</button>
                                </form>
                            </div>

                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <p class="font-semibold text-gray-800">Collaborateurs actifs</p>
                                    <span class="text-sm text-gray-500">Cliquez sur un module pour
                                        l'activer/désactiver.</span>
                                </div>
                                <div class="overflow-x-auto border border-gray-200 rounded-2xl">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead
                                            class="bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">
                                            <tr>
                                                <th class="px-4 py-3">Nom</th>
                                                <th class="px-4 py-3">Email</th>
                                                <th class="px-4 py-3">Rôle</th>
                                                <th class="px-4 py-3">Modules autorisés</th>
                                                <th class="px-4 py-3">Code d'accès</th>
                                                <th class="px-4 py-3 text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="access-members-tbody"
                                            class="divide-y divide-gray-100 text-sm text-gray-700">
                                            <tr>
                                                <td colspan="6" class="px-4 py-6 text-center text-gray-400">Chargement
                                                    des collaborateurs...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal: Sélectionner un client -->
    <div id="customer-select-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6 m-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-800">Sélectionner un client</h2>
                <button id="close-customer-select-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="mt-4 relative">
                <input type="text" id="customer-select-search" placeholder="Rechercher un client..."
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition" />
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
            <button id="open-new-customer-modal-button"
                class="mt-4 w-full inline-flex items-center justify-center px-4 py-3 bg-cyan-500 text-white text-sm font-semibold rounded-xl shadow-md hover:bg-cyan-600 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Créer un nouveau client
            </button>
            <div class="mt-4 flex-1 overflow-hidden">
                <div id="customer-select-placeholder"
                    class="flex items-center justify-center text-sm text-gray-400 h-32 border border-dashed border-gray-200 rounded-xl">
                    Aucun client enregistré.
                </div>
                <div id="customer-select-list" class="hidden space-y-3 max-h-80 overflow-y-auto pr-1">
                    <!-- Clients insérés par JS -->
                </div>
            </div>
            <button id="continue-without-customer-button"
                class="mt-4 w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-colors">
                Continuer sans client
            </button>
        </div>
    </div>

    <!-- Modal: Nouveau client -->
    <div id="customer-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Nouveau client</h2>
                <button id="close-customer-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="customer-form" class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-gray-600" for="customer-name">Nom complet *</label>
                    <input type="text" id="customer-name" placeholder="Ex: Jean Dupont"
                        class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition"
                        required />
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600" for="customer-email">Email</label>
                    <input type="email" id="customer-email" placeholder="jean.dupont@email.com"
                        class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition" />
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600" for="customer-phone">Téléphone</label>
                    <input type="tel" id="customer-phone" placeholder="+225 01 02 03 04 05"
                        class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition" />
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600" for="customer-address">Adresse (optionnel)</label>
                    <input type="text" id="customer-address" placeholder="Rue, ville, pays"
                        class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition" />
                </div>
                <div id="customer-error" class="text-red-500 text-sm hidden"></div>
                <div class="flex gap-3 pt-4">
                    <button type="button" id="back-to-customer-select-button"
                        class="w-1/2 px-4 py-3 rounded-xl border border-gray-200 bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-colors">
                        Retour
                    </button>
                    <button type="submit" id="customer-submit-button"
                        class="w-1/2 bg-cyan-500 text-white font-semibold py-3 px-4 rounded-xl hover:bg-cyan-600 transition-colors">
                        Enregistrer le client
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      MODAL "AJOUTER UN NOUVEAU PRODUIT"
    -->
    <div id="new-product-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <!-- En-tête -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Ajouter un nouveau produit au magasin</h2>
                <button id="close-new-product-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <!-- Formulaire -->
            <form id="new-product-form">
                <div class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700">Nom du Produit
                            *</label>
                        <input type="text" id="product-name" placeholder="ex: Écran 27 pouces"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                    </div>
                    <div>
                        <label for="product-description"
                            class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="product-description" placeholder="Une courte description du produit" rows="3"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="product-cost" class="block text-sm font-medium text-gray-700">Coût d'Achat
                                *</label>
                            <input type="number" id="product-cost" placeholder="0" value="0" min="0"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                                required>
                        </div>
                        <div>
                            <label for="product-currency" class="block text-sm font-medium text-gray-700">Devise
                                *</label>
                            <input type="text" id="product-currency" placeholder="EUR" value="EUR"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                                required>
                        </div>
                    </div>
                    <div>
                        <label for="product-quantity" class="block text-sm font-medium text-gray-700">Quantité Initiale
                            *</label>
                        <input type="number" id="product-quantity" placeholder="0" value="0" min="0"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                    </div>
                    <p id="new-product-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="new-product-submit-button"
                        class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Ajouter le produit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      MODAL "ENREGISTRER UNE ENTRÉE"
    -->
    <div id="entry-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Enregistrer une entrée</h2>
                <button id="close-entry-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <form id="entry-form">
                <div class="space-y-4">
                    <div id="entry-product-info" class="hidden rounded-xl bg-emerald-50 border border-emerald-100 p-4">
                        <p id="entry-product-name" class="text-sm font-semibold text-gray-900">—</p>
                        <p class="text-xs text-emerald-700 mt-1">Stock actuel: <span id="entry-product-stock">—</span></p>
                    </div>
                    <div id="entry-product-select-row">
                        <label for="entry-product-select" class="block text-sm font-medium text-gray-700">Produit
                            *</label>
                        <select id="entry-product-select"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400"
                            required>
                            <option value="">Sélectionnez un produit</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>
                    <div>
                        <label for="entry-quantity" class="block text-sm font-medium text-gray-700">Quantité à ajouter *</label>
                        <input type="number" id="entry-quantity" placeholder="0" min="1"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400"
                            required>
                    </div>
                    <div>
                        <label for="entry-comment" class="block text-sm font-medium text-gray-700">Commentaire</label>
                        <textarea id="entry-comment" placeholder="Motif de l'entrée..." rows="3"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400"></textarea>
                    </div>
                    <p id="entry-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <div class="pt-4 border-t border-gray-100 flex items-center gap-3">
                        <button type="button" id="entry-cancel-button"
                            class="flex-1 py-2.5 rounded-lg bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200">
                            Annuler
                        </button>
                        <button type="submit" id="entry-submit-button"
                            class="flex-1 bg-emerald-600 text-white font-semibold py-2.5 rounded-lg hover:bg-emerald-700 transition-colors shadow-sm">
                            Valider l'entrée
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      MODAL "ENREGISTRER UNE SORTIE"
    -->
    <div id="exit-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Enregistrer une sortie</h2>
                <button id="close-exit-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <form id="exit-form">
                <div class="space-y-4">
                    <div id="exit-product-info" class="hidden rounded-xl border border-orange-200 bg-orange-50 p-4">
                        <div class="flex items-start gap-2 text-orange-600">
                            <svg class="w-5 h-5 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div>
                                <p class="text-sm font-semibold text-gray-900">Informations produit</p>
                                <p id="exit-product-name" class="text-sm text-gray-800 mt-1">—</p>
                                <p class="text-xs text-orange-700 mt-1">Stock disponible: <span id="exit-product-stock">—</span></p>
                            </div>
                        </div>
                    </div>
                    <div id="exit-product-select-row">
                        <label for="exit-product-select" class="block text-sm font-medium text-gray-700">Produit
                            *</label>
                        <select id="exit-product-select"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-orange-400"
                            required>
                            <option value="">Sélectionnez un produit</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>
                    <div>
                        <label for="exit-quantity" class="block text-sm font-medium text-gray-700">Quantité à sortir *</label>
                        <input type="number" id="exit-quantity" placeholder="0" min="1"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-orange-400"
                            required>
                    </div>
                    <div class="pt-2">
                        <div class="flex items-center gap-2 text-sm font-semibold text-gray-800">
                            <svg class="w-4 h-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A4 4 0 0112 15a4 4 0 016.879 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Informations client
                        </div>
                        <div class="mt-3 space-y-3">
                            <div>
                                <label for="exit-customer-name" class="block text-sm font-medium text-gray-700">Nom du client *</label>
                                <input type="text" id="exit-customer-name" placeholder="Jean Dupont"
                                    class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-orange-400"
                                    required>
                            </div>
                            <div>
                                <label for="exit-customer-email" class="block text-sm font-medium text-gray-700">Email *</label>
                                <input type="email" id="exit-customer-email" placeholder="jean.dupont@email.com"
                                    class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-orange-400"
                                    required>
                            </div>
                            <div>
                                <label for="exit-customer-phone" class="block text-sm font-medium text-gray-700">Téléphone *</label>
                                <input type="tel" id="exit-customer-phone" placeholder="+33 6 12 34 56 78"
                                    class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-orange-400"
                                    required>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="exit-comment" class="block text-sm font-medium text-gray-700">Commentaire</label>
                        <textarea id="exit-comment" placeholder="Informations additionnelles sur la vente..." rows="3"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-orange-400"></textarea>
                    </div>
                    <p id="exit-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <div class="pt-4 border-t border-gray-100 flex items-center gap-3">
                        <button type="button" id="exit-cancel-button"
                            class="flex-1 py-2.5 rounded-lg bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200">
                            Annuler
                        </button>
                        <button type="submit" id="exit-submit-button"
                            class="flex-1 bg-orange-500 text-white font-semibold py-2.5 rounded-lg hover:bg-orange-600 transition-colors shadow-sm">
                            Envoyer pour validation
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      MODAL "TRANSFÉRER UN ARTICLE DEPUIS LE MAGASIN"
    -->
    <div id="transfer-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Transférer un article depuis le Magasin</h2>
                <button id="close-transfer-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <form id="transfer-form">
                <div class="space-y-4">
                    <div>
                        <label for="transfer-product-select" class="block text-sm font-medium text-gray-700">Article
                            Source (depuis le Magasin) *</label>
                        <select id="transfer-product-select"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                            <option value="">Sélectionnez un article à transférer...</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>

                    <div id="transfer-source-info" class="hidden">
                        <h4 class="text-sm font-medium text-gray-700">Informations de l'article source</h4>
                        <p class="mt-1 p-3 bg-gray-100 rounded-lg text-sm text-gray-600">
                            Coût d'achat: <span id="transfer-cost-display" class="font-semibold">0 CFA</span>
                        </p>
                    </div>

                    <div>
                        <label for="transfer-selling-price" class="block text-sm font-medium text-gray-700">Prix de
                            Vente (pour la Boutique) *</label>
                        <input type="number" id="transfer-selling-price" placeholder="110000" min="0"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="transfer-quantity" class="block text-sm font-medium text-gray-700">Stock à
                                Transférer *</label>
                            <input type="number" id="transfer-quantity" placeholder="1" min="1"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                                required>
                        </div>
                        <div>
                            <label for="transfer-alert-threshold" class="block text-sm font-medium text-gray-700">Seuil
                                d'alerte</label>
                            <input type="number" id="transfer-alert-threshold" placeholder="10" value="10" min="0"
                                class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400">
                        </div>
                    </div>

                    <div id="transfer-stock-warning"
                        class="hidden flex items-center p-3 bg-yellow-100 border border-yellow-200 rounded-lg">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-yellow-700">Cette valeur doit être inférieure ou égale à X.</p>
                    </div>

                    <p class="text-xs text-gray-500">
                        Si un article de boutique lié à cette source existe déjà, le stock sera fusionné. Sinon, un
                        nouvel article sera créé.
                    </p>

                    <p id="transfer-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="transfer-submit-button"
                        class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Transférer et Créer/Mettre à jour l'article
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      MODAL "RÉAPPROVISIONNER UN ARTICLE"
    -->
    <div id="restock-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Réapprovisionner un article</h2>
                <button id="close-restock-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <form id="restock-form">
                <div class="space-y-4">
                    <div>
                        <label for="restock-product-select" class="block text-sm font-medium text-gray-700">Produit de
                            la Boutique *</label>
                        <select id="restock-product-select"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                            <option value="">Sélectionnez un produit à réapprovisionner</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>

                    <div id="restock-source-info" class="hidden">
                        <h4 class="text-sm font-medium text-gray-700">Article Source</h4>
                        <p class="mt-1 p-3 bg-gray-100 rounded-lg text-sm text-gray-600">
                            <span id="restock-source-name" class="font-semibold"></span>
                            (Stock magasin disponible: <span id="restock-source-stock" class="font-semibold">0</span>)
                        </p>
                    </div>

                    <div>
                        <label for="restock-quantity" class="block text-sm font-medium text-gray-700">Quantité à Ajouter
                            (depuis le Magasin) *</label>
                        <input type="number" id="restock-quantity" placeholder="1" min="1"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                            required>
                    </div>

                    <div id="restock-stock-warning"
                        class="hidden flex items-center p-3 bg-yellow-100 border border-yellow-200 rounded-lg">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-yellow-700">Cette valeur doit être inférieure ou égale à X.</p>
                    </div>

                    <div>
                        <label for="restock-comment" class="block text-sm font-medium text-gray-700">Commentaire
                            (Optionnel)</label>
                        <textarea id="restock-comment" placeholder="ex: Réapprovisionnement hebdomadaire" rows="3"
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"></textarea>
                    </div>
                    <p id="restock-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    <button type="submit" id="restock-submit-button"
                        class="w-full bg-cyan-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transition-colors shadow-md hover:shadow-lg">
                        Confirmer le réapprovisionnement
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      TOAST DE SUCCÈS GLOBAL
    -->
    <div id="success-toast" class="fixed bottom-5 right-5 z-50">
        <div class="flex items-center bg-green-500 text-white text-sm font-medium px-4 py-3 rounded-lg shadow-lg">
            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="success-toast-message">Opération réussie!</span>
        </div>
    </div>

    <!-- Modal: Détails de vente -->
    <div id="sales-detail-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6 m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between">
                <h2 id="sales-detail-title" class="text-xl font-bold text-gray-900">Détails de la vente</h2>
                <button id="close-sales-detail-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="mt-6 space-y-5">
                <div class="bg-gray-50 rounded-2xl p-4">
                    <p id="sales-detail-customer-name" class="text-sm font-semibold text-gray-900">Client</p>
                    <p id="sales-detail-customer-email" class="text-xs text-gray-500 mt-1">Email</p>
                    <p id="sales-detail-seller-name" class="text-xs text-gray-500 mt-2">Vendeur :</p>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-900">Informations</h3>
                    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="rounded-2xl bg-gray-50 p-4">
                            <p class="text-xs text-gray-500">Date</p>
                            <p id="sales-detail-date" class="text-sm font-semibold text-gray-900 mt-1">-</p>
                        </div>
                        <div class="rounded-2xl bg-gray-50 p-4">
                            <p class="text-xs text-gray-500">Paiement</p>
                            <p id="sales-detail-payment" class="text-sm font-semibold text-gray-900 mt-1">Non renseigné</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-900">Produits</h3>
                    <div id="sales-detail-products" class="mt-3 space-y-3"></div>
                </div>

                <div id="sales-detail-comment-section" class="hidden">
                    <h3 class="text-sm font-semibold text-gray-900">Commentaire</h3>
                    <div class="mt-3 bg-gray-50 rounded-2xl p-4">
                        <p id="sales-detail-comment" class="text-sm text-gray-600"></p>
                    </div>
                </div>

                <div class="bg-blue-50 rounded-2xl p-4 space-y-2">
                    <div class="flex items-center justify-between text-sm text-gray-600">
                        <span>Sous-total</span>
                        <span id="sales-detail-subtotal">0 FCFA</span>
                    </div>
                    <div id="sales-detail-tax-row" class="flex items-center justify-between text-sm text-gray-400">
                        <span>TVA (20%)</span>
                        <span id="sales-detail-tax">0 FCFA</span>
                    </div>
                    <div class="flex items-center justify-between text-base font-semibold text-gray-900 border-t border-blue-100 pt-3">
                        <span>Total</span>
                        <span id="sales-detail-total" class="text-blue-600">0 FCFA</span>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="sales-detail-print" type="button"
                        class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 9V4h12v5M6 18h12v2H6v-2zM6 14h12v4H6v-4z" />
                        </svg>
                        Imprimer
                    </button>
                    <button id="sales-detail-email" type="button"
                        class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-purple-600 text-white font-semibold hover:bg-purple-700">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l9 6 9-6M5 6h14a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2z" />
                        </svg>
                        Envoyer par email
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- jsPDF Libraries for Invoice Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script type="module">
        // --- SDK Firebase ---
        import { initializeApp } from "firebase/app";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "firebase/auth";
        import {
            getDatabase,
            ref,
            set,
            push,
            onValue,
            off,
            update,
            query,
            orderByChild,
            equalTo,
            get,
            remove
        } from "firebase/database";

        // --- GESTION DES ICÔNES SVG ---
        function getIconSVG(name, className = '') {
            const icons = {
                logo: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4 6.5V17.5L12 22L20 17.5V6.5L12 2ZM11 15.5V10.5H13V15.5H11ZM11.5 8.5C10.67 8.5 10 7.83 10 7C10 6.17 10.67 5.5 11.5 5.5C12.33 5.5 13 6.17 13 7C13 7.83 12.33 8.5 11.5 8.5Z" /></svg>`,
                dashboard: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>`,
                sales: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>`,
                box: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>`,
                stats: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>`,
                dollar: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v18m0-14c-2.209 0-4 1.343-4 3s1.791 3 4 3 4 1.343 4 3-1.791 3-4 3" /></svg>`,
                settings: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`,
                logout: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>`,
                chartBar: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-4m3 4v-2m3 2v-6m3 2V7" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 20h14" /></svg>`,
                userPlus: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.5 11a4 4 0 100-8 4 4 0 000 8z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 8v6m3-3h-6" /></svg>`,
                users: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a4 4 0 00-3-3.87" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20H4v-2a4 4 0 014-4h1" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a4 4 0 11-8 0 4 4 0 018 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`,
                trash: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`,
                arrowUp: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>`,
                arrowDown: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`,
                clock: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v5l3 3" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21a9 9 0 100-18 9 9 0 000 18z" /></svg>`,
                menu: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>`,
                arrowLeft: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>`,
                arrowRight: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>`
            };
            const svg = icons[name] || '';
            if (className && svg) {
                return svg.replace('<svg', `<svg class="${className}"`);
            }
            return svg;
        }

        function renderIcons() {
            document.querySelectorAll('[data-icon]').forEach(element => {
                const iconName = element.getAttribute('data-icon');
                // Pass the placeholder's class directly to the SVG generator
                const svgString = getIconSVG(iconName, element.className);
                if (svgString) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = svgString.trim();
                    const svgElement = tempDiv.firstChild;
                    if (svgElement) {
                        element.replaceWith(svgElement);
                    }
                }
            });
        }
        renderIcons();

        // --- GESTION DE L'APPLICATION ---

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyB65Iye8YMpxXsPthdBYmNojBMpaTPZS3A",
                authDomain: "gestion-stock-c9484.firebaseapp.com",
                databaseURL: "https://gestion-stock-c9484-default-rtdb.firebaseio.com",
                projectId: "gestion-stock-c9484",
                storageBucket: "gestion-stock-c9484.firebasestorage.app",
                messagingSenderId: "834033352449",
                appId: "1:834033352449:web:b86ff5b60c816bb469e500",
                measurementId: "G-5VKP3S88F8"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getDatabase(app);

            let isAuthenticated = false;
            let currentPage = 'Tableau de bord';
            let isLoginView = true;
            let currentUser = null;
            let currentUserData = null;
            let dbBasePath = '';

            const appData = { storeProducts: {}, storeMovements: {}, shopStock: {}, salesHistory: {}, customers: {}, storeExitRequests: {}, pendingSales: {} };
            let isSidebarOpen = false;
            let isSidebarCollapsed = false;
            let isCodeLoginMode = false;
            let isCodeSession = false;

            const EXIT_STATUS_PENDING = 'en attente de validation';
            const EXIT_STATUS_APPROVED = 'validée';
            const EXIT_STATUS_REJECTED = 'refusée';
            const SALE_SOURCE_SHOP = 'shop';
            const SALE_SOURCE_STORE = 'store_direct';
            const SALE_SOURCE_MIXED = 'mixed';


            let storeProductsListener, storeMovementsListener, shopStockListener, shopMovementsListener, salesHistoryListener, companyMembersListener, companyCustomersListener, storeExitRequestsListener, pendingSalesListener;
            let storeProductsRef, storeMovementsRef, shopStockRef, shopMovementsRef, salesHistoryRef, companyMembersRef, companyCustomersRef, storeExitRequestsRef, pendingSalesRef;

            const accessModules = [
                'Tableau de bord',
                'Ventes',
                'Historique des ventes',
                'Stock Boutique',
                'Mon Magasin',
                'Mouvements Magasin',
                'Statistiques',
                'Paramètres',
                'Supprimer Stock Boutique',
                'Supprimer Stock Magasin'
            ];
            let teamMembersState = [];
            let selectedCustomer = null;
            let customerOptionLookup = {};
            let isCustomerHistoryOpen = false;
            let selectedSalesCategory = 'Tous';
            let salesHistoryTab = 'completed';
            let salesHistorySearch = '';
            let salesHistoryDateFilterValue = 'all';
            let isTaxEnabled = true;
            let activeSalesDetailId = null;

            // Cart state
            let cartItems = [];
            const SALES_TAX_RATE = 0.2;

            // Références DOM
            const authPageContainer = document.getElementById('auth-page-container');
            const layoutContainer = document.getElementById('layout-container');
            const logoutButton = document.getElementById('logout-button');
            const navButtons = document.querySelectorAll('.nav-button');
            const pageContents = document.querySelectorAll('.page-content');
            const authToggleLogin = document.getElementById('auth-toggle-login');
            const authToggleSignup = document.getElementById('auth-toggle-signup');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const userEmailDisplay = document.getElementById('user-email-display');
            const userNameDisplay = document.getElementById('user-name-display');
            const userCompanyDisplay = document.getElementById('user-company-display');
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error');
            const signupErrorContainer = document.getElementById('signup-error-container');
            const loginSubmitButton = document.getElementById('login-submit-button');
            const signupSubmitButton = document.getElementById('signup-submit-button');
            const loginPasswordInput = document.getElementById('password');
            const loginAccessCodeInput = document.getElementById('access-code');
            const loginPasswordField = document.getElementById('login-password-field');
            const loginAccessCodeField = document.getElementById('login-access-code-field');
            const loginModeAdminButton = document.getElementById('login-mode-admin');
            const loginModeCodeButton = document.getElementById('login-mode-code');

            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('main');
            const mobileHeader = document.getElementById('mobile-header');
            const mobilePageTitle = document.getElementById('mobile-page-title');
            const hamburgerButton = document.getElementById('hamburger-button');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebarCollapseToggle = document.getElementById('sidebar-collapse-toggle');

            const storeSearchInput = document.getElementById('store-search-input');
            const shopSearchInput = document.getElementById('shop-search-input');

            const storeProductsPlaceholder = document.getElementById('store-products-placeholder');
            const storeProductsTableContainer = document.getElementById('store-products-table-container');
            const storeProductsTbody = document.getElementById('store-products-tbody');
            const storeMovementsPlaceholder = document.getElementById('store-movements-placeholder');
            const storeMovementsTableContainer = document.getElementById('store-movements-table-container');
            const storeMovementsTbody = document.getElementById('store-movements-tbody');

            const shopStockPlaceholder = document.getElementById('shop-stock-placeholder');
            const shopStockTableContainer = document.getElementById('shop-stock-table-container');
            const shopStockTbody = document.getElementById('shop-stock-tbody');
            const shopMovementsPlaceholder = document.getElementById('shop-movements-placeholder');
            const shopMovementsTableContainer = document.getElementById('shop-movements-table-container');
            const shopMovementsTbody = document.getElementById('shop-movements-tbody');

            const salesError = document.getElementById('sales-error');
            const salesHistoryEmpty = document.getElementById('sales-history-empty');
            const salesHistoryList = document.getElementById('sales-history-list');
            const salesHistorySearchInput = document.getElementById('sales-history-search');
            const salesHistoryDateFilter = document.getElementById('sales-history-date-filter');
            const salesHistoryTabCompleted = document.getElementById('sales-history-tab-completed');
            const salesHistoryTabPending = document.getElementById('sales-history-tab-pending');
            const salesHistoryTabPayLater = document.getElementById('sales-history-tab-paylater');
            const salesHistoryTabStoreValidation = document.getElementById('sales-history-tab-store-validation');
            const salesHistoryCompletedCount = document.getElementById('sales-history-completed-count');
            const salesHistoryPendingCount = document.getElementById('sales-history-pending-count');
            const salesHistoryPayLaterCount = document.getElementById('sales-history-paylater-count');
            const salesHistoryStoreValidationCount = document.getElementById('sales-history-store-validation-count');
            const salesHistoryStatCompleted = document.getElementById('sales-history-stat-completed');
            const salesHistoryStatPending = document.getElementById('sales-history-stat-pending');
            const salesHistoryStatToday = document.getElementById('sales-history-stat-today');
            const salesHistoryStatTotal = document.getElementById('sales-history-stat-total');
            const salesHistoryStatPayLater = document.getElementById('sales-history-stat-paylater');
            const salesProductSearch = document.getElementById('sales-product-search');
            const salesCategoryFilters = document.getElementById('sales-category-filters');
            const salesProductsContainer = document.getElementById('sales-products-container');
            const salesProductsPlaceholder = document.getElementById('sales-products-placeholder');
            const customerIdInput = document.getElementById('customer-id');
            const customerSelectedCard = document.getElementById('customer-selected-card');
            const customerSelectedName = document.getElementById('customer-selected-name');
            const customerSelectedContact = document.getElementById('customer-selected-contact');
            const customerHistoryButton = document.getElementById('customer-history-button');
            const openCustomerSelectButton = document.getElementById('open-customer-select-button');
            const changeCustomerSelectionButton = document.getElementById('change-customer-selection');
            const customerHistorySection = document.getElementById('customer-history-section');
            const customerHistorySubtitle = document.getElementById('customer-history-subtitle');
            const customerHistoryTotal = document.getElementById('customer-history-total');
            const customerHistoryCount = document.getElementById('customer-history-count');
            const customerHistoryLast = document.getElementById('customer-history-last');
            const customerHistoryPlaceholder = document.getElementById('customer-history-placeholder');
            const customerHistoryTableContainer = document.getElementById('customer-history-table-container');
            const customerHistoryTbody = document.getElementById('customer-history-tbody');

            // Cart elements
            const cartItemsCount = document.getElementById('cart-items-count');
            const cartEmptyState = document.getElementById('cart-empty-state');
            const cartItemsList = document.getElementById('cart-items-list');
            const cartSubtotal = document.getElementById('cart-subtotal');
            const cartTax = document.getElementById('cart-tax');
            const cartTotal = document.getElementById('cart-total');
            const cartTaxRow = document.getElementById('cart-tax-row');
            const validateCartButton = document.getElementById('validate-cart-button');
            const generateInvoiceButton = document.getElementById('generate-invoice-button');
            const payLaterButton = document.getElementById('pay-later-button');
            const holdCartButton = document.getElementById('hold-cart-button');
            const holdCommentInput = document.getElementById('hold-comment');
            const holdCommentError = document.getElementById('hold-comment-error');
            const taxToggleSales = document.getElementById('tax-toggle-sales');
            const taxToggleHistory = document.getElementById('tax-toggle-history');


            // Modals
            const openNewProductModalButton = document.getElementById('open-new-product-modal-button');
            const newProductModal = document.getElementById('new-product-modal');
            const closeNewProductModalButton = document.getElementById('close-new-product-modal-button');
            const newProductForm = document.getElementById('new-product-form');
            const newProductError = document.getElementById('new-product-error');
            const newProductSubmitButton = document.getElementById('new-product-submit-button');

            const openEntryModalButton = document.getElementById('open-entry-modal-button');
            const entryModal = document.getElementById('entry-modal');
            const closeEntryModalButton = document.getElementById('close-entry-modal-button');
            const entryForm = document.getElementById('entry-form');
            const entryProductSelect = document.getElementById('entry-product-select');
            const entryProductInfo = document.getElementById('entry-product-info');
            const entryProductName = document.getElementById('entry-product-name');
            const entryProductStock = document.getElementById('entry-product-stock');
            const entryProductSelectRow = document.getElementById('entry-product-select-row');
            const entryError = document.getElementById('entry-error');
            const entrySubmitButton = document.getElementById('entry-submit-button');
            const entryCancelButton = document.getElementById('entry-cancel-button');

            const openExitModalButton = document.getElementById('open-exit-modal-button');
            const exitModal = document.getElementById('exit-modal');
            const closeExitModalButton = document.getElementById('close-exit-modal-button');
            const exitForm = document.getElementById('exit-form');
            const exitProductSelect = document.getElementById('exit-product-select');
            const exitProductInfo = document.getElementById('exit-product-info');
            const exitProductName = document.getElementById('exit-product-name');
            const exitProductStock = document.getElementById('exit-product-stock');
            const exitProductSelectRow = document.getElementById('exit-product-select-row');
            const exitCustomerNameInput = document.getElementById('exit-customer-name');
            const exitCustomerEmailInput = document.getElementById('exit-customer-email');
            const exitCustomerPhoneInput = document.getElementById('exit-customer-phone');
            const exitError = document.getElementById('exit-error');
            const exitSubmitButton = document.getElementById('exit-submit-button');
            const exitCancelButton = document.getElementById('exit-cancel-button');

            const openTransferModalButton = document.getElementById('open-transfer-modal-button');
            const transferModal = document.getElementById('transfer-modal');
            const closeTransferModalButton = document.getElementById('close-transfer-modal-button');
            const transferForm = document.getElementById('transfer-form');
            const transferProductSelect = document.getElementById('transfer-product-select');
            const transferSourceInfo = document.getElementById('transfer-source-info');
            const transferCostDisplay = document.getElementById('transfer-cost-display');
            const transferStockWarning = document.getElementById('transfer-stock-warning');
            const transferError = document.getElementById('transfer-error');
            const transferSubmitButton = document.getElementById('transfer-submit-button');

            const openRestockModalButton = document.getElementById('open-restock-modal-button');
            const restockModal = document.getElementById('restock-modal');
            const closeRestockModalButton = document.getElementById('close-restock-modal-button');
            const restockForm = document.getElementById('restock-form');
            const restockProductSelect = document.getElementById('restock-product-select');
            const restockSourceInfo = document.getElementById('restock-source-info');
            const restockSourceName = document.getElementById('restock-source-name');
            const restockSourceStock = document.getElementById('restock-source-stock');
            const restockStockWarning = document.getElementById('restock-stock-warning');
            const restockError = document.getElementById('restock-error');
            const restockSubmitButton = document.getElementById('restock-submit-button');
            const customerModal = document.getElementById('customer-modal');
            const closeCustomerModalButton = document.getElementById('close-customer-modal-button');
            const backToCustomerSelectButton = document.getElementById('back-to-customer-select-button');
            const customerForm = document.getElementById('customer-form');
            const customerNameInput = document.getElementById('customer-name');
            const customerPhoneInput = document.getElementById('customer-phone');
            const customerEmailInput = document.getElementById('customer-email');
            const customerAddressInput = document.getElementById('customer-address');
            const customerNotesInput = document.getElementById('customer-notes');
            const customerError = document.getElementById('customer-error');
            const customerSubmitButton = document.getElementById('customer-submit-button');
            const customerSelectModal = document.getElementById('customer-select-modal');
            const closeCustomerSelectModalButton = document.getElementById('close-customer-select-modal-button');
            const customerSelectSearchInput = document.getElementById('customer-select-search');
            const customerSelectList = document.getElementById('customer-select-list');
            const customerSelectPlaceholder = document.getElementById('customer-select-placeholder');
            const openNewCustomerModalButton = document.getElementById('open-new-customer-modal-button');
            const continueWithoutCustomerButton = document.getElementById('continue-without-customer-button');

            const successToast = document.getElementById('success-toast');
            const successToastMessage = document.getElementById('success-toast-message');
            const salesDetailModal = document.getElementById('sales-detail-modal');
            const closeSalesDetailModalButton = document.getElementById('close-sales-detail-modal-button');
            const salesDetailTitle = document.getElementById('sales-detail-title');
            const salesDetailCustomerName = document.getElementById('sales-detail-customer-name');
            const salesDetailCustomerEmail = document.getElementById('sales-detail-customer-email');
            const salesDetailSellerName = document.getElementById('sales-detail-seller-name');
            const salesDetailDate = document.getElementById('sales-detail-date');
            const salesDetailPayment = document.getElementById('sales-detail-payment');
            const salesDetailProducts = document.getElementById('sales-detail-products');
            const salesDetailCommentSection = document.getElementById('sales-detail-comment-section');
            const salesDetailComment = document.getElementById('sales-detail-comment');
            const salesDetailSubtotal = document.getElementById('sales-detail-subtotal');
            const salesDetailTaxRow = document.getElementById('sales-detail-tax-row');
            const salesDetailTax = document.getElementById('sales-detail-tax');
            const salesDetailTotal = document.getElementById('sales-detail-total');
            const salesDetailPrint = document.getElementById('sales-detail-print');
            const salesDetailEmail = document.getElementById('sales-detail-email');

            // Paramètres & accès
            const settingsRestrictedState = document.getElementById('settings-restricted-state');
            const settingsTabsWrapper = document.getElementById('settings-tabs-wrapper');
            const settingsTabButtons = document.querySelectorAll('.settings-tab-button');
            const settingsPanels = document.querySelectorAll('[data-settings-panel]');
            const settingsAdminBadge = document.getElementById('settings-admin-badge');
            const accessMembersTbody = document.getElementById('access-members-tbody');
            const accessAddMemberForm = document.getElementById('access-add-member-form');
            const accessMemberNameInput = document.getElementById('access-member-name');
            const accessMemberEmailInput = document.getElementById('access-member-email');
            const accessMemberRoleInput = document.getElementById('access-member-role');
            const accessTotalUsers = document.getElementById('access-total-users');
            const accessTotalAdmins = document.getElementById('access-total-admins');
            const accessTotalPending = document.getElementById('access-total-pending');
            const pendingExitCount = document.getElementById('pending-exit-count');
            const pendingExitPlaceholder = document.getElementById('pending-exit-placeholder');
            const pendingExitTableContainer = document.getElementById('pending-exit-table-container');
            const pendingExitTbody = document.getElementById('pending-exit-tbody');

            function showSuccessToast(message) {
                if (successToastMessage) successToastMessage.textContent = message;
                if (successToast) {
                    successToast.classList.add('show');
                    setTimeout(() => successToast.classList.remove('show'), 3000);
                }
            }

            function formatCurrency(value, currency = 'XOF') {
                if (isNaN(value) || value === null) value = 0;
                const displayCurrency = currency.toUpperCase() === 'CFA' ? 'XOF' : currency;
                try {
                    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: displayCurrency, minimumFractionDigits: 0 }).format(value);
                } catch (e) {
                    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF', minimumFractionDigits: 0 }).format(value);
                }
            }

            const TAX_TOGGLE_STORAGE_KEY = 'stockpilot-tax-enabled';

            function getTaxRate() {
                return isTaxEnabled ? SALES_TAX_RATE : 0;
            }

            function getTaxMultiplier() {
                return 1 + getTaxRate();
            }

            function syncTaxToggleUI() {
                if (taxToggleSales) taxToggleSales.checked = isTaxEnabled;
                if (taxToggleHistory) taxToggleHistory.checked = isTaxEnabled;
                if (cartTaxRow) cartTaxRow.classList.toggle('hidden', !isTaxEnabled);
                if (salesDetailTaxRow) salesDetailTaxRow.classList.toggle('hidden', !isTaxEnabled);
            }

            function setTaxEnabled(value) {
                isTaxEnabled = Boolean(value);
                try {
                    localStorage.setItem(TAX_TOGGLE_STORAGE_KEY, JSON.stringify(isTaxEnabled));
                } catch (error) {
                    console.warn('Impossible de sauvegarder le statut TVA.', error);
                }
                syncTaxToggleUI();
                renderCart();
                renderSalesHistory();
                if (activeSalesDetailId) {
                    openSalesDetailModal(activeSalesDetailId);
                }
            }

            function loadTaxSetting() {
                try {
                    const saved = localStorage.getItem(TAX_TOGGLE_STORAGE_KEY);
                    if (saved !== null) {
                        isTaxEnabled = JSON.parse(saved) === true;
                    }
                } catch (error) {
                    console.warn('Impossible de charger le statut TVA.', error);
                }
                syncTaxToggleUI();
            }

            function formatDateForDisplay(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(' à', ',');
            }

            function formatExitStatusBadge(status) {
                if (status === EXIT_STATUS_APPROVED) return { label: 'Validée', classes: 'bg-green-50 text-green-700 border-green-200' };
                if (status === EXIT_STATUS_REJECTED) return { label: 'Refusée', classes: 'bg-red-50 text-red-700 border-red-200' };
                return { label: 'En attente', classes: 'bg-yellow-50 text-yellow-700 border-yellow-200' };
            }

            function getPendingExitQuantity(productId) {
                const requests = Object.values(appData.storeExitRequests || {});
                return requests
                    .filter(request => request.productId === productId && request.status === EXIT_STATUS_PENDING)
                    .reduce((sum, request) => sum + (parseInt(request.quantity, 10) || 0), 0);
            }

            function normalizeString(value) {
                return (value || '').toString().trim().toLowerCase();
            }

            function normalizePhone(value) {
                return (value || '').toString().replace(/[\s().-]/g, '').trim();
            }

            function getSaleCurrency(sale) {
                if (!sale) return 'CFA';
                if (sale.currency) return sale.currency;
                if (sale.storeProductId && appData.storeProducts?.[sale.storeProductId]?.currency) {
                    return appData.storeProducts[sale.storeProductId].currency || 'CFA';
                }
                const shopItem = appData.shopStock?.[sale.shopProductId];
                if (shopItem && appData.storeProducts[shopItem.sourceProductId]) {
                    return appData.storeProducts[shopItem.sourceProductId].currency || 'CFA';
                }
                return 'CFA';
            }

            function getSaleSource(sale) {
                if (!sale) return SALE_SOURCE_SHOP;
                const raw = (sale.saleSource || sale.source || '').toString().trim().toLowerCase();
                if (raw) {
                    if (raw === 'shop' || raw === 'boutique') return SALE_SOURCE_SHOP;
                    if (raw === 'store' || raw === 'store_direct' || raw === 'magasin' || raw === 'magasin_direct') return SALE_SOURCE_STORE;
                    if (raw === 'mixed' || raw === 'mixte') return SALE_SOURCE_MIXED;
                }
                return sale.shopProductId ? SALE_SOURCE_SHOP : SALE_SOURCE_STORE;
            }

            function formatSaleSourceBadge(source) {
                if (source === SALE_SOURCE_STORE) return { label: 'Magasin direct', classes: 'bg-purple-50 text-purple-700' };
                if (source === SALE_SOURCE_MIXED) return { label: 'Mixte', classes: 'bg-slate-100 text-slate-700' };
                return { label: 'Boutique', classes: 'bg-cyan-50 text-cyan-700' };
            }

            function formatStoreFlagLabel(baseLabel, isStoreFlag) {
                if (!baseLabel) return '';
                return isStoreFlag ? `${baseLabel} Magasin` : baseLabel;
            }

            function isStoreValidationPending(sale) {
                if (!sale) return false;
                return sale.validationStatus === 'pending' || sale.paymentStatus === 'store_validation';
            }

            function getCountableSalesEntries() {
                return Object.values(appData.salesHistory || {}).filter(sale => !isStoreValidationPending(sale));
            }

            function buildCustomerOptionLabel(customer) {
                const name = customer.fullName || customer.name || 'Client';
                const details = [];
                if (customer.phone) details.push(customer.phone);
                if (customer.email) details.push(customer.email);
                return details.length ? `${name} - ${details.join(' - ')}` : name;
            }

            function updateCustomerHistoryVisibility() {
                const canShow = !!selectedCustomer;
                if (customerHistoryButton) customerHistoryButton.classList.toggle('hidden', !canShow);
                if (!canShow) isCustomerHistoryOpen = false;
                if (customerHistorySection) customerHistorySection.classList.toggle('hidden', !canShow || !isCustomerHistoryOpen);
            }

            function updateCustomerSelectedCard() {
                if (!customerSelectedCard || !customerSelectedName || !customerSelectedContact) return;
                if (!selectedCustomer) {
                    customerSelectedCard.classList.add('hidden');
                    return;
                }
                const name = selectedCustomer.fullName || selectedCustomer.name || 'Client';
                const contactParts = [];
                if (selectedCustomer.phone) contactParts.push(selectedCustomer.phone);
                if (selectedCustomer.email) contactParts.push(selectedCustomer.email);
                if (selectedCustomer.address) contactParts.push(selectedCustomer.address);
                customerSelectedName.textContent = name;
                customerSelectedContact.textContent = contactParts.length ? contactParts.join(' | ') : 'Informations non renseignées';
                customerSelectedCard.classList.remove('hidden');
            }

            function renderCustomerOptions() {
                customerOptionLookup = {};
                const customers = Object.values(appData.customers || {}).sort((a, b) => {
                    const nameA = (a.fullName || a.name || '').toLowerCase();
                    const nameB = (b.fullName || b.name || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
                customers.forEach(customer => {
                    const label = buildCustomerOptionLabel(customer);
                    const normalizedLabel = normalizeString(label);
                    if (normalizedLabel) customerOptionLookup[normalizedLabel] = customer;
                    if (customer.fullName) customerOptionLookup[normalizeString(customer.fullName)] = customer;
                    if (customer.phone) customerOptionLookup[normalizePhone(customer.phone)] = customer;
                    if (customer.email) customerOptionLookup[normalizeString(customer.email)] = customer;
                });
                renderCustomerSelectList(customerSelectSearchInput ? customerSelectSearchInput.value : '');
            }

            function renderCustomerSelectList(filter = '') {
                if (!customerSelectList || !customerSelectPlaceholder) return;
                const normalizedFilter = normalizeString(filter);
                const customers = Object.values(appData.customers || {}).sort((a, b) => {
                    const nameA = (a.fullName || a.name || '').toLowerCase();
                    const nameB = (b.fullName || b.name || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
                const filtered = customers.filter(customer => {
                    if (!normalizedFilter) return true;
                    const name = normalizeString(customer.fullName || customer.name || '');
                    const email = normalizeString(customer.email || '');
                    const address = normalizeString(customer.address || '');
                    const phone = normalizePhone(customer.phone || '');
                    return name.includes(normalizedFilter)
                        || email.includes(normalizedFilter)
                        || address.includes(normalizedFilter)
                        || phone.includes(normalizePhone(filter));
                });

                if (!filtered.length) {
                    customerSelectPlaceholder.classList.remove('hidden');
                    customerSelectList.classList.add('hidden');
                    customerSelectList.innerHTML = '';
                    return;
                }

                customerSelectPlaceholder.classList.add('hidden');
                customerSelectList.classList.remove('hidden');
                customerSelectList.innerHTML = filtered.map(customer => {
                    const name = customer.fullName || customer.name || 'Client';
                    const email = customer.email ? `<p class="text-xs text-gray-500">${customer.email}</p>` : '';
                    const phone = customer.phone ? `<p class="text-xs text-gray-500">${customer.phone}</p>` : '';
                    const address = customer.address ? `<p class="text-xs text-gray-400">${customer.address}</p>` : '';
                    return `
                        <button type="button" data-customer-id="${customer.id}"
                            class="w-full text-left p-4 border border-gray-200 rounded-xl hover:border-cyan-300 hover:bg-cyan-50/30 transition">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-full bg-cyan-50 text-cyan-600 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5.121 17.804A4 4 0 0112 15a4 4 0 016.879 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-900">${name}</p>
                                    ${email}
                                    ${phone}
                                    ${address}
                                </div>
                                <svg class="w-5 h-5 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        </button>
                    `;
                }).join('');
            }

            function applySelectedCustomer(customer) {
                selectedCustomer = customer || null;
                if (customerIdInput) customerIdInput.value = customer?.id || '';
                updateCustomerSelectedCard();
                updateCustomerHistoryVisibility();
                renderCustomerHistory();
                renderCart();
            }

            function clearSelectedCustomer() {
                selectedCustomer = null;
                if (customerIdInput) customerIdInput.value = '';
                updateCustomerSelectedCard();
                updateCustomerHistoryVisibility();
                renderCustomerHistory();
                renderCart();
            }

            function getCustomerContext() {
                const customerName = selectedCustomer?.fullName || selectedCustomer?.name || 'Client comptoir';
                return {
                    customerId: selectedCustomer?.id || null,
                    customerName,
                    customerPhone: selectedCustomer?.phone || '',
                    customerEmail: selectedCustomer?.email || ''
                };
            }

            function renderCustomerHistory() {
                updateCustomerHistoryVisibility();
                if (!selectedCustomer || !isCustomerHistoryOpen) return;
                if (!customerHistorySection) return;

                const targetId = selectedCustomer?.id;
                const sales = getCountableSalesEntries().filter(sale => sale.customerId === targetId);
                if (!sales.length) {
                    if (customerHistoryPlaceholder) customerHistoryPlaceholder.classList.remove('hidden');
                    if (customerHistoryTableContainer) customerHistoryTableContainer.classList.add('hidden');
                    if (customerHistoryTbody) customerHistoryTbody.innerHTML = '';
                    if (customerHistoryTotal) customerHistoryTotal.textContent = formatCurrency(0);
                    if (customerHistoryCount) customerHistoryCount.textContent = '0';
                    if (customerHistoryLast) customerHistoryLast.textContent = '-';
                    if (customerHistorySubtitle) customerHistorySubtitle.textContent = selectedCustomer.fullName || selectedCustomer.name || '';
                    return;
                }

                const groupMap = {};
                sales.forEach(sale => {
                    const groupId = sale.saleGroupId || sale.id;
                    if (!groupMap[groupId]) {
                        groupMap[groupId] = {
                            id: groupId,
                            date: sale.date,
                            sellerName: sale.sellerName || '',
                            items: [],
                            total: 0,
                            currency: getSaleCurrency(sale)
                        };
                    }
                    const group = groupMap[groupId];
                    if (new Date(sale.date) > new Date(group.date)) group.date = sale.date;
                    group.items.push({
                        name: sale.productName,
                        quantity: sale.quantity || 0,
                        total: sale.totalAmount || 0
                    });
                    group.total += sale.totalAmount || 0;
                });

                const groups = Object.values(groupMap).sort((a, b) => new Date(b.date) - new Date(a.date));
                const totalAmount = groups.reduce((sum, group) => sum + group.total, 0);
                const currency = groups[0]?.currency || 'CFA';

                if (customerHistorySubtitle) customerHistorySubtitle.textContent = selectedCustomer.fullName || selectedCustomer.name || '';
                if (customerHistoryTotal) customerHistoryTotal.textContent = formatCurrency(totalAmount, currency);
                if (customerHistoryCount) customerHistoryCount.textContent = `${groups.length}`;
                if (customerHistoryLast) customerHistoryLast.textContent = formatDateForDisplay(groups[0].date);

                if (customerHistoryPlaceholder) customerHistoryPlaceholder.classList.add('hidden');
                if (customerHistoryTableContainer) customerHistoryTableContainer.classList.remove('hidden');
                if (customerHistoryTbody) {
                    customerHistoryTbody.innerHTML = groups.map(group => {
                        const itemCount = group.items.reduce((sum, item) => sum + item.quantity, 0);
                        const itemsLabel = group.items.map(item => `${item.name} x${item.quantity}`).join(', ');
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(group.date)}</td>
                                <td class="px-4 py-3 text-sm text-gray-700">${itemCount} article${itemCount > 1 ? 's' : ''} · ${itemsLabel}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-700">${formatCurrency(group.total, group.currency)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${group.sellerName || '-'}</td>
                            </tr>`;
                    }).join('');
                }
            }

            function buildSalesHistoryGroups() {
                const sales = getCountableSalesEntries();
                const groups = {};
                sales.forEach(sale => {
                    if (isStoreValidationPending(sale)) return;
                    const groupId = sale.saleGroupId || sale.id;
                    if (!groups[groupId]) {
                        groups[groupId] = {
                            id: groupId,
                            date: sale.date,
                            sellerName: sale.sellerName || '',
                            customerId: sale.customerId || null,
                            customerName: sale.customerName || '',
                            customerPhone: sale.customerPhone || '',
                            customerEmail: sale.customerEmail || '',
                            items: [],
                            total: 0,
                            currency: getSaleCurrency(sale),
                            comments: [],
                            payLater: false,
                            saleSource: getSaleSource(sale),
                            paymentStatus: sale.paymentStatus || (sale.payLater ? 'pay_later' : 'paid'),
                            hasStoreSource: false,
                            hasShopSource: false,
                            storeFlag: false
                        };
                    }
                    const group = groups[groupId];
                    if (new Date(sale.date) > new Date(group.date)) group.date = sale.date;
                    if (!group.sellerName && sale.sellerName) group.sellerName = sale.sellerName;
                    if (!group.customerName && sale.customerName) group.customerName = sale.customerName;
                    if (!group.customerPhone && sale.customerPhone) group.customerPhone = sale.customerPhone;
                    if (!group.customerEmail && sale.customerEmail) group.customerEmail = sale.customerEmail;
                    group.items.push({
                        saleId: sale.id,
                        shopProductId: sale.shopProductId || null,
                        storeProductId: sale.storeProductId || null,
                        name: sale.productName,
                        quantity: sale.quantity || 0,
                        price: sale.sellingPrice || 0,
                        total: sale.totalAmount || 0
                    });
                    group.total += sale.totalAmount || 0;
                    if (sale.comment && !group.comments.includes(sale.comment)) group.comments.push(sale.comment);
                    if (sale.payLater === true || sale.paymentStatus === 'pay_later') group.payLater = true;
                    if (!group.paymentStatus && sale.paymentStatus) {
                        group.paymentStatus = sale.paymentStatus;
                    } else if (sale.paymentStatus && group.paymentStatus !== sale.paymentStatus) {
                        group.paymentStatus = sale.paymentStatus;
                    }
                    const saleSource = getSaleSource(sale);
                    if (saleSource === SALE_SOURCE_STORE) group.hasStoreSource = true;
                    if (saleSource === SALE_SOURCE_SHOP) group.hasShopSource = true;
                    if (!group.saleSource) {
                        group.saleSource = saleSource;
                    } else if (group.saleSource !== saleSource) {
                        group.saleSource = SALE_SOURCE_MIXED;
                    }
                    group.storeFlag = group.hasStoreSource && !group.hasShopSource;
                });

                return Object.values(groups).sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            const PENDING_SALES_STORAGE_KEY = 'stockpilot-held-cart';

            function getPendingSalesFromStorage() {
                try {
                    const raw = localStorage.getItem(PENDING_SALES_STORAGE_KEY);
                    if (!raw) return [];
                    const parsed = JSON.parse(raw);
                    const list = Array.isArray(parsed) ? parsed : (parsed && typeof parsed === 'object' ? [parsed] : []);
                    const baseId = Date.now();
                    return list.map((sale, index) => {
                        if (!sale || typeof sale !== 'object') return null;
                        return {
                            ...sale,
                            id: sale.id || `HOLD-${baseId}-${index}`
                        };
                    }).filter(Boolean);
                } catch (error) {
                    console.warn('Impossible de lire les ventes en attente.', error);
                }
                return [];
            }

            function savePendingSalesToStorage(pendingSales) {
                try {
                    if (!pendingSales || pendingSales.length === 0) {
                        localStorage.removeItem(PENDING_SALES_STORAGE_KEY);
                        return;
                    }
                    localStorage.setItem(PENDING_SALES_STORAGE_KEY, JSON.stringify(pendingSales));
                } catch (error) {
                    console.warn('Impossible de sauvegarder les ventes en attente.', error);
                }
            }

            function getPendingSalesList() {
                const pending = Object.values(appData.pendingSales || {}).map(item => ({
                    ...item,
                    id: item.id || item.key || item.pendingId
                })).filter(item => item.id);
                if (pending.length) {
                    return pending.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
                }
                return getPendingSalesFromStorage();
            }

            async function migrateLocalPendingSales() {
                if (!dbBasePath || !currentUser) return;
                const localPending = getPendingSalesFromStorage();
                if (!localPending.length) return;
                try {
                    const updates = {};
                    localPending.forEach(pending => {
                        const pendingRef = push(ref(db, `${dbBasePath}/pendingSales`));
                        updates[`${dbBasePath}/pendingSales/${pendingRef.key}`] = {
                            id: pendingRef.key,
                            createdAt: pending.createdAt || new Date().toISOString(),
                            comment: pending.comment || '',
                            customer: pending.customer || {},
                            items: Array.isArray(pending.items) ? pending.items : [],
                            legacyId: pending.id || null,
                            createdBy: currentUser.email || '',
                            stockReserved: pending.stockReserved === true
                        };
                    });
                    await update(ref(db), updates);
                    savePendingSalesToStorage([]);
                } catch (error) {
                    console.warn('Impossible de migrer les paniers en attente.', error);
                }
            }

            function calculateItemsTotal(items = []) {
                return items.reduce((sum, item) => {
                    const price = Number(item.sellingPrice ?? item.price ?? 0);
                    const quantity = Number(item.quantity ?? 0);
                    return sum + (price * quantity);
                }, 0);
            }

            function calculateItemsSummary(items = []) {
                const subtotal = calculateItemsTotal(items);
                const tax = subtotal * getTaxRate();
                const total = subtotal + tax;
                const currency = items[0]?.currency || 'CFA';
                return { subtotal, tax, total, currency };
            }

            function formatHistoryDateParts(dateValue) {
                const date = new Date(dateValue);
                return {
                    dateLabel: date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' }),
                    timeLabel: date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })
                };
            }

            function isDateInFilter(dateValue, filterKey) {
                if (!filterKey || filterKey === 'all') return true;
                const date = new Date(dateValue);
                const now = new Date();
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                if (filterKey === 'today') return date >= startOfToday;
                if (filterKey === 'last7') return date >= new Date(startOfToday.getTime() - 6 * 24 * 60 * 60 * 1000);
                if (filterKey === 'last30') return date >= new Date(startOfToday.getTime() - 29 * 24 * 60 * 60 * 1000);
                if (filterKey === 'thisMonth') return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                if (filterKey === 'lastMonth') {
                    const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    return date.getMonth() === lastMonthDate.getMonth() && date.getFullYear() === lastMonthDate.getFullYear();
                }
                return true;
            }

            function matchesHistorySearch(query, values) {
                if (!query) return true;
                const needle = normalizeString(query);
                return values.some(value => normalizeString(value).includes(needle));
            }

            function renderSalesHistory() {
                if (!salesHistoryList || !salesHistoryEmpty) return;

                const groups = buildSalesHistoryGroups();
                const pendingSales = getPendingSalesList();
                const storeValidationSales = Object.values(appData.salesHistory || {}).filter(isStoreValidationPending);
                const pendingGroups = groups.filter(group => group.paymentStatus === 'pending');
                const payLaterGroups = groups.filter(group => group.paymentStatus === 'pay_later' || group.payLater);
                const paidGroups = groups.filter(group => group.paymentStatus !== 'pending' && group.paymentStatus !== 'pay_later');
                const completedCount = paidGroups.length;
                const pendingCount = pendingSales.length + pendingGroups.length;
                const completedCurrency = paidGroups[0]?.currency || payLaterGroups[0]?.currency || groups[0]?.currency || storeValidationSales[0]?.currency || 'CFA';
                const revenueGroups = groups.filter(group => group.paymentStatus !== 'pending');
                const totalRevenue = revenueGroups.reduce((sum, group) => sum + (group.total * getTaxMultiplier()), 0);
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const todayRevenue = revenueGroups
                    .filter(group => new Date(group.date) >= todayStart)
                    .reduce((sum, group) => sum + (group.total * getTaxMultiplier()), 0);
                const payLaterTotal = payLaterGroups.reduce((sum, group) => sum + (group.total * getTaxMultiplier()), 0);

                if (salesHistoryCompletedCount) salesHistoryCompletedCount.textContent = completedCount;
                if (salesHistoryPendingCount) salesHistoryPendingCount.textContent = pendingCount;
                if (salesHistoryPayLaterCount) salesHistoryPayLaterCount.textContent = payLaterGroups.length;
                if (salesHistoryStoreValidationCount) salesHistoryStoreValidationCount.textContent = storeValidationSales.length;
                if (salesHistoryStatCompleted) salesHistoryStatCompleted.textContent = completedCount;
                if (salesHistoryStatPending) salesHistoryStatPending.textContent = pendingCount;
                if (salesHistoryStatPayLater) salesHistoryStatPayLater.textContent = formatCurrency(payLaterTotal, completedCurrency);
                if (salesHistoryStatToday) salesHistoryStatToday.textContent = formatCurrency(todayRevenue, completedCurrency);
                if (salesHistoryStatTotal) salesHistoryStatTotal.textContent = formatCurrency(totalRevenue, completedCurrency);

                if (salesHistoryTabCompleted) {
                    const isActive = salesHistoryTab === 'completed';
                    salesHistoryTabCompleted.classList.toggle('bg-blue-600', isActive);
                    salesHistoryTabCompleted.classList.toggle('text-white', isActive);
                    salesHistoryTabCompleted.classList.toggle('shadow', isActive);
                    salesHistoryTabCompleted.classList.toggle('bg-gray-100', !isActive);
                    salesHistoryTabCompleted.classList.toggle('text-gray-600', !isActive);
                    if (salesHistoryCompletedCount) {
                        salesHistoryCompletedCount.classList.toggle('bg-white/20', isActive);
                        salesHistoryCompletedCount.classList.toggle('bg-gray-200', !isActive);
                        salesHistoryCompletedCount.classList.toggle('text-white', isActive);
                        salesHistoryCompletedCount.classList.toggle('text-gray-600', !isActive);
                    }
                }
                if (salesHistoryTabPending) {
                    const isActive = salesHistoryTab === 'pending';
                    salesHistoryTabPending.classList.toggle('bg-orange-500', isActive);
                    salesHistoryTabPending.classList.toggle('text-white', isActive);
                    salesHistoryTabPending.classList.toggle('shadow', isActive);
                    salesHistoryTabPending.classList.toggle('bg-gray-100', !isActive);
                    salesHistoryTabPending.classList.toggle('text-gray-600', !isActive);
                    if (salesHistoryPendingCount) {
                        salesHistoryPendingCount.classList.toggle('bg-white/20', isActive);
                        salesHistoryPendingCount.classList.toggle('bg-gray-200', !isActive);
                        salesHistoryPendingCount.classList.toggle('text-white', isActive);
                        salesHistoryPendingCount.classList.toggle('text-gray-600', !isActive);
                    }
                }
                if (salesHistoryTabPayLater) {
                    const isActive = salesHistoryTab === 'pay_later';
                    salesHistoryTabPayLater.classList.toggle('bg-purple-600', isActive);
                    salesHistoryTabPayLater.classList.toggle('text-white', isActive);
                    salesHistoryTabPayLater.classList.toggle('shadow', isActive);
                    salesHistoryTabPayLater.classList.toggle('bg-gray-100', !isActive);
                    salesHistoryTabPayLater.classList.toggle('text-gray-600', !isActive);
                    if (salesHistoryPayLaterCount) {
                        salesHistoryPayLaterCount.classList.toggle('bg-white/20', isActive);
                        salesHistoryPayLaterCount.classList.toggle('bg-gray-200', !isActive);
                        salesHistoryPayLaterCount.classList.toggle('text-white', isActive);
                        salesHistoryPayLaterCount.classList.toggle('text-gray-600', !isActive);
                    }
                }
                if (salesHistoryTabStoreValidation) {
                    const isActive = salesHistoryTab === 'store_validation';
                    salesHistoryTabStoreValidation.classList.toggle('bg-emerald-600', isActive);
                    salesHistoryTabStoreValidation.classList.toggle('text-white', isActive);
                    salesHistoryTabStoreValidation.classList.toggle('shadow', isActive);
                    salesHistoryTabStoreValidation.classList.toggle('bg-gray-100', !isActive);
                    salesHistoryTabStoreValidation.classList.toggle('text-gray-600', !isActive);
                    if (salesHistoryStoreValidationCount) {
                        salesHistoryStoreValidationCount.classList.toggle('bg-white/20', isActive);
                        salesHistoryStoreValidationCount.classList.toggle('bg-gray-200', !isActive);
                        salesHistoryStoreValidationCount.classList.toggle('text-white', isActive);
                        salesHistoryStoreValidationCount.classList.toggle('text-gray-600', !isActive);
                    }
                }

                const filteredGroups = groups.filter(group => {
                    if (!isDateInFilter(group.date, salesHistoryDateFilterValue)) return false;
                    if (!salesHistorySearch) return true;
                    const customerLabel = group.customerName || (group.customerId && appData.customers?.[group.customerId]?.fullName) || 'Client comptoir';
                    const sourceLabel = formatSaleSourceBadge(group.saleSource)?.label || '';
                    const values = [
                        `INV-${group.id.slice(-6).toUpperCase()}`,
                        group.id,
                        customerLabel,
                        group.customerEmail,
                        group.customerPhone,
                        group.sellerName,
                        group.items.map(item => item.name).join(' '),
                        (group.comments || []).join(' '),
                        sourceLabel
                    ];
                    return matchesHistorySearch(salesHistorySearch, values);
                });
                const filteredPaid = filteredGroups.filter(group => group.paymentStatus !== 'pending' && group.paymentStatus !== 'pay_later');
                const filteredPayLater = filteredGroups.filter(group => group.paymentStatus === 'pay_later' || group.payLater);
                const filteredPendingGroups = filteredGroups.filter(group => group.paymentStatus === 'pending');

                const filteredPending = pendingSales.filter(pending => {
                    if (!isDateInFilter(pending.createdAt || pending.date, salesHistoryDateFilterValue)) return false;
                    if (!salesHistorySearch) return true;
                    const customer = pending.customer || {};
                    const values = [
                        `INV-${(pending.id || '').slice(-6).toUpperCase()}`,
                        pending.id,
                        customer.name,
                        customer.email,
                        customer.phone,
                        (pending.items || []).map(item => item.name).join(' '),
                        pending.comment
                    ];
                    return matchesHistorySearch(salesHistorySearch, values);
                });

                const filteredStoreValidation = storeValidationSales.filter(sale => {
                    const dateValue = sale.date || sale.requestedAt || sale.createdAt;
                    if (!isDateInFilter(dateValue, salesHistoryDateFilterValue)) return false;
                    if (!salesHistorySearch) return true;
                    const customerLabel = sale.customerName || 'Client comptoir';
                    const sourceLabel = formatSaleSourceBadge(getSaleSource(sale))?.label || '';
                    const values = [
                        `INV-${(sale.saleGroupId || sale.id || '').slice(-6).toUpperCase()}`,
                        sale.id,
                        customerLabel,
                        sale.customerEmail,
                        sale.customerPhone,
                        sale.sellerName,
                        sale.productName,
                        sale.comment,
                        sourceLabel
                    ];
                    return matchesHistorySearch(salesHistorySearch, values);
                });

                const showCompleted = salesHistoryTab === 'completed';
                const showPayLater = salesHistoryTab === 'pay_later';
                const showStoreValidation = salesHistoryTab === 'store_validation';
                const listHasItems = showCompleted
                    ? filteredPaid.length
                    : (showPayLater
                        ? filteredPayLater.length
                        : (showStoreValidation
                            ? filteredStoreValidation.length
                            : (filteredPendingGroups.length + filteredPending.length)));
                if (!listHasItems) {
                    salesHistoryEmpty.classList.remove('hidden');
                    salesHistoryList.classList.add('hidden');
                    salesHistoryList.innerHTML = '';
                    return;
                }

                salesHistoryEmpty.classList.add('hidden');
                salesHistoryList.classList.remove('hidden');

                if (showStoreValidation) {
                    const canValidateStore = getCurrentUserRole() === 'admin';
                    salesHistoryList.innerHTML = filteredStoreValidation.map(sale => {
                        const quantity = Number(sale.quantity || 0) || 1;
                        const unitPrice = Number(sale.sellingPrice || (sale.totalAmount / Math.max(quantity, 1)) || 0);
                        const currency = getSaleCurrency(sale) || 'CFA';
                        const summary = calculateItemsSummary([{
                            sellingPrice: unitPrice,
                            quantity,
                            currency
                        }]);
                        const { dateLabel, timeLabel } = formatHistoryDateParts(sale.date || new Date().toISOString());
                        const customerLabel = sale.customerName || 'Client comptoir';
                        const customerEmail = sale.customerEmail || '';
                        const sourceBadge = formatSaleSourceBadge(getSaleSource(sale));
                        const sourceHtml = sourceBadge
                            ? `<span class="px-2 py-0.5 rounded-full text-xs font-semibold ${sourceBadge.classes}">${sourceBadge.label}</span>`
                            : '';
                        const detailsButtonHtml = `
                            <button type="button" data-history-action="details" data-history-id="${sale.id}"
                                class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Détails
                            </button>
                        `;
                        const validationActions = canValidateStore ? `
                            <button type="button" data-store-validation-id="${sale.id}" data-store-validation-action="paid"
                                class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-700">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Valider
                            </button>
                            <button type="button" data-store-validation-id="${sale.id}" data-store-validation-action="pending"
                                class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-orange-500 text-white font-semibold hover:bg-orange-600">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3M12 6a6 6 0 100 12 6 6 0 000-12z" />
                                </svg>
                                En attente
                            </button>
                            <button type="button" data-store-validation-id="${sale.id}" data-store-validation-action="pay_later"
                                class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-purple-600 text-white font-semibold hover:bg-purple-700">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 11h18M5 7v10a2 2 0 002 2h10a2 2 0 002-2V7" />
                                </svg>
                                A payer plus tard
                            </button>
                            ${detailsButtonHtml}
                        ` : detailsButtonHtml;
                        return `
                            <div class="border border-gray-200 rounded-2xl shadow-sm bg-white overflow-hidden">
                                <div class="p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
                                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7l9-4 9 4-9 4-9-4zM3 7v10l9 4 9-4V7" />
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <p class="font-semibold text-gray-900">INV-${(sale.saleGroupId || sale.id || '').slice(-6).toUpperCase()}</p>
                                                <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-700">Validation magasin</span>
                                                ${sourceHtml}
                                            </div>
                                            <div class="mt-1 flex flex-wrap items-center gap-3 text-xs text-gray-500">
                                                <span>${dateLabel}</span>
                                                <span>${timeLabel}</span>
                                                <span>${quantity} article${quantity > 1 ? 's' : ''}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-2xl font-bold text-emerald-600">${formatCurrency(summary.total, summary.currency)}</p>
                                        <p class="text-xs text-gray-400">${quantity} article${quantity > 1 ? 's' : ''}</p>
                                    </div>
                                </div>
                                <div class="px-4 pb-4">
                                    <div class="flex items-center gap-2 text-sm text-gray-600 border-t border-gray-100 pt-3">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A4 4 0 0112 15a4 4 0 016.879 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span class="font-semibold text-gray-900">${customerLabel}</span>
                                        ${customerEmail ? `<span class="text-xs text-gray-400">· ${customerEmail}</span>` : ''}
                                    </div>
                                    ${sale.comment ? `<p class="mt-2 text-xs text-gray-500">Commentaire: ${sale.comment}</p>` : ''}
                                    <div class="mt-4 space-y-3">
                                        <div class="flex items-center justify-between text-sm text-gray-700">
                                            <div class="flex items-center gap-3">
                                                <span class="px-2 py-0.5 rounded-lg bg-gray-100 text-xs font-semibold text-gray-500">${quantity}x</span>
                                                <span class="font-semibold text-gray-900">${sale.productName || 'Produit'}</span>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-xs text-gray-500">${formatCurrency(unitPrice, summary.currency)} / unité</p>
                                                <p class="text-sm font-semibold text-gray-900">${formatCurrency(sale.totalAmount || (unitPrice * quantity), summary.currency)}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 space-y-2 border-t border-gray-100 pt-4">
                                        <div class="flex items-center justify-between text-sm text-gray-600">
                                            <span>Sous-total</span>
                                            <span>${formatCurrency(summary.subtotal, summary.currency)}</span>
                                        </div>
                                        ${isTaxEnabled ? `
                                            <div class="flex items-center justify-between text-sm text-gray-400">
                                                <span>TVA (20%)</span>
                                                <span>${formatCurrency(summary.tax, summary.currency)}</span>
                                            </div>
                                        ` : ''}
                                        <div class="flex items-center justify-between text-base font-semibold text-gray-900 border-t border-gray-100 pt-3">
                                            <span>Total</span>
                                            <span class="text-emerald-600">${formatCurrency(summary.total, summary.currency)}</span>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex flex-col md:flex-row gap-3">
                                        ${validationActions}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    return;
                }

                if (showCompleted || showPayLater) {
                    const groupsToRender = showPayLater ? filteredPayLater : filteredPaid;
                    salesHistoryList.innerHTML = groupsToRender.map(group => {
                        const customerLabel = group.customerName || (group.customerId && appData.customers?.[group.customerId]?.fullName) || 'Client comptoir';
                        const customerEmail = group.customerEmail || (group.customerId && appData.customers?.[group.customerId]?.email) || '';
                        const itemsCount = group.items.reduce((sum, item) => sum + item.quantity, 0);
                        const isPayLater = group.paymentStatus === 'pay_later' || group.payLater;
                        const summary = calculateItemsSummary(group.items.map(item => ({
                            sellingPrice: item.price,
                            quantity: item.quantity,
                            currency: group.currency
                        })));
                        const { dateLabel, timeLabel } = formatHistoryDateParts(group.date);
                        const itemsHtml = group.items.map(item => {
                            const unitPrice = item.price || (item.total / Math.max(item.quantity, 1));
                            const canRemove = isPayLater && item.saleId;
                            const removeButtonHtml = canRemove ? `
                                <button type="button" data-history-item-remove="${item.saleId}" data-history-item-group="${group.id}"
                                    class="mt-1 text-xs font-semibold text-red-600 hover:text-red-700">
                                    Retirer
                                </button>
                            ` : '';
                            return `
                                <div class="flex items-center justify-between text-sm text-gray-700">
                                    <div class="flex items-center gap-3">
                                        <span class="px-2 py-0.5 rounded-lg bg-gray-100 text-xs font-semibold text-gray-500">${item.quantity}x</span>
                                        <span class="font-semibold text-gray-900">${item.name}</span>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs text-gray-500">${formatCurrency(unitPrice, group.currency)} / unité</p>
                                        <p class="text-sm font-semibold text-gray-900">${formatCurrency(item.total, group.currency)}</p>
                                        ${removeButtonHtml}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        const taxRowHtml = isTaxEnabled ? `
                            <div class="flex items-center justify-between text-sm text-gray-400">
                                <span>TVA (20%)</span>
                                <span>${formatCurrency(summary.tax, summary.currency)}</span>
                            </div>
                        ` : '';
                        const isStoreFlagged = group.storeFlag === true;
                        const statusLabel = isPayLater
                            ? formatStoreFlagLabel('A payer plus tard', isStoreFlagged)
                            : formatStoreFlagLabel('Complétée', isStoreFlagged);
                        const statusHtml = isPayLater
                            ? `<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-purple-100 text-purple-700">${statusLabel}</span>`
                            : `<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-green-50 text-green-700">${statusLabel}</span>`;
                        const sourceBadge = formatSaleSourceBadge(group.saleSource);
                        const sourceHtml = sourceBadge
                            ? `<span class="px-2 py-0.5 rounded-full text-xs font-semibold ${sourceBadge.classes}">${sourceBadge.label}</span>`
                            : '';
                        const markPaidButtonHtml = isPayLater ? `
                            <button type="button" data-history-action="mark-paid" data-history-id="${group.id}"
                                class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-700">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Marquer comme payé
                            </button>
                        ` : '';
                        const detailsButtonHtml = `
                            <button type="button" data-history-action="details" data-history-id="${group.id}"
                                class="${isPayLater ? 'inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700' : 'flex-1 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700'}">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Voir détails
                            </button>
                        `;
                        return `
                            <div class="border border-gray-200 rounded-2xl shadow-sm bg-white overflow-hidden">
                                <div class="p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center">
                                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l2 2 4-4M7 4h10a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V6a2 2 0 012-2z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <p class="font-semibold text-gray-900">INV-${group.id.slice(-6).toUpperCase()}</p>
                                                ${statusHtml}
                                                ${sourceHtml}
                                            </div>
                                            <div class="mt-1 flex flex-wrap items-center gap-3 text-xs text-gray-500">
                                                <span>${dateLabel}</span>
                                                <span>${timeLabel}</span>
                                                <span>${itemsCount} article${itemsCount > 1 ? 's' : ''}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-2xl font-bold text-blue-600">${formatCurrency(summary.total, summary.currency)}</p>
                                        <p class="text-xs text-gray-400">${itemsCount} article${itemsCount > 1 ? 's' : ''}</p>
                                    </div>
                                </div>
                                <div class="px-4 pb-4">
                                    <div class="flex items-center gap-2 text-sm text-gray-600 border-t border-gray-100 pt-3">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A4 4 0 0112 15a4 4 0 016.879 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span class="font-semibold text-gray-900">${customerLabel}</span>
                                        ${customerEmail ? `<span class="text-xs text-gray-400">· ${customerEmail}</span>` : ''}
                                    </div>
                                    <div class="mt-4 space-y-3">
                                        ${itemsHtml}
                                    </div>
                                    <div class="mt-4 space-y-2 border-t border-gray-100 pt-4">
                                        <div class="flex items-center justify-between text-sm text-gray-600">
                                            <span>Sous-total</span>
                                            <span>${formatCurrency(summary.subtotal, summary.currency)}</span>
                                        </div>
                                        ${taxRowHtml}
                                        <div class="flex items-center justify-between text-base font-semibold text-gray-900 border-t border-gray-100 pt-3">
                                            <span>Total</span>
                                            <span class="text-blue-600">${formatCurrency(summary.total, summary.currency)}</span>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex flex-col md:flex-row gap-3">
                                        ${markPaidButtonHtml}
                                        ${detailsButtonHtml}
                                        ${isPayLater ? '' : `
                                            <button type="button" data-history-action="print" data-history-id="${group.id}"
                                                class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-gray-900 text-white font-semibold hover:bg-gray-800">
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 9V4h12v5M6 18h12v2H6v-2zM6 14h12v4H6v-4z" />
                                                </svg>
                                                Imprimer
                                            </button>
                                            <button type="button" data-history-action="email" data-history-id="${group.id}"
                                                class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-purple-600 text-white font-semibold hover:bg-purple-700">
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l9 6 9-6M5 6h14a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2z" />
                                                </svg>
                                                Email
                                            </button>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    return;
                }

                const pendingGroupsHtml = filteredPendingGroups.map(group => {
                    const customerLabel = group.customerName || (group.customerId && appData.customers?.[group.customerId]?.fullName) || 'Client comptoir';
                    const customerEmail = group.customerEmail || (group.customerId && appData.customers?.[group.customerId]?.email) || '';
                    const itemsCount = group.items.reduce((sum, item) => sum + item.quantity, 0);
                    const summary = calculateItemsSummary(group.items.map(item => ({
                        sellingPrice: item.price,
                        quantity: item.quantity,
                        currency: group.currency
                    })));
                    const { dateLabel, timeLabel } = formatHistoryDateParts(group.date);
                    const itemsHtml = group.items.map(item => {
                        const unitPrice = item.price || (item.total / Math.max(item.quantity, 1));
                        const removeButtonHtml = item.saleId ? `
                            <button type="button" data-history-item-remove="${item.saleId}" data-history-item-group="${group.id}"
                                class="mt-1 text-xs font-semibold text-red-600 hover:text-red-700">
                                Retirer
                            </button>
                        ` : '';
                        return `
                            <div class="flex items-center justify-between text-sm text-gray-700">
                                <div class="flex items-center gap-3">
                                    <span class="px-2 py-0.5 rounded-lg bg-gray-100 text-xs font-semibold text-gray-500">${item.quantity}x</span>
                                    <span class="font-semibold text-gray-900">${item.name}</span>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">${formatCurrency(unitPrice, group.currency)} / unité</p>
                                    <p class="text-sm font-semibold text-gray-900">${formatCurrency(item.total, group.currency)}</p>
                                    ${removeButtonHtml}
                                </div>
                            </div>
                        `;
                    }).join('');
                    const taxRowHtml = isTaxEnabled ? `
                        <div class="flex items-center justify-between text-sm text-gray-400">
                            <span>TVA (20%)</span>
                            <span>${formatCurrency(summary.tax, summary.currency)}</span>
                        </div>
                    ` : '';
                    const pendingLabel = formatStoreFlagLabel('En attente', group.storeFlag === true);
                    const statusHtml = `<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-orange-50 text-orange-700">${pendingLabel}</span>`;
                    const sourceBadge = formatSaleSourceBadge(group.saleSource);
                    const sourceHtml = sourceBadge
                        ? `<span class="px-2 py-0.5 rounded-full text-xs font-semibold ${sourceBadge.classes}">${sourceBadge.label}</span>`
                        : '';
                    return `
                        <div class="border border-gray-200 rounded-2xl shadow-sm bg-white overflow-hidden">
                            <div class="p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-xl bg-orange-50 text-orange-600 flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3M12 6a6 6 0 100 12 6 6 0 000-12z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <p class="font-semibold text-gray-900">INV-${group.id.slice(-6).toUpperCase()}</p>
                                            ${statusHtml}
                                            ${sourceHtml}
                                        </div>
                                        <div class="mt-1 flex flex-wrap items-center gap-3 text-xs text-gray-500">
                                            <span>${dateLabel}</span>
                                            <span>${timeLabel}</span>
                                            <span>${itemsCount} article${itemsCount > 1 ? 's' : ''}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold text-blue-600">${formatCurrency(summary.total, summary.currency)}</p>
                                    <p class="text-xs text-gray-400">${itemsCount} article${itemsCount > 1 ? 's' : ''}</p>
                                </div>
                            </div>
                            <div class="px-4 pb-4">
                                <div class="flex items-center gap-2 text-sm text-gray-600 border-t border-gray-100 pt-3">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A4 4 0 0112 15a4 4 0 016.879 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    <span class="font-semibold text-gray-900">${customerLabel}</span>
                                    ${customerEmail ? `<span class="text-xs text-gray-400">· ${customerEmail}</span>` : ''}
                                </div>
                                <div class="mt-4 space-y-3">
                                    ${itemsHtml}
                                </div>
                                <div class="mt-4 space-y-2 border-t border-gray-100 pt-4">
                                    <div class="flex items-center justify-between text-sm text-gray-600">
                                        <span>Sous-total</span>
                                        <span>${formatCurrency(summary.subtotal, summary.currency)}</span>
                                    </div>
                                    ${taxRowHtml}
                                    <div class="flex items-center justify-between text-base font-semibold text-gray-900 border-t border-gray-100 pt-3">
                                        <span>Total</span>
                                        <span class="text-blue-600">${formatCurrency(summary.total, summary.currency)}</span>
                                    </div>
                                </div>
                                <div class="mt-4 flex flex-col md:flex-row gap-3">
                                    <button type="button" data-history-action="mark-paid" data-history-id="${group.id}"
                                        class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-700">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                        Valider
                                    </button>
                                    <button type="button" data-history-action="mark-paylater" data-history-id="${group.id}"
                                        class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-purple-600 text-white font-semibold hover:bg-purple-700">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 11h18M5 7v10a2 2 0 002 2h10a2 2 0 002-2V7" />
                                        </svg>
                                        A payer plus tard
                                    </button>
                                    <button type="button" data-history-action="details" data-history-id="${group.id}"
                                        class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Voir détails
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                const pendingLocalHtml = filteredPending.map(pending => {
                    const customer = pending.customer || {};
                    const items = pending.items || [];
                    const itemsCount = items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                    const summary = calculateItemsSummary(items);
                    const { dateLabel, timeLabel } = formatHistoryDateParts(pending.createdAt || pending.date || new Date().toISOString());
                    const itemsHtml = items.map((item, itemIndex) => {
                        const unitPrice = item.sellingPrice || (item.total / Math.max(item.quantity, 1));
                        const lineTotal = (item.sellingPrice || item.price || 0) * (item.quantity || 0);
                        return `
                            <div class="flex items-center justify-between text-sm text-gray-700">
                                <div class="flex items-center gap-3">
                                    <span class="px-2 py-0.5 rounded-lg bg-gray-100 text-xs font-semibold text-gray-500">${item.quantity}x</span>
                                    <span class="font-semibold text-gray-900">${item.name}</span>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">${formatCurrency(unitPrice, summary.currency)} / unité</p>
                                    <p class="text-sm font-semibold text-gray-900">${formatCurrency(lineTotal, summary.currency)}</p>
                                    <button type="button" data-pending-item-remove="${pending.id}" data-pending-item-index="${itemIndex}"
                                        class="mt-1 text-xs font-semibold text-red-600 hover:text-red-700">
                                        Retirer
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    const taxRowHtml = isTaxEnabled ? `
                        <div class="flex items-center justify-between text-sm text-gray-400">
                            <span>TVA (20%)</span>
                            <span>${formatCurrency(summary.tax, summary.currency)}</span>
                        </div>
                    ` : '';

                    return `
                        <div class="border border-gray-200 rounded-2xl shadow-sm bg-white overflow-hidden">
                            <div class="p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-xl bg-orange-50 text-orange-600 flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3M12 6a6 6 0 100 12 6 6 0 000-12z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <p class="font-semibold text-gray-900">INV-${(pending.id || '').slice(-6).toUpperCase()}</p>
                                            <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-orange-50 text-orange-700">En attente</span>
                                        </div>
                                        <div class="mt-1 flex flex-wrap items-center gap-3 text-xs text-gray-500">
                                            <span>${dateLabel}</span>
                                            <span>${timeLabel}</span>
                                            <span>${itemsCount} article${itemsCount > 1 ? 's' : ''}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold text-blue-600">${formatCurrency(summary.total, summary.currency)}</p>
                                    <p class="text-xs text-gray-400">${itemsCount} article${itemsCount > 1 ? 's' : ''}</p>
                                </div>
                            </div>
                            <div class="px-4 pb-4">
                                <div class="flex items-center gap-2 text-sm text-gray-600 border-t border-gray-100 pt-3">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A4 4 0 0112 15a4 4 0 016.879 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    <span class="font-semibold text-gray-900">${customer.name || 'Client'}</span>
                                    ${customer.email ? `<span class="text-xs text-gray-400">· ${customer.email}</span>` : ''}
                                </div>
                                ${pending.comment ? `<p class="mt-2 text-xs text-gray-500">Commentaire: ${pending.comment}</p>` : ''}
                                <div class="mt-4 space-y-3">
                                    ${itemsHtml}
                                </div>
                                <div class="mt-4 space-y-2 border-t border-gray-100 pt-4">
                                    <div class="flex items-center justify-between text-sm text-gray-600">
                                        <span>Sous-total</span>
                                        <span>${formatCurrency(summary.subtotal, summary.currency)}</span>
                                    </div>
                                    ${taxRowHtml}
                                    <div class="flex items-center justify-between text-base font-semibold text-gray-900 border-t border-gray-100 pt-3">
                                        <span>Total</span>
                                        <span class="text-blue-600">${formatCurrency(summary.total, summary.currency)}</span>
                                    </div>
                                </div>
                                <div class="mt-4 flex flex-col md:flex-row gap-3">
                                    <button type="button" data-pending-validate="${pending.id}"
                                        class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-700">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                        Valider la vente
                                    </button>
                                    <button type="button" data-pending-cancel="${pending.id}"
                                        class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-700">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                        Annuler
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                salesHistoryList.innerHTML = `${pendingGroupsHtml}${pendingLocalHtml}`;
            }

            function openSalesDetailModal(groupId) {
                if (!salesDetailModal || !groupId) return;
                const groups = buildSalesHistoryGroups();
                let group = groups.find(item => item.id === groupId);
                if (!group) {
                    const sale = appData.salesHistory?.[groupId];
                    if (!sale) return;
                    const quantity = Number(sale.quantity || 0) || 1;
                    const totalAmount = Number(sale.totalAmount || 0);
                    const unitPrice = Number(sale.sellingPrice || (totalAmount / Math.max(quantity, 1)) || 0);
                    const currency = getSaleCurrency(sale) || 'CFA';
                    group = {
                        id: sale.saleGroupId || sale.id || groupId,
                        date: sale.date || sale.requestedAt || sale.createdAt || new Date().toISOString(),
                        sellerName: sale.sellerName || '',
                        customerId: sale.customerId || null,
                        customerName: sale.customerName || '',
                        customerPhone: sale.customerPhone || '',
                        customerEmail: sale.customerEmail || '',
                        items: [{
                            name: sale.productName || 'Produit',
                            quantity,
                            price: unitPrice,
                            total: totalAmount || (unitPrice * quantity)
                        }],
                        total: totalAmount || (unitPrice * quantity),
                        currency,
                        comments: sale.comment ? [sale.comment] : [],
                        payLater: sale.payLater === true || sale.paymentStatus === 'pay_later',
                        saleSource: getSaleSource(sale),
                        paymentStatus: sale.paymentStatus || (sale.payLater ? 'pay_later' : (isStoreValidationPending(sale) ? 'store_validation' : 'paid'))
                    };
                }

                activeSalesDetailId = groupId;
                const customerName = group.customerName || (group.customerId && appData.customers?.[group.customerId]?.fullName) || 'Client comptoir';
                const customerEmail = group.customerEmail || (group.customerId && appData.customers?.[group.customerId]?.email) || 'Email non renseigné';
                const sellerName = group.sellerName || 'Non renseigné';
                const summary = calculateItemsSummary(group.items.map(item => ({
                    sellingPrice: item.price,
                    quantity: item.quantity,
                    currency: group.currency
                })));
                const itemsHtml = group.items.map(item => {
                    const unitPrice = item.price || (item.total / Math.max(item.quantity, 1));
                    return `
                        <div class="flex items-center justify-between bg-gray-50 rounded-2xl px-4 py-3">
                            <div>
                                <p class="text-sm font-semibold text-gray-900">${item.name}</p>
                                <p class="text-xs text-gray-500">${item.quantity}x ${formatCurrency(unitPrice, group.currency)}</p>
                            </div>
                            <p class="text-sm font-semibold text-gray-900">${formatCurrency(item.total, group.currency)}</p>
                        </div>
                    `;
                }).join('');
                const commentList = Array.isArray(group.comments) ? group.comments.filter(Boolean) : [];
                const commentText = commentList.length
                    ? commentList.join(' · ')
                    : (group.comment || '').toString().trim();
                const sourceLabel = formatSaleSourceBadge(group.saleSource)?.label || 'Boutique';

                if (salesDetailTitle) salesDetailTitle.textContent = `Détails de la vente INV-${group.id.slice(-6).toUpperCase()}`;
                if (salesDetailCustomerName) salesDetailCustomerName.textContent = customerName;
                if (salesDetailCustomerEmail) salesDetailCustomerEmail.textContent = customerEmail;
                if (salesDetailSellerName) salesDetailSellerName.textContent = `Vendeur : ${sellerName}`;
                if (salesDetailDate) salesDetailDate.textContent = formatDateForDisplay(group.date);
                const paymentLabel = group.paymentStatus === 'store_validation'
                    ? 'Validation magasin'
                    : (group.paymentStatus === 'pending'
                        ? 'En attente'
                        : (group.paymentStatus === 'pay_later' || group.payLater ? 'A payer plus tard' : 'Payée'));
                if (salesDetailPayment) salesDetailPayment.textContent = `${paymentLabel} · ${sourceLabel}`;
                if (salesDetailProducts) salesDetailProducts.innerHTML = itemsHtml;
                if (salesDetailComment) salesDetailComment.textContent = commentText;
                if (salesDetailCommentSection) salesDetailCommentSection.classList.toggle('hidden', !commentText);
                if (salesDetailSubtotal) salesDetailSubtotal.textContent = formatCurrency(summary.subtotal, summary.currency);
                if (salesDetailTax) salesDetailTax.textContent = formatCurrency(summary.tax, summary.currency);
                if (salesDetailTotal) salesDetailTotal.textContent = formatCurrency(summary.total, summary.currency);
                if (salesDetailTaxRow) salesDetailTaxRow.classList.toggle('hidden', !isTaxEnabled);

                salesDetailModal.classList.remove('hidden');
            }

            function closeSalesDetailModal() {
                if (!salesDetailModal) return;
                salesDetailModal.classList.add('hidden');
                activeSalesDetailId = null;
            }

            function openCustomerSelectModal() {
                if (customerSelectSearchInput) customerSelectSearchInput.value = '';
                renderCustomerSelectList('');
                if (customerSelectModal) customerSelectModal.classList.remove('hidden');
            }

            function closeCustomerSelectModal() {
                if (customerSelectModal) customerSelectModal.classList.add('hidden');
            }

            function openCustomerModalDialog() {
                if (customerError) customerError.classList.add('hidden');
                if (customerForm) customerForm.reset();
                if (customerModal) customerModal.classList.remove('hidden');
            }

            function closeCustomerModalDialog() {
                if (customerModal) customerModal.classList.add('hidden');
            }

            function generateAccessCode() {
                const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 8; i += 1) {
                    code += alphabet[Math.floor(Math.random() * alphabet.length)];
                }
                return code;
            }

            function getCurrentUserRole() {
                if (!isAuthenticated || !currentUserData) return 'invite';
                return (currentUserData.role || 'admin').toLowerCase();
            }

            function normalizePermissions(list) {
                if (!Array.isArray(list)) return [];
                return [...new Set(list)].sort();
            }

            function updateSettingsAccess() {
                const canAccessSettings = hasPermission('Paramètres');
                if (settingsRestrictedState) settingsRestrictedState.classList.toggle('hidden', canAccessSettings);
                if (settingsTabsWrapper) settingsTabsWrapper.classList.toggle('hidden', !canAccessSettings);
                if (settingsAdminBadge) settingsAdminBadge.textContent = `Rôle : ${canAccessSettings ? 'Admin' : 'Accès limité'}`;
            }

            function hasPermission(permission) {
                if (!isAuthenticated || !currentUserData) return false;
                if (!Array.isArray(currentUserData.permissions)) return false;
                return currentUserData.permissions.includes(permission);
            }

            // Mapping des pages aux permissions requises
            const pagePermissions = {
                'Tableau de bord': 'Tableau de bord',
                'Ventes': 'Ventes',
                'Historique des ventes': ['Historique des ventes', 'Ventes'],
                'Stock Boutique': 'Stock Boutique',
                'Mon Magasin': 'Mon Magasin',
                'Mouvements Magasin': ['Mouvements Magasin', 'Mon Magasin'],
                'Statistiques': 'Statistiques',
                'Paramètres': 'Paramètres'
            };

            function canAccessPage(pageName) {
                if (!isAuthenticated || !currentUserData) {
                    console.log(`[canAccessPage] Not authenticated or no user data for page: ${pageName}`);
                    return false;
                }

                const requiredPermission = pagePermissions[pageName];
                console.log(`[canAccessPage] Checking page: ${pageName}, Required permission: ${requiredPermission}`);
                console.log(`[canAccessPage] User permissions:`, currentUserData.permissions);

                if (requiredPermission === undefined) {
                    console.log(`[canAccessPage] Unknown page, access denied: ${pageName}`);
                    return false;
                }

                // Sinon, vérifier la permission
                const requiredList = Array.isArray(requiredPermission) ? requiredPermission : [requiredPermission];
                const hasAccess = requiredList.some(permission => hasPermission(permission));
                console.log(`[canAccessPage] Access result for ${pageName}: ${hasAccess}`);
                return hasAccess;
            }


            function handleManualLogout() {
                isAuthenticated = false;
                isCodeSession = false;
                currentUser = null;
                currentUserData = null;
                dbBasePath = '';
                cleanupFirebaseListeners();
                updateUI();
            }

            // === DASHBOARD FUNCTIONS ===

            /**
             * Met à jour toutes les statistiques du tableau de bord
             */
            function updateDashboardStats() {
                if (!isAuthenticated || !dbBasePath) return;

                updateDashboardTimestamp();

                const monthlyRevenueSummary = calculateMonthlyRevenueSummary();
                const statRevenue = document.getElementById('stat-monthly-revenue');
                if (statRevenue) statRevenue.textContent = formatCurrency(monthlyRevenueSummary.total, monthlyRevenueSummary.currency);

                const monthlyOrders = calculateMonthlyOrders();
                const statOrders = document.getElementById('stat-orders');
                if (statOrders) statOrders.textContent = monthlyOrders.toLocaleString('fr-FR');

                const productsInStock = calculateShopStockUnits();
                const statProducts = document.getElementById('stat-dashboard-products-in-stock');
                if (statProducts) statProducts.textContent = productsInStock.toLocaleString('fr-FR');

                const weeklyNewCustomers = calculateWeeklyNewCustomers();
                const statWeeklyCustomers = document.getElementById('stat-weekly-customers');
                if (statWeeklyCustomers) statWeeklyCustomers.textContent = weeklyNewCustomers.toLocaleString('fr-FR');

                const totalCustomers = Object.keys(appData.customers || {}).length;
                const statTotalCustomers = document.getElementById('stat-total-customers');
                if (statTotalCustomers) statTotalCustomers.textContent = totalCustomers.toLocaleString('fr-FR');

                updateTrendIndicators({
                    monthlyRevenue: monthlyRevenueSummary.total,
                    lastMonthRevenue: calculateLastMonthRevenue(),
                    monthlyOrders,
                    lastMonthOrders: calculateLastMonthOrders(),
                    weeklyCustomers: weeklyNewCustomers,
                    lastWeekCustomers: calculateLastWeekCustomers(),
                    productsInStock
                });

                renderDashboardWeeklyChart();
                renderDashboardTopProducts();
                renderDashboardStockAlerts();
                renderDashboardCategoryDonut();
            }

            function updateDashboardTimestamp() {
                const target = document.getElementById('dashboard-last-updated');
                if (!target) return;
                const now = new Date();
                const formatted = now.toLocaleString('fr-FR', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(' à', ',');
                target.textContent = formatted;
            }

            function formatCompactNumber(value) {
                if (!Number.isFinite(value)) return '0';
                try {
                    return new Intl.NumberFormat('fr-FR', { notation: 'compact', maximumFractionDigits: 1 }).format(value);
                } catch (error) {
                    return Math.round(value).toLocaleString('fr-FR');
                }
            }

            function calculateMonthlyRevenueSummary() {
                const sales = getCountableSalesEntries();
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                let total = 0;
                let currency = 'CFA';
                sales.forEach(sale => {
                    const saleDate = new Date(sale.date);
                    if (saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear) {
                        total += sale.totalAmount || 0;
                        if (currency === 'CFA') {
                            currency = getSaleCurrency(sale) || currency;
                        }
                    }
                });
                return { total, currency };
            }

            function calculateMonthlyOrders() {
                const now = new Date();
                const month = now.getMonth();
                const year = now.getFullYear();
                return buildSalesHistoryGroups().filter(group => {
                    const date = new Date(group.date);
                    return date.getMonth() === month && date.getFullYear() === year;
                }).length;
            }

            function calculateLastMonthOrders() {
                const now = new Date();
                const lastMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                const year = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                return buildSalesHistoryGroups().filter(group => {
                    const date = new Date(group.date);
                    return date.getMonth() === lastMonth && date.getFullYear() === year;
                }).length;
            }

            function calculateShopStockUnits() {
                return Object.values(appData.shopStock || {}).reduce((sum, item) => sum + (Number(item.quantityInShop) || 0), 0);
            }

            function calculateLastWeekCustomers() {
                const customers = appData.customers || {};
                const now = new Date();
                const end = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const start = new Date(end);
                start.setDate(start.getDate() - 6);
                const previousStart = new Date(start);
                previousStart.setDate(previousStart.getDate() - 7);
                let count = 0;
                Object.values(customers).forEach(customer => {
                    const createdAt = customer?.createdAt;
                    if (!createdAt) return;
                    const createdDate = new Date(createdAt);
                    if (Number.isNaN(createdDate.getTime())) return;
                    if (createdDate >= previousStart && createdDate < start) {
                        count += 1;
                    }
                });
                return count;
            }

            function getStartOfWeek(date) {
                const start = new Date(date);
                const day = (start.getDay() + 6) % 7;
                start.setDate(start.getDate() - day);
                start.setHours(0, 0, 0, 0);
                return start;
            }

            function renderDashboardWeeklyChart() {
                const salesLine = document.getElementById('dashboard-sales-line');
                const salesDots = document.getElementById('dashboard-sales-dots');
                const ordersLine = document.getElementById('dashboard-orders-line');
                const ordersDots = document.getElementById('dashboard-orders-dots');
                const hoverPoints = document.getElementById('dashboard-hover-points');
                const guideLine = document.getElementById('dashboard-chart-guide');
                const tooltip = document.getElementById('dashboard-chart-tooltip');
                const tooltipDay = document.getElementById('dashboard-tooltip-day');
                const tooltipSales = document.getElementById('dashboard-tooltip-sales');
                const tooltipOrders = document.getElementById('dashboard-tooltip-orders');
                const chartSvg = document.getElementById('dashboard-weekly-sales-chart');
                const maxLabel = document.getElementById('dashboard-chart-max');
                const midLabel = document.getElementById('dashboard-chart-mid');
                const minLabel = document.getElementById('dashboard-chart-min');
                if (!salesLine || !ordersLine || !salesDots || !ordersDots || !hoverPoints || !guideLine || !tooltip || !tooltipDay || !tooltipSales || !tooltipOrders || !chartSvg || !maxLabel || !midLabel || !minLabel) return;

                const startOfWeek = getStartOfWeek(new Date());
                const dailySales = Array(7).fill(0);
                const dailyOrders = Array(7).fill(0);
                const groups = buildSalesHistoryGroups();

                groups.forEach(group => {
                    const date = new Date(group.date);
                    date.setHours(0, 0, 0, 0);
                    const index = Math.floor((date.getTime() - startOfWeek.getTime()) / (24 * 60 * 60 * 1000));
                    if (index >= 0 && index < 7) {
                        dailySales[index] += (group.total || 0) * getTaxMultiplier();
                        dailyOrders[index] += 1;
                    }
                });

                const maxSales = Math.max(...dailySales, 0);
                const chartMax = maxSales > 0 ? maxSales : 1;
                maxLabel.textContent = formatCompactNumber(chartMax);
                midLabel.textContent = formatCompactNumber(chartMax / 2);
                minLabel.textContent = formatCompactNumber(0);

                const xPositions = [60, 160, 260, 360, 460, 560, 650];
                const chartTop = 40;
                const chartBottom = 240;
                const chartHeight = chartBottom - chartTop;
                const toY = value => chartBottom - (value / chartMax) * chartHeight;
                const dayLabels = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                const chartWidth = 700;
                const chartHeightTotal = 260;
                const container = chartSvg.parentElement;
                const weeklyCurrency = groups.find(group => (group.total || 0) > 0)?.currency || 'CFA';

                const salesPoints = xPositions.map((x, index) => `${x},${toY(dailySales[index])}`).join(' ');
                salesLine.setAttribute('points', salesPoints);
                salesDots.innerHTML = xPositions.map((x, index) => {
                    const y = toY(dailySales[index]);
                    return `<circle class="dashboard-sales-dot" data-index="${index}" cx="${x}" cy="${y}" r="4"></circle>`;
                }).join('');

                const maxOrders = Math.max(...dailyOrders, 0);
                const ordersScaled = maxOrders > 0
                    ? dailyOrders.map(value => (value / maxOrders) * chartMax)
                    : dailyOrders;
                const ordersPoints = xPositions.map((x, index) => `${x},${toY(ordersScaled[index])}`).join(' ');
                ordersLine.setAttribute('points', ordersPoints);
                ordersDots.innerHTML = xPositions.map((x, index) => {
                    const y = toY(ordersScaled[index]);
                    return `<circle class="dashboard-orders-dot" data-index="${index}" cx="${x}" cy="${y}" r="4"></circle>`;
                }).join('');

                hoverPoints.innerHTML = xPositions.map((x, index) => {
                    const y = toY(dailySales[index]);
                    return `
                        <circle class="dashboard-hover-point" data-index="${index}" data-day="${dayLabels[index]}" data-sales="${dailySales[index]}" data-orders="${dailyOrders[index]}"
                            cx="${x}" cy="${y}" r="18" fill="transparent" style="cursor: pointer;"></circle>
                    `;
                }).join('');

                const resetDots = () => {
                    salesDots.querySelectorAll('.dashboard-sales-dot').forEach(dot => {
                        dot.setAttribute('r', '4');
                        dot.removeAttribute('fill');
                        dot.removeAttribute('stroke');
                        dot.removeAttribute('stroke-width');
                    });
                    ordersDots.querySelectorAll('.dashboard-orders-dot').forEach(dot => {
                        dot.setAttribute('r', '4');
                        dot.removeAttribute('fill');
                        dot.removeAttribute('stroke');
                        dot.removeAttribute('stroke-width');
                    });
                };

                const hideTooltip = () => {
                    tooltip.classList.add('hidden');
                    guideLine.classList.add('hidden');
                    resetDots();
                };

                const showTooltip = (index) => {
                    const day = dayLabels[index] || '';
                    const salesValue = dailySales[index] || 0;
                    const ordersValue = dailyOrders[index] || 0;
                    const x = xPositions[index];
                    const y = toY(dailySales[index]);

                    tooltipDay.textContent = day;
                    tooltipSales.textContent = `Ventes : ${formatCurrency(salesValue, weeklyCurrency)}`;
                    tooltipOrders.textContent = `Commandes : ${ordersValue}`;
                    tooltip.classList.remove('hidden');

                    const svgRect = chartSvg.getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();
                    const xPos = ((x / chartWidth) * svgRect.width) + (svgRect.left - containerRect.left);
                    const yPos = ((y / chartHeightTotal) * svgRect.height) + (svgRect.top - containerRect.top);

                    const tooltipWidth = tooltip.offsetWidth || 160;
                    const tooltipHeight = tooltip.offsetHeight || 80;
                    let left = xPos + 14;
                    if (left + tooltipWidth > containerRect.width - 8) {
                        left = xPos - tooltipWidth - 14;
                    }
                    left = Math.max(8, left);
                    let top = yPos - tooltipHeight - 12;
                    if (top < 8) {
                        top = yPos + 14;
                    }
                    tooltip.style.left = `${left}px`;
                    tooltip.style.top = `${top}px`;

                    guideLine.setAttribute('x1', `${x}`);
                    guideLine.setAttribute('x2', `${x}`);
                    guideLine.classList.remove('hidden');

                    resetDots();
                    const salesDot = salesDots.querySelector(`.dashboard-sales-dot[data-index="${index}"]`);
                    if (salesDot) {
                        salesDot.setAttribute('r', '6');
                        salesDot.setAttribute('fill', '#FFFFFF');
                        salesDot.setAttribute('stroke', '#3B82F6');
                        salesDot.setAttribute('stroke-width', '2');
                    }
                    const ordersDot = ordersDots.querySelector(`.dashboard-orders-dot[data-index="${index}"]`);
                    if (ordersDot) {
                        ordersDot.setAttribute('r', '6');
                        ordersDot.setAttribute('fill', '#FFFFFF');
                        ordersDot.setAttribute('stroke', '#10B981');
                        ordersDot.setAttribute('stroke-width', '2');
                    }
                };

                hoverPoints.querySelectorAll('.dashboard-hover-point').forEach(point => {
                    const index = Number(point.getAttribute('data-index'));
                    point.addEventListener('mouseenter', () => showTooltip(index));
                    point.addEventListener('mouseleave', hideTooltip);
                });

                chartSvg.onmouseleave = hideTooltip;
            }

            function renderDashboardTopProducts() {
                const container = document.getElementById('dashboard-top-products');
                const emptyState = document.getElementById('dashboard-top-products-empty');
                if (!container || !emptyState) return;

                const sales = getCountableSalesEntries();
                if (!sales.length) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                const now = new Date();
                const startCurrent = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                startCurrent.setDate(startCurrent.getDate() - 6);
                const startPrevious = new Date(startCurrent);
                startPrevious.setDate(startPrevious.getDate() - 7);

                const totals = {};
                sales.forEach(sale => {
                    const name = sale.productName || 'Produit';
                    if (!totals[name]) {
                        totals[name] = { name, quantity: 0, revenue: 0, currency: getSaleCurrency(sale) || 'CFA', recent: 0, previous: 0 };
                    }
                    totals[name].quantity += sale.quantity || 0;
                    totals[name].revenue += sale.totalAmount || 0;
                    const saleDate = new Date(sale.date);
                    if (saleDate >= startCurrent) {
                        totals[name].recent += sale.totalAmount || 0;
                    } else if (saleDate >= startPrevious && saleDate < startCurrent) {
                        totals[name].previous += sale.totalAmount || 0;
                    }
                });

                const topProducts = Object.values(totals).sort((a, b) => b.revenue - a.revenue).slice(0, 5);
                if (!topProducts.length) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                container.innerHTML = topProducts.map((product, index) => {
                    const diff = product.recent - product.previous;
                    const hasTrend = product.previous > 0;
                    const percent = hasTrend ? Math.abs((diff / product.previous) * 100).toFixed(1) : null;
                    const isUp = diff >= 0;
                    const trendClass = isUp ? 'text-green-600' : 'text-red-600';
                    const trendArrow = isUp ? '↗' : '↘';
                    const trendText = hasTrend ? `${trendArrow} ${isUp ? '+' : '-'}${percent}%` : '—';
                    return `
                        <div class="flex items-center justify-between py-4">
                            <div class="flex items-center gap-4">
                                <span class="w-9 h-9 rounded-full bg-blue-50 text-blue-600 font-semibold flex items-center justify-center">${index + 1}</span>
                                <div>
                                    <p class="text-sm font-semibold text-gray-900">${product.name}</p>
                                    <p class="text-xs text-gray-500">${product.quantity} vente${product.quantity > 1 ? 's' : ''}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-gray-900">${formatCurrency(product.revenue, product.currency)}</p>
                                <p class="text-xs ${trendClass}">${trendText}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function renderDashboardStockAlerts() {
                const container = document.getElementById('dashboard-stock-alerts');
                const emptyState = document.getElementById('dashboard-stock-alerts-empty');
                const countBadge = document.getElementById('dashboard-low-stock-count');
                if (!container || !emptyState || !countBadge) return;

                const stockItems = Object.values(appData.shopStock || {});
                const alerts = stockItems.filter(item => item.quantityInShop <= (item.alertThreshold || 5));

                countBadge.textContent = alerts.length.toString();

                if (!alerts.length) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                const sortedAlerts = alerts.sort((a, b) => (a.quantityInShop / Math.max(a.alertThreshold || 1, 1)) - (b.quantityInShop / Math.max(b.alertThreshold || 1, 1)));

                container.innerHTML = sortedAlerts.map(item => {
                    const current = Number(item.quantityInShop) || 0;
                    const threshold = Number(item.alertThreshold) || 0;
                    const ratio = threshold > 0 ? Math.min(current / threshold, 1) : 0;
                    const width = Math.max(5, Math.round(ratio * 100));
                    return `
                        <div class="rounded-2xl border border-orange-100 bg-orange-50/60 p-4">
                            <div class="flex items-center justify-between gap-3">
                                <div>
                                    <p class="text-sm font-semibold text-gray-900">${item.name || 'Produit'}</p>
                                    <p class="text-xs text-gray-500 mt-1">Stock actuel: ${current}</p>
                                </div>
                                <span class="text-xs font-semibold text-orange-700 bg-orange-100 px-2 py-1 rounded-full">Stock faible</span>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-500 mt-3">
                                <span>Stock actuel: ${current}</span>
                                <span>Min recommandé: ${threshold}</span>
                            </div>
                            <div class="mt-2 h-2 rounded-full bg-orange-100">
                                <div class="h-2 rounded-full bg-orange-500" style="width: ${width}%;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function renderDashboardCategoryDonut() {
                const donut = document.getElementById('dashboard-category-donut');
                const legend = document.getElementById('dashboard-category-legend');
                if (!donut || !legend) return;

                const colors = ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6'];
                const fallback = [
                    { label: 'Électronique', percent: 45 },
                    { label: 'Accessoires', percent: 30 },
                    { label: 'Audio', percent: 15 },
                    { label: 'Stockage', percent: 10 }
                ];

                const sales = getCountableSalesEntries();
                if (!sales.length) {
                    const segments = fallback.reduce((acc, item, index) => {
                        const start = acc.total;
                        const end = start + item.percent;
                        acc.segments.push(`${colors[index]} ${start}% ${end}%`);
                        acc.total = end;
                        return acc;
                    }, { segments: [], total: 0 }).segments;
                    donut.style.background = `conic-gradient(${segments.join(', ')})`;
                    legend.innerHTML = fallback.map((item, index) => `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="w-2.5 h-2.5 rounded-full" style="background:${colors[index]}"></span>
                                <span>${item.label}</span>
                            </div>
                            <span class="font-semibold text-gray-700">${item.percent}%</span>
                        </div>
                    `).join('');
                    return;
                }

                const totals = {};
                sales.forEach(sale => {
                    const shopItem = appData.shopStock?.[sale.shopProductId];
                    const category = shopItem ? getShopItemCategory(shopItem) : 'Autres';
                    totals[category] = (totals[category] || 0) + (sale.totalAmount || 0);
                });

                const entries = Object.entries(totals).filter(([, value]) => value > 0).sort((a, b) => b[1] - a[1]).slice(0, 4);
                if (!entries.length) {
                    donut.style.background = 'conic-gradient(#E5E7EB 0 100%)';
                    legend.innerHTML = '<p class="text-sm text-gray-400">Aucune donnée disponible.</p>';
                    return;
                }

                const total = entries.reduce((sum, [, value]) => sum + value, 0);
                let cumulative = 0;
                const segments = entries.map(([label, value], index) => {
                    const percent = total > 0 ? (value / total) * 100 : 0;
                    const start = cumulative;
                    cumulative += percent;
                    return `${colors[index]} ${start}% ${cumulative}%`;
                });
                donut.style.background = `conic-gradient(${segments.join(', ')})`;
                legend.innerHTML = entries.map(([label, value], index) => {
                    const percent = total > 0 ? Math.round((value / total) * 100) : 0;
                    return `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="w-2.5 h-2.5 rounded-full" style="background:${colors[index]}"></span>
                                <span>${label}</span>
                            </div>
                            <span class="font-semibold text-gray-700">${percent}%</span>
                        </div>
                    `;
                }).join('');
            }

            /**
             * Calculer les ventes du jour
             */
            function calculateDailySales() {
                const sales = getCountableSalesEntries();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let count = 0;
                let amount = 0;

                sales.forEach(sale => {
                    const saleDate = new Date(sale.date);
                    saleDate.setHours(0, 0, 0, 0);
                    if (saleDate.getTime() === today.getTime()) {
                        count += sale.quantity || 0;
                        amount += sale.totalAmount || 0;
                    }
                });

                return { count, amount };
            }

            /**
             * Calculer les nouveaux clients sur les 7 derniers jours
             */
            function calculateWeeklyNewCustomers() {
                const customers = appData.customers || {};
                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                start.setDate(start.getDate() - 6);
                let count = 0;
                Object.values(customers).forEach(customer => {
                    const createdAt = customer?.createdAt;
                    if (!createdAt) return;
                    const createdDate = new Date(createdAt);
                    if (!Number.isNaN(createdDate.getTime()) && createdDate >= start) {
                        count += 1;
                    }
                });
                return count;
            }

            /**
             * Calculer les revenus du mois
             */
            function calculateMonthlyRevenue() {
                const sales = getCountableSalesEntries();
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                let total = 0;
                sales.forEach(sale => {
                    const saleDate = new Date(sale.date);
                    if (saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear) {
                        total += sale.totalAmount || 0;
                    }
                });

                return total;
            }

            /**
             * Compter les produits en alerte stock faible
             */
            function countLowStockAlerts() {
                const shopStock = appData.shopStock || {};
                return Object.values(shopStock).filter(item =>
                    item.quantityInShop <= (item.alertThreshold || 5)
                ).length;
            }

            /**
             * Calculer le bénéfice du mois
             */
            function calculateMonthlyProfit() {
                const sales = getCountableSalesEntries();
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                let profit = 0;
                sales.forEach(sale => {
                    const saleDate = new Date(sale.date);
                    if (saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear) {
                        // Trouver le produit source pour le prix d'achat
                        const shopProduct = Object.values(appData.shopStock || {}).find(p => p.id === sale.shopProductId);
                        if (shopProduct) {
                            const storeProduct = appData.storeProducts[shopProduct.sourceProductId];
                            if (storeProduct) {
                                const costPrice = storeProduct.purchasePrice || 0;
                                const sellingPrice = sale.sellingPrice || 0;
                                profit += (sellingPrice - costPrice) * sale.quantity;
                            }
                        }
                    }
                });

                return Math.round(profit);
            }

            /**
             * Mettre à jour les indicateurs de tendance
             */
            function updateTrendIndicators({ monthlyRevenue, lastMonthRevenue, monthlyOrders, lastMonthOrders, weeklyCustomers, lastWeekCustomers, productsInStock }) {
                updateTrend('trend-monthly-revenue', monthlyRevenue, lastMonthRevenue);
                updateTrend('trend-monthly-orders', monthlyOrders, lastMonthOrders);
                updateTrend('trend-weekly-customers', weeklyCustomers, lastWeekCustomers);
                updateTrend('trend-products-stock', productsInStock, null);
            }

            /**
             * Mettre à jour un indicateur de tendance
             */
            function updateTrend(elementId, current, previous) {
                const element = document.getElementById(elementId);
                if (!element) return;

                if (previous === null || previous === undefined || previous === 0) {
                    element.textContent = '';
                    return;
                }

                const diff = current - previous;
                const percent = Math.abs((diff / previous) * 100).toFixed(1);
                const isUp = diff >= 0;
                const arrow = isUp ? '↗' : '↘';
                const color = isUp ? 'text-green-600' : 'text-red-600';
                const sign = isUp ? '+' : '-';

                element.innerHTML = `<span class="inline-flex items-center gap-1 ${color}">${arrow} ${sign}${percent}%</span>`;
            }

            /**
             * Calculer les ventes d'hier
             */
            function calculateYesterdaySales() {
                const sales = getCountableSalesEntries();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(0, 0, 0, 0);

                let count = 0;
                sales.forEach(sale => {
                    const saleDate = new Date(sale.date);
                    saleDate.setHours(0, 0, 0, 0);
                    if (saleDate.getTime() === yesterday.getTime()) {
                        count += sale.quantity || 0;
                    }
                });

                return { count };
            }

            /**
             * Calculer les revenus du mois dernier
             */
            function calculateLastMonthRevenue() {
                const sales = getCountableSalesEntries();
                const now = new Date();
                const lastMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                const year = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();

                let total = 0;
                sales.forEach(sale => {
                    const saleDate = new Date(sale.date);
                    if (saleDate.getMonth() === lastMonth && saleDate.getFullYear() === year) {
                        total += sale.totalAmount || 0;
                    }
                });

                return total;
            }

            /**
             * Calculer le bénéfice du mois dernier
             */
            function calculateLastMonthProfit() {
                const sales = getCountableSalesEntries();
                const now = new Date();
                const lastMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                const year = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();

                let profit = 0;
                sales.forEach(sale => {
                    const saleDate = new Date(sale.date);
                    if (saleDate.getMonth() === lastMonth && saleDate.getFullYear() === year) {
                        const shopProduct = Object.values(appData.shopStock || {}).find(p => p.id === sale.shopProductId);
                        if (shopProduct) {
                            const storeProduct = appData.storeProducts[shopProduct.sourceProductId];
                            if (storeProduct) {
                                const costPrice = storeProduct.purchasePrice || 0;
                                const sellingPrice = sale.sellingPrice || 0;
                                profit += (sellingPrice - costPrice) * sale.quantity;
                            }
                        }
                    }
                });

                return Math.round(profit);
            }

            /**
             * Mettre à jour la timeline d'activités
             */
            function updateActivityTimeline() {
                const container = document.getElementById('recent-activities');
                if (!container) return;

                // Récupérer les 5 dernières activités (ventes + mouvements)
                const activities = [];

                // Ventes
                const sales = getCountableSalesEntries();
                sales.forEach(sale => {
                    activities.push({
                        date: new Date(sale.date),
                        type: 'sale',
                        icon: '💰',
                        text: `Vente : ${sale.quantity} ${sale.productName}`,
                        amount: sale.totalAmount
                    });
                });

                // Mouvements boutique
                const shopMovements = Object.values(appData.shopMovements || {}).filter(m => m.type === 'Entrée');
                shopMovements.forEach(move => {
                    activities.push({
                        date: new Date(move.date),
                        type: 'entry',
                        icon: '📦',
                        text: `Entree stock : ${move.quantityChange} ${move.productName}`
                    });
                });

                // Trier par date et prendre les 5 derniers
                activities.sort((a, b) => b.date - a.date);
                const recentActivities = activities.slice(0, 5);

                if (recentActivities.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">Aucune activite pour le moment</p>';
                    return;
                }

                container.innerHTML = recentActivities.map(activity => {
                    const time = activity.date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    const amountText = activity.amount ? ` - ${activity.amount.toLocaleString()} FCFA` : '';
                    return `
                        <div class="flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                            <span class="text-2xl">${activity.icon}</span>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">${activity.text}${amountText}</p>
                                <p class="text-xs text-gray-500 mt-1">🕐 ${time}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function setActiveSettingsTab(tabId = 'compte') {
                if (!settingsTabButtons.length) return;
                settingsTabButtons.forEach(button => {
                    const isActive = button.dataset.settingsTab === tabId;
                    button.classList.toggle('bg-cyan-500', isActive);
                    button.classList.toggle('text-white', isActive);
                    button.classList.toggle('text-gray-600', !isActive);
                });
                settingsPanels.forEach(panel => panel.classList.toggle('hidden', panel.dataset.settingsPanel !== tabId));
            }

            function updateLoginModeUI() {
                if (!loginPasswordField || !loginAccessCodeField) return;
                if (isCodeLoginMode) {
                    loginPasswordField.classList.add('hidden');
                    loginAccessCodeField.classList.remove('hidden');
                    if (loginPasswordInput) loginPasswordInput.required = false;
                    if (loginAccessCodeInput) {
                        loginAccessCodeInput.required = true;
                        loginAccessCodeInput.value = '';
                    }
                    if (loginModeAdminButton) {
                        loginModeAdminButton.classList.remove('bg-white', 'shadow', 'text-gray-800');
                        loginModeAdminButton.classList.add('text-gray-500', 'hover:text-gray-700');
                    }
                    if (loginModeCodeButton) {
                        loginModeCodeButton.classList.remove('text-gray-500', 'hover:text-gray-700');
                        loginModeCodeButton.classList.add('bg-white', 'shadow', 'text-gray-800');
                    }
                } else {
                    loginPasswordField.classList.remove('hidden');
                    loginAccessCodeField.classList.add('hidden');
                    if (loginPasswordInput) loginPasswordInput.required = true;
                    if (loginAccessCodeInput) loginAccessCodeInput.required = false;
                    if (loginModeCodeButton) {
                        loginModeCodeButton.classList.remove('bg-white', 'shadow', 'text-gray-800');
                        loginModeCodeButton.classList.add('text-gray-500', 'hover:text-gray-700');
                    }
                    if (loginModeAdminButton) {
                        loginModeAdminButton.classList.remove('text-gray-500', 'hover:text-gray-700');
                        loginModeAdminButton.classList.add('bg-white', 'shadow', 'text-gray-800');
                    }
                }
            }

            function ensureCurrentUserInTeam() {
                if (!currentUser) return;
                const normalizedEmail = (currentUserData?.email || currentUser?.email || '').toLowerCase();
                let hasCurrentUser = false;
                teamMembersState = teamMembersState.map(member => {
                    const isCurrent = member.id === currentUser.uid || (normalizedEmail && member.email?.toLowerCase() === normalizedEmail);
                    if (isCurrent) hasCurrentUser = true;
                    return { ...member, isCurrentUser: isCurrent };
                });
                if (!hasCurrentUser) {
                    const name = currentUserData?.fullName || 'Utilisateur';
                    const email = currentUser?.email || currentUserData?.email;
                    const role = getCurrentUserRole();
                    const permissions = normalizePermissions(currentUserData?.permissions);
                    teamMembersState.unshift({
                        id: currentUser.uid,
                        name,
                        email,
                        role,
                        status: 'actif',
                        permissions,
                        isCurrentUser: true,
                        accessCode: currentUserData?.accessCode || 'ADMIN'
                    });
                }
                renderAccessMembers();
            }

            function syncCurrentUserFromMembers(membersData) {
                if (!currentUser || !currentUserData) return false;
                const normalizedEmail = (currentUserData.email || currentUser.email || '').toLowerCase();
                let member = null;
                if (currentUser.uid && membersData[currentUser.uid]) {
                    member = membersData[currentUser.uid];
                } else if (normalizedEmail) {
                    const matchKey = Object.keys(membersData).find(key => (membersData[key].email || '').toLowerCase() === normalizedEmail);
                    if (matchKey) member = membersData[matchKey];
                }
                if (!member) return false;

                let changed = false;
                const nextRole = member.role || currentUserData.role || 'consultation';
                if (currentUserData.role !== nextRole) {
                    currentUserData.role = nextRole;
                    changed = true;
                }
                const nextPermissions = normalizePermissions(member.permissions);
                const currentPermissions = normalizePermissions(currentUserData.permissions);
                if (JSON.stringify(currentPermissions) !== JSON.stringify(normalizePermissions(nextPermissions))) {
                    currentUserData.permissions = nextPermissions;
                    changed = true;
                }
                if (member.accessCode && currentUserData.accessCode !== member.accessCode) {
                    currentUserData.accessCode = member.accessCode;
                    changed = true;
                }
                return changed;
            }

            function renderAccessMembers() {
                if (!accessMembersTbody) return;
                if (!teamMembersState.length) {
                    accessMembersTbody.innerHTML = `<tr><td colspan="6" class="px-4 py-6 text-center text-gray-400">Aucun collaborateur pour le moment.</td></tr>`;
                } else {
                    const rows = teamMembersState.map(member => {
                        const permissionButtons = accessModules.map(module => {
                            const isActive = member.permissions?.includes(module);
                            const classes = `px-3 py-1 rounded-full border text-xs font-semibold mr-2 mb-2 inline-flex ${isActive ? 'bg-cyan-50 border-cyan-200 text-cyan-600' : 'bg-gray-100 border-gray-200 text-gray-500'}`;
                            return `<button type="button" data-member-id="${member.id}" data-permission="${module}" class="${classes}">${module}</button>`;
                        }).join('');
                        const accessCodeBlock = member.accessCode ? `
                            <div class="flex items-center gap-2">
                                <span class="font-mono text-sm text-gray-900">${member.accessCode}</span>
                                <button type="button" data-copy-code="${member.accessCode}" class="px-2 py-1 text-xs font-semibold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200">Copier</button>
                            </div>
                        ` : `<span class="text-xs text-gray-400">Non défini</span>`;
                        const statusLabel = member.status === 'pending' ? 'Code partagé' : 'Actif';
                        const actionCell = member.isCurrentUser ? `<span class="text-xs text-gray-400">Vous</span>` : `<button type="button" data-remove-member="${member.id}" class="text-sm text-red-500 hover:text-red-600 font-semibold">Retirer</button>`;
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    <p class="font-semibold text-gray-900">${member.fullName || member.name || '-'}</p>
                                    <p class="text-xs text-gray-400">${statusLabel}</p>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-500">${member.email || '-'}</td>
                                <td class="px-4 py-3">
                                    <select data-role-select="${member.id}" class="rounded-lg border-gray-200 focus:ring-cyan-400 focus:border-cyan-400 text-sm">
                                        <option value="admin" ${member.role === 'admin' ? 'selected' : ''}>Admin</option>
                                        <option value="manager" ${member.role === 'manager' ? 'selected' : ''}>Manager</option>
                                        <option value="vendeur" ${member.role === 'vendeur' ? 'selected' : ''}>Vendeur</option>
                                        <option value="consultation" ${member.role === 'consultation' ? 'selected' : ''}>Consultation</option>
                                    </select>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex flex-wrap">${permissionButtons}</div>
                                </td>
                                <td class="px-4 py-3">
                                    ${accessCodeBlock}
                                </td>
                                <td class="px-4 py-3 text-right">
                                    ${actionCell}
                                </td>
                            </tr>
                        `;
                    }).join('');
                    accessMembersTbody.innerHTML = rows;
                }
                if (accessTotalUsers) accessTotalUsers.textContent = teamMembersState.length;
                if (accessTotalAdmins) accessTotalAdmins.textContent = teamMembersState.filter(m => m.role === 'admin').length;
                if (accessTotalPending) accessTotalPending.textContent = teamMembersState.filter(m => m.status === 'pending').length;
            }

            function toggleMemberPermission(memberId, permission) {
                const member = teamMembersState.find(m => m.id === memberId);
                if (!member) return;
                member.permissions = member.permissions || [];
                if (permission === 'Paramètres' && member.role !== 'admin') {
                    showSuccessToast("Seuls les administrateurs peuvent accéder aux paramètres.");
                    return;
                }
                if (member.permissions.includes(permission)) {
                    member.permissions = member.permissions.filter(p => p !== permission);
                } else {
                    member.permissions.push(permission);
                }
                if (member.isCurrentUser && currentUserData) {
                    currentUserData.permissions = [...member.permissions];
                    updateUI();
                    renderStoreProducts(storeSearchInput ? storeSearchInput.value : '');
                    renderShopStock(shopSearchInput ? shopSearchInput.value : '');
                }
                renderAccessMembers();
                saveMemberState(member);
                ensureCurrentUserInTeam();
            }

            function setMemberRole(memberId, role) {
                const member = teamMembersState.find(m => m.id === memberId);
                if (!member) return;
                member.role = role;
                member.permissions = member.permissions || [];
                if (role === 'admin' && !member.permissions.includes('Paramètres')) {
                    member.permissions.push('Paramètres');
                }
                if (role !== 'admin') {
                    member.permissions = member.permissions.filter(permission => permission !== 'Paramètres');
                }
                if (member.isCurrentUser && currentUserData) {
                    currentUserData.role = role;
                    currentUserData.permissions = [...member.permissions];
                    updateUI();
                    renderStoreProducts(storeSearchInput ? storeSearchInput.value : '');
                    renderShopStock(shopSearchInput ? shopSearchInput.value : '');
                }
                renderAccessMembers();
                saveMemberState(member);
                ensureCurrentUserInTeam();
            }

            if (settingsTabButtons.length) {
                settingsTabButtons.forEach(button => button.addEventListener('click', () => setActiveSettingsTab(button.dataset.settingsTab)));
                setActiveSettingsTab('compte');
            }

            async function findMemberByEmailAndCode(email, code) {
                const companiesSnapshot = await get(ref(db, 'companies'));
                if (!companiesSnapshot.exists()) return null;
                const normalizedEmail = email.trim().toLowerCase();
                const normalizedCode = code.trim().toUpperCase();
                const companies = companiesSnapshot.val();
                for (const [companyId, companyData] of Object.entries(companies)) {
                    if (!companyData.members) continue;
                    for (const [memberId, memberData] of Object.entries(companyData.members)) {
                        if ((memberData.email || '').toLowerCase() === normalizedEmail && (memberData.accessCode || '').toUpperCase() === normalizedCode) {
                            return {
                                companyId,
                                companyName: companyData.name || '',
                                memberId,
                                member: memberData
                            };
                        }
                    }
                }
                return null;
            }

            async function handleAccessCodeLogin(email, code) {
                if (!email || !code) {
                    if (loginError) {
                        loginError.textContent = "Email et code requis.";
                        loginError.classList.remove('hidden');
                    }
                    return;
                }
                try {
                    const match = await findMemberByEmailAndCode(email, code);
                    if (!match) {
                        if (loginError) {
                            loginError.textContent = "Code d'accès invalide.";
                            loginError.classList.remove('hidden');
                        }
                        return;
                    }
                    isAuthenticated = true;
                    isCodeSession = true;
                    currentUser = { email, uid: match.memberId };
                    currentUserData = {
                        uid: match.memberId,
                        email,
                        fullName: match.member.fullName || match.member.name || 'Collaborateur',
                        companyId: match.companyId,
                        companyName: match.companyName,
                        role: match.member.role || 'consultation',
                        permissions: Array.isArray(match.member.permissions) ? match.member.permissions : [],
                        accessCode: match.member.accessCode
                    };
                    dbBasePath = `companies/${match.companyId}`;
                    if (match.member.status !== 'actif') {
                        await update(ref(db, `${dbBasePath}/members/${match.memberId}`), { status: 'actif' });
                    }
                    setupFirebaseListeners();
                    updateSettingsAccess();
                    updateUI();
                    showSuccessToast("Connexion réussie !");
                } catch (error) {
                    if (loginError) {
                        loginError.textContent = "Impossible de vérifier ce code pour le moment.";
                        loginError.classList.remove('hidden');
                    }
                } finally {
                    if (loginSubmitButton) { loginSubmitButton.disabled = false; loginSubmitButton.textContent = "Se connecter"; }
                }
            }

            function saveMemberState(member) {
                if (!member || !member.id || !dbBasePath) return;
                const memberCopy = { ...member };
                delete memberCopy.isCurrentUser;
                set(ref(db, `${dbBasePath}/members/${member.id}`), memberCopy);
            }

            function deleteMember(memberId) {
                if (!dbBasePath || !memberId) return;
                remove(ref(db, `${dbBasePath}/members/${memberId}`));
            }

            function onCompanyMembersValue(snapshot) {
                const membersData = snapshot.val() || {};
                teamMembersState = Object.keys(membersData).map(key => ({
                    id: key,
                    ...membersData[key],
                }));
                const permissionsChanged = syncCurrentUserFromMembers(membersData);
                ensureCurrentUserInTeam();
                if (permissionsChanged) {
                    updateUI();
                    renderStoreProducts(storeSearchInput ? storeSearchInput.value : '');
                    renderShopStock(shopSearchInput ? shopSearchInput.value : '');
                }
            }

            if (accessMembersTbody) {
                accessMembersTbody.addEventListener('click', (event) => {
                    const permissionButton = event.target.closest('button[data-permission]');
                    if (permissionButton) {
                        toggleMemberPermission(permissionButton.dataset.memberId, permissionButton.dataset.permission);
                        return;
                    }
                    const removeButton = event.target.closest('button[data-remove-member]');
                    if (removeButton) {
                        teamMembersState = teamMembersState.filter(member => member.id !== removeButton.dataset.removeMember || member.isCurrentUser);
                        renderAccessMembers();
                        deleteMember(removeButton.dataset.removeMember);
                        return;
                    }
                    const copyButton = event.target.closest('button[data-copy-code]');
                    if (copyButton) {
                        const code = copyButton.dataset.copyCode;
                        if (!code) return;
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(code).then(() => showSuccessToast('Code copié dans le presse-papiers'));
                        } else {
                            const tempInput = document.createElement('input');
                            tempInput.value = code;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            showSuccessToast('Code copié');
                        }
                    }
                });
                accessMembersTbody.addEventListener('change', (event) => {
                    const roleSelect = event.target.closest('select[data-role-select]');
                    if (roleSelect) setMemberRole(roleSelect.dataset.roleSelect, roleSelect.value);
                });
            }

            if (accessAddMemberForm) {
                accessAddMemberForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    if (!dbBasePath) {
                        showSuccessToast("Veuillez sélectionner une entreprise valide.");
                        return;
                    }
                    const name = accessMemberNameInput.value.trim();
                    const email = accessMemberEmailInput.value.trim();
                    const role = accessMemberRoleInput.value;
                    if (!name || !email) return;

                    const accessCode = generateAccessCode();
                    const basePermissions = role === 'consultation'
                        ? ['Tableau de bord', 'Statistiques']
                        : (role === 'manager'
                            ? ['Tableau de bord', 'Ventes', 'Historique des ventes', 'Stock Boutique', 'Mon Magasin', 'Mouvements Magasin', 'Statistiques']
                            : ['Tableau de bord', 'Ventes', 'Historique des ventes', 'Stock Boutique']);

                    try {
                        const newMemberRef = push(ref(db, `${dbBasePath}/members`));
                        await set(newMemberRef, {
                            id: newMemberRef.key,
                            fullName: name,
                            email,
                            role,
                            status: 'pending',
                            permissions: role === 'admin' ? [...accessModules] : basePermissions,
                            accessCode,
                            createdAt: new Date().toISOString(),
                            invitedBy: currentUser?.email || 'admin'
                        });
                        accessAddMemberForm.reset();
                        showSuccessToast(`Collaborateur ajouté. Code: ${accessCode}`);
                    } catch (error) {
                        console.error(error);
                        showSuccessToast("Impossible d'ajouter ce collaborateur pour le moment.");
                    }
                });
            }

            if (pendingExitTableContainer) {
                pendingExitTableContainer.addEventListener('click', (event) => {
                    const approveButton = event.target.closest('button[data-approve-exit]');
                    if (approveButton) {
                        const requestId = approveButton.dataset.approveExit;
                        if (requestId && confirm("Valider cette sortie ?")) {
                            approveExitRequest(requestId);
                        }
                        return;
                    }
                    const rejectButton = event.target.closest('button[data-reject-exit]');
                    if (rejectButton) {
                        const requestId = rejectButton.dataset.rejectExit;
                        if (requestId && confirm("Refuser cette sortie ?")) {
                            rejectExitRequest(requestId);
                        }
                    }
                });
            }

            function populateStoreProductSelects() {
                const products = appData.storeProducts;
                const selects = [entryProductSelect, exitProductSelect, transferProductSelect];
                selects.forEach(select => {
                    if (!select) return;
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption.cloneNode(true));
                    if (products) {
                        Object.values(products).forEach(product => {
                            const option = document.createElement('option');
                            option.value = product.id;
                            option.textContent = `${product.name} (Actuellement : ${product.quantityInStore})`;
                            select.appendChild(option);
                        });
                    }
                });
                if (entryProductSelect && entryProductSelect.value) {
                    updateEntryProductInfo(appData.storeProducts?.[entryProductSelect.value]);
                }
                if (exitProductSelect && exitProductSelect.value) {
                    updateExitProductInfo(appData.storeProducts?.[exitProductSelect.value]);
                }
            }

            function updateEntryProductInfo(product) {
                if (!entryProductInfo || !entryProductName || !entryProductStock) return;
                if (!product) {
                    entryProductInfo.classList.add('hidden');
                    entryProductName.textContent = '—';
                    entryProductStock.textContent = '—';
                    return;
                }
                entryProductInfo.classList.remove('hidden');
                entryProductName.textContent = product.name || '—';
                entryProductStock.textContent = `${product.quantityInStore ?? 0}`;
            }

            function updateExitProductInfo(product) {
                if (!exitProductInfo || !exitProductName || !exitProductStock) return;
                if (!product) {
                    exitProductInfo.classList.add('hidden');
                    exitProductName.textContent = '—';
                    exitProductStock.textContent = '—';
                    return;
                }
                const pendingQty = getPendingExitQuantity(product.id);
                const available = Math.max((product.quantityInStore || 0) - pendingQty, 0);
                exitProductInfo.classList.remove('hidden');
                exitProductName.textContent = product.name || '—';
                exitProductStock.textContent = `${available}`;
            }

            function openEntryModalForProduct(productId = null) {
                if (!entryModal || !entryForm) return;
                entryForm.reset();
                if (entryError) entryError.classList.add('hidden');
                if (entryProductSelectRow) entryProductSelectRow.classList.toggle('hidden', !!productId);
                if (entryProductSelect) entryProductSelect.value = productId || '';
                updateEntryProductInfo(productId ? appData.storeProducts[productId] : null);
                entryModal.classList.remove('hidden');
            }

            function openExitModalForProduct(productId = null) {
                if (!exitModal || !exitForm) return;
                exitForm.reset();
                if (exitError) exitError.classList.add('hidden');
                if (exitProductSelectRow) exitProductSelectRow.classList.toggle('hidden', !!productId);
                if (exitProductSelect) exitProductSelect.value = productId || '';
                updateExitProductInfo(productId ? appData.storeProducts[productId] : null);
                exitModal.classList.remove('hidden');
            }

            function populateShopProductSelects() {
                const products = appData.shopStock;
                const selects = [restockProductSelect];
                selects.forEach(select => {
                    if (!select) return;
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption.cloneNode(true));
                    if (products) {
                        Object.values(products).forEach(product => {
                            const option = document.createElement('option');
                            option.value = product.id;
                            option.textContent = `${product.name} (Actuellement : ${product.quantityInShop})`;
                            select.appendChild(option);
                        });
                    }
                });
            }

            function renderStoreProducts(searchTerm = '') {
                const products = appData.storeProducts;
                const normalizedSearch = searchTerm.toLowerCase();
                const filteredProducts = Object.values(products).filter(product =>
                    product.name?.toLowerCase().includes(normalizedSearch) || product.description?.toLowerCase().includes(normalizedSearch)
                );

                if (filteredProducts.length > 0) {
                    storeProductsPlaceholder.classList.add('hidden');
                    storeProductsTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedProducts = filteredProducts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    const canDelete = hasPermission('Supprimer Stock Magasin');
                    sortedProducts.forEach(product => {
                        const quantity = Number(product.quantityInStore ?? 0);
                        const quantityClass = quantity <= 10
                            ? 'bg-red-100 text-red-700'
                            : quantity <= 50
                                ? 'bg-amber-100 text-amber-700'
                                : 'bg-emerald-100 text-emerald-700';
                        const entryButtonHtml = `
                            <button type="button"
                                class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-emerald-100 text-emerald-600 hover:bg-emerald-200"
                                data-store-action="entry" data-product-id="${product.id}">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>`;
                        const exitButtonHtml = `
                            <button type="button"
                                class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-orange-100 text-orange-600 hover:bg-orange-200"
                                data-store-action="exit" data-product-id="${product.id}">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </button>`;
                        const deleteButtonHtml = canDelete
                            ? `<button type="button" class="delete-icon inline-flex items-center justify-center w-9 h-9 rounded-lg bg-red-50 text-red-500 hover:bg-red-100" data-type="store" data-product-id="${product.id}">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>`
                            : '';
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.description || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-700">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${quantityClass}">${quantity}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(product.purchaseCost, product.currency)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <div class="flex items-center gap-2">
                                        ${entryButtonHtml}
                                        ${exitButtonHtml}
                                        ${deleteButtonHtml}
                                    </div>
                                </td>
                            </tr>`;
                    });
                    storeProductsTbody.innerHTML = html;
                } else {
                    storeProductsTableContainer.classList.add('hidden');
                    storeProductsPlaceholder.classList.remove('hidden');
                    storeProductsTbody.innerHTML = '';
                }
            }

            function formatMovementDate(value) {
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return '-';
                const pad = (num) => String(num).padStart(2, '0');
                return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
            }

            function getMovementTypeBadge(move) {
                const comment = (move?.comment || '').toString().toLowerCase();
                if (comment.includes('transfert')) {
                    return { label: 'Transfert', classes: 'bg-purple-100 text-purple-700' };
                }
                if (move?.type === 'Entrée') {
                    return { label: 'Entrée', classes: 'bg-emerald-100 text-emerald-700' };
                }
                if (move?.type === 'Sortie directe') {
                    return { label: 'Sortie directe', classes: 'bg-orange-100 text-orange-700' };
                }
                if (move?.type === 'Sortie') {
                    return { label: 'Sortie', classes: 'bg-orange-100 text-orange-700' };
                }
                return { label: move?.type || '—', classes: 'bg-gray-100 text-gray-600' };
            }

            function getStatusBadge(status) {
                if (status === EXIT_STATUS_PENDING) return { label: 'En attente', classes: 'bg-yellow-100 text-yellow-700' };
                if (status === EXIT_STATUS_REJECTED) return { label: 'Refusé', classes: 'bg-red-100 text-red-700' };
                return { label: 'Validé', classes: 'bg-blue-100 text-blue-700' };
            }

            function renderStoreMovementsPage() {
                if (!storeMovementsPlaceholder || !storeMovementsTableContainer || !storeMovementsTbody) return;
                const movements = Object.values(appData.storeMovements || {}).filter(move => {
                    const comment = (move?.comment || '').toString().trim().toLowerCase();
                    if (move?.type === 'Sortie directe') return true;
                    return !comment.startsWith('vente');
                });
                const pendingRequests = Object.values(appData.storeExitRequests || {}).filter(request => request.status === EXIT_STATUS_PENDING);
                const combined = [
                    ...movements.map(move => ({ kind: 'movement', data: move, date: move.date })),
                    ...pendingRequests.map(request => ({ kind: 'request', data: request, date: request.requestedAt || request.date }))
                ].filter(item => item.date);

                if (!combined.length) {
                    storeMovementsPlaceholder.classList.remove('hidden');
                    storeMovementsTableContainer.classList.add('hidden');
                    storeMovementsTbody.innerHTML = '';
                    return;
                }

                combined.sort((a, b) => new Date(b.date) - new Date(a.date));
                storeMovementsPlaceholder.classList.add('hidden');
                storeMovementsTableContainer.classList.remove('hidden');

                storeMovementsTbody.innerHTML = combined.map(item => {
                    if (item.kind === 'request') {
                        const request = item.data;
                        const qty = parseInt(request.quantity, 10) || 0;
                        const changeValue = -Math.abs(qty);
                        const statusBadge = getStatusBadge(request.status);
                        const comment = request.comment ? request.comment : 'Sortie en attente';
                        const customerLine = request.customerName ? `<p class="text-xs text-gray-500 mt-1">Client: ${request.customerName}</p>` : '';
                        const actionHtml = `<span class="text-xs text-gray-400 italic">En attente de validation</span>`;
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${request.productName || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-700">Sortie</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${Math.abs(qty)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-600">${changeValue}</td>
                                <td class="px-6 py-4 text-sm text-gray-600">
                                    <p>${comment}</p>
                                    ${customerLine}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatMovementDate(item.date)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusBadge.classes}">${statusBadge.label}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right">
                                    ${actionHtml}
                                </td>
                        </tr>`;
                    }

                    const move = item.data;
                    const qty = parseInt(move.quantityChange, 10) || 0;
                    const isEntry = move.type === 'Entrée';
                    const changeValue = isEntry ? Math.abs(qty) : -Math.abs(qty);
                    const typeBadge = getMovementTypeBadge(move);
                    const statusBadge = getStatusBadge(move.status || EXIT_STATUS_APPROVED);
                    const comment = move.comment ? move.comment : '-';
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${move.productName || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${typeBadge.classes}">${typeBadge.label}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${Math.abs(qty)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${changeValue >= 0 ? 'text-emerald-600' : 'text-red-600'}">${changeValue >= 0 ? '+' : ''}${changeValue}</td>
                            <td class="px-6 py-4 text-sm text-gray-600">${comment}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatMovementDate(item.date)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusBadge.classes}">${statusBadge.label}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <span class="text-xs text-gray-400">—</span>
                            </td>
                        </tr>`;
                }).join('');
            }

            function onStoreMovementsValue(snapshot) {
                appData.storeMovements = snapshot.val() || {};
                renderStoreMovementsPage();
            }

            function renderPendingExitRequests() {
                if (!pendingExitTableContainer || !pendingExitTbody || !pendingExitPlaceholder) return;
                const requests = Object.values(appData.storeExitRequests || {})
                    .filter(request => request.status === EXIT_STATUS_PENDING)
                    .sort((a, b) => new Date(b.requestedAt || b.date) - new Date(a.requestedAt || a.date));

                if (pendingExitCount) pendingExitCount.textContent = requests.length;

                if (!requests.length) {
                    pendingExitPlaceholder.classList.remove('hidden');
                    pendingExitTableContainer.classList.add('hidden');
                    pendingExitTbody.innerHTML = '';
                    return;
                }

                pendingExitPlaceholder.classList.add('hidden');
                pendingExitTableContainer.classList.remove('hidden');
                pendingExitTbody.innerHTML = requests.map(request => {
                    const statusBadge = formatExitStatusBadge(request.status);
                    const requestedBy = request.requestedByName || request.requestedBy || request.requestedByEmail || '-';
                    const comment = request.comment ? request.comment : '-';
                    const date = request.requestedAt || request.date || new Date().toISOString();
                    const actionsHtml = `<span class="text-xs text-gray-400">À valider dans Historique des ventes</span>`;
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(date)}</td>
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${request.productName || '-'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-700">${request.quantity}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${requestedBy}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${comment}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="px-2.5 py-0.5 rounded-full text-xs font-semibold border ${statusBadge.classes}">${statusBadge.label}</span>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-right">
                                ${actionsHtml}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            async function resolveStoreValidationSale(saleId, action) {
                if (!dbBasePath || !currentUser) return;
                if (getCurrentUserRole() !== 'admin') {
                    showSuccessToast("Accès réservé aux administrateurs.");
                    return;
                }
                const sale = appData.salesHistory?.[saleId];
                if (!sale || !isStoreValidationPending(sale)) {
                    showSuccessToast("Cette vente a déjà été traitée.");
                    return;
                }
                if (!['paid', 'pending', 'pay_later'].includes(action)) return;
                const product = appData.storeProducts?.[sale.storeProductId];
                if (!product) {
                    showSuccessToast("Produit introuvable.");
                    return;
                }
                const quantity = parseInt(sale.quantity, 10) || 0;
                if (quantity <= 0) return;
                if (quantity > (product.quantityInStore || 0)) {
                    showSuccessToast("Stock insuffisant pour valider cette sortie.");
                    return;
                }

                const paymentStatus = action === 'pay_later'
                    ? 'pay_later'
                    : (action === 'pending' ? 'pending' : 'paid');
                const payLater = paymentStatus === 'pay_later';

                try {
                    const now = new Date().toISOString();
                    const newStock = (product.quantityInStore || 0) - quantity;
                    const updates = {};

                    updates[`${dbBasePath}/storeProducts/${product.id}/quantityInStore`] = newStock;

                    const moveKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                    updates[`${dbBasePath}/storeMovements/${moveKey}`] = {
                        id: moveKey,
                        productId: product.id,
                        productName: product.name,
                        type: "Sortie directe",
                        quantityChange: quantity,
                        oldStock: product.quantityInStore,
                        newStock,
                        comment: sale.comment ? `Sortie directe: ${sale.comment}` : "Sortie directe magasin",
                        date: now,
                        approvedFromRequest: sale.storeRequestId || sale.approvedFromRequest || null,
                        userEmail: currentUser.email || '',
                        status: EXIT_STATUS_APPROVED
                    };

                    updates[`${dbBasePath}/salesHistory/${saleId}/paymentStatus`] = paymentStatus;
                    updates[`${dbBasePath}/salesHistory/${saleId}/payLater`] = payLater;
                    updates[`${dbBasePath}/salesHistory/${saleId}/validationStatus`] = 'validated';
                    updates[`${dbBasePath}/salesHistory/${saleId}/validatedAt`] = now;
                    updates[`${dbBasePath}/salesHistory/${saleId}/validatedBy`] = currentUser.email || currentUserData?.email || '';
                    updates[`${dbBasePath}/salesHistory/${saleId}/storeMovementId`] = moveKey;

                    const requestId = sale.storeRequestId || sale.approvedFromRequest || sale.requestId;
                    if (requestId) {
                        updates[`${dbBasePath}/storeExitRequests/${requestId}/status`] = EXIT_STATUS_APPROVED;
                        updates[`${dbBasePath}/storeExitRequests/${requestId}/validatedAt`] = now;
                        updates[`${dbBasePath}/storeExitRequests/${requestId}/validatedBy`] = currentUser.email || currentUserData?.email || '';
                    }

                    await update(ref(db), updates);

                    const messageMap = {
                        paid: 'Vente magasin validée.',
                        pending: 'Vente mise en attente.',
                        pay_later: 'Vente en paiement différé.'
                    };
                    showSuccessToast(messageMap[paymentStatus] || 'Mise à jour effectuée.');
                } catch (error) {
                    console.error(error);
                    showSuccessToast("Impossible de valider cette vente pour le moment.");
                }
            }

            async function approveExitRequest(requestId) {
                if (!dbBasePath || !currentUser || getCurrentUserRole() !== 'admin') return;
                const request = appData.storeExitRequests?.[requestId];
                if (!request || request.status !== EXIT_STATUS_PENDING) {
                    showSuccessToast("Cette demande a déjà été traitée.");
                    return;
                }
                if (request.saleHistoryId) {
                    await resolveStoreValidationSale(request.saleHistoryId, 'paid');
                    return;
                }
                const product = appData.storeProducts?.[request.productId];
                if (!product) {
                    showSuccessToast("Produit introuvable.");
                    return;
                }
                const quantity = parseInt(request.quantity, 10) || 0;
                if (quantity <= 0) return;
                if (quantity > product.quantityInStore) {
                    showSuccessToast("Stock insuffisant pour valider cette sortie.");
                    return;
                }

                try {
                    const now = new Date().toISOString();
                    const sellerName = currentUserData?.fullName || currentUser.email || '';
                    const newStock = product.quantityInStore - quantity;
                    const updates = {};
                    updates[`${dbBasePath}/storeProducts/${product.id}/quantityInStore`] = newStock;
                    const moveKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                    updates[`${dbBasePath}/storeMovements/${moveKey}`] = {
                        id: moveKey,
                        productId: product.id,
                        productName: product.name,
                        type: "Sortie directe",
                        quantityChange: quantity,
                        oldStock: product.quantityInStore,
                        newStock,
                        comment: request.comment ? `Sortie validée - ${request.comment}` : "Sortie validée",
                        date: now,
                        approvedFromRequest: requestId,
                        userEmail: request.requestedByEmail || ''
                    };
                    const saleKey = push(ref(db, `${dbBasePath}/salesHistory`)).key;
                    const sellingPrice = Number(product.purchaseCost ?? 0);
                    const totalAmount = sellingPrice * quantity;
                    updates[`${dbBasePath}/salesHistory/${saleKey}`] = {
                        id: saleKey,
                        storeProductId: product.id,
                        productName: product.name,
                        quantity,
                        sellingPrice,
                        totalAmount,
                        sellerName,
                        customerId: null,
                        customerName: request.customerName || '',
                        customerPhone: request.customerPhone || '',
                        customerEmail: request.customerEmail || '',
                        comment: request.comment || 'Sortie directe magasin',
                        paymentStatus: 'paid',
                        payLater: false,
                        date: now,
                        saleSource: SALE_SOURCE_STORE,
                        currency: product.currency || 'CFA',
                        approvedFromRequest: requestId
                    };
                    updates[`${dbBasePath}/storeExitRequests/${requestId}/status`] = EXIT_STATUS_APPROVED;
                    updates[`${dbBasePath}/storeExitRequests/${requestId}/validatedAt`] = now;
                    updates[`${dbBasePath}/storeExitRequests/${requestId}/validatedBy`] = currentUser.email || currentUserData?.email || '';
                    await update(ref(db), updates);
                    showSuccessToast("Sortie validée avec succès.");
                } catch (error) {
                    console.error(error);
                    showSuccessToast("Impossible de valider cette sortie pour le moment.");
                }
            }

            async function rejectExitRequest(requestId) {
                if (!dbBasePath || !currentUser || getCurrentUserRole() !== 'admin') return;
                const request = appData.storeExitRequests?.[requestId];
                if (!request || request.status !== EXIT_STATUS_PENDING) {
                    showSuccessToast("Cette demande a déjà été traitée.");
                    return;
                }
                try {
                    const now = new Date().toISOString();
                    const updates = {};
                    updates[`${dbBasePath}/storeExitRequests/${requestId}/status`] = EXIT_STATUS_REJECTED;
                    updates[`${dbBasePath}/storeExitRequests/${requestId}/validatedAt`] = now;
                    updates[`${dbBasePath}/storeExitRequests/${requestId}/validatedBy`] = currentUser.email || currentUserData?.email || '';
                    await update(ref(db), updates);
                    showSuccessToast("Sortie refusée.");
                } catch (error) {
                    console.error(error);
                    showSuccessToast("Impossible de refuser cette sortie pour le moment.");
                }
            }

            function onStoreExitRequestsValue(snapshot) {
                appData.storeExitRequests = snapshot.val() || {};
                renderPendingExitRequests();
                renderStoreMovementsPage();
            }

            function onStoreProductsValue(snapshot) {
                appData.storeProducts = snapshot.val() || {};
                populateStoreProductSelects();
                renderStoreProducts(storeSearchInput ? storeSearchInput.value : '');
                updateDashboardStats();
                updateAllStats();
            }

            function renderShopStock(searchTerm = '') {
                const stock = appData.shopStock;
                const normalizedSearch = searchTerm.toLowerCase();
                const filteredStock = Object.values(stock).filter(item => item.name?.toLowerCase().includes(normalizedSearch));

                if (filteredStock.length > 0) {
                    shopStockPlaceholder.classList.add('hidden');
                    shopStockTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedStock = filteredStock.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    const canDelete = hasPermission('Supprimer Stock Boutique');
                    sortedStock.forEach(item => {
                        const isLowStock = item.quantityInShop <= item.alertThreshold;
                        const currency = appData.storeProducts[item.sourceProductId]?.currency || 'CFA';
                        const deleteButtonHtml = canDelete
                            ? `<button class="delete-icon text-gray-400 hover:text-red-500" data-type="shop" data-stock-id="${item.id}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>`
                            : '';
                        html += `
                            <tr class="hover:bg-gray-50 ${isLowStock ? 'bg-red-50' : ''}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${isLowStock ? 'text-red-600' : 'text-gray-700'}">${item.quantityInShop}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(item.sellingPrice, currency)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.alertThreshold}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    ${deleteButtonHtml}
                                </td>
                            </tr>`;
                    });
                    shopStockTbody.innerHTML = html;
                } else {
                    shopStockTableContainer.classList.add('hidden');
                    shopStockPlaceholder.classList.remove('hidden');
                    shopStockTbody.innerHTML = '';
                }
            }

            function onShopStockValue(snapshot) {
                appData.shopStock = snapshot.val() || {};
                populateShopProductSelects();
                renderShopStock(shopSearchInput ? shopSearchInput.value : '');
                renderSalesCategoryFilters();
                renderSalesProducts(salesProductSearch ? salesProductSearch.value : '');
                updateDashboardStats();
                updateAllStats();
                renderCart();
            }

            function onShopMovementsValue(snapshot) {
                const movements = snapshot.val();
                if (movements) {
                    const filteredMovements = Object.values(movements).filter(move => {
                        const comment = (move?.comment || '').toString().trim().toLowerCase();
                        return !comment.startsWith('vente');
                    });
                    if (!filteredMovements.length) {
                        shopMovementsPlaceholder.classList.remove('hidden');
                        shopMovementsTableContainer.classList.add('hidden');
                        shopMovementsTbody.innerHTML = '';
                        return;
                    }
                    shopMovementsPlaceholder.classList.add('hidden');
                    shopMovementsTableContainer.classList.remove('hidden');
                    let html = '';
                    const sortedMovements = filteredMovements.sort((a, b) => new Date(b.date) - new Date(a.date));
                    sortedMovements.forEach(move => {
                        const isEntry = move.type === 'Entrée';
                        const userDisplay = move.userEmail ? move.userEmail.split('@')[0] : 'N/A';
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${move.productName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.type}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${isEntry ? 'text-green-600' : 'text-red-600'}">${isEntry ? '+' : '-'}${move.quantityChange}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.newStock}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${move.comment}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${userDisplay}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(move.date)}</td>
                            </tr>`;
                    });
                    shopMovementsTbody.innerHTML = html;
                } else {
                    shopMovementsPlaceholder.classList.remove('hidden');
                    shopMovementsTableContainer.classList.add('hidden');
                    shopMovementsTbody.innerHTML = '';
                }
            }

            function onSalesHistoryValue(snapshot) {
                appData.salesHistory = snapshot.val() || {};
                renderSalesHistory();
                updateDashboardStats();
                renderCustomerHistory();
            }

            function onPendingSalesValue(snapshot) {
                appData.pendingSales = snapshot.val() || {};
                renderSalesHistory();
            }

            function onCompanyCustomersValue(snapshot) {
                appData.customers = snapshot.val() || {};
                renderCustomerOptions();
                if (selectedCustomer?.id) {
                    const updated = appData.customers[selectedCustomer.id];
                    if (updated) {
                        applySelectedCustomer({ id: selectedCustomer.id, ...updated });
                    } else {
                        clearSelectedCustomer();
                    }
                }
                renderCustomerHistory();
                renderSalesHistory();
                updateDashboardStats();
            }

            function setupFirebaseListeners() {
                cleanupFirebaseListeners();
                if (!dbBasePath) return;

                storeProductsRef = ref(db, `${dbBasePath}/storeProducts`);
                storeProductsListener = onValue(storeProductsRef, onStoreProductsValue);

                storeMovementsRef = ref(db, `${dbBasePath}/storeMovements`);
                storeMovementsListener = onValue(storeMovementsRef, onStoreMovementsValue);

                storeExitRequestsRef = ref(db, `${dbBasePath}/storeExitRequests`);
                storeExitRequestsListener = onValue(storeExitRequestsRef, onStoreExitRequestsValue);

                shopStockRef = ref(db, `${dbBasePath}/shopStock`);
                shopStockListener = onValue(shopStockRef, onShopStockValue);

                shopMovementsRef = ref(db, `${dbBasePath}/shopMovements`);
                shopMovementsListener = onValue(shopMovementsRef, onShopMovementsValue);

                salesHistoryRef = ref(db, `${dbBasePath}/salesHistory`);
                salesHistoryListener = onValue(salesHistoryRef, onSalesHistoryValue);

                pendingSalesRef = ref(db, `${dbBasePath}/pendingSales`);
                pendingSalesListener = onValue(pendingSalesRef, onPendingSalesValue);

                companyMembersRef = ref(db, `${dbBasePath}/members`);
                companyMembersListener = onValue(companyMembersRef, onCompanyMembersValue);

                companyCustomersRef = ref(db, `${dbBasePath}/customers`);
                companyCustomersListener = onValue(companyCustomersRef, onCompanyCustomersValue);

                migrateLocalPendingSales();
            }

            function cleanupFirebaseListeners() {
                if (storeProductsListener && storeProductsRef) off(storeProductsRef, storeProductsListener);
                if (storeMovementsListener && storeMovementsRef) off(storeMovementsRef, storeMovementsListener);
                if (storeExitRequestsListener && storeExitRequestsRef) off(storeExitRequestsRef, storeExitRequestsListener);
                if (shopStockListener && shopStockRef) off(shopStockRef, shopStockListener);
                if (shopMovementsListener && shopMovementsRef) off(shopMovementsRef, shopMovementsListener);
                if (salesHistoryListener && salesHistoryRef) off(salesHistoryRef, salesHistoryListener);
                if (pendingSalesListener && pendingSalesRef) off(pendingSalesRef, pendingSalesListener);
                if (companyMembersListener && companyMembersRef) off(companyMembersRef, companyMembersListener);
                if (companyCustomersListener && companyCustomersRef) off(companyCustomersRef, companyCustomersListener);

                storeProductsListener = null; storeMovementsListener = null; storeExitRequestsListener = null; shopStockListener = null; shopMovementsListener = null; salesHistoryListener = null; pendingSalesListener = null; companyMembersListener = null; companyCustomersListener = null;
                appData.storeProducts = {}; appData.storeMovements = {}; appData.shopStock = {}; appData.salesHistory = {}; appData.customers = {}; appData.storeExitRequests = {}; appData.pendingSales = {};
                selectedCustomer = null;
                customerOptionLookup = {};
                isCustomerHistoryOpen = false;
            }

            function updateUI() {
                if (isAuthenticated) {
                    if (authPageContainer) authPageContainer.classList.add('hidden');
                    if (layoutContainer) layoutContainer.classList.remove('hidden');
                    if (currentUser && userEmailDisplay) userEmailDisplay.textContent = currentUser.email;
                    if (currentUserData) {
                        if (userNameDisplay) userNameDisplay.textContent = currentUserData.fullName || 'Utilisateur';
                        if (userCompanyDisplay) userCompanyDisplay.textContent = currentUserData.companyName || '';
                    }
                    if (mobilePageTitle) mobilePageTitle.textContent = currentPage;

                    // Vérifier si l'utilisateur peut accéder à la page actuelle
                    if (!canAccessPage(currentPage)) {
                        const availablePage = Object.keys(pagePermissions).find(page => canAccessPage(page)) || '';
                        currentPage = availablePage;
                        if (mobilePageTitle) mobilePageTitle.textContent = currentPage || '';
                    }
                } else {
                    if (authPageContainer) authPageContainer.classList.remove('hidden');
                    if (layoutContainer) layoutContainer.classList.add('hidden');
                }

                pageContents.forEach(page => {
                    if (currentPage && page.id === `page-${currentPage.replace(/ /g, '-')}`) page.classList.remove('hidden');
                    else page.classList.add('hidden');
                });

                navButtons.forEach(button => {
                    const pageName = button.dataset.page;

                    // Masquer le bouton si l'utilisateur n'a pas accès à la page
                    if (!canAccessPage(pageName)) {
                        button.style.display = 'none';
                        return;
                    } else {
                        button.style.display = '';
                    }

                    // Mettre en surbrillance le bouton actif
                    if (button.dataset.page === currentPage) {
                        button.classList.add('bg-cyan-400', 'text-white', 'shadow');
                        button.classList.remove('text-gray-600', 'hover:bg-gray-100');
                    } else {
                        button.classList.remove('bg-cyan-400', 'text-white', 'shadow');
                        button.classList.add('text-gray-600', 'hover:bg-gray-100');
                    }
                });

                updateSettingsAccess();

                // Mettre à jour les boutons d'actions rapides
                if (isAuthenticated && typeof updateQuickActionButtons === 'function') {
                    updateQuickActionButtons();
                }
            }

            function updateAuthFormView() {
                updateLoginModeUI();
                if (isLoginView) {
                    if (loginForm) loginForm.classList.remove('hidden');
                    if (signupForm) signupForm.classList.add('hidden');
                    if (authToggleLogin) authToggleLogin.classList.add('bg-white', 'shadow', 'text-gray-800');
                    if (authToggleSignup) authToggleSignup.classList.remove('bg-white', 'shadow', 'text-gray-800');
                } else {
                    if (loginForm) loginForm.classList.add('hidden');
                    if (signupForm) signupForm.classList.remove('hidden');
                    if (authToggleSignup) authToggleSignup.classList.add('bg-white', 'shadow', 'text-gray-800');
                    if (authToggleLogin) authToggleLogin.classList.remove('bg-white', 'shadow', 'text-gray-800');
                }
            }

            function formatCategoryLabel(value) {
                const trimmed = (value || '').toString().trim();
                if (!trimmed) return 'Autres';
                return trimmed.charAt(0).toUpperCase() + trimmed.slice(1);
            }

            function getShopItemCategory(item) {
                const source = appData.storeProducts?.[item.sourceProductId];
                const raw = item.category || item.categoryName || item.type || source?.category || source?.categoryName || source?.type || '';
                return formatCategoryLabel(raw || 'Autres');
            }

            function renderSalesCategoryFilters() {
                if (!salesCategoryFilters) return;
                const categories = [...new Set(Object.values(appData.shopStock || {}).map(getShopItemCategory))].sort((a, b) => a.localeCompare(b));
                if (selectedSalesCategory !== 'Tous' && !categories.includes(selectedSalesCategory)) {
                    selectedSalesCategory = 'Tous';
                }
                const allCategories = ['Tous', ...categories];
                salesCategoryFilters.innerHTML = allCategories.map(category => {
                    const isActive = selectedSalesCategory === category;
                    const classes = isActive
                        ? 'bg-blue-600 text-white shadow'
                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200';
                    return `<button type="button" data-sales-category="${category}" class="px-4 py-2 rounded-full text-sm font-semibold transition ${classes}">${category}</button>`;
                }).join('');
            }

            function renderSalesProducts(searchTerm = '') {
                if (!salesProductsPlaceholder || !salesProductsContainer) return;
                const normalizedSearch = normalizeString(searchTerm);
                const stock = Object.values(appData.shopStock || {}).filter(item => {
                    const name = normalizeString(item.name);
                    const category = normalizeString(getShopItemCategory(item));
                    const matchesSearch = !normalizedSearch || name.includes(normalizedSearch) || category.includes(normalizedSearch);
                    const matchesCategory = selectedSalesCategory === 'Tous' || getShopItemCategory(item) === selectedSalesCategory;
                    return matchesSearch && matchesCategory;
                });
                const displayItems = stock.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                if (!displayItems.length) {
                    salesProductsPlaceholder.classList.remove('hidden');
                    salesProductsContainer.classList.add('hidden');
                    salesProductsContainer.innerHTML = '';
                    return;
                }

                salesProductsPlaceholder.classList.add('hidden');
                salesProductsContainer.classList.remove('hidden');

                salesProductsContainer.innerHTML = displayItems.map(item => {
                    const currency = appData.storeProducts[item.sourceProductId]?.currency || 'CFA';
                    const category = getShopItemCategory(item);
                    const isLowStock = item.quantityInShop <= (item.alertThreshold || 5);
                    const isOut = item.quantityInShop <= 0;
                    const stockLabel = isOut ? 'Rupture' : `Stock: ${item.quantityInShop}`;
                    const stockClass = isOut
                        ? 'bg-red-100 text-red-600'
                        : isLowStock
                            ? 'bg-yellow-100 text-yellow-700'
                            : 'bg-green-100 text-green-700';
                    const actionHtml = isOut
                        ? `<span class="text-xs font-semibold text-gray-400">Indisponible</span>`
                        : `<button type="button" data-add-product="${item.id}" class="mt-4 w-full px-3 py-2 text-xs font-semibold rounded-lg bg-cyan-500 text-white hover:bg-cyan-600">Ajouter</button>`;
                    return `
                        <div class="border border-gray-200 rounded-2xl p-4 hover:shadow-md transition ${isOut ? 'opacity-60' : ''}">
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-xs font-semibold text-gray-400 uppercase">${category}</span>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${stockClass}">${stockLabel}</span>
                            </div>
                            <h3 class="mt-3 text-base font-semibold text-gray-900">${item.name}</h3>
                            <p class="mt-2 text-lg font-bold text-cyan-600">${formatCurrency(item.sellingPrice, currency)}</p>
                            ${actionHtml}
                        </div>
                    `;
                }).join('');
            }

            // --- FONCTIONS DE GESTION DU PANIER ---
            function showSalesErrorMessage(message) {
                if (!salesError) {
                    alert(message);
                    return;
                }
                salesError.textContent = message;
                salesError.classList.remove('hidden');
                setTimeout(() => salesError.classList.add('hidden'), 3000);
            }

            function addToCart(productId = null, quantityOverride = null) {
                const shopProductId = productId;
                const quantityInput = Number.isFinite(quantityOverride) ? quantityOverride : 1;

                if (!shopProductId || isNaN(quantityInput) || quantityInput <= 0) {
                    showSalesErrorMessage("Veuillez sélectionner un produit valide.");
                    return;
                }

                const shopProduct = appData.shopStock[shopProductId];
                if (!shopProduct) return;
                if (shopProduct.quantityInShop <= 0) {
                    showSalesErrorMessage("Stock insuffisant pour ce produit.");
                    return;
                }

                const existingItemIndex = cartItems.findIndex(item => item.shopProductId === shopProductId);
                const existingQty = existingItemIndex !== -1 ? cartItems[existingItemIndex].quantity : 0;
                if (existingQty + quantityInput > shopProduct.quantityInShop) {
                    showSalesErrorMessage(`Stock insuffisant. Disponible: ${shopProduct.quantityInShop}`);
                    return;
                }

                if (existingItemIndex !== -1) {
                    cartItems[existingItemIndex].quantity += quantityInput;
                } else {
                    const currency = appData.storeProducts[shopProduct.sourceProductId]?.currency || 'CFA';
                    cartItems.push({
                        shopProductId,
                        name: shopProduct.name,
                        sellingPrice: shopProduct.sellingPrice,
                        quantity: quantityInput,
                        currency
                    });
                }

                renderCart();
                showSuccessToast('Article ajouté au panier');
            }

            function removeFromCart(index) {
                cartItems.splice(index, 1);
                renderCart();
                showSuccessToast('Article retiré du panier');
            }

            function updateCartQuantity(index, newQty) {
                const item = cartItems[index];
                if (!item) return;
                if (newQty <= 0) {
                    removeFromCart(index);
                    return;
                }
                const shopProduct = appData.shopStock[item.shopProductId];
                const maxQty = shopProduct?.quantityInShop ?? item.quantity;
                if (newQty > maxQty) {
                    showSalesErrorMessage(`Stock insuffisant. Disponible: ${maxQty}`);
                    return;
                }
                cartItems[index].quantity = newQty;
                renderCart();
            }

            function calculateCartTotal() {
                return cartItems.reduce((total, item) => total + (item.sellingPrice * item.quantity), 0);
            }

            function calculateCartSummary() {
                const subtotal = calculateCartTotal();
                const tax = subtotal * getTaxRate();
                const total = subtotal + tax;
                const currency = cartItems[0]?.currency || 'CFA';
                return { subtotal, tax, total, currency };
            }

            function renderCart() {
                const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
                if (cartItemsCount) {
                    let label = 'article';
                    if (totalItems === 0) label = 'article(s)';
                    if (totalItems > 1) label = 'articles';
                    cartItemsCount.textContent = `${totalItems} ${label}`;
                }

                const hasItems = cartItems.length > 0;
                const canHold = hasItems && !!selectedCustomer;
                if (cartTaxRow) cartTaxRow.classList.toggle('hidden', !isTaxEnabled);
                if (cartEmptyState) cartEmptyState.classList.toggle('hidden', hasItems);
                if (cartItemsList) cartItemsList.classList.toggle('hidden', !hasItems);
                if (holdCommentError) holdCommentError.classList.add('hidden');

                if (!hasItems) {
                    if (cartItemsList) cartItemsList.innerHTML = '';
                    if (cartSubtotal) cartSubtotal.textContent = formatCurrency(0);
                    if (cartTax) cartTax.textContent = formatCurrency(0);
                    if (cartTotal) cartTotal.textContent = formatCurrency(0);
                    if (validateCartButton) {
                        validateCartButton.disabled = true;
                        validateCartButton.classList.add('bg-gray-300');
                        validateCartButton.classList.remove('bg-cyan-500', 'hover:bg-cyan-600');
                    }
                    if (generateInvoiceButton) {
                        generateInvoiceButton.disabled = true;
                        generateInvoiceButton.classList.add('bg-gray-300');
                        generateInvoiceButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    }
                    if (payLaterButton) {
                        payLaterButton.disabled = true;
                        payLaterButton.title = 'Ajoutez des articles pour marquer à payer plus tard';
                        payLaterButton.classList.add('bg-gray-300');
                        payLaterButton.classList.remove('bg-amber-500', 'hover:bg-amber-600');
                    }
                    if (holdCartButton) {
                        holdCartButton.disabled = true;
                        holdCartButton.title = 'Ajoutez des articles pour mettre en attente';
                    }
                    return;
                }

                if (validateCartButton) {
                    validateCartButton.disabled = false;
                    validateCartButton.classList.remove('bg-gray-300');
                    validateCartButton.classList.add('bg-cyan-500', 'hover:bg-cyan-600');
                }
                if (generateInvoiceButton) {
                    generateInvoiceButton.disabled = false;
                    generateInvoiceButton.classList.remove('bg-gray-300');
                    generateInvoiceButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
                if (payLaterButton) {
                    const canPayLater = hasItems && !!selectedCustomer;
                    payLaterButton.disabled = !canPayLater;
                    payLaterButton.title = canPayLater ? '' : 'Sélectionnez un client pour marquer à payer plus tard';
                    payLaterButton.classList.toggle('bg-gray-300', !canPayLater);
                    payLaterButton.classList.toggle('bg-amber-500', canPayLater);
                    payLaterButton.classList.toggle('hover:bg-amber-600', canPayLater);
                }
                if (holdCartButton) {
                    holdCartButton.disabled = !canHold;
                    holdCartButton.title = canHold ? '' : 'Sélectionnez un client pour mettre en attente';
                }

                if (cartItemsList) {
                    cartItemsList.innerHTML = cartItems.map((item, index) => {
                        const subtotal = item.sellingPrice * item.quantity;
                        return `
                            <div class="border border-gray-200 rounded-xl p-3 flex items-start justify-between gap-3">
                                <div>
                                    <p class="text-sm font-semibold text-gray-900">${item.name}</p>
                                    <p class="text-xs text-gray-500 mt-1">${formatCurrency(item.sellingPrice, item.currency)} x ${item.quantity}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-semibold text-gray-900">${formatCurrency(subtotal, item.currency)}</p>
                                    <div class="mt-2 flex items-center justify-end gap-2">
                                        <button type="button" data-cart-action="decrease" data-index="${index}" class="w-7 h-7 rounded-full border border-gray-200 text-gray-500 hover:text-gray-700">-</button>
                                        <input type="number" min="1" step="1" value="${item.quantity}" data-cart-quantity data-index="${index}"
                                            class="w-14 h-7 rounded-md border border-gray-200 text-xs text-center text-gray-700 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" />
                                        <button type="button" data-cart-action="increase" data-index="${index}" class="w-7 h-7 rounded-full border border-gray-200 text-gray-500 hover:text-gray-700">+</button>
                                        <button type="button" data-cart-action="remove" data-index="${index}" class="ml-1 text-xs font-semibold text-red-500 hover:text-red-600">Retirer</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                const summary = calculateCartSummary();
                if (cartSubtotal) cartSubtotal.textContent = formatCurrency(summary.subtotal, summary.currency);
                if (cartTax) cartTax.textContent = formatCurrency(summary.tax, summary.currency);
                if (cartTotal) cartTotal.textContent = formatCurrency(summary.total, summary.currency);
            }

            async function holdCart() {
                if (!cartItems.length) return;
                if (!selectedCustomer) {
                    showSalesErrorMessage("Sélectionnez un client pour mettre en attente.");
                    return;
                }
                const comment = (holdCommentInput?.value || '').trim();
                if (!comment) {
                    if (holdCommentError) {
                        holdCommentError.textContent = "Le commentaire est requis pour la mise en attente.";
                        holdCommentError.classList.remove('hidden');
                    } else {
                        showSalesErrorMessage("Le commentaire est requis pour la mise en attente.");
                    }
                    return;
                }

                try {
                    const now = new Date().toISOString();
                    const heldSale = {
                        createdAt: now,
                        comment,
                        customer: {
                            id: selectedCustomer.id,
                            name: selectedCustomer.fullName || selectedCustomer.name || 'Client',
                            phone: selectedCustomer.phone || '',
                            email: selectedCustomer.email || ''
                        },
                        items: cartItems
                    };

                    if (dbBasePath) {
                        if (!currentUser) return;
                        for (const item of cartItems) {
                            const shopProduct = appData.shopStock[item.shopProductId];
                            if (!shopProduct || item.quantity > shopProduct.quantityInShop) {
                                showSalesErrorMessage(`Stock insuffisant pour ${item.name}. Disponible: ${shopProduct?.quantityInShop || 0}`);
                                return;
                            }
                        }

                        const updates = {};
                        const pendingRef = push(ref(db, `${dbBasePath}/pendingSales`));
                        heldSale.id = pendingRef.key;
                        heldSale.createdBy = currentUser?.email || '';
                        heldSale.stockReserved = true;
                        updates[`${dbBasePath}/pendingSales/${pendingRef.key}`] = heldSale;

                        cartItems.forEach(item => {
                            const shopProduct = appData.shopStock[item.shopProductId];
                            const newStock = (Number(shopProduct?.quantityInShop) || 0) - item.quantity;
                            updates[`${dbBasePath}/shopStock/${item.shopProductId}/quantityInShop`] = newStock;
                            const shopMoveKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                            updates[`${dbBasePath}/shopMovements/${shopMoveKey}`] = {
                                id: shopMoveKey,
                                shopProductId: item.shopProductId,
                                productName: item.name,
                                type: "Sortie",
                                quantityChange: item.quantity,
                                oldStock: shopProduct?.quantityInShop ?? 0,
                                newStock,
                                comment: comment ? `Vente en attente: ${comment}` : 'Vente en attente',
                                date: now,
                                userEmail: currentUser.email || ''
                            };
                        });

                        await update(ref(db), updates);
                    } else {
                        heldSale.id = `HOLD-${Date.now()}`;
                        heldSale.stockReserved = false;
                        const pendingSales = getPendingSalesFromStorage();
                        pendingSales.unshift(heldSale);
                        savePendingSalesToStorage(pendingSales);
                    }
                } catch (error) {
                    console.warn('Impossible de sauvegarder le panier en attente.', error);
                    return;
                }

                cartItems = [];
                if (holdCommentInput) holdCommentInput.value = '';
                renderCart();
                renderSalesHistory();
                showSuccessToast('Panier mis en attente');
            }

            async function finalizeSale({ generateInvoice = false, payLater = false } = {}) {
                if (!currentUser || !dbBasePath) return;
                if (cartItems.length === 0) {
                    alert('Le panier est vide !');
                    return;
                }
                if (payLater && !selectedCustomer) {
                    showSalesErrorMessage("Sélectionnez un client pour marquer la vente 'A payer plus tard'.");
                    return;
                }

                // Vérifier le stock disponible pour chaque article
                for (const item of cartItems) {
                    const shopProduct = appData.shopStock[item.shopProductId];
                    if (!shopProduct || item.quantity > shopProduct.quantityInShop) {
                        alert(`Stock insuffisant pour ${item.name}. Disponible: ${shopProduct?.quantityInShop || 0}`);
                        return;
                    }
                }

                try {
                    [validateCartButton, generateInvoiceButton, payLaterButton].filter(Boolean).forEach(btn => {
                        btn.disabled = true;
                    });

                    const updates = {};
                    const now = new Date().toISOString();
                    const sellerName = currentUserData?.fullName || currentUser.email;
                    const comment = (holdCommentInput?.value || '').trim();
                    const customerContext = getCustomerContext();
                    const saleGroupId = push(ref(db, `${dbBasePath}/sales`)).key;
                    const summary = calculateCartSummary();
                    const totalAmount = summary.total;
                    const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
                    const paymentStatus = payLater ? 'pay_later' : 'paid';
                    const itemsSnapshot = cartItems.map(item => ({
                        name: item.name,
                        quantity: item.quantity,
                        price: item.sellingPrice,
                        total: item.sellingPrice * item.quantity
                    }));

                    updates[`${dbBasePath}/sales/${saleGroupId}`] = {
                        id: saleGroupId,
                        date: now,
                        customerId: customerContext.customerId,
                        customerName: customerContext.customerName || '',
                        customerPhone: customerContext.customerPhone || '',
                        customerEmail: customerContext.customerEmail || '',
                        sellerName,
                        total: totalAmount,
                        itemsCount: totalItems,
                        status: 'validee',
                        comment,
                        paymentStatus,
                        payLater: payLater === true
                    };

                    // Traiter chaque article du panier
                    for (const item of cartItems) {
                        const shopProduct = appData.shopStock[item.shopProductId];
                        const shopNewStock = shopProduct.quantityInShop - item.quantity;

                        // Mettre à jour le stock de la boutique
                        updates[`${dbBasePath}/shopStock/${item.shopProductId}/quantityInShop`] = shopNewStock;

                        // Ajouter un mouvement de stock
                        const shopMoveKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                        updates[`${dbBasePath}/shopMovements/${shopMoveKey}`] = {
                            id: shopMoveKey,
                            shopProductId: item.shopProductId,
                            productName: item.name,
                            type: "Sortie",
                            quantityChange: item.quantity,
                            oldStock: shopProduct.quantityInShop,
                            newStock: shopNewStock,
                            comment: comment ? `Vente groupée: ${comment}` : 'Vente groupée',
                            date: now,
                            userEmail: currentUser.email
                        };

                        // Ajouter une vente à l'historique
                        const saleKey = push(ref(db, `${dbBasePath}/salesHistory`)).key;
                        updates[`${dbBasePath}/salesHistory/${saleKey}`] = {
                            id: saleKey,
                            saleGroupId,
                            shopProductId: item.shopProductId,
                            productName: item.name,
                            quantity: item.quantity,
                            sellingPrice: item.sellingPrice,
                            totalAmount: item.sellingPrice * item.quantity,
                            sellerName,
                            customerId: customerContext.customerId,
                            customerName: customerContext.customerName || '',
                            customerPhone: customerContext.customerPhone || '',
                            customerEmail: customerContext.customerEmail || '',
                            comment,
                            paymentStatus,
                            payLater: payLater === true,
                            date: now,
                            saleSource: SALE_SOURCE_SHOP
                        };
                    }

                    await update(ref(db), updates);

                    if (payLater) {
                        showSuccessToast(`Vente enregistrée : A payer plus tard · Total: ${formatCurrency(totalAmount, summary.currency)}`);
                    } else if (generateInvoice) {
                        showSuccessToast(`Vente enregistrée et facture générée · Total: ${formatCurrency(totalAmount, summary.currency)}`);
                    } else {
                        showSuccessToast(`Vente enregistrée · Total: ${formatCurrency(totalAmount, summary.currency)}`);
                    }

                    // Vider le panier et réinitialiser le formulaire
                    cartItems = [];
                    if (holdCommentInput) holdCommentInput.value = '';
                    renderSalesHistory();
                    if (generateInvoice) {
                        const invoiceData = {
                            companyName: currentUserData?.companyName || 'Mon Entreprise',
                            sellerName,
                            customerName: customerContext.customerName || '',
                            customerPhone: customerContext.customerPhone || '',
                            customerEmail: customerContext.customerEmail || '',
                            date: now,
                            items: itemsSnapshot,
                            total: totalAmount,
                            currency: summary.currency,
                            comment
                        };
                        await generateInvoicePDF(invoiceData);
                    }

                } catch (error) {
                    console.error(error);
                    alert('Une erreur est survenue lors de la validation de la vente');
                } finally {
                    renderCart();
                }
            }

            function validateCart() {
                return finalizeSale({ generateInvoice: false, payLater: false });
            }

            function generateInvoiceFromCart() {
                return finalizeSale({ generateInvoice: true, payLater: false });
            }

            function markPayLaterFromCart() {
                return finalizeSale({ generateInvoice: false, payLater: true });
            }

            async function markPayLaterAsPaid(groupId) {
                if (!currentUser || !dbBasePath || !groupId) return;
                try {
                    const salesHistoryEntries = Object.values(appData.salesHistory || {});
                    const updates = {};
                    const hasGroup = salesHistoryEntries.some(sale => sale.saleGroupId === groupId);

                    if (hasGroup) {
                        updates[`${dbBasePath}/sales/${groupId}/paymentStatus`] = 'paid';
                        updates[`${dbBasePath}/sales/${groupId}/payLater`] = false;
                    }

                    salesHistoryEntries.forEach(sale => {
                        if (sale.saleGroupId === groupId || sale.id === groupId) {
                            updates[`${dbBasePath}/salesHistory/${sale.id}/paymentStatus`] = 'paid';
                            updates[`${dbBasePath}/salesHistory/${sale.id}/payLater`] = false;
                        }
                    });

                    if (Object.keys(updates).length === 0) {
                        showSalesErrorMessage('Impossible de trouver cette vente à mettre à jour.');
                        return;
                    }

                    await update(ref(db), updates);

                    salesHistoryEntries.forEach(sale => {
                        if (sale.saleGroupId === groupId || sale.id === groupId) {
                            sale.paymentStatus = 'paid';
                            sale.payLater = false;
                        }
                    });

                    renderSalesHistory();
                    if (activeSalesDetailId === groupId) {
                        openSalesDetailModal(groupId);
                    }
                    showSuccessToast('Vente marquée comme payée.');
                } catch (error) {
                    console.error(error);
                    alert('Une erreur est survenue lors de la mise à jour du paiement.');
                }
            }

            async function markSaleAsPayLater(groupId) {
                if (!currentUser || !dbBasePath || !groupId) return;
                try {
                    const salesHistoryEntries = Object.values(appData.salesHistory || {});
                    const updates = {};
                    const hasGroup = salesHistoryEntries.some(sale => sale.saleGroupId === groupId);

                    if (hasGroup) {
                        updates[`${dbBasePath}/sales/${groupId}/paymentStatus`] = 'pay_later';
                        updates[`${dbBasePath}/sales/${groupId}/payLater`] = true;
                    }

                    salesHistoryEntries.forEach(sale => {
                        if (sale.saleGroupId === groupId || sale.id === groupId) {
                            updates[`${dbBasePath}/salesHistory/${sale.id}/paymentStatus`] = 'pay_later';
                            updates[`${dbBasePath}/salesHistory/${sale.id}/payLater`] = true;
                        }
                    });

                    if (Object.keys(updates).length === 0) {
                        showSalesErrorMessage('Impossible de trouver cette vente à mettre à jour.');
                        return;
                    }

                    await update(ref(db), updates);

                    salesHistoryEntries.forEach(sale => {
                        if (sale.saleGroupId === groupId || sale.id === groupId) {
                            sale.paymentStatus = 'pay_later';
                            sale.payLater = true;
                        }
                    });

                    renderSalesHistory();
                    if (activeSalesDetailId === groupId) {
                        openSalesDetailModal(groupId);
                    }
                    showSuccessToast('Vente passée en paiement différé.');
                } catch (error) {
                    console.error(error);
                    alert('Une erreur est survenue lors de la mise à jour du paiement.');
                }
            }

            async function validatePendingSale(pendingId) {
                if (!currentUser || !dbBasePath || !pendingId) return;
                const pendingSales = getPendingSalesList();
                const pendingIndex = pendingSales.findIndex(sale => sale.id === pendingId);
                if (pendingIndex === -1) return;
                const pending = pendingSales[pendingIndex];
                const items = pending.items || [];
                if (!items.length) {
                    showSalesErrorMessage('Aucun article dans cette vente en attente.');
                    return;
                }
                const isReserved = pending.stockReserved === true;

                if (!isReserved) {
                    for (const item of items) {
                        const shopProduct = appData.shopStock[item.shopProductId];
                        if (!shopProduct || item.quantity > shopProduct.quantityInShop) {
                            alert(`Stock insuffisant pour ${item.name}. Disponible: ${shopProduct?.quantityInShop || 0}`);
                            return;
                        }
                    }
                }

                try {
                    const updates = {};
                    const now = new Date().toISOString();
                    const sellerName = currentUserData?.fullName || currentUser.email;
                    const comment = pending.comment || '';
                    const customer = pending.customer || {};
                    const saleGroupId = push(ref(db, `${dbBasePath}/sales`)).key;
                    const summary = calculateItemsSummary(items);
                    const totalAmount = summary.total;
                    const totalItems = items.reduce((sum, item) => sum + (item.quantity || 0), 0);

                    updates[`${dbBasePath}/sales/${saleGroupId}`] = {
                        id: saleGroupId,
                        date: now,
                        customerId: customer.id || null,
                        customerName: customer.name || '',
                        customerPhone: customer.phone || '',
                        customerEmail: customer.email || '',
                        sellerName,
                        total: totalAmount,
                        itemsCount: totalItems,
                        status: 'validee',
                        comment,
                        paymentStatus: 'paid',
                        payLater: false
                    };

                    for (const item of items) {
                        if (!isReserved) {
                            const shopProduct = appData.shopStock[item.shopProductId];
                            const shopNewStock = shopProduct.quantityInShop - item.quantity;

                            updates[`${dbBasePath}/shopStock/${item.shopProductId}/quantityInShop`] = shopNewStock;

                            const shopMoveKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                            updates[`${dbBasePath}/shopMovements/${shopMoveKey}`] = {
                                id: shopMoveKey,
                                shopProductId: item.shopProductId,
                                productName: item.name,
                                type: "Sortie",
                                quantityChange: item.quantity,
                                oldStock: shopProduct.quantityInShop,
                                newStock: shopNewStock,
                                comment: comment ? `Vente en attente: ${comment}` : 'Vente en attente',
                                date: now,
                                userEmail: currentUser.email
                            };
                        }

                        const saleKey = push(ref(db, `${dbBasePath}/salesHistory`)).key;
                        updates[`${dbBasePath}/salesHistory/${saleKey}`] = {
                            id: saleKey,
                            saleGroupId,
                            shopProductId: item.shopProductId,
                            productName: item.name,
                            quantity: item.quantity,
                            sellingPrice: item.sellingPrice,
                            totalAmount: item.sellingPrice * item.quantity,
                            sellerName,
                            customerId: customer.id || null,
                            customerName: customer.name || '',
                            customerPhone: customer.phone || '',
                            customerEmail: customer.email || '',
                            comment,
                            paymentStatus: 'paid',
                            payLater: false,
                            date: now,
                            saleSource: SALE_SOURCE_SHOP
                        };
                    }

                    await update(ref(db), updates);

                    if (dbBasePath) {
                        await remove(ref(db, `${dbBasePath}/pendingSales/${pendingId}`));
                    } else {
                        pendingSales.splice(pendingIndex, 1);
                        savePendingSalesToStorage(pendingSales);
                    }
                    renderSalesHistory();

                    const invoiceData = {
                        companyName: currentUserData?.companyName || 'Mon Entreprise',
                        sellerName,
                        customerName: customer.name || '',
                        customerPhone: customer.phone || '',
                        customerEmail: customer.email || '',
                        date: now,
                        items: items.map(item => ({
                            name: item.name,
                            quantity: item.quantity,
                            price: item.sellingPrice,
                            total: item.sellingPrice * item.quantity
                        })),
                        total: totalAmount,
                        currency: summary.currency,
                        comment
                    };

                    await generateInvoicePDF(invoiceData);
                    showSuccessToast('Vente en attente validée.');
                } catch (error) {
                    console.error(error);
                    alert('Une erreur est survenue lors de la validation de la vente en attente.');
                }
            }

            async function cancelPendingSale(pendingId) {
                if (!pendingId) return;
                const pendingSales = getPendingSalesList();
                const pending = pendingSales.find(sale => sale.id === pendingId);
                const isReserved = pending?.stockReserved === true;

                try {
                    if (dbBasePath) {
                        const updates = {};
                        const now = new Date().toISOString();

                        if (isReserved && Array.isArray(pending?.items) && pending.items.length) {
                            for (const item of pending.items) {
                                const shopProduct = appData.shopStock?.[item.shopProductId];
                                if (!shopProduct) {
                                    showSalesErrorMessage("Produit introuvable pour remettre le stock en boutique.");
                                    return;
                                }
                            }

                            pending.items.forEach(item => {
                                const shopProduct = appData.shopStock[item.shopProductId];
                                const newStock = (Number(shopProduct.quantityInShop) || 0) + (Number(item.quantity) || 0);
                                updates[`${dbBasePath}/shopStock/${item.shopProductId}/quantityInShop`] = newStock;
                                const shopMoveKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                                updates[`${dbBasePath}/shopMovements/${shopMoveKey}`] = {
                                    id: shopMoveKey,
                                    shopProductId: item.shopProductId,
                                    productName: item.name || shopProduct.name || 'Produit',
                                    type: "Entrée",
                                    quantityChange: item.quantity,
                                    oldStock: shopProduct.quantityInShop,
                                    newStock,
                                    comment: pending.comment ? `Vente en attente: ${pending.comment}` : 'Vente en attente',
                                    date: now,
                                    userEmail: currentUser?.email || ''
                                };
                            });
                        }

                        updates[`${dbBasePath}/pendingSales/${pendingId}`] = null;
                        await update(ref(db), updates);
                    } else {
                        const nextSales = pendingSales.filter(sale => sale.id !== pendingId);
                        savePendingSalesToStorage(nextSales);
                    }

                    renderSalesHistory();
                    showSuccessToast('Vente en attente annulée.');
                } catch (error) {
                    console.error(error);
                    showSalesErrorMessage("Impossible d'annuler cette vente pour le moment.");
                }
            }

            async function removePendingSaleItem(pendingId, itemIndex) {
                if (!pendingId) return;
                const index = Number(itemIndex);
                if (Number.isNaN(index)) return;
                const pendingSales = getPendingSalesList();
                const pending = pendingSales.find(sale => sale.id === pendingId);
                if (!pending || !Array.isArray(pending.items)) return;
                if (index < 0 || index >= pending.items.length) return;

                const removedItem = pending.items[index];
                const itemLabel = removedItem?.name ? `« ${removedItem.name} »` : 'cet article';
                if (!confirm(`Confirmer le retrait de ${itemLabel} de la vente en attente ?`)) return;

                const nextItems = pending.items.slice();
                nextItems.splice(index, 1);

                if (!nextItems.length) {
                    cancelPendingSale(pendingId);
                    return;
                }

                try {
                    if (dbBasePath) {
                        const updates = {};
                        const now = new Date().toISOString();
                        const isReserved = pending.stockReserved === true;

                        if (isReserved) {
                            const shopProduct = appData.shopStock?.[removedItem.shopProductId];
                            if (!shopProduct) {
                                showSalesErrorMessage("Produit introuvable pour remettre le stock en boutique.");
                                return;
                            }
                            const newStock = (Number(shopProduct.quantityInShop) || 0) + (Number(removedItem.quantity) || 0);
                            updates[`${dbBasePath}/shopStock/${removedItem.shopProductId}/quantityInShop`] = newStock;
                            const shopMoveKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                            updates[`${dbBasePath}/shopMovements/${shopMoveKey}`] = {
                                id: shopMoveKey,
                                shopProductId: removedItem.shopProductId,
                                productName: removedItem.name || shopProduct.name || 'Produit',
                                type: "Entrée",
                                quantityChange: removedItem.quantity,
                                oldStock: shopProduct.quantityInShop,
                                newStock,
                                comment: pending.comment ? `Vente en attente: ${pending.comment}` : 'Vente en attente',
                                date: now,
                                userEmail: currentUser?.email || ''
                            };
                        }

                        updates[`${dbBasePath}/pendingSales/${pendingId}/items`] = nextItems;
                        updates[`${dbBasePath}/pendingSales/${pendingId}/updatedAt`] = now;
                        await update(ref(db), updates);
                        if (appData.pendingSales?.[pendingId]) {
                            appData.pendingSales[pendingId].items = nextItems;
                        }
                    } else {
                        const localPending = getPendingSalesFromStorage();
                        const updatedPending = localPending.map(sale => {
                            if (sale.id !== pendingId) return sale;
                            return { ...sale, items: nextItems, updatedAt: new Date().toISOString() };
                        });
                        savePendingSalesToStorage(updatedPending);
                    }
                    renderSalesHistory();
                    showSuccessToast('Article retiré de la vente en attente.');
                } catch (error) {
                    console.error(error);
                    showSalesErrorMessage("Impossible de retirer l'article pour le moment.");
                }
            }

            async function removeSalesHistoryItem(groupId, saleId) {
                if (!dbBasePath || !currentUser || !saleId) return;
                const sale = appData.salesHistory?.[saleId];
                if (!sale) return;

                const saleGroupId = sale.saleGroupId || sale.id;
                if (groupId && saleGroupId !== groupId) return;

                const paymentStatus = sale.paymentStatus || (sale.payLater ? 'pay_later' : 'paid');
                if (!['pending', 'pay_later'].includes(paymentStatus)) {
                    showSalesErrorMessage("Le retrait d'articles est disponible uniquement pour les ventes en attente ou en paiement différé.");
                    return;
                }

                const quantity = parseInt(sale.quantity, 10) || 0;
                if (quantity <= 0) return;
                const itemLabel = sale.productName ? `« ${sale.productName} »` : 'cet article';
                if (!confirm(`Confirmer le retrait de ${itemLabel} de la facture ?`)) return;

                const updates = {};
                const now = new Date().toISOString();
                const invoiceLabel = `INV-${saleGroupId.slice(-6).toUpperCase()}`;
                const statusLabel = paymentStatus === 'pay_later' ? 'paiement différé' : 'en attente';
                const movementComment = `Retrait facture ${invoiceLabel} (${statusLabel})`;

                if (sale.shopProductId) {
                    const shopProduct = appData.shopStock?.[sale.shopProductId];
                    if (!shopProduct) {
                        showSalesErrorMessage("Produit introuvable pour remettre le stock en boutique.");
                        return;
                    }
                    const newStock = (Number(shopProduct.quantityInShop) || 0) + quantity;
                    updates[`${dbBasePath}/shopStock/${sale.shopProductId}/quantityInShop`] = newStock;
                    const shopMoveKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                    updates[`${dbBasePath}/shopMovements/${shopMoveKey}`] = {
                        id: shopMoveKey,
                        shopProductId: sale.shopProductId,
                        productName: sale.productName || shopProduct.name || 'Produit',
                        type: "Entrée",
                        quantityChange: quantity,
                        oldStock: shopProduct.quantityInShop,
                        newStock,
                        comment: movementComment,
                        date: now,
                        userEmail: currentUser.email || ''
                    };
                } else if (sale.storeProductId) {
                    const storeProduct = appData.storeProducts?.[sale.storeProductId];
                    if (!storeProduct) {
                        showSalesErrorMessage("Produit introuvable pour remettre le stock magasin.");
                        return;
                    }
                    const newStock = (Number(storeProduct.quantityInStore) || 0) + quantity;
                    updates[`${dbBasePath}/storeProducts/${storeProduct.id}/quantityInStore`] = newStock;
                    const moveKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                    updates[`${dbBasePath}/storeMovements/${moveKey}`] = {
                        id: moveKey,
                        productId: storeProduct.id,
                        productName: storeProduct.name || 'Produit',
                        type: "Entrée",
                        quantityChange: quantity,
                        oldStock: storeProduct.quantityInStore,
                        newStock,
                        comment: movementComment,
                        date: now,
                        userEmail: currentUser.email || '',
                        status: EXIT_STATUS_APPROVED
                    };
                } else {
                    showSalesErrorMessage("Impossible d'identifier le produit pour ajuster le stock.");
                    return;
                }

                updates[`${dbBasePath}/salesHistory/${saleId}`] = null;

                if (saleGroupId && saleGroupId !== sale.id) {
                    const remainingSales = Object.values(appData.salesHistory || {}).filter(s => {
                        const group = s.saleGroupId || s.id;
                        return group === saleGroupId && s.id !== saleId;
                    });
                    if (remainingSales.length) {
                        const total = remainingSales.reduce((sum, s) => {
                            const lineTotal = Number(s.totalAmount) || (Number(s.sellingPrice) || 0) * (Number(s.quantity) || 0);
                            return sum + lineTotal;
                        }, 0);
                        const itemsCount = remainingSales.reduce((sum, s) => sum + (Number(s.quantity) || 0), 0);
                        updates[`${dbBasePath}/sales/${saleGroupId}/total`] = total;
                        updates[`${dbBasePath}/sales/${saleGroupId}/itemsCount`] = itemsCount;
                        updates[`${dbBasePath}/sales/${saleGroupId}/updatedAt`] = now;
                    } else {
                        updates[`${dbBasePath}/sales/${saleGroupId}`] = null;
                    }
                }

                try {
                    await update(ref(db), updates);

                    if (appData.salesHistory?.[saleId]) {
                        delete appData.salesHistory[saleId];
                    }
                    if (sale.shopProductId && appData.shopStock?.[sale.shopProductId]) {
                        appData.shopStock[sale.shopProductId].quantityInShop =
                            (Number(appData.shopStock[sale.shopProductId].quantityInShop) || 0) + quantity;
                    }
                    if (sale.storeProductId && appData.storeProducts?.[sale.storeProductId]) {
                        appData.storeProducts[sale.storeProductId].quantityInStore =
                            (Number(appData.storeProducts[sale.storeProductId].quantityInStore) || 0) + quantity;
                    }

                    renderSalesHistory();
                    updateDashboardStats();
                    updateAllStats();
                    if (activeSalesDetailId === saleGroupId) {
                        openSalesDetailModal(saleGroupId);
                    }
                    showSuccessToast('Article retiré de la facture.');
                } catch (error) {
                    console.error(error);
                    showSalesErrorMessage("Impossible de retirer l'article pour le moment.");
                }
            }

            // --- FONCTIONS DE GÉNÉRATION DE FACTURES PDF ---

            /**
             * Obtenir le prochain numéro de facture
             */
            async function getNextInvoiceNumber() {
                if (!dbBasePath) return 'FACT-0000-0001';

                const year = new Date().getFullYear();
                const counterPath = `${dbBasePath}/invoiceCounters/${year}`;

                try {
                    const snapshot = await get(ref(db, counterPath));
                    const currentCounter = snapshot.val() || 0;
                    const newCounter = currentCounter + 1;

                    // Incrémenter le compteur dans Firebase
                    await set(ref(db, counterPath), newCounter);

                    // Format: FACT-2026-0001
                    const paddedNumber = String(newCounter).padStart(4, '0');
                    return `FACT-${year}-${paddedNumber}`;
                } catch (error) {
                    console.error('Erreur récupération numéro facture:', error);
                    return `FACT-${year}-0001`;
                }
            }

            /**
             * Générer une facture PDF
             * @param {Object} invoiceData - Données de la facture
             */
            async function generateInvoicePDF(invoiceData) {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Obtenir le numéro de facture
                    const invoiceNumber = await getNextInvoiceNumber();

                    // Couleurs
                    const primaryColor = [6, 182, 212]; // Cyan
                    const darkGray = [31, 41, 55];
                    const lightGray = [243, 244, 246];

                    let yPos = 20;

                    // === EN-TÊTE ===
                    // Nom de l'entreprise
                    doc.setFillColor(...primaryColor);
                    doc.rect(0, 0, 210, 40, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(24);
                    doc.setFont(undefined, 'bold');
                    doc.text(invoiceData.companyName || 'Mon Entreprise', 20, 20);

                    // Titre FACTURE
                    doc.setFontSize(16);
                    doc.text('FACTURE', 150, 20);

                    // Numéro de facture
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text(`N° ${invoiceNumber}`, 150, 28);

                    // Date
                    const dateStr = new Date(invoiceData.date).toLocaleDateString('fr-FR');
                    doc.text(`Date: ${dateStr}`, 150, 35);

                    yPos = 50;

                    // === INFORMATIONS DE VENTE ===
                    doc.setTextColor(...darkGray);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('INFORMATIONS DE VENTE', 20, yPos);

                    yPos += 8;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Vendeur: ${invoiceData.sellerName}`, 20, yPos);

                    yPos += 6;
                    const saleDateTime = new Date(invoiceData.date).toLocaleString('fr-FR');
                    doc.text(`Date et heure de vente: ${saleDateTime}`, 20, yPos);

                    if (invoiceData.customerName) {
                        yPos += 6;
                        doc.text(`Client: ${invoiceData.customerName}`, 20, yPos);
                    }
                    if (invoiceData.customerPhone) {
                        yPos += 6;
                        doc.text(`Telephone: ${invoiceData.customerPhone}`, 20, yPos);
                    }
                    if (invoiceData.customerEmail) {
                        yPos += 6;
                        doc.text(`Email: ${invoiceData.customerEmail}`, 20, yPos);
                    }

                    yPos += 10;

                    // === TABLEAU DES PRODUITS ===
                    // Fonction ultra-simple pour éviter les problèmes d'encodage
                    const formatPDFCurrency = (amount) => {
                        // Convertir en string et ajouter des espaces pour les milliers
                        const numStr = Math.round(amount).toString();
                        return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                    };

                    const tableData = invoiceData.items.map(item => [
                        item.name,
                        item.quantity.toString(),
                        formatPDFCurrency(item.price),
                        formatPDFCurrency(item.total)
                    ]);

                    doc.autoTable({
                        startY: yPos,
                        head: [['Produit', 'Quantite', 'Prix Unitaire', 'Total']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: {
                            fillColor: primaryColor,
                            textColor: [255, 255, 255],
                            fontStyle: 'bold',
                            fontSize: 10,
                            halign: 'center'
                        },
                        bodyStyles: {
                            fontSize: 9
                        },
                        columnStyles: {
                            0: { cellWidth: 60, halign: 'left' },
                            1: { cellWidth: 30, halign: 'center' },
                            2: { cellWidth: 45, halign: 'right' },
                            3: { cellWidth: 45, halign: 'right' }
                        },
                        margin: { left: 15, right: 15 },
                        tableWidth: 'auto'
                    });

                    yPos = doc.lastAutoTable.finalY + 10;

                    // === TOTAL ===
                    doc.setFillColor(...lightGray);
                    doc.rect(15, yPos, 180, 12, 'F');
                    doc.setTextColor(...darkGray);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('TOTAL:', 135, yPos + 8);
                    doc.text(formatPDFCurrency(invoiceData.total) + ' ' + invoiceData.currency, 185, yPos + 8, { align: 'right' });

                    yPos += 20;

                    // === COMMENTAIRE (si présent) ===
                    if (invoiceData.comment) {
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'italic');
                        doc.setTextColor(100, 100, 100);
                        doc.text('Commentaire:', 20, yPos);
                        yPos += 6;
                        const commentLines = doc.splitTextToSize(invoiceData.comment, 170);
                        doc.text(commentLines, 20, yPos);
                        yPos += (commentLines.length * 5) + 10;
                    }

                    // === PIED DE PAGE ===
                    doc.setFillColor(...primaryColor);
                    doc.rect(0, 270, 210, 27, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text('Merci pour votre achat !', 105, 280, { align: 'center' });
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text('Facture générée par StockPilot', 105, 287, { align: 'center' });

                    // Sauvegarder la facture dans Firebase
                    await saveInvoiceRecord(invoiceNumber, invoiceData);

                    // Télécharger le PDF
                    doc.save(`Facture_${invoiceNumber}.pdf`);
                    showSuccessToast(`Facture ${invoiceNumber} générée !`);

                } catch (error) {
                    console.error('Erreur génération PDF:', error);
                    alert('Erreur lors de la génération de la facture');
                }
            }

            /**
             * Sauvegarder l'enregistrement de la facture dans Firebase
             */
            async function saveInvoiceRecord(invoiceNumber, invoiceData) {
                if (!dbBasePath) return;

                try {
                    const invoiceKey = push(ref(db, `${dbBasePath}/invoices`)).key;
                    await set(ref(db, `${dbBasePath}/invoices/${invoiceKey}`), {
                        id: invoiceKey,
                        invoiceNumber,
                        generatedAt: new Date().toISOString(),
                        saleData: invoiceData
                    });
                } catch (error) {
                    console.error('Erreur sauvegarde facture:', error);
                }
            }

            /**
             * Générer une facture depuis l'historique des ventes
             */
            async function generateInvoiceFromSale(saleId) {
                const sale = appData.salesHistory[saleId];
                if (!sale) {
                    alert('Vente introuvable');
                    return;
                }
                const subtotal = sale.totalAmount || (sale.sellingPrice || 0) * (sale.quantity || 0);
                const totalWithTax = subtotal * getTaxMultiplier();

                // Préparer les données de facture
                const invoiceData = {
                    companyName: currentUserData?.companyName || 'Mon Entreprise',
                    sellerName: sale.sellerName || currentUser?.email,
                    customerName: sale.customerName || 'Client comptoir',
                    customerPhone: sale.customerPhone || '',
                    customerEmail: sale.customerEmail || '',
                    date: sale.date,
                    items: [{
                        name: sale.productName,
                        quantity: sale.quantity,
                        price: sale.sellingPrice,
                        total: sale.totalAmount
                    }],
                    total: totalWithTax,
                    currency: getSaleCurrency(sale) || 'CFA',
                    comment: sale.comment || ''
                };

                await generateInvoicePDF(invoiceData);
            }

            async function generateReceiptFromGroup(groupId) {
                const groups = buildSalesHistoryGroups();
                const group = groups.find(item => item.id === groupId);
                if (!group) {
                    alert('Vente introuvable');
                    return;
                }
                const customerName = group.customerName || (group.customerId && appData.customers?.[group.customerId]?.fullName) || 'Client comptoir';
                const customerPhone = group.customerPhone || (group.customerId && appData.customers?.[group.customerId]?.phone) || '';
                const customerEmail = group.customerEmail || (group.customerId && appData.customers?.[group.customerId]?.email) || '';
                const summary = calculateItemsSummary(group.items.map(item => ({
                    sellingPrice: item.price,
                    quantity: item.quantity,
                    currency: group.currency
                })));
                const invoiceData = {
                    companyName: currentUserData?.companyName || 'Mon Entreprise',
                    sellerName: group.sellerName || currentUser?.email || '',
                    customerName,
                    customerPhone,
                    customerEmail,
                    date: group.date,
                    items: group.items.map(item => ({
                        name: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        total: item.total
                    })),
                    total: summary.total,
                    currency: summary.currency || group.currency || 'CFA',
                    comment: group.comments?.join(' | ') || ''
                };
                await generateInvoicePDF(invoiceData);
            }

            // Exposer les fonctions pour les boutons
            window.generateInvoiceFromSale = generateInvoiceFromSale;



            function updateSidebarMobileState() {
                if (isSidebarOpen) {
                    sidebar.classList.remove('-translate-x-full');
                    sidebarOverlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                }
            }

            function updateSidebarDesktopState() {
                const sidebarTexts = document.querySelectorAll('.sidebar-text');
                if (isSidebarCollapsed) {
                    sidebar.classList.replace('w-64', 'lg:w-20');
                    mainContent.classList.replace('lg:ml-64', 'lg:ml-20');
                    sidebarTexts.forEach(el => el.classList.add('lg:hidden'));
                } else {
                    sidebar.classList.replace('lg:w-20', 'w-64');
                    mainContent.classList.replace('lg:ml-20', 'lg:ml-64');
                    sidebarTexts.forEach(el => el.classList.remove('lg:hidden'));
                }
            }

            // --- ÉCOUTEURS POUR LA SUPPRESSION ---
            if (storeProductsTbody) {
                storeProductsTbody.addEventListener('click', async (e) => {
                    const actionButton = e.target.closest('button[data-store-action]');
                    if (actionButton && actionButton.dataset.productId) {
                        const action = actionButton.dataset.storeAction;
                        if (action === 'entry') {
                            openEntryModalForProduct(actionButton.dataset.productId);
                        } else if (action === 'exit') {
                            openExitModalForProduct(actionButton.dataset.productId);
                        }
                        return;
                    }

                    const btn = e.target.closest('button.delete-icon');
                    if (btn && btn.dataset.productId) {
                        if (confirm('Supprimer ce produit du magasin définitivement ?')) {
                            try {
                                await remove(ref(db, `${dbBasePath}/storeProducts/${btn.dataset.productId}`));
                                showSuccessToast('Produit supprimé du magasin');
                            } catch (err) { console.error(err); }
                        }
                    }
                });
            }

            if (storeMovementsTableContainer) {
                storeMovementsTableContainer.addEventListener('click', (event) => {
                    const approveButton = event.target.closest('button[data-approve-exit]');
                    if (approveButton) {
                        const requestId = approveButton.dataset.approveExit;
                        if (requestId && confirm("Valider cette sortie ?")) {
                            approveExitRequest(requestId);
                        }
                    }
                });
            }

            if (shopStockTbody) {
                shopStockTbody.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button.delete-icon');
                    if (btn && btn.dataset.stockId) {
                        if (confirm('Supprimer ce produit de la boutique ?')) {
                            try {
                                await remove(ref(db, `${dbBasePath}/shopStock/${btn.dataset.stockId}`));
                                showSuccessToast('Produit retiré de la boutique');
                            } catch (err) { console.error(err); }
                        }
                    }
                });
            }

            // Event Listeners
            if (hamburgerButton) hamburgerButton.addEventListener('click', () => { isSidebarOpen = true; updateSidebarMobileState(); });
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', () => { isSidebarOpen = false; updateSidebarMobileState(); });
            if (sidebarCollapseToggle) sidebarCollapseToggle.addEventListener('click', () => { isSidebarCollapsed = !isSidebarCollapsed; updateSidebarDesktopState(); });
            if (authToggleLogin) authToggleLogin.addEventListener('click', () => { isLoginView = true; updateAuthFormView(); });
            if (authToggleSignup) authToggleSignup.addEventListener('click', () => { isLoginView = false; updateAuthFormView(); });
            if (loginModeAdminButton) loginModeAdminButton.addEventListener('click', () => { isCodeLoginMode = false; updateLoginModeUI(); });
            if (loginModeCodeButton) loginModeCodeButton.addEventListener('click', () => { isCodeLoginMode = true; updateLoginModeUI(); });
            if (openCustomerSelectButton) openCustomerSelectButton.addEventListener('click', openCustomerSelectModal);
            if (changeCustomerSelectionButton) changeCustomerSelectionButton.addEventListener('click', openCustomerSelectModal);
            if (closeCustomerSelectModalButton) closeCustomerSelectModalButton.addEventListener('click', closeCustomerSelectModal);
            if (customerSelectModal) {
                customerSelectModal.addEventListener('click', (event) => {
                    if (event.target === customerSelectModal) closeCustomerSelectModal();
                });
            }
            if (customerSelectSearchInput) {
                customerSelectSearchInput.addEventListener('input', () => {
                    renderCustomerSelectList(customerSelectSearchInput.value);
                });
            }
            if (customerSelectList) {
                customerSelectList.addEventListener('click', (event) => {
                    const button = event.target.closest('button[data-customer-id]');
                    if (!button) return;
                    const customer = appData.customers?.[button.dataset.customerId];
                    if (customer) {
                        applySelectedCustomer({ id: button.dataset.customerId, ...customer });
                        closeCustomerSelectModal();
                    }
                });
            }
            if (openNewCustomerModalButton) {
                openNewCustomerModalButton.addEventListener('click', () => {
                    closeCustomerSelectModal();
                    openCustomerModalDialog();
                });
            }
            if (continueWithoutCustomerButton) {
                continueWithoutCustomerButton.addEventListener('click', () => {
                    clearSelectedCustomer();
                    closeCustomerSelectModal();
                });
            }
            if (closeCustomerModalButton) closeCustomerModalButton.addEventListener('click', closeCustomerModalDialog);
            if (backToCustomerSelectButton) {
                backToCustomerSelectButton.addEventListener('click', () => {
                    closeCustomerModalDialog();
                    openCustomerSelectModal();
                });
            }
            if (customerModal) {
                customerModal.addEventListener('click', (event) => {
                    if (event.target === customerModal) closeCustomerModalDialog();
                });
            }
            if (customerHistoryButton) {
                customerHistoryButton.addEventListener('click', () => {
                    if (!selectedCustomer) return;
                    isCustomerHistoryOpen = !isCustomerHistoryOpen;
                    renderCustomerHistory();
                });
            }
            if (salesProductSearch) salesProductSearch.addEventListener('input', () => {
                renderSalesProducts(salesProductSearch.value);
            });
            if (salesCategoryFilters) {
                salesCategoryFilters.addEventListener('click', (event) => {
                    const button = event.target.closest('[data-sales-category]');
                    if (!button) return;
                    selectedSalesCategory = button.dataset.salesCategory || 'Tous';
                    renderSalesCategoryFilters();
                    renderSalesProducts(salesProductSearch ? salesProductSearch.value : '');
                });
            }
            if (salesProductsContainer) {
                salesProductsContainer.addEventListener('click', (event) => {
                    const addButton = event.target.closest('[data-add-product]');
                    if (!addButton) return;
                    const productId = addButton.dataset.addProduct;
                    if (productId) addToCart(productId, 1);
                });
            }
            if (customerSelectedCard) {
                const clearButton = document.getElementById('clear-customer-selection');
                if (clearButton) clearButton.addEventListener('click', () => clearSelectedCustomer());
            }
            if (holdCommentInput) {
                holdCommentInput.addEventListener('input', () => {
                    if (holdCommentError) holdCommentError.classList.add('hidden');
                });
            }

            // Cart event listeners
            if (cartItemsList) {
                cartItemsList.addEventListener('click', (event) => {
                    const actionButton = event.target.closest('[data-cart-action]');
                    if (!actionButton) return;
                    const index = parseInt(actionButton.dataset.index, 10);
                    if (Number.isNaN(index)) return;
                    const action = actionButton.dataset.cartAction;
                    if (action === 'increase') updateCartQuantity(index, cartItems[index]?.quantity + 1);
                    if (action === 'decrease') updateCartQuantity(index, cartItems[index]?.quantity - 1);
                    if (action === 'remove') removeFromCart(index);
                });
                cartItemsList.addEventListener('change', (event) => {
                    const qtyInput = event.target.closest('[data-cart-quantity]');
                    if (!qtyInput) return;
                    const index = parseInt(qtyInput.dataset.index, 10);
                    if (Number.isNaN(index)) return;
                    const newQty = parseInt(qtyInput.value, 10);
                    if (!Number.isFinite(newQty)) {
                        qtyInput.value = cartItems[index]?.quantity ?? 1;
                        return;
                    }
                    updateCartQuantity(index, newQty);
                });
            }
            if (validateCartButton) validateCartButton.addEventListener('click', validateCart);
            if (generateInvoiceButton) generateInvoiceButton.addEventListener('click', generateInvoiceFromCart);
            if (payLaterButton) payLaterButton.addEventListener('click', markPayLaterFromCart);
            if (holdCartButton) holdCartButton.addEventListener('click', holdCart);
            if (salesHistoryTabCompleted) {
                salesHistoryTabCompleted.addEventListener('click', () => {
                    salesHistoryTab = 'completed';
                    renderSalesHistory();
                });
            }
            if (salesHistoryTabPending) {
                salesHistoryTabPending.addEventListener('click', () => {
                    salesHistoryTab = 'pending';
                    renderSalesHistory();
                });
            }
            if (salesHistoryTabPayLater) {
                salesHistoryTabPayLater.addEventListener('click', () => {
                    salesHistoryTab = 'pay_later';
                    renderSalesHistory();
                });
            }
            if (salesHistoryTabStoreValidation) {
                salesHistoryTabStoreValidation.addEventListener('click', () => {
                    salesHistoryTab = 'store_validation';
                    renderSalesHistory();
                });
            }
            if (salesHistorySearchInput) {
                salesHistorySearchInput.addEventListener('input', (event) => {
                    salesHistorySearch = event.target.value;
                    renderSalesHistory();
                });
            }
            if (salesHistoryDateFilter) {
                salesHistoryDateFilter.addEventListener('change', (event) => {
                    salesHistoryDateFilterValue = event.target.value || 'all';
                    renderSalesHistory();
                });
            }
            if (salesHistoryList) {
                salesHistoryList.addEventListener('click', (event) => {
                    const pendingItemRemoveButton = event.target.closest('[data-pending-item-remove]');
                    if (pendingItemRemoveButton) {
                        const pendingId = pendingItemRemoveButton.dataset.pendingItemRemove;
                        const itemIndex = pendingItemRemoveButton.dataset.pendingItemIndex;
                        removePendingSaleItem(pendingId, itemIndex);
                        return;
                    }
                    const historyItemRemoveButton = event.target.closest('[data-history-item-remove]');
                    if (historyItemRemoveButton) {
                        const saleId = historyItemRemoveButton.dataset.historyItemRemove;
                        const groupId = historyItemRemoveButton.dataset.historyItemGroup;
                        removeSalesHistoryItem(groupId, saleId);
                        return;
                    }
                    const actionButton = event.target.closest('[data-history-action]');
                    if (actionButton) {
                        const action = actionButton.dataset.historyAction;
                        const groupId = actionButton.dataset.historyId;
                        if (!groupId) return;
                        if (action === 'details') {
                            openSalesDetailModal(groupId);
                            return;
                        }
                        if (action === 'mark-paid') {
                            markPayLaterAsPaid(groupId);
                            return;
                        }
                        if (action === 'mark-paylater') {
                            markSaleAsPayLater(groupId);
                            return;
                        }
                        if (action === 'print') {
                            generateReceiptFromGroup(groupId);
                            return;
                        }
                        if (action === 'email') {
                            showSuccessToast('Email envoyé (simulation).');
                            return;
                        }
                    }
                    const storeValidationButton = event.target.closest('[data-store-validation-action]');
                    if (storeValidationButton) {
                        const saleId = storeValidationButton.dataset.storeValidationId;
                        const action = storeValidationButton.dataset.storeValidationAction;
                        if (saleId && action) {
                            resolveStoreValidationSale(saleId, action);
                        }
                        return;
                    }
                    const validateButton = event.target.closest('[data-pending-validate]');
                    if (validateButton) {
                        validatePendingSale(validateButton.dataset.pendingValidate);
                        return;
                    }
                    const cancelButton = event.target.closest('[data-pending-cancel]');
                    if (cancelButton) {
                        cancelPendingSale(cancelButton.dataset.pendingCancel);
                    }
                });
            }

            if (taxToggleSales) {
                taxToggleSales.addEventListener('change', (event) => {
                    setTaxEnabled(event.target.checked);
                });
            }
            if (taxToggleHistory) {
                taxToggleHistory.addEventListener('change', (event) => {
                    setTaxEnabled(event.target.checked);
                });
            }
            if (closeSalesDetailModalButton) {
                closeSalesDetailModalButton.addEventListener('click', closeSalesDetailModal);
            }
            if (salesDetailModal) {
                salesDetailModal.addEventListener('click', (event) => {
                    if (event.target === salesDetailModal) closeSalesDetailModal();
                });
            }
            if (salesDetailPrint) {
                salesDetailPrint.addEventListener('click', () => {
                    if (activeSalesDetailId) generateReceiptFromGroup(activeSalesDetailId);
                });
            }
            if (salesDetailEmail) {
                salesDetailEmail.addEventListener('click', () => {
                    showSuccessToast('Email envoyé (simulation).');
                });
            }

            // Quick Actions buttons
            const quickActionButtons = document.querySelectorAll('[data-quick-action]');

            function setActivePage(pageName) {
                // Vérifier les permissions avant de naviguer
                if (!canAccessPage(pageName)) {
                    alert(`Vous n'avez pas accès à la page "${pageName}".`);
                    return;
                }
                currentPage = pageName;
                updateUI();
            }

            function updateQuickActionButtons() {
                quickActionButtons.forEach(button => {
                    const targetPage = button.dataset.quickAction;
                    let canAccess = false;

                    // Déterminer quelle page vérifier
                    if (targetPage === 'Reappro') {
                        canAccess = canAccessPage('Stock Boutique');
                    } else {
                        canAccess = canAccessPage(targetPage);
                    }

                    // Masquer le bouton si l'utilisateur n'a pas accès
                    if (!canAccess) {
                        button.style.display = 'none';
                    } else {
                        button.style.display = '';
                    }
                });
            }

            quickActionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetPage = button.dataset.quickAction;
                    if (targetPage === 'Reappro') {
                        // Vérifier l'accès à Stock Boutique
                        if (!canAccessPage('Stock Boutique')) {
                            alert('Vous n\'avez pas accès au réapprovisionnement.');
                            return;
                        }
                        // Naviguer vers Stock Boutique
                        setActivePage('Stock Boutique');
                        // Ouvrir le modal de réapprovisionnement
                        setTimeout(() => {
                            const reapproButton = document.getElementById('open-restock-modal-button');
                            if (reapproButton) reapproButton.click();
                        }, 100);
                    } else {
                        setActivePage(targetPage);
                    }
                });
            });


            // Auth Logic
            if (loginForm) loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = loginForm.email.value.trim();
                if (isCodeLoginMode) {
                    const accessCode = loginAccessCodeInput.value.trim();
                    await handleAccessCodeLogin(email, accessCode);
                } else {
                    const password = loginPasswordInput.value;
                    try {
                        if (loginSubmitButton) loginSubmitButton.disabled = true;
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (error) {
                        if (loginError) {
                            loginError.textContent = "Email ou mot de passe incorrect.";
                            loginError.classList.remove('hidden');
                        }
                    } finally {
                        if (loginSubmitButton) loginSubmitButton.disabled = false;
                    }
                }
            });

            if (signupForm) signupForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = signupForm['signup-email'].value;
                const password = signupForm['signup-password'].value;
                const fullName = signupForm.fullName.value;
                const companyName = signupForm.companyName.value;

                try {
                    if (signupSubmitButton) signupSubmitButton.disabled = true;
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const companyId = push(ref(db, 'companies')).key;
                    await set(ref(db, `companies/${companyId}`), { name: companyName, createdAt: new Date().toISOString(), createdBy: user.uid });
                    const userData = { uid: user.uid, email, fullName, companyName, companyId, role: 'admin' };
                    await set(ref(db, `users/${user.uid}`), userData);
                    await set(ref(db, `companies/${companyId}/members/${user.uid}`), { fullName, email, role: 'admin', status: 'actif', permissions: [...accessModules] });
                } catch (error) {
                    if (signupError) {
                        signupError.textContent = error.message;
                        if (signupErrorContainer) signupErrorContainer.classList.remove('hidden');
                    }
                } finally {
                    if (signupSubmitButton) signupSubmitButton.disabled = false;
                }
            });

            if (customerForm) customerForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!dbBasePath) return;
                if (customerError) customerError.classList.add('hidden');
                const name = customerNameInput?.value.trim();
                const phone = customerPhoneInput?.value.trim() || '';
                const email = customerEmailInput?.value.trim() || '';
                const address = customerAddressInput?.value.trim() || '';
                const notes = customerNotesInput?.value.trim() || '';

                if (!name) {
                    if (customerError) {
                        customerError.textContent = "Le nom du client est requis.";
                        customerError.classList.remove('hidden');
                    }
                    return;
                }

                const normalizedPhone = normalizePhone(phone);
                const normalizedEmail = normalizeString(email);
                const existing = Object.values(appData.customers || {}).find(customer => {
                    if (normalizedPhone && normalizePhone(customer.phone) === normalizedPhone) return true;
                    if (normalizedEmail && normalizeString(customer.email) === normalizedEmail) return true;
                    return false;
                });

                if (existing) {
                    const shouldSelect = confirm("Un client avec ce telephone ou email existe deja. Voulez-vous le selectionner ?");
                    if (shouldSelect) {
                        applySelectedCustomer({ id: existing.id, ...existing });
                        closeCustomerModalDialog();
                    } else if (customerError) {
                        customerError.textContent = "Client existe deja. Selectionnez-le dans la liste.";
                        customerError.classList.remove('hidden');
                    }
                    return;
                }

                try {
                    if (customerSubmitButton) customerSubmitButton.disabled = true;
                    const newRef = push(ref(db, `${dbBasePath}/customers`));
                    const payload = {
                        id: newRef.key,
                        fullName: name,
                        phone,
                        email,
                        address,
                        notes,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    await set(newRef, payload);
                    showSuccessToast("Client ajoute avec succes.");
                    applySelectedCustomer(payload);
                    closeCustomerModalDialog();
                } catch (error) {
                    if (customerError) {
                        customerError.textContent = "Impossible d'enregistrer ce client.";
                        customerError.classList.remove('hidden');
                    }
                } finally {
                    if (customerSubmitButton) customerSubmitButton.disabled = false;
                }
            });

            if (newProductForm) newProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !dbBasePath) return;
                const name = newProductForm['product-name'].value;
                const desc = newProductForm['product-description'].value;
                const cost = parseFloat(newProductForm['product-cost'].value);
                const currency = newProductForm['product-currency'].value;
                const qty = parseInt(newProductForm['product-quantity'].value, 10);
                if (!name || isNaN(cost)) return;

                try {
                    if (newProductSubmitButton) newProductSubmitButton.disabled = true;

                    // LOGIQUE D'AGRÉGATION AUTO (MAGASIN)
                    const existingProduct = Object.values(appData.storeProducts).find(p =>
                        p.name.toLowerCase() === name.trim().toLowerCase() && p.purchaseCost === cost
                    );

                    if (existingProduct) {
                        const newStock = existingProduct.quantityInStore + qty;
                        const updates = {};
                        const now = new Date().toISOString();
                        updates[`${dbBasePath}/storeProducts/${existingProduct.id}/quantityInStore`] = newStock;
                        const moveKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                        updates[`${dbBasePath}/storeMovements/${moveKey}`] = { id: moveKey, productId: existingProduct.id, productName: name, type: "Entrée", quantityChange: qty, oldStock: existingProduct.quantityInStore, newStock: newStock, comment: "Ajout automatique (même prix)", date: now };
                        await update(ref(db), updates);
                        showSuccessToast("Stock mis à jour pour le produit existant");
                    } else {
                        const newRef = push(ref(db, `${dbBasePath}/storeProducts`));
                        const newProd = { id: newRef.key, name: name.trim(), description: desc, purchaseCost: cost, currency, quantityInStore: qty, createdAt: new Date().toISOString() };
                        await set(newRef, newProd);
                        const moveRef = push(ref(db, `${dbBasePath}/storeMovements`));
                        await set(moveRef, { id: moveRef.key, productId: newProd.id, productName: name, type: "Entrée", quantityChange: qty, oldStock: 0, newStock: qty, comment: "Création", date: new Date().toISOString() });
                        showSuccessToast("Produit ajouté!");
                    }

                    newProductForm.reset();
                    newProductModal.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                } finally {
                    if (newProductSubmitButton) newProductSubmitButton.disabled = false;
                }
            });

            if (entryForm) entryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !dbBasePath) return;
                const pid = entryProductSelect.value;
                const qty = parseInt(entryForm['entry-quantity'].value, 10);
                const comment = entryForm['entry-comment'].value;
                const prod = appData.storeProducts[pid];
                if (!prod || qty <= 0) return;

                try {
                    if (entrySubmitButton) entrySubmitButton.disabled = true;
                    const newStock = prod.quantityInStore + qty;
                    const updates = {};
                    updates[`${dbBasePath}/storeProducts/${pid}/quantityInStore`] = newStock;
                    const moveKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                    updates[`${dbBasePath}/storeMovements/${moveKey}`] = { id: moveKey, productId: pid, productName: prod.name, type: "Entrée", quantityChange: qty, oldStock: prod.quantityInStore, newStock, comment, date: new Date().toISOString() };
                    await update(ref(db), updates);
                    showSuccessToast("Entrée de stock réussie !");
                    entryForm.reset();
                    entryModal.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                } finally {
                    if (entrySubmitButton) entrySubmitButton.disabled = false;
                }
            });

            if (exitForm) exitForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !dbBasePath) return;
                if (exitError) exitError.classList.add('hidden');
                const pid = exitProductSelect.value;
                const qty = parseInt(exitForm['exit-quantity'].value, 10);
                const comment = exitForm['exit-comment'].value;
                const customerName = exitCustomerNameInput ? exitCustomerNameInput.value.trim() : '';
                const customerEmail = exitCustomerEmailInput ? exitCustomerEmailInput.value.trim() : '';
                const customerPhone = exitCustomerPhoneInput ? exitCustomerPhoneInput.value.trim() : '';
                const prod = appData.storeProducts[pid];
                if (!prod || qty <= 0) return;
                if (!customerName || !customerEmail || !customerPhone) {
                    if (exitError) {
                        exitError.textContent = 'Veuillez renseigner les informations client obligatoires.';
                        exitError.classList.remove('hidden');
                    }
                    return;
                }
                const pendingQty = getPendingExitQuantity(pid);
                const available = prod.quantityInStore - pendingQty;
                if (qty > available) {
                    if (exitError) {
                        exitError.textContent = `Stock insuffisant. Disponible: ${Math.max(available, 0)}.`;
                        exitError.classList.remove('hidden');
                    } else {
                        alert("Stock insuffisant dans le magasin.");
                    }
                    return;
                }

                try {
                    if (exitSubmitButton) exitSubmitButton.disabled = true;
                    const requestRef = push(ref(db, `${dbBasePath}/storeExitRequests`));
                    const saleRef = push(ref(db, `${dbBasePath}/salesHistory`));
                    const now = new Date().toISOString();
                    const sellerName = currentUserData?.fullName || currentUser.email || '';
                    const sellingPrice = Number(prod.purchaseCost ?? 0);
                    const totalAmount = sellingPrice * qty;
                    const updates = {};

                    updates[`${dbBasePath}/storeExitRequests/${requestRef.key}`] = {
                        id: requestRef.key,
                        productId: pid,
                        productName: prod.name,
                        quantity: qty,
                        comment,
                        customerName,
                        customerEmail,
                        customerPhone,
                        status: EXIT_STATUS_PENDING,
                        requestedAt: now,
                        requestedByName: currentUserData?.fullName || currentUser.email || '',
                        requestedByEmail: currentUser.email || '',
                        requestedById: currentUser.uid || '',
                        stockBefore: prod.quantityInStore,
                        saleHistoryId: saleRef.key
                    };

                    updates[`${dbBasePath}/salesHistory/${saleRef.key}`] = {
                        id: saleRef.key,
                        saleGroupId: saleRef.key,
                        storeProductId: pid,
                        productName: prod.name,
                        quantity: qty,
                        sellingPrice,
                        totalAmount,
                        sellerName,
                        customerId: null,
                        customerName,
                        customerPhone,
                        customerEmail,
                        comment: comment || 'Vente directe magasin',
                        paymentStatus: 'store_validation',
                        validationStatus: 'pending',
                        payLater: false,
                        date: now,
                        saleSource: SALE_SOURCE_STORE,
                        currency: prod.currency || 'CFA',
                        storeRequestId: requestRef.key
                    };

                    await update(ref(db), updates);
                    showSuccessToast("Vente magasin envoyée pour validation.");
                    exitForm.reset();
                    exitModal.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                } finally {
                    if (exitSubmitButton) exitSubmitButton.disabled = false;
                }
            });

            if (transferForm) transferForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !dbBasePath) return;
                const sourceId = transferProductSelect.value;
                const qty = parseInt(transferForm['transfer-quantity'].value, 10);
                const price = parseFloat(transferForm['transfer-selling-price'].value);
                const alertT = parseInt(transferForm['transfer-alert-threshold'].value, 10) || 5;
                const sourceProd = appData.storeProducts[sourceId];
                if (!sourceProd || qty > sourceProd.quantityInStore) {
                    alert("Stock magasin insuffisant.");
                    return;
                }

                try {
                    if (transferSubmitButton) transferSubmitButton.disabled = true;

                    // LOGIQUE D'AGRÉGATION AUTO (BOUTIQUE) par NOM + PRIX
                    let existingItem = Object.values(appData.shopStock).find(i =>
                        i.name.toLowerCase() === sourceProd.name.toLowerCase() && i.sellingPrice === price
                    );

                    const updates = {}; const now = new Date().toISOString();
                    const storeNew = sourceProd.quantityInStore - qty;
                    const shopOld = existingItem ? existingItem.quantityInShop : 0;
                    const shopNew = shopOld + qty;

                    updates[`${dbBasePath}/storeProducts/${sourceId}/quantityInStore`] = storeNew;
                    const smKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                    updates[`${dbBasePath}/storeMovements/${smKey}`] = { id: smKey, productId: sourceId, productName: sourceProd.name, type: "Sortie", quantityChange: qty, oldStock: sourceProd.quantityInStore, newStock: storeNew, comment: "Transfert Boutique", date: now };

                    const shopId = existingItem ? existingItem.id : push(ref(db, `${dbBasePath}/shopStock`)).key;
                    updates[`${dbBasePath}/shopStock/${shopId}`] = { id: shopId, sourceProductId: sourceId, name: sourceProd.name, purchaseCost: sourceProd.purchaseCost, sellingPrice: price, quantityInShop: shopNew, alertThreshold: alertT, createdAt: existingItem ? existingItem.createdAt : now, updatedAt: now };

                    const shmKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                    updates[`${dbBasePath}/shopMovements/${shmKey}`] = { id: shmKey, shopProductId: shopId, productName: sourceProd.name, type: "Entrée", quantityChange: qty, oldStock: shopOld, newStock: shopNew, comment: existingItem ? "Fusion stock (même prix)" : "Depuis magasin", date: now, userEmail: currentUser.email };

                    await update(ref(db), updates);
                    showSuccessToast(existingItem ? "Stock fusionné en boutique !" : "Transfert boutique réussi !");
                    transferForm.reset();
                    transferModal.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                } finally {
                    if (transferSubmitButton) transferSubmitButton.disabled = false;
                }
            });

            if (restockForm) restockForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !dbBasePath) return;
                const sid = restockProductSelect.value;
                const qty = parseInt(restockForm['restock-quantity'].value, 10);
                const comment = restockForm['restock-comment'].value || "Restock";
                const shopProd = appData.shopStock[sid];
                if (!shopProd) return;
                const sourceProd = appData.storeProducts[shopProd.sourceProductId];
                if (!sourceProd || qty > sourceProd.quantityInStore) {
                    alert("Stock magasin insuffisant.");
                    return;
                }

                try {
                    if (restockSubmitButton) restockSubmitButton.disabled = true;
                    const updates = {}; const now = new Date().toISOString();
                    const storeNew = sourceProd.quantityInStore - qty;
                    const shopNew = shopProd.quantityInShop + qty;

                    updates[`${dbBasePath}/storeProducts/${sourceProd.id}/quantityInStore`] = storeNew;
                    const smKey = push(ref(db, `${dbBasePath}/storeMovements`)).key;
                    updates[`${dbBasePath}/storeMovements/${smKey}`] = { id: smKey, productId: sourceProd.id, productName: sourceProd.name, type: "Sortie", quantityChange: qty, oldStock: sourceProd.quantityInStore, newStock: storeNew, comment: "Réappro Boutique", date: now };

                    updates[`${dbBasePath}/shopStock/${sid}/quantityInShop`] = shopNew;
                    updates[`${dbBasePath}/shopStock/${sid}/updatedAt`] = now;
                    const shmKey = push(ref(db, `${dbBasePath}/shopMovements`)).key;
                    updates[`${dbBasePath}/shopMovements/${shmKey}`] = { id: shmKey, shopProductId: sid, productName: shopProd.name, type: "Entrée", quantityChange: qty, oldStock: shopProd.quantityInShop, newStock: shopNew, comment: comment, date: now, userEmail: currentUser.email };

                    await update(ref(db), updates);
                    showSuccessToast("Réapprovisionnement réussi !");
                    restockForm.reset();
                    restockModal.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                } finally {
                    if (restockSubmitButton) restockSubmitButton.disabled = false;
                }
            });

            // UI Navigation
            navButtons.forEach(btn => btn.addEventListener('click', () => {
                currentPage = btn.dataset.page;
                if (window.innerWidth < 1024) {
                    isSidebarOpen = false;
                    updateSidebarMobileState();
                }
                updateUI();
            }));

            if (logoutButton) logoutButton.addEventListener('click', () => {
                if (isCodeSession) {
                    handleManualLogout();
                    showSuccessToast('Déconnecté');
                } else {
                    signOut(auth);
                }
            });

            // Delete event listeners with permission checks
            if (storeProductsTbody) {
                storeProductsTbody.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button.delete-icon');
                    if (btn && btn.dataset.productId) {
                        // Check permission
                        if (!hasPermission('Supprimer Stock Magasin')) {
                            alert('Vous n\'avez pas la permission de supprimer des produits du Stock Magasin.');
                            return;
                        }

                        if (confirm('Supprimer ce produit du magasin définitivement ?')) {
                            try {
                                await remove(ref(db, `${dbBasePath}/storeProducts/${btn.dataset.productId}`));
                                showSuccessToast('Produit supprimé du magasin');
                            } catch (err) {
                                console.error(err);
                                alert('Erreur lors de la suppression');
                            }
                        }
                    }
                });
            }

            if (shopStockTbody) {
                shopStockTbody.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button.delete-icon');
                    if (btn && btn.dataset.stockId) {
                        // Check permission
                        if (!hasPermission('Supprimer Stock Boutique')) {
                            alert('Vous n\'avez pas la permission de supprimer des produits du Stock Boutique.');
                            return;
                        }

                        if (confirm('Supprimer ce produit de la boutique ?')) {
                            try {
                                await remove(ref(db, `${dbBasePath}/shopStock/${btn.dataset.stockId}`));
                                showSuccessToast('Produit retiré de la boutique');
                            } catch (err) {
                                console.error(err);
                                alert('Erreur lors de la suppression');
                            }
                        }
                    }
                });
            }


            // Modals Open
            if (openNewProductModalButton) openNewProductModalButton.addEventListener('click', () => { newProductModal.classList.remove('hidden'); newProductForm.reset(); });
            if (openEntryModalButton) openEntryModalButton.addEventListener('click', () => openEntryModalForProduct());
            if (openExitModalButton) openExitModalButton.addEventListener('click', () => openExitModalForProduct());
            if (openTransferModalButton) openTransferModalButton.addEventListener('click', () => { transferModal.classList.remove('hidden'); transferForm.reset(); transferSourceInfo.classList.add('hidden'); });
            if (openRestockModalButton) openRestockModalButton.addEventListener('click', () => { restockModal.classList.remove('hidden'); restockForm.reset(); restockSourceInfo.classList.add('hidden'); });

            // Modals Close
            if (closeNewProductModalButton) closeNewProductModalButton.addEventListener('click', () => newProductModal.classList.add('hidden'));
            if (closeEntryModalButton) closeEntryModalButton.addEventListener('click', () => entryModal.classList.add('hidden'));
            if (closeExitModalButton) closeExitModalButton.addEventListener('click', () => exitModal.classList.add('hidden'));
            if (entryCancelButton) entryCancelButton.addEventListener('click', () => entryModal.classList.add('hidden'));
            if (exitCancelButton) exitCancelButton.addEventListener('click', () => exitModal.classList.add('hidden'));
            if (closeTransferModalButton) closeTransferModalButton.addEventListener('click', () => transferModal.classList.add('hidden'));
            if (closeRestockModalButton) closeRestockModalButton.addEventListener('click', () => restockModal.classList.add('hidden'));

            if (entryProductSelect) {
                entryProductSelect.addEventListener('change', () => {
                    updateEntryProductInfo(appData.storeProducts?.[entryProductSelect.value]);
                });
            }
            if (exitProductSelect) {
                exitProductSelect.addEventListener('change', () => {
                    updateExitProductInfo(appData.storeProducts?.[exitProductSelect.value]);
                });
            }

            // Background Modal Close
            [newProductModal, entryModal, exitModal, transferModal, restockModal].forEach(m => {
                if (m) m.addEventListener('click', e => { if (e.target === m) m.classList.add('hidden'); });
            });

            // Select Interaction (Info display in modals)
            if (transferProductSelect) transferProductSelect.addEventListener('change', () => {
                const p = appData.storeProducts[transferProductSelect.value];
                if (p) {
                    transferCostDisplay.textContent = formatCurrency(p.purchaseCost, p.currency);
                    transferSourceInfo.classList.remove('hidden');
                } else {
                    transferSourceInfo.classList.add('hidden');
                }
            });

            if (restockProductSelect) restockProductSelect.addEventListener('change', () => {
                const si = appData.shopStock[restockProductSelect.value];
                if (si && appData.storeProducts[si.sourceProductId]) {
                    const sp = appData.storeProducts[si.sourceProductId];
                    restockSourceName.textContent = sp.name;
                    restockSourceStock.textContent = sp.quantityInStore;
                    restockSourceInfo.classList.remove('hidden');
                } else {
                    restockSourceInfo.classList.add('hidden');
                }
            });

            function updateAllStats() {
                const sales = getCountableSalesEntries();
                const shopItems = Object.values(appData.shopStock);
                const storeItems = Object.values(appData.storeProducts);
                const now = new Date();
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();

                if (document.getElementById('stat-daily-sales'))
                    document.getElementById('stat-daily-sales').textContent = sales.filter(s => s.date >= startOfDay).length;

                const shopCount = shopItems.reduce((acc, i) => acc + i.quantityInShop, 0);
                if (document.getElementById('stat-shop-stock'))
                    document.getElementById('stat-shop-stock').textContent = shopCount + " produits";

                if (document.getElementById('stat-store-stock'))
                    document.getElementById('stat-store-stock').textContent = storeItems.reduce((acc, i) => acc + i.quantityInStore, 0) + " produits";

                if (document.getElementById('stat-total-sales'))
                    document.getElementById('stat-total-sales').textContent = sales.length;

                if (document.getElementById('stat-revenue'))
                    document.getElementById('stat-revenue').textContent = formatCurrency(sales.reduce((acc, s) => acc + s.totalAmount, 0));

                if (document.getElementById('stat-products-in-stock'))
                    document.getElementById('stat-products-in-stock').textContent = shopItems.length;

                // Rendus statistiques (Top produits, etc)
                const bestSellingContainer = document.getElementById('best-selling-tbody');
                if (bestSellingContainer) {
                    const productSales = sales.reduce((acc, s) => { acc[s.productName] = (acc[s.productName] || 0) + s.quantity; return acc; }, {});
                    const sortedProd = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    bestSellingContainer.innerHTML = sortedProd.length ? sortedProd.map(([name, qty]) => `<tr class="hover:bg-gray-50"><td class="px-4 py-3 text-sm text-gray-800">${name}</td><td class="px-4 py-3 text-sm text-gray-600 font-bold">${qty}</td><td class="px-4 py-3"></td></tr>`).join('') : '';
                    if (sortedProd.length) {
                        document.getElementById('best-selling-placeholder')?.classList.add('hidden');
                        document.getElementById('best-selling-table-container')?.classList.remove('hidden');
                    }
                }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    isCodeSession = false;
                    isAuthenticated = true;
                    currentUser = user;
                    get(ref(db, `users/${user.uid}`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            currentUserData = snapshot.val();
                            currentUserData.role = currentUserData.role || 'admin';
                            dbBasePath = currentUserData.companyId ? `companies/${currentUserData.companyId}` : `users/${user.uid}`;
                            setupFirebaseListeners();
                            ensureCurrentUserInTeam();
                            updateSettingsAccess();
                            updateUI();
                        }
                    });
                } else {
                    if (!isCodeSession) {
                        isAuthenticated = false; currentUser = null; currentUserData = null; dbBasePath = ''; currentPage = 'Tableau de bord'; cleanupFirebaseListeners(); updateUI();
                    }
                }
            });

            updateUI();
            updateAuthFormView();
            renderSalesCategoryFilters();
            renderSalesProducts();
            loadTaxSetting();
            renderCart();
            updateCustomerHistoryVisibility();
            renderSalesHistory();
        });
    </script>
</body>

</html>
